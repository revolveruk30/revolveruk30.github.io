<html>
<title>Detection Rules</title>
<meta name="robots" content="noindex,nofollow" />
<link rel="stylesheet" href="w2.css">

<head>
<style>
html, body {
background-color: #f0f0f0;
}

.w3-topbar {
width: 100%;
height:5%;
background-color: black;
position: fixed;
top: 1px;
overflow: hidden;
}
#myInput {
background-repeat: no-repeat;
width: 40%;
border: 1px solid #ddd;
margin-left: 300px;
text-align: center;
font-family: "Roboto", sans-serif
}
#keywords {
background-repeat: no-repeat;
width: 28%;
border: 1px solid #ddd;
border: 1px solid #ddd;
margin-bottom: 2px;
margin-left: 300px;
text-align: center;
font-family: "Roboto", sans-serif
}
#myUL {
list-style-type: none;
padding: 0;
text-align: center;
margin-top: 10px;
width: 100%;
}
#myUL li a {
margin-top: -1px;
padding: 8px;
text-decoration: none;
font-size: 14px;
color: black;
display: block
}
}
</style>
</head>
<body>
<!-- Topbar -->
<div class="w3-topbar"></div>
<!-- Sidebar -->
<BR>
<p>
<BR>
<center><H3>Elastic Detection Rules</H3></center>
<BR>
<input type="text" id="myInput" onkeyup="myFunction()" placeholder="Filter Paragraph by Keyword" title="Search">
<form method="GET" onsubmit="myHilitor.apply(hilite.value); return false;">
<input type="text" id="keywords" size="20" name="hilite" placeholder="Highlight Multiple Keywords">
<input type="submit" value="Apply">
<input type="button" value="Remove" onclick="myHilitor.remove();">
</span>
</form>
</nav>
<div class="w3-main w3-theme-l5" style="margin-left:100px, margin-right:50px">
<div id="playground">
<center>
<ul id="myUL">
<p>
<p>
<li><a href="#">description = "A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected." false_positives = [ "Trusted SolarWinds child processes. Verify process details such as network connections and file writes.", ] query = " process where event.type == "start" and process.name: ("cmd.exe", "powershell.exe") and process.parent.name: ( "ConfigurationWizard*.exe", "NetflowDatabaseMaintenance*.exe", "NetFlowService*.exe", "SolarWinds.Administration*.exe", "SolarWinds.Collector.Service*.exe", "SolarwindsDiagnostics*.exe" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1195" name = "Supply Chain Compromise" reference = [[rule.threat.technique.subtechnique]] id = "T1195.002" name = "Compromise Software Supply Chain" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = "A suspicious SolarWinds child process was detected, which may indicate an attempt to execute malicious programs." false_positives = [ "Trusted SolarWinds child processes, verify process details such as network connections and file writes.", ] query = " process where event.type == "start" and process.parent.name: ("SolarWinds.BusinessLayerHost.exe", "SolarWinds.BusinessLayerHostx64.exe") and not process.name : ( "APMServiceControl*.exe", "ExportToPDFCmd*.Exe", "SolarWinds.Credentials.Orion.WebApi*.exe", "SolarWinds.Orion.Topology.Calculator*.exe", "Database-Maint.exe", "SolarWinds.Orion.ApiPoller.Service.exe", "WerFault.exe", "WerMgr.exe", "SolarWinds.BusinessLayerHost.exe", "SolarWinds.BusinessLayerHostx64.exe") and not process.executable : ("?:\\Windows\\SysWOW64\\ARP.EXE", "?:\\Windows\\SysWOW64\\lodctr.exe", "?:\\Windows\\SysWOW64\\unlodctr.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1106" name = "Native API" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1195" name = "Supply Chain Compromise" reference = [[rule.threat.technique.subtechnique]] id = "T1195.002" name = "Compromise Software Supply Chain" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = "Adversaries can add the 'hidden' attribute to files to hide them from the user in an attempt to evade detection." query = " process where event.type == "start" and process.name : "attrib.exe" and process.args : "+h" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.001" name = "Hidden Files and Directories" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Adversaries may encode/decode data in an attempt to evade detection by host- or network-based security controls." false_positives = [ Automated tools such as Jenkins may encode or decode files as part of their normal behavior. These events can be filtered by the process executable or username values., ] query = " event.category:process and event.type:(start or process_started) and process.name:(base16 or base32 or base32plain or base32hex) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1027" name = "Obfuscated Files or Information" reference = [[rule.threat.technique]] id = "T1140" name = "Deobfuscate/Decode Files or Information" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Detects attempts to establish persistence on an endpoint by abusing Microsoft Office add-ins." query = " file where event.type != "deletion" and file.extension : ("wll","xll","ppa","ppam","xla","xlam") and file.path : ( "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Word\\Startup\\*", "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\AddIns\\*", "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Excel\\XLSTART\\*" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1137" name = "Office Application Startup" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Detects attempts to establish persistence on an endpoint by installing a rogue Microsoft Outlook VBA Template." false_positives = ["A legitimate VBA for Outlook is usually configured interactively via OUTLOOK.EXE."] query = " file where event.type != "deletion" and file.path : "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Outlook\\VbaProject.OTM" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1137" name = "Office Application Startup" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Detects PowerShell scripts that can record audio, a common feature in popular post-exploitation tooling." query = " event.category:process and powershell.file.script_block_text : ( "Get-MicrophoneAudio" or (waveInGetNumDevs and mciSendStringA) ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1123" name = "Audio Capture" reference = [rule.threat.tactic] id = "TA0009" name = "Collection" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects." false_positives = ["Legitimate Administrative Activity"] index = ["winlogbeat-*", "logs-system.*", "logs-windows.*"] language = "kuery" license = "Elastic License v2" name = "Startup/Logon Script added to Group Policy Object" note =## Triage and analysis ### Investigating Scheduled Task Execution at Scale via GPO Group Policy Objects (GPOs) can be used by attackers to instruct arbitrarily large groups of clients to execute specified commands at startup, logon, shutdown, and logoff. This is done by creating or modifying the `scripts.ini` or `psscripts.ini` files. The scripts are stored in the following paths: - `<GPOPath>\\Machine\\Scripts\\` - `<GPOPath>\\User\\Scripts\\` #### Possible investigation steps - This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation. - Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries. - Investigate other alerts associated with the user/host during the past 48 hours. - Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO. ### False positive analysis - Verify if the execution is legitimately authorized and executed under a change management process. ### Related rules - Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf - Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e ### Response and remediation - Initiate the incident response process based on the outcome of the triage. - The investigation and containment must be performed in every computer controlled by the GPO, where necessary. - Remove the script from the GPO. - Check if other GPOs have suspicious scripts attached. - Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector. - Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR). ## Setup The 'Audit Detailed File Share' audit policy must be configured (Success Failure). Steps to implement the logging policy with with Advanced Audit Configuration: ``` Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policies Configuration > Audit Policies > Object Access > Audit Detailed File Share (Success,Failure) ``` The 'Audit Directory Service Changes' audit policy must be configured (Success Failure). Steps to implement the logging policy with with Advanced Audit Configuration: ``` Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policies Configuration > Audit Policies > DS Access > Audit Directory Service Changes (Success,Failure) ``` references = [ , , , ] risk_score = 47 rule_id = "16fac1a1-21ee-4ca6-b720-458e3855d046" severity = "medium" tags = [ "Elastic", "Host", "Windows", "Threat Detection", "Privilege Escalation", "Active Directory", "Investigation Guide", ] timestamp_override = "event.ingested" type = "query = " ( event.code:5136 and winlog.event_data.AttributeLDAPDisplayName:(gPCMachineExtensionNames or gPCUserExtensionNames) and winlog.event_data.AttributeValue:(*42B5FAAE-6536-11D2-AE5A-0000F87571E3* and (*40B66650-4972-11D1-A7CA-0000F87571E3* or *40B6664F-4972-11D1-A7CA-0000F87571E3*)) ) or ( event.code:5145 and winlog.event_data.ShareName:\\\\*\\SYSVOL and winlog.event_data.RelativeTargetName:(*\\scripts.ini or *\\psscripts.ini) and (message:WriteData or winlog.event_data.AccessList:*%%4417*) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1484" name = "Domain Policy Modification" reference = [[rule.threat.technique.subtechnique]] id = "T1484.001" name = "Group Policy Modification" reference = [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = "Detects use of the systemsetup command to enable remote SSH Login." query = " event.category:process and event.type:(start or process_started) and process.name:systemsetup and process.args:("-setremotelogin" and on) and not process.parent.executable : /usr/local/jamf/bin/jamf " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.004" name = "SSH" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = "Detects writing executable files that will be automatically launched by Adobe on launch." query = " file where event.type == "creation" and file.path : ("?:\\Program Files (x86)\\Adobe\\Acrobat Reader DC\\Reader\\AcroCEF\\RdrCEF.exe", "?:\\Program Files\\Adobe\\Acrobat Reader DC\\Reader\\AcroCEF\\RdrCEF.exe") and not process.name : "msiexec.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.010" name = "Services File Permissions Weakness" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Discovery of remote system information using built-in commands, which may be used to move laterally." query = " process where event.type == "start" and ((process.name : "nbtstat.exe" and process.args : ("-n", "-s")) or (process.name : "arp.exe" and process.args : "-a")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1016" name = "System Network Configuration Discovery" reference = [[rule.threat.technique]] id = "T1018" name = "Remote System Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = "Identifies a successful login to the AWS Management Console by the Root user." false_positives = [ It's strongly recommended that the root user is not used for everyday tasks, including the administrative ones. Verify whether the IP address, location, and/or hostname should be logging in as root in your environment. Unfamiliar root logins should be investigated immediately. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and aws.cloudtrail.user_identity.type:Root and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection." query = " process where event.type == "start" and process.parent.pid == 4 and not process.executable : ("Registry", "MemCompression", "?:\\Windows\\System32\\smss.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies a suspicious parent child process relationship with cmd.exe descending from an unusual process." query = " process where event.type == "start" and process.name : "cmd.exe" and process.parent.name : ("lsass.exe", "csrss.exe", "epad.exe", "regsvr32.exe", "dllhost.exe", "LogonUI.exe", "wermgr.exe", "spoolsv.exe", "jucheck.exe", "jusched.exe", "ctfmon.exe", "taskhostw.exe", "GoogleUpdate.exe", "sppsvc.exe", "sihost.exe", "slui.exe", "SIHClient.exe", "SearchIndexer.exe", "SearchProtocolHost.exe", "FlashPlayerUpdateService.exe", "WerFault.exe", "WUDFHost.exe", "unsecapp.exe", "wlanext.exe" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies a suspicious parent child process relationship with cmd.exe descending from svchost.exe" query = " process where event.type == "start" and process.parent.name : "svchost.exe" and process.name : "cmd.exe" and not process.args : ("??:\\Program Files\\Npcap\\CheckStatus.bat?", "?:\\Program Files\\Npcap\\CheckStatus.bat", "\\system32\\cleanmgr.exe", "?:\\Windows\\system32\\silcollector.cmd", "\\system32\\AppHostRegistrationVerifier.exe", "\\system32\\ServerManagerLauncher.exe", "dir", "?:\\Program Files\\*", "?:\\Program Files (x86)\\*", "?:\\Windows\\LSDeployment\\Lspush.exe", "(x86)\\FMAuditOnsite\\watchdog.bat", "?:\\ProgramData\\chocolatey\\bin\\choco-upgrade-all.bat", "Files\\Npcap\\CheckStatus.bat") and /* very noisy pattern - bat or cmd script executed via scheduled tasks */ not (process.parent.args : "netsvcs" and process.args : ("?:\\*.bat", "?:\\*.cmd")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies an AWS configuration change to stop recording a designated set of resources." false_positives = [ Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Recording changes from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:config.amazonaws.com and event.action:StopConfigurationRecorder and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies an executable or script file remotely downloaded via a TeamViewer transfer session." query = " file where event.type == "creation" and process.name : "TeamViewer.exe" and file.extension : ("exe", "dll", "scr", "com", "bat", "ps1", "vbs", "vbe", "js", "wsh", "hta") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [[rule.threat.technique]] id = "T1219" name = "Remote Access Software" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = "Identifies an update to an AWS log trail setting that specifies the delivery of log files." false_positives = [ Trail updates may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail updates from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:UpdateTrail and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1565" name = "Data Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1565.001" name = "Stored Data Manipulation" reference = [rule.threat.tactic] id = "TA0040" name = "Impact" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1530" name = "Data from Cloud Storage" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = "Identifies attempts to dump Wireless saved access keys in clear text using the Windows built-in utility Netsh." query = " process where event.type == "start" and (process.name : "netsh.exe" or process.pe.original_file_name == "netsh.exe") and process.args : "wlan" and process.args : "key*clear" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1082" name = "System Information Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = "Identifies attempts to enumerate hosts in a network using the built-in Windows net.exe tool." query = " process where event.type == "start" and ((process.name : "net.exe" or process.pe.original_file_name == "net.exe") or ((process.name : "net1.exe" or process.pe.original_file_name == "net1.exe") and not process.parent.name : "net.exe")) and (process.args : "view" or (process.args : "time" and process.args : "\\\\*")) /* expand when ancestry is available and not descendant of [process where event.type == "start" and process.name : "cmd.exe" and ((process.parent.name : "userinit.exe") or (process.parent.name : "gpscript.exe") or (process.parent.name : "explorer.exe" and process.args : "C:\\*\\Start Menu\\Programs\\Startup\\*.bat*"))] */ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1018" name = "Remote System Discovery" reference = [[rule.threat.technique]] id = "T1135" name = "Network Share Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool." query = " process where event.type == "start" and process.pe.original_file_name == "reg.exe" and process.args : ("save", "export") and process.args : ("hklm\\sam", "hklm\\security") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.002" name = "Security Account Manager" reference = [[rule.threat.technique.subtechnique]] id = "T1003.004" name = "LSA Secrets" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = "Identifies attempts to unload the Elastic Endpoint Security kernel extension via the kextunload command." query = " event.category:process and event.type:(start or process_started) and process.name:kextunload and process.args:("/System/Library/Extensions/EndpointSecurity.kext" or "EndpointSecurity.kext") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.006" name = "Kernel Modules and Extensions" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code." false_positives = ["Microsoft Windows installers leveraging RunDLL32 for installation."] query = " process where event.type == "start" and process.name : ("cmd.exe", "powershell.exe") and process.parent.name : "rundll32.exe" and process.parent.command_line != null and /* common FPs can be added here */ not process.parent.args : ("C:\\Windows\\System32\\SHELL32.dll,RunAsNewUser_RunDLL", "C:\\WINDOWS\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies execution of a suspicious program via scheduled tasks by looking at process lineage and command line usage." false_positives = ["Legitimate scheduled tasks running third party software."] query = " process where event.type == "start" and /* Schedule service cmdline on Win10+ */ process.parent.name : "svchost.exe" and process.parent.args : "Schedule" and /* add suspicious programs here */ process.pe.original_file_name in ( "cscript.exe", "wscript.exe", "PowerShell.EXE", "Cmd.Exe", "MSHTA.EXE", "RUNDLL32.EXE", "REGSVR32.EXE", "MSBuild.exe", "InstallUtil.exe", "RegAsm.exe", "RegSvcs.exe", "msxsl.exe", "CONTROL.EXE", "EXPLORER.EXE", "Microsoft.Workflow.Compiler.exe", "msiexec.exe" ) and /* add suspicious paths here */ process.args : ( "C:\\Users\\*", "C:\\ProgramData\\*", "C:\\Windows\\Temp\\*", "C:\\Windows\\Tasks\\*", "C:\\PerfLogs\\*", "C:\\Intel\\*", "C:\\Windows\\Debug\\*", "C:\\HP\\*") and not (process.name : "cmd.exe" and process.args : "?:\\*.bat" and process.working_directory : "?:\\Windows\\System32\\") and not (process.name : "cscript.exe" and process.args : "?:\\Windows\\system32\\calluxxprovider.vbs") and not (process.name : "powershell.exe" and process.args : ("-File", "-PSConsoleFile") and user.id : "S-1-5-18") and not (process.name : "msiexec.exe" and user.id : "S-1-5-18") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies powershell.exe being used to download an executable file from an untrusted remote destination." query = " sequence by host.id, process.entity_id with maxspan=30s [network where process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and network.protocol == "dns" and not dns.question.name : ("localhost", "*.microsoft.com", "*.azureedge.net", "*.powershellgallery.com", "*.windowsupdate.com", "metadata.google.internal") and not user.domain : "NT AUTHORITY"] [file where process.name : "powershell.exe" and event.type == "creation" and file.extension : ("exe", "dll", "ps1", "bat") and not file.name : "__PSScriptPolicy*.ps1"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement." query = " /* Task Scheduler service incoming connection followed by TaskCache registry modification */ sequence by host.id, process.entity_id with maxspan = 1m [network where process.name : "svchost.exe" and network.direction : ("incoming", "ingress") and source.port >= 49152 and destination.port >= 49152 and source.ip != "127.0.0.1" and source.ip != "::1" ] [registry where registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies suspicious .NET code execution. connections." query = " process where event.type == "start" and process.name : ("csc.exe", "vbc.exe") and process.parent.name : ("wscript.exe", "mshta.exe", "cscript.exe", "wmic.exe", "svchost.exe", "rundll32.exe", "cmstp.exe", "regsvr32.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1027" name = "Obfuscated Files or Information" reference = [[rule.threat.technique.subtechnique]] id = "T1027.004" name = "Compile After Delivery" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access." false_positives = [ Network monitoring or management products may have a web server component that runs shell commands as part of normal behavior., ] query = " event.category:process and event.type:(start or process_started) and process.name:(bash or dash or ash or zsh or "python*" or "perl*" or "php*") and process.parent.name:("apache" or "nginx" or "www" or "apache2" or "httpd" or "www-data") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1505" name = "Server Software Component" reference = [[rule.threat.technique.subtechnique]] id = "T1505.003" name = "Web Shell" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access." false_positives = [ Security audits, maintenance, and network administrative scripts may trigger this alert when run under web processes., ] query = " process where event.type == "start" and process.parent.name : ("w3wp.exe", "httpd.exe", "nginx.exe", "php.exe", "php-cgi.exe", "tomcat.exe") and process.name : ("cmd.exe", "cscript.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe", "wmic.exe", "wscript.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1505" name = "Server Software Component" reference = [[rule.threat.technique.subtechnique]] id = "T1505.003" name = "Web Shell" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = "Identifies that a user has deleted an unusually large volume of files as reported by Microsoft Cloud App Security." false_positives = ["Users or System Administrator cleaning out folders."] query = " event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:"Unusual volume of file deletion" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = "Identifies that an Amazon Relational Database Service (RDS) cluster or instance has been stopped." false_positives = [ Valid clusters or instances may be stopped by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster or instance stoppages from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(StopDBCluster or StopDBInstance) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1489" name = "Service Stop" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = "Identifies the addition of a user to a specified group in AWS Identity and Access Management (IAM)." false_positives = [ Adding users to a specified group may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. User additions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:AddUserToGroup and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies the creation of an Amazon Relational Database Service (RDS) Aurora database instance." false_positives = [ A database instance may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Instances creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:CreateDBInstance and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies the creation of an Amazon Relational Database Service (RDS) Security group." false_positives = [ An RDS security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:CreateDBSecurityGroup and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [[rule.threat.technique.subtechnique]] id = "T1136.003" name = "Cloud Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies the creation of an AWS log trail that specifies the settings for delivery of log data." false_positives = [ Trail creations may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:CreateTrail and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1530" name = "Data from Cloud Storage" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = "Identifies the deletion of a specified AWS Web Application Firewall (WAF) access control list." false_positives = [ Firewall ACL's may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Web ACL deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.action:DeleteWebACL and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies the deletion of a specified AWS Web Application Firewall (WAF) rule or rule group." false_positives = [ WAF rules or rule groups may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Rule deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:(waf.amazonaws.com or waf-regional.amazonaws.com or wafv2.amazonaws.com) and event.action:(DeleteRule or DeleteRuleGroup) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies the deletion of an Amazon Relational Database Service (RDS) Security group." false_positives = [ An RDS security group deletion may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:DeleteDBSecurityGroup and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = "Identifies the deletion of an AWS CloudWatch alarm. An adversary may delete alarms in an attempt to evade defenses." false_positives = [ Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Alarm deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:monitoring.amazonaws.com and event.action:DeleteAlarms and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies the deletion of an AWS log trail. An adversary may delete trails in an attempt to evade defenses." false_positives = [ Trail deletions may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:DeleteTrail and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies the deletion of various Amazon Simple Storage Service (S3) bucket configuration components." false_positives = [ Bucket components may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Bucket component deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:s3.amazonaws.com and event.action:(DeleteBucketPolicy or DeleteBucketReplication or DeleteBucketCors or DeleteBucketEncryption or DeleteBucketLifecycle) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies the execution of a shell process with suspicious arguments which may be indicative of reverse shell activity." query = " process where event.type in ("start", "process_started") and process.name in ("sh", "bash", "zsh", "dash", "zmodload") and process.args : ("*/dev/tcp/*", "*/dev/udp/*", "*zsh/net/tcp*", "*zsh/net/udp*") and /* noisy FPs */ not (process.parent.name : "timeout" and process.executable : "/var/lib/docker/overlay*") and not process.command_line : ("*/dev/tcp/sirh_db/*", "*/dev/tcp/remoteiot.com/*", "*dev/tcp/elk.stag.one/*", "*dev/tcp/kafka/*", "*/dev/tcp/$0/$1*", "*/dev/tcp/127.*", "*/dev/udp/127.*", "*/dev/tcp/localhost/*") and not process.parent.command_line : "runc init" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies the execution of and EggShell Backdoor. EggShell is a known post exploitation tool for macOS and Linux." query = " event.category:process and event.type:(start or process_started) and process.name:espl and process.args:eyJkZWJ1ZyI6* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.006" name = "Python" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = "Identifies the export of an Amazon Relational Database Service (RDS) Aurora database snapshot." false_positives = [ Exporting snapshots may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Snapshot exports from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:StartExportTask and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = "Identifies the password log file from the default Mimikatz memssp module." query = " file where file.name : "mimilsa.log" and process.name : "lsass.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = "Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file." query = " process where event.type == "start" and (process.name : "MpCmdRun.exe" or process.pe.original_file_name == "MpCmdRun.exe") and process.args : "-DownloadFile" and process.args : "-url" and process.args : "-path" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = "Identifies unauthorized access attempts to Okta applications." index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Unauthorized Access to an Okta Application" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 21 rule_id = "4edd3e1a-3aa0-499b-8147-4d2ea43b1613" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:app.generic.unauth_app_access_attempt " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = "Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings." false_positives = ["Planned Windows Defender configuration changes."] query = " process where event.type == "start" and (process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or process.pe.original_file_name in ("powershell.exe", "pwsh.dll", "powershell_ise.exe")) and process.args : "Set-MpPreference" and process.args : ("-Disable*", "Disabled", "NeverSend", "-Exclusion*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies when a request has been made to transfer a Route 53 domain to another AWS account." false_positives = [ A domain may be transferred to another AWS account by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Domain transfers from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:TransferDomainToAnotherAwsAccount and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = "Identifies when a Route53 private hosted zone has been associated with VPC." false_positives = [ A private hosted zone may be asssociated with a VPC by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:AssociateVPCWithHostedZone and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies when an AWS Route Table has been created." false_positives = [ Route Tables may be created by a system or network administrators. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Route Table creation by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule. Automated processes that use Terraform may lead to false positives., ] query = " event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:(CreateRoute or CreateRouteTable) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies when an AWS Route Table has been modified or deleted." false_positives = [ Route Table could be modified or deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Route Table being modified from unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule. Also automated processes that use Terraform may lead to false positives., ] query = " event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:(ReplaceRoute or ReplaceRouteTableAssociation or DeleteRouteTable or DeleteRoute or DisassociateRouteTable) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = "Identifies when an ElastiCache security group has been created." false_positives = [ A ElastiCache security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:elasticache.amazonaws.com and event.action:"Create Cache Security Group" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies when an ElastiCache security group has been modified or deleted." false_positives = [ A ElastiCache security group deletion may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security Group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:elasticache.amazonaws.com and event.action:("Delete Cache Security Group" or "Authorize Cache Security Group Ingress" or "Revoke Cache Security Group Ingress" or "AuthorizeCacheSecurityGroupEgress" or "RevokeCacheSecurityGroupEgress") and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = "Identifies when Microsoft Cloud App Security reports that a single user performs more than 50 downloads within 1 minute." false_positives = ["Unknown"] query = " event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:"Mass download by a single user" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = "Identifies when SAML activity has occurred in AWS. An adversary could manipulate SAML to maintain access to the target." false_positives = [ SAML Provider could be updated by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. SAML Provider updates by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:(iam.amazonaws.com or sts.amazonaws.com) and event.action:(Assumerolewithsaml or UpdateSAMLProvider) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1550" name = "Use Alternate Authentication Material" reference = [[rule.threat.technique.subtechnique]] id = "T1550.001" name = "Application Access Token" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = "This rule identifies a high number (10) of process terminations via pkill from the same host within a short time period." query = " event.category:process and event.type:start and process.name:"pkill" and process.args:"-f" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1489" name = "Service Stop" reference = [rule.threat.tactic] id = "TA0040" name = "Impact" reference = [rule.threshold] field = ["host.id"] value = 10
<li><a href="#">description = A job can be used to schedule programs or scripts to be executed at a specified date and time. Adversaries may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. false_positives = ["Legitimate scheduled jobs may be created during installation of new software."] query = " file where event.type != "deletion" and file.path : "?:\\Windows\\Tasks\\*" and file.extension : "job" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = A netcat process is engaging in network activity on a Linux host. Netcat is often used as a persistence mechanism by exporting a reverse shell or by serving a shell on a listening port. Netcat is also sometimes used for data exfiltration. false_positives = [ Netcat is a dual-use tool that can be used for benign or malicious activity. Netcat is included in some Linux distributions so its presence is not necessarily suspicious. Some normal use of this program, while uncommon, may originate from scripts, automation tools, and frameworks., ] query = " sequence by process.entity_id [process where process.name:("nc","ncat","netcat","netcat.openbsd","netcat.traditional") and ( /* bind shell to echo for command execution */ (process.args:("-l","-p") and process.args:("-c","echo","$*")) /* bind shell to specific port */ or process.args:("-l","-p","-lp") /* reverse shell to command-line interpreter used for command execution */ or (process.args:("-e") and process.args:("/bin/bash","/bin/sh")) /* file transfer via stdout */ or process.args:(">","<") /* file transfer via pipe */ or (process.args:("|") and process.args:("nc","ncat")) )] [network where (process.name == "nc" or process.name == "ncat" or process.name == "netcat" or process.name == "netcat.openbsd" or process.name == "netcat.traditional")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.004" name = "Unix Shell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = A POST request to a web application returned a 403 response, which indicates the web application declined to process the request because the action requested was not allowed. false_positives = [ Security scans and tests may result in these errors. Misconfigured or buggy applications may produce large numbers of these errors. If the source is unexpected, the user unauthorized, or the request unusual, these may indicate suspicious or malicious activity., ] index = ["apm-*-transaction*", "traces-apm*"] language = "kuery" license = "Elastic License v2" name = "Web Application Suspicious Activity: POST Request Declined" references = [] risk_score = 47 rule_id = "a87a4e42-1d82-44bd-b0bf-d9b7f91fb89e" severity = "medium" tags = ["Elastic", "APM"] timestamp_override = "event.ingested" type = "query = " http.response.status_code:403 and http.request.method:post "
<li><a href="#">description = A request to a web application returned a 405 response, which indicates the web application declined to process the request because the HTTP method is not allowed for the resource. false_positives = [ Security scans and tests may result in these errors. Misconfigured or buggy applications may produce large numbers of these errors. If the source is unexpected, the user unauthorized, or the request unusual, these may indicate suspicious or malicious activity., ] index = ["apm-*-transaction*", "traces-apm*"] language = "kuery" license = "Elastic License v2" name = "Web Application Suspicious Activity: Unauthorized Method" references = [] risk_score = 47 rule_id = "75ee75d8-c180-481c-ba88-ee50129a6aef" severity = "medium" tags = ["Elastic", "APM"] timestamp_override = "event.ingested" type = "query = " http.response.status_code:405 "
<li><a href="#">description = A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by an adversary to establish persistence. false_positives = ["Legitimate scheduled tasks may be created during installation of new software."] query = " sequence by host.id with maxspan = 30s [any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : "taskschd.dll" or file.name : "taskschd.dll") and process.name : ("cscript.exe", "wscript.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe")] [registry where registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC) certificates. An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign a malicious executable, making it appear the file was from a trusted, legitimate source. index = ["winlogbeat-*", "logs-windows.*"] language = "kuery" license = "Elastic License v2" name = "Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall)" risk_score = 21 rule_id = "56557cde-d923-4b88-adee-c61b3f3b5dc3" severity = "low" tags = ["Elastic", "Host", "Windows", "Threat Detection", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.provider:"Microsoft-Windows-Audit-CVE" and message:"[CVE-2020-0601]" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1553" name = "Subvert Trust Controls" reference = [[rule.threat.technique.subtechnique]] id = "T1553.002" name = "Code Signing" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = A sudoers file specifies the commands that users or groups can run and from which terminals. Adversaries can take advantage of these configurations to execute commands as other users or spawn processes with higher privileges. query = " event.category:file and event.type:change and file.path:(/etc/sudoers* or /private/etc/sudoers*) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.003" name = "Sudo and Sudo Caching" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = A sudoers file specifies the commands users or groups can run and from which terminals. Adversaries can take advantage of these configurations to execute commands as other users or spawn processes with higher privileges. query = " event.category:process and event.type:start and process.args:(echo and *NOPASSWD*ALL*) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.003" name = "Sudo and Sudo Caching" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = A suspicious Endpoint Security parent process was detected. This may indicate a process hollowing or other form of code injection. query = " process where event.type == "start" and process.name : ("esensor.exe", "elastic-endpoint.exe") and process.parent.executable != null and /* add FPs here */ not process.parent.executable : ("C:\\Program Files\\Elastic\\*", "C:\\Windows\\System32\\services.exe", "C:\\Windows\\System32\\WerFault*.exe", "C:\\Windows\\System32\\wermgr.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit registry key manipulation. Verify process details such as command line, network connections and file writes. false_positives = ["Custom Windows error reporting debugger or applications restarted by WerFault after a crash."] query = " process where event.type == "start" and process.parent.name : "WerFault.exe" and /* args -s and -t used to execute a process via SilentProcessExit mechanism */ (process.parent.args : "-s" and process.parent.args : "-t" and process.parent.args : "-c") and not process.executable : ("?:\\Windows\\SysWOW64\\Initcrypt.exe", "?:\\Program Files (x86)\\Heimdal\\Heimdal.Guard.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details such as command line, network connections, file writes and associated file signature details as well. query = " process where event.type == "start" and process.parent.name : "Zoom.exe" and process.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = A user has initiated a session impersonation granting them access to the environment with the permissions of the user they are impersonating. This would likely indicate Okta administrative access and should only ever occur if requested and expected. query = " event.dataset:okta.system and event.action:user.session.impersonation.initiate " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Adversaries can use the autostart mechanism provided by the Local Security Authority (LSA) authentication packages for privilege escalation or persistence by placing a reference to a binary in the Windows registry. The binary will then be executed by SYSTEM when the authentication packages are loaded. query = " registry where event.type == "change" and registry.path : "HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Authentication Packages" and /* exclude SYSTEM SID - look for changes by non-SYSTEM user */ not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.002" name = "Authentication Package" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.002" name = "Authentication Package" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Adversaries may attempt to clear or disable the Bash command-line history in an attempt to evade detection or forensic investigations. query = " process where event.type in ("start", "process_started") and ( ((process.args : ("rm", "echo") or (process.args : "ln" and process.args : "-sf" and process.args : "/dev/null") or (process.args : "truncate" and process.args : "-s0")) and process.args : (".bash_history", "/root/.bash_history", "/home/*/.bash_history","/Users/.bash_history", "/Users/*/.bash_history", ".zsh_history", "/root/.zsh_history", "/home/*/.zsh_history", "/Users/.zsh_history", "/Users/*/.zsh_history")) or (process.name : "history" and process.args : "-c") or (process.args : "export" and process.args : ("HISTFILE=/dev/null", "HISTFILESIZE=0")) or (process.args : "unset" and process.args : "HISTFILE") or (process.args : "set" and process.args : "history" and process.args : "+o") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.003" name = "Clear Command History" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Adversaries may attempt to disable the syslog service in an attempt to an attempt to disrupt event logging and evade detection by security controls. query = " event.category:process and event.type:(start or process_started) and ((process.name:service and process.args:stop) or (process.name:chkconfig and process.args:off) or (process.name:systemctl and process.args:(disable or stop or kill))) and process.args:(syslog or rsyslog or "syslog-ng") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Adversaries may collect keychain storage data from a system to in order to acquire credentials. Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos. false_positives = ["Applications for password management."] query = " process where event.type == "start" and process.name : "security" and process.args : "-wa" and process.args : ("find-generic-password", "find-internet-password") and process.args : ("Chrome*", "Chromium", "Opera", "Safari*", "Brave", "Microsoft Edge", "Edge", "Firefox*") and not process.parent.executable : "/Applications/Keeper Password Manager.app/Contents/Frameworks/Keeper Password Manager Helper*/Contents/MacOS/Keeper Password Manager Helper*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.001" name = "Keychain" reference = [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.003" name = "Credentials from Web Browsers" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Adversaries may collect the keychain storage data from a system to acquire credentials. Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features such as WiFi passwords, websites, secure notes and certificates. query = " process where event.type in ("start", "process_started") and process.args : ( "/Users/*/Library/Keychains/*", "/Library/Keychains/*", "/Network/Library/Keychains/*", "System.keychain", "login.keychain-db", "login.keychain" ) and not process.args : ("find-certificate", "add-trusted-cert", "set-keychain-settings", "delete-certificate", "/Users/*/Library/Keychains/openvpn.keychain-db", "show-keychain-info", "lock-keychain", "set-key-partition-list", "import", "find-identity") and not process.parent.executable : ( "/Applications/OpenVPN Connect/OpenVPN Connect.app/Contents/MacOS/OpenVPN Connect", "/Applications/Microsoft Defender.app/Contents/MacOS/wdavdaemon_enterprise.app/Contents/MacOS/wdavdaemon_enterprise", "/opt/jc/bin/jumpcloud-agent" ) and not process.executable : "/opt/jc/bin/jumpcloud-agent" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.001" name = "Keychain" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Adversaries may create or modify the Sublime application plugins or scripts to execute a malicious payload each time the Sublime application is started. query = " file where event.type in ("change", "creation") and file.extension : "py" and file.path : ( "/Users/*/Library/Application Support/Sublime Text*/Packages/*.py", "/Applications/Sublime Text.app/Contents/MacOS/sublime.py" ) and not process.executable : ( "/Applications/Sublime Text*.app/Contents/*", "/usr/local/Cellar/git/*/bin/git", "/Library/Developer/CommandLineTools/usr/bin/git", "/usr/libexec/xpcproxy", "/System/Library/PrivateFrameworks/DesktopServicesPriv.framework/Versions/A/Resources/DesktopServicesHelper" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1554" name = "Compromise Client Software Binary" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Adversaries may dump the content of the keychain storage data from a system to acquire credentials. Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos. query = " process where event.type in ("start", "process_started") and process.args : "dump-keychain" and process.args : "-d" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.001" name = "Keychain" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Adversaries may implement command and control (C2) communications that use common web services to hide their activity. This attack technique is typically targeted at an organization and uses web services common to the victim network, which allows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since they have most likely been used before compromise, which helps malicious traffic blend in. query = " network where network.protocol == "dns" and process.name != null and user.id not in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and /* Add new WebSvc domains here */ dns.question.name : ( "raw.githubusercontent.*", "*.pastebin.*", "*drive.google.*", "*docs.live.*", "*api.dropboxapi.*", "*dropboxusercontent.*", "*onedrive.*", "*4shared.*", "*.file.io", "*filebin.net", "*slack-files.com", "*ghostbin.*", "*ngrok.*", "*portmap.*", "*serveo.net", "*localtunnel.me", "*pagekite.me", "*localxpose.io", "*notabug.org", "rawcdn.githack.*", "paste.nrecom.net", "zerobin.net", "controlc.com", "requestbin.net", "cdn.discordapp.com", "discordapp.com", "discord.com", "script.google.com", "script.googleusercontent.com" ) and /* Insert noisy false positives here */ not process.executable : ( "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Windows\\System32\\WWAHost.exe", "?:\\Windows\\System32\\smartscreen.exe", "?:\\Windows\\System32\\MicrosoftEdgeCP.exe", "?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe", "?:\\Users\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrome.exe", "?:\\Users\\*\\AppData\\Local\\Programs\\Fiddler\\Fiddler.exe", "?:\\Users\\*\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe", "?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe", "?:\\Windows\\system32\\mobsync.exe", "?:\\Windows\\SysWOW64\\mobsync.exe", "?:\\Users\\*\\AppData\\Local\\Discord\\app-*\\Discord.exe" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1102" name = "Web Service" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1567" name = "Exfiltration Over Web Service" reference = [[rule.threat.technique.subtechnique]] id = "T1567.001" name = "Exfiltration to Code Repository" reference = [[rule.threat.technique.subtechnique]] id = "T1567.002" name = "Exfiltration to Cloud Storage" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to their command and control servers. Root certificates are used in public key cryptography to identify a root certificate authority (CA). When a root certificate is installed, the system or application will trust certificates in the root's chain of trust that have been signed by the root certificate. false_positives = ["Certain applications may install root certificates for the purpose of inspecting SSL traffic."] query = " event.category:process and event.type:(start or process_started) and process.name:security and process.args:"add-trusted-cert" and not process.parent.executable:("/Library/Bitdefender/AVP/product/bin/BDCoreIssues" or "/Applications/Bitdefender/SecurityNetworkInstallerApp.app/Contents/MacOS/SecurityNetworkInstallerApp" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1553" name = "Subvert Trust Controls" reference = [[rule.threat.technique.subtechnique]] id = "T1553.004" name = "Install Root Certificate" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Adversaries may modify SSH related binaries for persistence or credential access by patching sensitive functions to enable unauthorized access or by logging SSH credentials for exfiltration. false_positives = [ "Trusted OpenSSH executable updates. It's recommended to verify the integrity of OpenSSH binary changes.", ] query = " event.category:file and event.type:change and process.name:* and (file.path:(/usr/sbin/sshd or /usr/bin/ssh or /usr/bin/sftp or /usr/bin/scp) or file.name:libkeyutils.so) and not process.name:("dpkg" or "yum" or "dnf" or "dnf-automatic") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Adversaries may modify the standard authentication module for persistence via patching the normal authorization process or modifying the login configuration to allow unauthorized access or elevate privileges. false_positives = [ "Trusted system module updates or allowed Pluggable Authentication Module (PAM) daemon configuration changes.", ] query = " event.category:file and event.type:change and (file.name:pam_*.so or file.path:(/etc/pam.d/* or /private/etc/pam.d/*)) and process.executable: (* and not ( /bin/yum or "/usr/sbin/pam-auth-update" or /usr/libexec/packagekitd or /usr/bin/dpkg or /usr/bin/vim or /usr/libexec/xpcproxy or /usr/bin/bsdtar or /usr/local/bin/brew or /usr/bin/rsync or /usr/bin/yum or /var/lib/docker/*/bin/yum or /var/lib/docker/*/bin/dpkg or ./merged/var/lib/docker/*/bin/dpkg or "/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service" ) ) and not file.path: ( /tmp/snap.rootfs_*/pam_*.so or /tmp/newroot/lib/*/pam_*.so or /private/var/folders/*/T/com.apple.fileprovider.ArchiveService/TemporaryItems/*/lib/security/pam_*.so or /tmp/newroot/usr/lib64/security/pam_*.so ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = An adversary can establish persistence by installing a new launch agent that executes at login by using launchd or launchctl to load a plist into the appropriate directories. false_positives = ["Trusted applications persisting via LaunchAgent"] query = " sequence by host.id with maxspan=1m [file where event.type != "deletion" and file.path : ("/System/Library/LaunchAgents/*", "/Library/LaunchAgents/*", "/Users/*/Library/LaunchAgents/*") ] [process where event.type in ("start", "process_started") and process.name == "launchctl" and process.args == "load"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.001" name = "Launch Agent" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = An adversary can establish persistence by modifying an existing macOS dock property list in order to execute a malicious application instead of the intended one when invoked. query = " event.category : file and event.action : modification and file.path : /Users/*/Library/Preferences/com.apple.dock.plist and not process.name : (xpcproxy or cfprefsd or plutil or jamf or PlistBuddy or InstallerRemotePluginService) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = An adversary can use the Background Intelligent Transfer Service (BITS) SetNotifyCmdLine method to execute a program that runs after a job finishes transferring data or after a job enters a specified state in order to persist on a system. query = " process where event.type == "start" and process.parent.name : "svchost.exe" and process.parent.args : "BITS" and not process.executable : ("?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\System32\\wermgr.exe", "?:\\WINDOWS\\system32\\directxdatabaseupdater.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1197" name = "BITS Jobs" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to an event and execute arbitrary code when that event occurs, providing persistence on a system. query = " process where event.type == "start" and (process.name : "wmic.exe" or process.pe.original_file_name == "wmic.exe") and process.args : "create" and process.args : ("ActiveScriptEventConsumer", "CommandLineEventConsumer") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.003" name = "Windows Management Instrumentation Event Subscription" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = An adversary may add the setuid or setgid bit to a file or directory in order to run a file with the privileges of the owning user or group. An adversary can take advantage of this to either do a shell escape or exploit a vulnerability in an application with the setuid or setgid bit to get code running in a different users context. Additionally, adversaries can use this mechanism on their own malware to make sure they're able to execute in elevated contexts in the future. query = " event.category:process AND event.type:(start OR process_started) AND process.name:chmod AND process.args:("+s" OR "u+s" OR /4[0-9]{3}/ OR g+s OR /2[0-9]{3}/) AND NOT process.args: ( /.*\/Applications\/VirtualBox.app\/.+/ OR /\/usr\/local\/lib\/python.+/ OR /\/var\/folders\/.+\/FP.*nstallHelper/ OR /\/Library\/Filesystems\/.+/ OR /\/usr\/lib\/virtualbox\/.+/ OR /\/Library\/Application.*/ OR "/run/postgresql" OR "/var/crash" OR "/var/run/postgresql" OR /\/usr\/bin\/.+/ OR /\/usr\/local\/share\/.+/ OR /\/Applications\/.+/ OR /\/usr\/libexec\/.+/ OR "/var/metrics" OR /\/var\/lib\/dpkg\/.+/ OR /\/run\/log\/journal\/.*/ OR \/Users\/*\/.minikube\/bin\/docker-machine-driver-hyperkit ) AND NOT process.parent.executable: ( /\/var\/lib\/docker\/.+/ OR "/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service" OR "/var/lib/dpkg/info/whoopsie.postinst" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.001" name = "Setuid and Setgid" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = An adversary may attempt to access the secrets in secrets manager to steal certificates, credentials, or other sensitive material false_positives = [ Verify whether the user identity, user agent, and/or hostname should be using GetSecretString API for the specified SecretId. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:secretsmanager.amazonaws.com and event.action:GetSecretValue " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1528" name = "Steal Application Access Token" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies common locations used to discover virtual machine hardware by a non-root user. This technique has been used by the Pupy RAT and other malware. false_positives = [ Certain tools or automated software may enumerate hardware information. These tools can be exempted via user name or process arguments to eliminate potential noise., ] query = " event.category:process and event.type:(start or process_started) and process.args:("/sys/class/dmi/id/bios_version" or "/sys/class/dmi/id/product_name" or "/sys/class/dmi/id/chassis_vendor" or "/proc/scsi/scsi" or "/proc/ide/hd0/model") and not user.name:root " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1082" name = "System Information Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies common locations used to discover virtual machine hardware by a non-root user. This technique has been used by the Pupy RAT and other malware. false_positives = [ Certain tools or automated software may enumerate hardware information. These tools can be exempted via user name or process arguments to eliminate potential noise., ] query = " process where event.type == "start" and process.name in ("grep", "egrep") and user.id != "0" and process.args : ("parallels*", "vmware*", "virtualbox*") and process.args : "Manufacturer*" and not process.parent.executable in ("/Applications/Docker.app/Contents/MacOS/Docker", "/usr/libexec/kcare/virt-what") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1082" name = "System Information Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = An attempt was made to modify AWS EC2 snapshot attributes. Snapshots are sometimes shared by threat actors in order to exfiltrate bulk data from an EC2 fleet. If the permissions were modified, verify the snapshot was not shared with an unauthorized or unexpected AWS account. false_positives = [ IAM users may occasionally share EC2 snapshots with another AWS account belonging to the same organization. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:ModifySnapshotAttribute " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1537" name = "Transfer Data to Cloud Account" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, created a thread in another process. This technique is sometimes used to evade detection or elevate privileges. false_positives = ["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."] index = ["winlogbeat-*", "logs-windows.*"] language = "kuery" license = "Elastic License v2" name = "Process Injection by the Microsoft Build Engine" risk_score = 21 rule_id = "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae9" severity = "low" tags = ["Elastic", "Host", "Windows", "Threat Detection", "Defense Evasion", "Sysmon Only"] timestamp_override = "event.ingested" type = "query = " process.name:MSBuild.exe and event.action:"CreateRemoteThread detected (rule: CreateRemoteThread)" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows credential management. This technique is sometimes used for credential dumping. false_positives = ["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."] query = " sequence by process.entity_id [process where event.type == "start" and (process.name : "MSBuild.exe" or process.pe.original_file_name == "MSBuild.exe")] [any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : ("vaultcli.dll", "SAMLib.DLL") or file.name : ("vaultcli.dll", "SAMLib.DLL"))] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, started a PowerShell script or the Visual C# Command Line Compiler. This technique is sometimes used to deploy a malicious payload using the Build Engine. false_positives = [ The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. If a build system triggers this rule it can be exempted by process, user or host name., ] query = " process where event.type == "start" and process.parent.name : "MSBuild.exe" and process.name : ("csc.exe", "iexplore.exe", "powershell.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1027" name = "Obfuscated Files or Information" reference = [[rule.threat.technique.subtechnique]] id = "T1027.004" name = "Compile After Delivery" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and may indicate an attempt to run unnoticed or undetected. false_positives = ["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."] query = " process where event.type == "start" and process.pe.original_file_name == "MSBuild.exe" and not process.name : "MSBuild.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.003" name = "Rename System Utilities" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, was started by a script or the Windows command interpreter. This behavior is unusual and is sometimes used by malicious payloads. false_positives = ["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."] query = " process where event.type == "start" and (process.name : "MSBuild.exe" or process.pe.original_file_name == "MSBuild.exe") and process.parent.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe", "cscript.exe", "wscript.exe", "mshta.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1127.001" name = "MSBuild" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the Build Engine and could have been caused by an Excel or Word document executing a malicious script payload. false_positives = [ The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. It is quite unusual for this program to be started by an Office application like Word or Excel., ] query = " process where event.type == "start" and process.name : "MSBuild.exe" and process.parent.name : ("eqnedt32.exe", "excel.exe", "fltldr.exe", "msaccess.exe", "mspub.exe", "outlook.exe", "powerpnt.exe", "winword.exe" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1127.001" name = "MSBuild" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management Instrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads. false_positives = ["The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."] query = " process where event.type == "start" and process.name : "MSBuild.exe" and process.parent.name : ("explorer.exe", "wmiprvse.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1127.001" name = "MSBuild" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Assigning the administrative role to a user will grant them access to the Google Admin console and grant them administrator privileges which allow them to access and manage various resources and applications. An adversary may create a new administrator account for persistence or apply the admin role to an existing user to carry out further intrusion efforts. Users with super-admin privileges can bypass single-sign on if enabled in Google Workspace. false_positives = [ Google Workspace admin role assignments may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:"google_workspace.admin" and event.category:"iam" and event.action:"ASSIGN_ROLE" and google_workspace.event.type:"DELEGATED_ADMIN_SETTINGS" and google_workspace.admin.role.name : *_ADMIN_ROLE " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.003" name = "Additional Cloud Roles" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Attackers may maintain persistence by creating registry keys using AppInit DLLs. AppInit DLLs are loaded by every process using the common library, user32.dll. query = " registry where registry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls", "HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls") and not process.executable : ("C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe", "C:\\Program Files\\Commvault\\ContentStore*\\Base\\cvd.exe", "C:\\Program Files (x86)\\Commvault\\ContentStore*\\Base\\cvd.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.010" name = "AppInit DLLs" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Authorization plugins are used to extend the authorization services API and implement mechanisms that are not natively supported by the OS, such as multi-factor authentication with third party software. Adversaries may abuse this feature to persist and/or collect clear text credentials as they traverse the registered plugins during user logon. query = " event.category:file and not event.type:deletion and file.path:(/Library/Security/SecurityAgentPlugins/* and not /Library/Security/SecurityAgentPlugins/TeamViewerAuthPlugin.bundle/*) and not process.name:shove and process.code_signature.trusted:true " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.002" name = "Authentication Package" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Azure Active Directory (AD) Privileged Identity Management (PIM) is a service that enables you to manage, control, and monitor access to important resources in an organization. PIM can be used to manage the built-in Azure resource roles such as Global Administrator and Application Administrator. An adversary may add a user to a PIM role in order to maintain persistence in their target's environment or modify a PIM role to weaken their target's security controls. query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Update role setting in PIM" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signature validation. Adversaries may use these binaries to 'live off the land' and execute malicious files that could bypass application allowlists and signature validation. query = " sequence by process.entity_id [process where (process.name : "expand.exe" or process.name : "extrac32.exe" or process.name : "ieexec.exe" or process.name : "makecab.exe") and event.type == "start"] [network where (process.name : "expand.exe" or process.name : "extrac32.exe" or process.name : "ieexec.exe" or process.name : "makecab.exe") and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Both ~/.bash_profile and ~/.bashrc are files containing shell commands that are run when Bash is invoked. These files are executed in a user's context, either interactively or non-interactively, when a user logs in so that their environment is set correctly. Adversaries may abuse this to establish persistence by executing malicious content triggered by a users shell. false_positives = ["Changes to the Shell Profile tend to be noisy, a tuning per your environment will be required."] query = " event.category:file and event.type:change and process.name:(* and not (sudo or vim or zsh or env or nano or bash or Terminal or xpcproxy or login or cat or cp or launchctl or java)) and not process.executable:(/Applications/* or /private/var/folders/* or /usr/local/*) and file.path:(/private/etc/rc.local or /etc/rc.local or /home/*/.profile or /home/*/.profile1 or /home/*/.bash_profile or /home/*/.bash_profile1 or /home/*/.bashrc or /Users/*/.bash_profile or /Users/*/.zshenv) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.004" name = "Unix Shell Configuration Modification" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Cobalt Strike is a threat emulation platform commonly modified and used by adversaries to conduct network attack and exploitation campaigns. This rule detects a network activity algorithm leveraged by Cobalt Strike implant beacons for command and control. false_positives = [ This rule should be tailored to either exclude systems, as sources or destinations, in which this behavior is expected., ] query = " event.category:(network OR network_traffic) AND type:(tls OR http) AND network.transport:tcp AND destination.domain:/[a-z]{3}.stage.[0-9]{8}\..*/ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique]] id = "T1568" name = "Dynamic Resolution" reference = [[rule.threat.technique.subtechnique]] id = "T1568.002" name = "Domain Generation Algorithms" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe). query = " sequence by process.entity_id [process where process.name : "hh.exe" and event.type == "start"] [network where process.name : "hh.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1204.002" name = "Malicious File" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.001" name = "Compiled HTML File" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe). false_positives = [ The HTML Help executable program (hh.exe) runs whenever a user clicks a compiled help (.chm) file or menu item that opens the help file inside the Help Viewer. This is not always malicious, but adversaries may abuse this technology to conceal malicious code., ] query = " process where event.type == "start" and process.parent.name : "hh.exe" and process.name : ("mshta.exe", "cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe", "cscript.exe", "wscript.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1204.002" name = "Malicious File" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.001" name = "Compiled HTML File" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects a file being made immutable using the chattr binary. Making a file immutable means it cannot be deleted or renamed, no link can be created to this file, most of the file's metadata can not be modified, and the file can not be opened in write mode. Threat actors will commonly utilize this to prevent tampering or modification of their malicious files or any system files they have modified for purposes of persistence (e.g .ssh, /etc/passwd, etc.). query = " process where event.type == "start" and user.name == "root" and process.executable : "/usr/bin/chattr" and process.args : ("-*i*", "+*i*") and not process.parent.executable: "/lib/systemd/systemd" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1222" name = "File and Directory Permissions Modification" reference = [[rule.threat.technique.subtechnique]] id = "T1222.002" name = "Linux and Mac File and Directory Permissions Modification" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects a Roshal Archive (RAR) file or PowerShell script downloaded from the internet by an internal host. Gaining initial access to a system and then downloading encoded or encrypted tools to move laterally is a common practice for adversaries as a way to protect their more valuable tools and tactics, techniques, and procedures (TTPs). This may be atypical behavior for a managed network and can be indicative of malware, exfiltration, or command and control. false_positives = [ Downloading RAR or PowerShell files from the Internet may be expected for certain systems. This rule should be tailored to either exclude systems as sources or destinations in which this behavior is expected., ] query = " event.category:(network or network_traffic) and network.protocol:http and (url.extension:(ps1 or rar) or url.path:(*.ps1 or *.rar)) and not destination.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) and source.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Detects attempts to bypass Okta multi-factor authentication (MFA). An adversary may attempt to bypass the Okta MFA policies configured for an organization in order to obtain unauthorized access to an application. index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempted Bypass of Okta MFA" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 73 rule_id = "3805c3dc-f82c-4f8d-891e-63c24d3102b0" severity = "high" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:user.mfa.attempt_bypass " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1111" name = "Multi-Factor Authentication Interception" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Detects attempts to create an Okta API token. An adversary may create an Okta API token to maintain access to an organization's network while they work to achieve their objectives. An attacker may abuse an API token to execute techniques such as creating user accounts or disabling security rules or policies. false_positives = [ If the behavior of creating Okta API tokens is expected, consider adding exceptions to this rule to filter false positives., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Create Okta API Token" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "96b9f4ea-0e8c-435b-8d53-2096e75fcac5" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:system.api_token.create " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects attempts to deactivate a rule within an Okta policy. An adversary may attempt to deactivate a rule within an Okta policy in order to remove or weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly deactivated in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Deactivate an Okta Policy Rule" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "cc92c835-da92-45c9-9f29-b4992ad621a0" severity = "medium" tags = [ "Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access", "Defense Evasion", ] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:policy.rule.deactivate " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to deactivate an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations. false_positives = [ Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deactivated and the behavior is expected., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Deactivate an Okta Application" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 21 rule_id = "edb91186-1c7e-4db8-b53e-bfa33a1a0a8a" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Impact"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:application.lifecycle.deactivate " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1489" name = "Service Stop" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects attempts to deactivate an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if your organization's Okta network zones are regularly modified., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Deactivate an Okta Network Zone" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "8a5c1e5f-ad63-481e-b53a-ef959230f7f1" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Network Security", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:zone.deactivate " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to deactivate an Okta policy. An adversary may attempt to deactivate an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to deactivate an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts. false_positives = [ If the behavior of deactivating Okta policies is expected, consider adding exceptions to this rule to filter false positives., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Deactivate an Okta Policy" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 21 rule_id = "b719a170-3bdb-4141-b0e3-13e3cf627bfe" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:policy.lifecycle.deactivate " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to deactivate multi-factor authentication (MFA) for an Okta user. An adversary may deactivate MFA for an Okta user account in order to weaken the authentication requirements for the account. false_positives = [ If the behavior of deactivating MFA for Okta user accounts is expected, consider adding exceptions to this rule to filter false positives., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Deactivate MFA for an Okta User Account" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 21 rule_id = "cd89602e-9db0-48e3-9391-ae3bf241acd8" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:user.mfa.factor.deactivate " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects attempts to delete a rule within an Okta policy. An adversary may attempt to delete an Okta policy rule in order to weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Delete an Okta Policy Rule" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 21 rule_id = "d5d86bf5-cf0c-4c06-b688-53fdc072fdfd" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:policy.rule.delete " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to delete an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations. false_positives = [ Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deleted and the behavior is expected., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Delete an Okta Application" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 21 rule_id = "d48e1c13-4aca-4d1f-a7b1-a9161c0ad86f" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Impact"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:application.lifecycle.delete " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1489" name = "Service Stop" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects attempts to delete an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly deleted., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Delete an Okta Network Zone" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "c749e367-a069-4a73-b1f2-43a3798153ad" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Network Security", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:zone.delete " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to delete an Okta policy. An adversary may attempt to delete an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to delete an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts. false_positives = [ Consider adding exceptions to this rule to filter false positives if Okta policies are regularly deleted in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Delete an Okta Policy" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "b4bb1440-0fcb-4ed1-87e5-b06d58efc5e9" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:policy.lifecycle.delete " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to disable Gatekeeper on macOS. Gatekeeper is a security feature that's designed to ensure that only trusted software is run. Adversaries may attempt to disable Gatekeeper before executing malicious code. query = " event.category:process and event.type:(start or process_started) and process.args:(spctl and "--master-disable") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1553" name = "Subvert Trust Controls" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service. Exploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running as SYSTEM. query = " sequence by host.id with maxspan=30s [registry where registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\Printers\\*\\SpoolDirectory" and registry.data.strings : "C:\\Windows\\System32\\spool\\drivers\\x64\\4"] [registry where registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\Printers\\*\\CopyFiles\\Payload\\Module" and registry.data.strings : "C:\\Windows\\System32\\spool\\drivers\\x64\\4\\*"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects attempts to exploit privilege escalation vulnerabilities related to the Adobe Acrobat Reader PrivilegedHelperTool responsible for installing updates. For more information, refer to CVE-2020-9615, CVE-2020-9614 and CVE-2020-9613 and verify that the impacted system is patched. false_positives = ["Trusted system or Adobe Acrobat Related processes."] query = " event.category:process and event.type:(start or process_started) and process.parent.name:com.adobe.ARMDC.SMJobBlessHelper and user.name:root and not process.executable: (/Library/PrivilegedHelperTools/com.adobe.ARMDC.SMJobBlessHelper or /usr/bin/codesign or /private/var/folders/zz/*/T/download/ARMDCHammer or /usr/sbin/pkgutil or /usr/bin/shasum or /usr/bin/perl* or /usr/sbin/spctl or /usr/sbin/installer or /usr/bin/csrutil) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service including CVE-2020-1048 and CVE-2020-1337. query = " file where event.type != "deletion" and file.extension : "spl" and file.path : "?:\\Windows\\System32\\spool\\PRINTERS\\*" and not process.name : ("spoolsv.exe", "printfilterpipelinesvc.exe", "PrintIsolationHost.exe", "splwow64.exe", "msiexec.exe", "poqexec.exe") and not user.id : "S-1-5-18" and not process.executable : ("?:\\Windows\\System32\\mmc.exe", "\\Device\\Mup\\*.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\mmc.exe", "?:\\Windows\\System32\\printui.exe", "?:\\Windows\\System32\\mstsc.exe", "?:\\Windows\\System32\\spool\\*.exe", "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\PROGRA~1\\*.exe", "?:\\PROGRA~2\\*.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service. For more information refer to the following CVE's - CVE-2020-1048, CVE-2020-1337 and CVE-2020-1300 and verify that the impacted system is patched. query = " file where event.type == "creation" and process.name : "spoolsv.exe" and file.extension : "dll" and file.path : ("?:\\Windows\\System32\\*", "?:\\Windows\\SysWOW64\\*") and not file.path : ("?:\\WINDOWS\\SysWOW64\\PrintConfig.dll", "?:\\WINDOWS\\system32\\x5lrs.dll", "?:\\WINDOWS\\sysWOW64\\x5lrs.dll", "?:\\WINDOWS\\system32\\PrintConfig.dll") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects attempts to maintain persistence by creating registry keys using AppCert DLLs. AppCert DLLs are loaded by every process using the common API functions to create processes. query = " registry where /* uncomment once stable length(bytes_written_string) > 0 and */ registry.path : "HKLM\\SYSTEM\\*ControlSet*\\Control\\Session Manager\\AppCertDLLs\\*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.009" name = "AppCert DLLs" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects attempts to modify a rule within an Okta policy. An adversary may attempt to modify an Okta policy rule in order to weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Modify an Okta Policy Rule" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 21 rule_id = "000047bb-b27a-47ec-8b62-ef1a5d2c9e19" severity = "low" tags = [ "Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access", "Defense Evasion", ] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:policy.rule.update " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to modify an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations. false_positives = [ Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly modified and the behavior is expected., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Modify an Okta Application" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 21 rule_id = "c74fd275-ab2c-4d49-8890-e2943fa65c09" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Impact"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:application.lifecycle.update " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects attempts to modify an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly modified., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Modify an Okta Network Zone" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "e48236ca-b67a-4b4e-840c-fdc7782bc0c3" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Network Security", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:(zone.update or network_zone.rule.disabled or zone.remove_blacklist) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to modify an Okta policy. An adversary may attempt to modify an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to modify an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts. false_positives = [ Consider adding exceptions to this rule to filter false positives if Okta policies are regularly modified in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Modify an Okta Policy" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 21 rule_id = "6731fbf2-8f28-49ed-9ab9-9a918ceb5a45" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:policy.lifecycle.update " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects attempts to modify or delete a sign on policy for an Okta application. An adversary may attempt to modify or delete the sign on policy for an Okta application in order to remove or weaken an organization's security controls. false_positives = [ Consider adding exceptions to this rule to filter false positives if sign on policies for Okta applications are regularly modified or deleted in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Modification or Removal of an Okta Application Sign-On Policy" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "cd16fb10-0261-46e8-9932-a0336278cdbe" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access", "Persistence"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:(application.policy.sign_on.update or application.policy.sign_on.rule.delete) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects attempts to reset an Okta user's enrolled multi-factor authentication (MFA) factors. An adversary may attempt to reset the MFA factors for an Okta user's account in order to register new MFA factors and abuse the account to blend in with normal activity in the victim's environment. false_positives = [ Consider adding exceptions to this rule to filter false positives if the MFA factors for Okta user accounts are regularly reset in your organization., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Reset MFA Factors for an Okta User Account" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 21 rule_id = "729aa18d-06a6-41c7-b175-b65b739b1181" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:user.mfa.factor.reset_all " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could be an indication of an adversary's attempt to persist in a stealthy manner. query = " registry where /* uncomment once stable length(registry.data.strings) > 0 and */ registry.path : ( "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Runonce\\*", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Load", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Run", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\IconServiceLib", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\AppSetup", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Taskman", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\VmApplet", "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell", "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script", "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script", "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script", "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script", "HKLM\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\*\\ShellComponent", "HKLM\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect\\MicrosoftActiveSync", "HKLM\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect\\MicrosoftActiveSync", "HKLM\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath", "HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec", "HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script", "HKLM\\SOFTWARE\\Microsoft\\Command Processor\\Autorun", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Command Processor\\Autorun", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*\\VerifierDlls", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\GpExtensions\\*\\DllName", "HKLM\\SYSTEM\\ControlSet*\\Control\\SafeBoot\\AlternateShell", "HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal Server\\Wds\\rdpwd\\StartupPrograms", "HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram", "HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\BootExecute", "HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\SetupExecute", "HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\Execute", "HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\S0InitialCommand", "HKLM\\SYSTEM\\ControlSet*\\Control\\ServiceControlManagerExtension", "HKLM\\SYSTEM\\ControlSet*\\Control\\BootVerificationProgram\\ImagePath", "HKLM\\SYSTEM\\Setup\\CmdLine", "HKEY_USERS\\*\\Environment\\UserInitMprLogonScript") and not registry.data.strings : ("C:\\Windows\\system32\\userinit.exe", "cmd.exe", "C:\\Program Files (x86)\\*.exe", "C:\\Program Files\\*.exe") and not (process.name : "rundll32.exe" and registry.path : "*\\Software\\Microsoft\\Internet Explorer\\Extensions\\*\\Script") and not process.executable : ("C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe", "C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe", "C:\\Program Files\\*.exe", "C:\\Program Files (x86)\\*.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1112" name = "Modify Registry" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects deletion of print driver files by an unusual process. This may indicate a clean up attempt post successful privilege escalation via Print Spooler service related vulnerabilities. false_positives = [ Uninstall or manual deletion of a legitimate printing driver files. Verify the printer file metadata such as manufacturer and signature information., ] query = " file where event.type : "deletion" and not process.name : ("spoolsv.exe", "dllhost.exe", "explorer.exe") and file.path : "?:\\Windows\\System32\\spool\\drivers\\x64\\3\\*.dll" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects execution via the Apple script interpreter (osascript) followed by a network connection from the same process within a short time period. Adversaries may use malicious scripts for execution and command and control. query = " sequence by host.id, process.entity_id with maxspan=30s [process where event.type == "start" and process.name == "osascript"] [network where event.type != "end" and process.name == "osascript" and destination.ip != "::1" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.002" name = "AppleScript" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Detects file name patterns generated by the use of Sysinternals SDelete utility to securely delete a file via multiple file overwrite and rename operations. query = " file where event.type == "change" and file.name : "*AAA.AAA" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.004" name = "File Deletion" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects modification of a Folder Action script. A Folder Action script is executed when the folder to which it is attached has items added or removed, or when its window is opened, closed, moved, or resized. Adversaries may abuse this feature to establish persistence by utilizing a malicious script. query = " sequence by host.id with maxspan=5s [process where event.type in ("start", "process_started", "info") and process.name == "com.apple.foundation.UserScriptService"] by process.pid [process where event.type in ("start", "process_started") and process.name in ("osascript", "python", "tcl", "node", "perl", "ruby", "php", "bash", "csh", "zsh", "sh") and not process.args : "/Users/*/Library/Application Support/iTerm2/Scripts/AutoLaunch/*.scpt" ] by process.parent.pid " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1037" name = "Boot or Logon Initialization Scripts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent backdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their Administrative Privileges. query = " event.action:"Directory Service Changes" and event.code:5136 and winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System* " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects possible Denial of Service (DoS) attacks against an Okta organization. An adversary may attempt to disrupt an organization's business operations by performing a DoS attack against its Okta service. index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Possible Okta DoS Attack" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "e6e3ecff-03dd-48ec-acbd-54a04de10c68" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:(application.integration.rate_limit_exceeded or system.org.rate_limit.warning or system.org.rate_limit.violation or core.concurrency.org.limit.violation) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1498" name = "Network Denial of Service" reference = [[rule.threat.technique]] id = "T1499" name = "Endpoint Denial of Service" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects PowerShell scripts that can take screenshots, which is a common feature in post-exploitation kits and remote access tools (RATs). query = " event.category:process and powershell.file.script_block_text : ( CopyFromScreen and ("System.Drawing.Bitmap" or "Drawing.Bitmap") ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1113" name = "Screen Capture" reference = [rule.threat.tactic] id = "TA0009" name = "Collection" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step in Kerberoasting toolkits to crack service accounts. query = " event.category:process and powershell.file.script_block_text : ( KerberosRequestorSecurityToken ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [[rule.threat.technique.subtechnique]] id = "T1558.003" name = "Kerberoasting" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects scripts that contain PowerShell functions, structures, or Windows API functions related to token impersonation/theft. Attackers may duplicate then impersonate another user's token to escalate privileges and bypass access controls. query = " event.category:process and powershell.file.script_block_text:( "Invoke-TokenManipulation" or "ImpersonateNamedPipeClient" or "NtImpersonateThread" or ( "STARTUPINFOEX" and "UpdateProcThreadAttribute" ) or ( "AdjustTokenPrivileges" and "SeDebugPrivilege" ) or ( ("DuplicateToken" or "DuplicateTokenEx") and ("SetThreadToken" or "ImpersonateLoggedOnUser" or "CreateProcessWithTokenW" or "CreatePRocessAsUserW" or "CreateProcessAsUserA") ) ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1134.001" name = "Token Impersonation/Theft" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [[rule.threat.technique]] id = "T1106" name = "Native API" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects scripts that contain PowerShell functions, structures, or Windows API functions related to windows share enumeration activities. Attackers, mainly ransomware groups, commonly identify and inspect network shares, looking for critical information for encryption and/or exfiltration. query = " event.category:process and powershell.file.script_block_text:( "Invoke-ShareFinder" or "Invoke-ShareFinderThreaded" or ( "shi1_netname" and "shi1_remark" ) or ( "NetShareEnum" and "NetApiBufferFree" ) ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1135" name = "Network Share Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [[rule.threat.technique]] id = "T1106" name = "Native API" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects the copying of the Linux dynamic loader binary and subsequent file creation for the purpose of creating a backup copy. This technique was seen recently being utilized by Linux malware prior to patching the dynamic loader in order to inject and preload a malicious shared object file. This activity should never occur and if it does then it should be considered highly suspicious or malicious. query = " sequence by process.entity_id with maxspan=1m [process where event.type == "start" and process.name : ("cp", "rsync") and process.args : ("/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2", "/etc/ld.so.preload")] [file where event.action == "creation" and file.extension == "so"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.006" name = "Dynamic Linker Hijacking" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects the creation and modification of an account with the "Don't Expire Password" option Enabled. Attackers can abuse this misconfiguration to persist in the domain and maintain long-term access using compromised accounts with this property. false_positives = [ User accounts can be used as service accounts and have their password set never to expire. This is a bad security practice that exposes the account to Credential Access attacks. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically., ] query = " event.action:"modified-user-account" and event.code:"4738" and message:"'Don't Expire Password' - Enabled" and not user.id:"S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects the creation or modification of a new Group Policy based scheduled task or service. These methods are used for legitimate system administration, but can also be abused by an attacker with domain admin permissions to execute a malicious payload remotely on all or a subset of the domain joined machines. query = " file where event.type != "deletion" and file.path : ("?:\\Windows\\SYSVOL\\domain\\Policies\\*\\MACHINE\\Preferences\\ScheduledTasks\\ScheduledTasks.xml", "?:\\Windows\\SYSVOL\\domain\\Policies\\*\\MACHINE\\Preferences\\Services\\Services.xml") and not process.name : "dfsrs.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects the execution of a MacOS installer package with an abnormal child process (e.g bash) followed immediately by a network connection via a suspicious process (e.g curl). Threat actors will build and distribute malicious MacOS installer packages, which have a .pkg extension, many times imitating valid software in order to persuade and infect their victims often using the package files (e.g pre/post install scripts etc.) to download additional tools or malicious software. If this rule fires it should indicate the installation of a malicious or suspicious package. false_positives = [ Custom organization-specific macOS packages that use .pkg files to run cURL could trigger this rule. If known behavior is causing false positives, it can be excluded from the rule., ] query = " sequence by host.id, user.id with maxspan=30s [process where event.type == "start" and event.action == "exec" and process.parent.name : ("installer", "package_script_service") and process.name : ("bash", "sh", "zsh", "python", "osascript", "tclsh*")] [network where event.type == "start" and process.name : ("curl", "osascript", "wget", "python")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.007" name = "JavaScript" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique.subtechnique]] id = "T1071.001" name = "Web Protocols" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or use them to add users as local admins. index = ["winlogbeat-*", "logs-system.*", "logs-windows.*"] language = "kuery" license = "Elastic License v2" name = "Group Policy Abuse for Privilege Addition" note =## Triage and analysis ### Investigating Group Policy Abuse for Privilege Addition Group Policy Objects (GPOs) can be used to add rights and/or modify Group Membership on GPOs by changing the contents of an INF file named GptTmpl.inf, which is responsible for storing every setting under the Security Settings container in the GPO. This file is unique for each GPO, and only exists if the GPO contains security settings. Example Path: "\\\\DC.com\\SysVol\\DC.com\\Policies\\{PolicyGUID}\\Machine\\Microsoft\\Windows NT\\SecEdit\\GptTmpl.inf" #### Possible investigation steps - This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation. - Retrieve the contents of the `GptTmpl.inf` file, and under the `Privilege Rights` section, look for potentially dangerous high privileges, for example: SeTakeOwnershipPrivilege, SeEnableDelegationPrivilege, etc. - Inspect the user security identifiers (SIDs) associated with these privileges, and if they should have these privileges. ### False positive analysis - Inspect whether the user that has done the modifications should be allowed to. The user name can be found in the `winlog.event_data.SubjectUserName` field. ### Related rules - Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e - Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046 ### Response and remediation - Initiate the incident response process based on the outcome of the triage. - The investigation and containment must be performed in every computer controlled by the GPO, where necessary. - Remove the script from the GPO. - Check if other GPOs have suspicious scripts attached. ## Setup The 'Audit Directory Service Changes' audit policy must be configured (Success Failure). Steps to implement the logging policy with with Advanced Audit Configuration: ``` Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policies Configuration > Audit Policies > DS Access > Audit Directory Service Changes (Success,Failure) ``` references = [ , , ] risk_score = 73 rule_id = "b9554892-5e0e-424b-83a0-5aef95aa43bf" severity = "high" tags = [ "Elastic", "Host", "Windows", "Threat Detection", "Privilege Escalation", "Active Directory", "Investigation Guide", ] timestamp_override = "event.ingested" type = "query = " event.code: "5136" and winlog.event_data.AttributeLDAPDisplayName:"gPCMachineExtensionNames" and winlog.event_data.AttributeValue:(*827D319E-6EAC-11D2-A4EA-00C04F79F83A* and *803E14A0-B4FB-11D0-A0D0-00A0C90F574B*) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1484" name = "Domain Policy Modification" reference = [[rule.threat.technique.subtechnique]] id = "T1484.001" name = "Group Policy Modification" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects the manual creation of files in specific etc directories, via user root, used by Linux malware to persist and elevate privileges on compromised systems. File creation in these directories should not be entirely common and could indicate a malicious binary or script installing persistence for long term access. query = " file where event.action == "creation" and user.name == "root" and file.path : ("/etc/ld.so.conf.d/*", "/etc/cron.d/*", "/etc/sudoers.d/*", "/etc/rc.d/init.d/*", "/etc/systemd/system/*") and not process.executable : ("*/dpkg", "*/yum", "*/apt", "*/dnf", "*/systemd", "*/snapd", "*/dnf-automatic", "*/yum-cron", "*/elastic-agent", "*/dnfdaemon-system") " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat.technique]] id = "T1037" name = "Boot or Logon Initialization Scripts" reference = [[rule.threat.technique.subtechnique]] id = "T1037.004" name = "RC Scripts" reference = [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.006" name = "Dynamic Linker Hijacking" reference = [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.002" name = "Systemd Service" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.003" name = "Cron" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.003" name = "Sudo and Sudo Caching"
<li><a href="#">description = Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by the GPO. index = ["winlogbeat-*", "logs-system.*", "logs-windows.*"] language = "kuery" license = "Elastic License v2" name = "Scheduled Task Execution at Scale via GPO" note =## Triage and analysis ### Investigating Scheduled Task Execution at Scale via GPO Group Policy Objects (GPOs) can be used by attackers to execute scheduled tasks at scale to compromise objects controlled by a given GPO. This is done by changing the contents of the `<GPOPath>\\Machine\\Preferences\\ScheduledTasks\\ScheduledTasks.xml` file. #### Possible investigation steps - This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation. - Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries. - Investigate other alerts associated with the user/host during the past 48 hours. - Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO. ### False positive analysis - Verify if the execution is allowed and done under change management, and if the execution is legitimate. ### Related rules - Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf - Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046 ### Response and remediation - Initiate the incident response process based on the outcome of the triage. - The investigation and containment must be performed in every computer controlled by the GPO, where necessary. - Remove the script from the GPO. - Check if other GPOs have suspicious scheduled tasks attached. - Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector. - Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR). ## Setup The 'Audit Detailed File Share' audit policy must be configured (Success Failure). Steps to implement the logging policy with with Advanced Audit Configuration: ``` Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policies Configuration > Audit Policies > Object Access > Audit Detailed File Share (Success,Failure) ``` The 'Audit Directory Service Changes' audit policy must be configured (Success Failure). Steps to implement the logging policy with with Advanced Audit Configuration: ``` Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policies Configuration > Audit Policies > DS Access > Audit Directory Service Changes (Success,Failure) ``` references = [ , , , , , ] risk_score = 47 rule_id = "15a8ba77-1c13-4274-88fe-6bd14133861e" severity = "medium" tags = [ "Elastic", "Host", "Windows", "Threat Detection", "Privilege Escalation", "Active Directory", "Investigation Guide", ] timestamp_override = "event.ingested" type = "query = " (event.code: "5136" and winlog.event_data.AttributeLDAPDisplayName:("gPCMachineExtensionNames" or "gPCUserExtensionNames") and winlog.event_data.AttributeValue:(*CAB54552-DEEA-4691-817E-ED4A4D1AFC72* and *AADCED64-746C-4633-A97C-D61349046527*)) or (event.code: "5145" and winlog.event_data.ShareName: "\\\\*\\SYSVOL" and winlog.event_data.RelativeTargetName: *ScheduledTasks.xml and (message: WriteData or winlog.event_data.AccessList: *%%4417*)) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [[rule.threat.technique]] id = "T1484" name = "Domain Policy Modification" reference = [[rule.threat.technique.subtechnique]] id = "T1484.001" name = "Group Policy Modification" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects the occurrence of emails reported as Phishing or Malware by Users. Security Awareness training is essential to stay ahead of scammers and threat actors, as security products can be bypassed, and the user can still receive a malicious message. Educating users to report suspicious messages can help identify gaps in security controls and prevent malware infections and Business Email Compromise attacks. false_positives = ["Legitimate files reported by the users"] query = " event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.action:AlertTriggered and rule.name:"Email reported by user as malware or phish" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Detects the occurrence of mailbox audit bypass associations. The mailbox audit is responsible for logging specified mailbox events (like accessing a folder or a message or permanently deleting a message). However, actions taken by some authorized accounts, such as accounts used by third-party tools or accounts used for lawful monitoring, can create a large number of mailbox audit log entries and may not be of interest to your organization. Because of this, administrators can create bypass associations, allowing certain accounts to perform their tasks without being logged. Attackers can abuse this allowlist mechanism to conceal actions taken, as the mailbox audit will log no activity done by the account. false_positives = ["Legitimate allowlisting of noisy accounts"] query = " event.dataset:o365.audit and event.provider:Exchange and event.action:Set-MailboxAuditBypassAssociation and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackers embed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk. query = " event.category:process and powershell.file.script_block_text : ( TVqQAAMAAAAEAAAA ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an integrity level of system. query = " process where event.type == "start" and process.parent.name : "CompatTelRunner.exe" and process.args : "-cv*" and not process.name : ("conhost.exe", "DeviceCensus.exe", "CompatTelRunner.exe", "DismHost.exe", "rundll32.exe", "powershell.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects the use of PSReflect in PowerShell scripts. Attackers leverage PSReflect as a library that enables PowerShell to access win32 API functions. false_positives = ["Legitimate PowerShell scripts that make use of PSReflect to access the win32 API"] query = " event.category:process and powershell.file.script_block_text:( "New-InMemoryModule" or "Add-Win32Type" or psenum or DefineDynamicAssembly or DefineDynamicModule or "Reflection.TypeAttributes" or "Reflection.Emit.OpCodes" or "Reflection.Emit.CustomAttributeBuilder" or "Runtime.InteropServices.DllImportAttribute" ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [[rule.threat.technique]] id = "T1106" name = "Native API" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this method to load executables and DLLs without writing to the disk, bypassing security solutions. query = " event.category:process and powershell.file.script_block_text : ( "[System.Reflection.Assembly]::Load" or "[Reflection.Assembly]::Load" ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [[rule.threat.technique.subtechnique]] id = "T1055.001" name = "Dynamic-link Library Injection" reference = [[rule.threat.technique.subtechnique]] id = "T1055.002" name = "Portable Executable Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize this technique to maintain persistence on a system. When a new service is added, chkconfig ensures that the service has either a start or a kill entry in every runlevel and when the system is rebooted the service file added will run providing long-term persistence. query = " process where event.type == "start" and (process.executable : "/usr/sbin/chkconfig" and process.args : "--add") or (process.args : "*chkconfig" and process.args : "--add") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1037" name = "Boot or Logon Initialization Scripts" reference = [[rule.threat.technique.subtechnique]] id = "T1037.004" name = "RC Scripts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects the use of the insmod binary to load a Linux kernel object file. Threat actors can use this binary, given they have root privileges, to load a rootkit on a system providing them with complete control and the ability to hide from security products. Manually loading a kernel module in this manner should not be at all common and can indicate suspcious or malicious behavior. query = " process where event.type == "start" and process.executable : "/usr/sbin/insmod" and process.args : "*.ko" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.006" name = "Kernel Modules and Extensions" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers use this technique to capture user input, looking for credentials and/or other valuable data. query = " event.category:process and ( powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or "Get-Keystrokes") or powershell.file.script_block_text : ( (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and (GetForegroundWindow or GetWindowTextA or GetWindowTextW or "WM_KEYBOARD_LL") ) ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1056" name = "Input Capture" reference = [[rule.threat.technique.subtechnique]] id = "T1056.001" name = "Keylogging" reference = [rule.threat.tactic] id = "TA0009" name = "Collection" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects the use of Windows API functions that are commonly abused by malware and security tools to load malicious code or inject it into remote processes. false_positives = ["Legitimate PowerShell scripts that make use of these functions."] query = " event.category:process and powershell.file.script_block_text : ( (VirtualAlloc or VirtualAllocEx or VirtualProtect or LdrLoadDll or LoadLibrary or LoadLibraryA or LoadLibraryEx or GetProcAddress or OpenProcess or OpenProcessToken or AdjustTokenPrivileges) and (WriteProcessMemory or CreateRemoteThread or NtCreateThreadEx or CreateThread or QueueUserAPC or SuspendThread or ResumeThread or GetDelegateForFunctionPointer) ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [[rule.threat.technique.subtechnique]] id = "T1055.001" name = "Dynamic-link Library Injection" reference = [[rule.threat.technique.subtechnique]] id = "T1055.002" name = "Portable Executable Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege escalation vulnerabilities related to the Printing Service on Windows. false_positives = [ Install or update of a legitimate printing driver. Verify the printer driver file metadata such as manufacturer and signature information., ] query = " process where event.type == "start" and process.parent.name : "spoolsv.exe" and (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and /* exclusions for FP control below */ not process.name : ("splwow64.exe", "PDFCreator.exe", "acrodist.exe", "spoolsv.exe", "msiexec.exe", "route.exe", "WerFault.exe") and not process.command_line : "*\\WINDOWS\\system32\\spool\\DRIVERS*" and not (process.name : "net.exe" and process.command_line : ("*stop*", "*start*")) and not (process.name : ("cmd.exe", "powershell.exe") and process.command_line : ("*.spl*", "*\\program files*", "*route add*")) and not (process.name : "netsh.exe" and process.command_line : ("*add portopening*", "*rule name*")) and not (process.name : "regsvr32.exe" and process.command_line : "*PrintConfig.dll*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Detects when a custom admin role is created in Google Workspace. An adversary may create a custom admin role in order to elevate the permissions of other user accounts and persist in their targets environment. false_positives = [ Custom Google Workspace admin roles may be created by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:CREATE_ROLE " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when a custom admin role is deleted. An adversary may delete a custom admin role in order to impact the permissions or capabilities of system administrators. false_positives = [ Google Workspace admin roles may be deleted by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:DELETE_ROLE " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects when a custom admin role or its permissions are modified. An adversary may modify a custom admin role in order to elevate the permissions of other user accounts and persist in their targets environment. false_positives = [ Google Workspace admin roles may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(ADD_PRIVILEGE or UPDATE_ROLE) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when a custom Gmail route is added or modified in Google Workspace. Adversaries can add a custom e-mail route for outbound mail to route these e-mails to their own inbox of choice for data gathering. This allows adversaries to capture sensitive information from e-mail and potential attachments, such as invoices or payment documents. By default, all email from current Google Workspace users with accounts are routed through a domain's mail server for inbound and outbound mail. false_positives = [ Administrators may create custom email routes in Google Workspace based on organizational policies, administrative preference or for security purposes regarding spam., ] query = " event.dataset:"google_workspace.admin" and event.action:("CREATE_GMAIL_SETTING" or "CHANGE_GMAIL_SETTING") and google_workspace.event.type:"EMAIL_SETTINGS" and google_workspace.admin.setting.name:("EMAIL_ROUTE" or "MESSAGE_SECURITY_RULE") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1114" name = "Email Collection" reference = [[rule.threat.technique.subtechnique]] id = "T1114.003" name = "Email Forwarding Rule" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Detects when a domain is added to the list of trusted Google Workspace domains. An adversary may add a trusted domain in order to collect and exfiltrate data from their targets organization with less restrictive security controls. false_positives = [ Trusted domains may be added by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ADD_TRUSTED_DOMAINS " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects when a domain-wide delegation of authority is granted to a service account. Domain-wide delegation can be configured to grant third-party and internal applications to access the data of Google Workspace users. An adversary may configure domain-wide delegation to maintain access to their targets data. false_positives = [ Domain-wide delegation of authority may be granted to service accounts by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:AUTHORIZE_API_CLIENT_ACCESS " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when a Google marketplace application is added to the Google Workspace domain. An adversary may add a malicious application to an organizations Google Workspace domain in order to maintain a presence in their targets organization and steal data. false_positives = [ Applications can be added to a Google Workspace domain by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ADD_APPLICATION " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when a Google Workspace password policy is modified. An adversary may attempt to modify a password policy in order to weaken an organizations security controls. false_positives = [ Password policies may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(CHANGE_APPLICATION_SETTING or CREATE_APPLICATION_SETTING) and google_workspace.admin.setting.name:( "Password Management - Enforce strong password" or "Password Management - Password reset frequency" or "Password Management - Enable password reuse" or "Password Management - Enforce password policy at next login" or "Password Management - Minimum password length" or "Password Management - Maximum password length" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when a user account has the servicePrincipalName attribute modified. Attackers can abuse write privileges over a user to configure Service Principle Names (SPNs) so that they can perform Kerberoasting. Administrators can also configure this for legitimate purposes, exposing the account to Kerberoasting. query = " event.action:"Directory Service Changes" and event.code:5136 and winlog.event_data.ObjectClass:"user" and winlog.event_data.AttributeLDAPDisplayName:"servicePrincipalName" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [[rule.threat.technique.subtechnique]] id = "T1558.003" name = "Kerberoasting" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Detects when a user grants permissions to an Azure-registered application or when an administrator grants tenant-wide permissions to an application. An adversary may create an Azure-registered application that requests access to data such as contact information, email, or documents. query = " event.dataset:(azure.activitylogs or azure.auditlogs or o365.audit) and ( azure.activitylogs.operation_name:"Consent to application" or azure.auditlogs.operation_name:"Consent to application" or o365.audit.Operation:"Consent to application." ) and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1528" name = "Steal Application Access Token" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Detects when a user reports suspicious activity for their Okta account. These events should be investigated, as they can help security teams identify when an adversary is attempting to gain access to their network. false_positives = ["A user may report suspicious activity on their Okta account in error."] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Suspicious Activity Reported by Okta User" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "f994964f-6fce-4d75-8e79-e16ccc412588" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:user.account.report_suspicious_activity_by_enduser " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects when an administrator role is assigned to an Okta group. An adversary may attempt to assign administrator privileges to an Okta group in order to assign additional permissions to compromised user accounts and maintain access to their target organization. false_positives = [ Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Administrator Privileges Assigned to an Okta Group" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "b8075894-0b62-46e5-977c-31275da34419" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:group.privilege.grant " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access. index = ["filebeat-*", "logs-okta*"] language = "eql" license = "Elastic License v2" name = "Potential Abuse of Repeated MFA Push Notifications" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 73 rule_id = "97a8e584-fd3b-421f-9b9d-9c9d9e57e9d7" severity = "high" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access"] type = "eql" query = " sequence by user.email with maxspan=10m [any where event.module == "okta" and event.action == "user.mfa.okta_verify.deny_push"] [any where event.module == "okta" and event.action == "user.mfa.okta_verify.deny_push"] [any where event.module == "okta" and event.action == "user.authentication.sso"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Detects when an EFS File System or Mount is deleted. An adversary could break any file system using the mount target that is being deleted, which might disrupt instances or applications using those mounts. The mount must be deleted prior to deleting the File System, or the adversary will be unable to delete the File System. false_positives = [ File System or Mount being deleted may be performed by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. File System Mount deletion by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:elasticfilesystem.amazonaws.com and event.action:(DeleteMountTarget or DeleteFileSystem) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects when multi-factor authentication (MFA) enforcement is disabled for Google Workspace users. An adversary may disable MFA enforcement in order to weaken an organizations security controls. false_positives = [ MFA policies may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ENFORCE_STRONG_AUTHENTICATION and google_workspace.admin.new_value:false " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Detects when multi-factor authentication (MFA) is disabled for a Google Workspace organization. An adversary may attempt to modify a password policy in order to weaken an organizations security controls. false_positives = [ MFA settings may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(ENFORCE_STRONG_AUTHENTICATION or ALLOW_STRONG_AUTHENTICATION) and google_workspace.admin.new_value:false " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects when Okta ThreatInsight identifies a request from a malicious IP address. Investigating requests from IP addresses identified as malicious by Okta ThreatInsight can help security teams monitor for and respond to credential based attacks against their organization, such as brute force and password spraying attacks. index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Threat Detected by Okta ThreatInsight" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "6885d2ae-e008-4762-b98a-e8e1cd3a81e9" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:security.threat.detected "
<li><a href="#">description = Detects when the Console Window Host (conhost.exe) process is spawned by a suspicious parent process, which could be indicative of code injection. query = " process where event.type == "start" and process.name : "conhost.exe" and process.parent.name : ("lsass.exe", "services.exe", "smss.exe", "winlogon.exe", "explorer.exe", "dllhost.exe", "rundll32.exe", "regsvr32.exe", "userinit.exe", "wininit.exe", "spoolsv.exe", "ctfmon.exe") and not (process.parent.name : "rundll32.exe" and process.parent.args : ("?:\\Windows\\Installer\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc", "?:\\WINDOWS\\system32\\PcaSvc.dll,PcaPatchSdbTask", "?:\\WINDOWS\\system32\\davclnt.dll,DavSetCookie")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Detects when the Google Marketplace restrictions are changed to allow any application for users in Google Workspace. Malicious APKs created by adversaries may be uploaded to the Google marketplace but not installed on devices managed within Google Workspace. Administrators should set restrictions to not allow any application from the marketplace for security reasons. Adversaries may enable any app to be installed and executed on mobile devices within a Google Workspace environment prior to distributing the malicious APK to the end user. false_positives = [ Applications can be added and removed from blocklists by Google Workspace administrators, but they can all be explicitly allowed for users. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:"google_workspace.admin" and event.action:"CHANGE_APPLICATION_SETTING" and event.category:(iam or configuration) and google_workspace.event.type:"APPLICATION_SETTINGS" and google_workspace.admin.application.name:"Google Workspace Marketplace" and google_workspace.admin.setting.name:"Apps Access Setting Allowlist access" and google_workspace.admin.new_value:"ALLOW_ALL" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects when the tc (transmission control) binary is utilized to set a BPF (Berkeley Packet Filter) on a network interface. Tc is used to configure Traffic Control in the Linux kernel. It can shape, schedule, police and drop traffic. A threat actor can utilize tc to set a bpf filter on an interface for the purpose of manipulating the incoming traffic. This technique is not at all common and should indicate abnormal, suspicious or malicious activity. query = " process where event.type != "end" and process.executable : "/usr/sbin/tc" and process.args : "filter" and process.args : "add" and process.args : "bpf" and not process.parent.executable: "/usr/sbin/libvirtd" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.004" name = "Unix Shell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Drive and Docs is a Google Workspace service that allows users to leverage Google Drive and Google Docs. Access to files is based on inherited permissions from the child organizational unit the user belongs to which is scoped by administrators. Typically if a user is removed, their files can be transferred to another user by the administrator. This service can also be abused by adversaries to transfer files to an adversary account for potential exfiltration. false_positives = [ Administrators may transfer file ownership during employee leave or absence to ensure continued operations by a new or existing employee., ] query = " event.dataset:"google_workspace.admin" and event.action:"CREATE_DATA_TRANSFER_REQUEST" and event.category:"iam" and google_workspace.admin.application.name:Drive* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1074" name = "Data Staged" reference = [[rule.threat.technique.subtechnique]] id = "T1074.002" name = "Remote Data Staging" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Elastic Endgame detected an Adversary Behavior. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and (event.action:behavior_protection_event or endgame.event_subtype_full:behavior_protection_event) "
<li><a href="#">description = Elastic Endgame detected an Exploit. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:exploit_event or endgame.event_subtype_full:exploit_event) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame detected Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Elastic Endgame detected Credential Manipulation. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:token_manipulation_event or endgame.event_subtype_full:token_manipulation_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame detected Malware. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:file_classification_event or endgame.event_subtype_full:file_classification_event) "
<li><a href="#">description = Elastic Endgame detected Permission Theft. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:token_protection_event or endgame.event_subtype_full:token_protection_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame detected Process Injection. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:kernel_shellcode_event or endgame.event_subtype_full:kernel_shellcode_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame detected ransomware. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event) "
<li><a href="#">description = Elastic Endgame prevented an Exploit. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:exploit_event or endgame.event_subtype_full:exploit_event) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame prevented Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Elastic Endgame prevented Credential Manipulation. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:token_manipulation_event or endgame.event_subtype_full:token_manipulation_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame prevented Malware. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:file_classification_event or endgame.event_subtype_full:file_classification_event) "
<li><a href="#">description = Elastic Endgame prevented Permission Theft. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:token_protection_event or endgame.event_subtype_full:token_protection_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame prevented Process Injection. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:kernel_shellcode_event or endgame.event_subtype_full:kernel_shellcode_event) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Elastic Endgame prevented ransomware. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information. query = " event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event) "
<li><a href="#">description = Finder Sync plugins enable users to extend Finders functionality by modifying the user interface. Adversaries may abuse this feature by adding a rogue Finder Plugin to repeatedly execute malicious payloads for persistence. false_positives = ["Trusted Finder Sync Plugins"] query = " process where event.type in ("start", "process_started") and process.name : "pluginkit" and process.args : "-e" and process.args : "use" and process.args : "-i" and not process.args : ( "com.google.GoogleDrive.FinderSyncAPIExtension", "com.google.drivefs.findersync", "com.boxcryptor.osx.Rednif", "com.adobe.accmac.ACCFinderSync", "com.microsoft.OneDrive.FinderSync", "com.insynchq.Insync.Insync-Finder-Integration", "com.box.desktop.findersyncext" ) and not process.parent.executable : ( "/Library/Application Support/IDriveforMac/IDriveHelperTools/FinderPluginApp.app/Contents/MacOS/FinderPluginApp" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Generates a detection alert each time an Elastic Endpoint Security alert is received. Enabling this rule allows you to immediately begin investigating your Endpoint alerts. enabled = true query = " event.kind:alert and event.module:(endpoint and not endgame) " [[rule.exceptions_list]] id = "endpoint_list" list_id = "endpoint_list" namespace_type = "agnostic" type = "endpoint" [[rule.risk_score_mapping]] field = "event.risk_score" operator = "equals" value = [[rule.severity_mapping]] field = "event.severity" operator = "equals" severity = "low" value = "21" [[rule.severity_mapping]] field = "event.severity" operator = "equals" severity = "medium" value = "47" [[rule.severity_mapping]] field = "event.severity" operator = "equals" severity = "high" value = "73" [[rule.severity_mapping]] field = "event.severity" operator = "equals" severity = "critical" value = "99"
<li><a href="#">description = Generates a detection alert for each external alert written to the configured indices. Enabling this rule allows you to immediately begin investigating external alerts in the app. index = ["apm-*-transaction*", "traces-apm*", "auditbeat-*", "filebeat-*", "logs-*", "packetbeat-*", "winlogbeat-*"] language = "kuery" license = "Elastic License v2" max_signals = 10000 name = "External Alerts" risk_score = 47 rule_id = "eb079c62-4481-4d6e-9643-3ca499df7aaa" rule_name_override = "message" severity = "medium" tags = ["Elastic", "Network", "Windows", "APM", "macOS", "Linux"] timestamp_override = "event.ingested" type = "query = " event.kind:alert and not event.module:(endgame or endpoint) " [[rule.risk_score_mapping]] field = "event.risk_score" operator = "equals" value = [[rule.severity_mapping]] field = "event.severity" operator = "equals" value = "21" severity = "low" [[rule.severity_mapping]] field = "event.severity" operator = "equals" value = "47" severity = "medium" [[rule.severity_mapping]] field = "event.severity" operator = "equals" value = "73" severity = "high" [[rule.severity_mapping]] field = "event.severity" operator = "equals" value = "99" severity = "critical"
<li><a href="#">description = Google Workspace administrators may be aware of malicious applications within the Google marketplace and block these applications for user security purposes. An adversary, with administrative privileges, may remove this application from the explicit block list to allow distribution of the application amongst users. This may also indicate the unauthorized use of an application that had been previously blocked before by a user with admin privileges. false_positives = [ Applications can be added and removed from blocklists by Google Workspace administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:"google_workspace.admin" and event.category:"iam" and event.type:"change" and event.action:"CHANGE_APPLICATION_SETTING" and google_workspace.admin.application.name:"Google Workspace Marketplace" and google_workspace.admin.old_value: *allowed*false* and google_workspace.admin.new_value: *allowed*true* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Google Workspace administrators whom manage Windows devices and have Windows device management enabled may also enable BitLocker drive encryption to mitigate unauthorized data access on lost or stolen computers. Adversaries with valid account access may disable BitLocker to access sensitive data on an endpoint added to Google Workspace device management. false_positives = [ Administrators may temporarily disabled Bitlocker on managed devices for maintenance, testing or to resolve potential endpoint conflicts., ] query = " event.dataset:"google_workspace.admin" and event.action:"CHANGE_APPLICATION_SETTING" and event.category:(iam or configuration) and google_workspace.admin.new_value:"Disabled" and google_workspace.admin.setting.name:BitLocker* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Google Workspace admins may setup 2-step verification (2SV) to add an extra layer of security to user accounts by asking users to verify their identity when they use login credentials. Admins have the ability to enforce 2SV from the admin console as well as the methods acceptable for verification and enrollment period. 2SV requires enablement on admin accounts prior to it being enabled for users within organization units. Adversaries may disable 2SV to lower the security requirements to access a valid account. false_positives = [ Administrators may remove 2-step verification (2SV) temporarily for testing or during maintenance. If 2SV was previously enabled, it is not common to disable this policy for extended periods of time., ] query = " event.dataset:"google_workspace.admin" and event.action:"2sv_disable" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Halfbaked is a malware family used to establish persistence in a contested network. This rule detects a network activity algorithm leveraged by Halfbaked implant beacons for command and control. false_positives = [ This rule should be tailored to exclude systems, either as sources or destinations, in which this behavior is expected., ] query = " event.category:(network OR network_traffic) AND network.protocol:http AND network.transport:tcp AND url.full:/http:\/\/[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}\/cd/ AND destination.port:(53 OR 80 OR 8080 OR 443) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique]] id = "T1568" name = "Dynamic Resolution" reference = [[rule.threat.technique.subtechnique]] id = "T1568.002" name = "Domain Generation Algorithms" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Hping ran on a Linux host. Hping is a FOSS command-line packet analyzer and has the ability to construct network packets for a wide variety of network security testing applications, including scanning and firewall auditing. false_positives = [ Normal use of hping is uncommon apart from security testing and research. Use by non-security engineers is very uncommon., ] query = " event.category:process and event.type:(start or process_started) and process.name:(hping or hping2 or hping3) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1082" name = "System Information Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies .lnk shortcut file downloaded from outside the local network. These shortcut files are commonly used in phishing campaigns. query = " /* leaving in development pending `file.Ext.windows.zone_identifier` landing in ECS then endpoint */ sequence by process.entity_id with maxspan=2s /* file.extension added to endpoint fields for 7.10 */ [file where event.type == "creation" and file.extension == "lnk"] /* not sure yet how the update will capture ADS */ [file where event.type == "creation" and file.extension == "lnk:Zone.Identifier" and /* non-ECS field - may disqualify conversion */ file.Ext.windows.zone_identifier > 1] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1204.002" name = "Malicious File" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies .url shortcut files downloaded from outside the local network. These shortcut files are commonly used in phishing campaigns. query = " /* leaving in development pending `file.Ext.windows.zone_identifier` landing in ECS then endpoint */ sequence by process.entity_id with maxspan=2s [file where event.type == "creation" and file.extension == "url" and not process.name == "explorer.exe"] [file where event.type == "creation" and file.extension == "url:Zone.Identifier" and /* non-ECS field - may disqualify conversion */ file.Ext.windows.zone_identifier > 1 and not process.name == "explorer.exe"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies a change to an AWS Security Group Configuration. A security group is like a virtual firewall, and modifying configurations may allow unauthorized access. Threat actors may abuse this to establish persistence, exfiltrate data, or pivot in an AWS environment. false_positives = [ A security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(AuthorizeSecurityGroupEgress or CreateSecurityGroup or ModifyInstanceAttribute or ModifySecurityGroupRules or RevokeSecurityGroupEgress or RevokeSecurityGroupIngress) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a copy operation of the Active Directory Domain Database (ntds.dit) or Security Account Manager (SAM) files. Those files contain sensitive information including hashed domain and/or local credentials. query = " process where event.type == "start" and ( (process.pe.original_file_name in ("Cmd.Exe", "PowerShell.EXE", "XCOPY.EXE") and process.args : ("copy", "xcopy", "Copy-Item", "move", "cp", "mv") ) or (process.pe.original_file_name : "esentutl.exe" and process.args : ("*/y*", "*/vss*", "*/d*")) ) and process.args : ("*\\ntds.dit", "*\\config\\SAM", "\\*\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy*\\*", "*/system32/config/SAM*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.002" name = "Security Account Manager" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies a high number (20) of macOS SSH KeyGen process executions from the same host. An adversary may attempt a brute force attack to obtain unauthorized access to user accounts. query = " event.category:process and event.type:start and process.name:"sshd-keygen-wrapper" and process.parent.name:launchd " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["host.id"] value = 20
<li><a href="#">description = Identifies a high number (25) of failed Microsoft 365 user authentication attempts from a single IP address within 30 minutes, which could be indicative of a password spraying attack. An adversary may attempt a password spraying attack to obtain unauthorized access to user accounts. false_positives = [ Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives., ] query = " event.dataset:o365.audit and event.provider:(Exchange or AzureActiveDirectory) and event.category:authentication and event.action:("UserLoginFailed" or "PasswordLogonInitialAuthUsingPassword") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["source.ip"] value = 25
<li><a href="#">description = Identifies a high number of failed attempts to assume an AWS Identity and Access Management (IAM) role. IAM roles are used to delegate access to users or services. An adversary may attempt to enumerate IAM roles in order to determine if a role exists before attempting to assume or hijack the discovered role. query = " event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:UpdateAssumeRolePolicy and aws.cloudtrail.error_code:MalformedPolicyDocumentException and event.outcome:failure " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = [] value = 25
<li><a href="#">description = Identifies a high number of failed authentication attempts to the AWS management console for the Root user identity. An adversary may attempt to brute force the password for the Root user identity, as it has complete access to all services and resources for the AWS account. false_positives = [ Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives., ] query = " event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and aws.cloudtrail.user_identity.type:Root and event.outcome:failure " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["cloud.account.id"] value = 10
<li><a href="#">description = Identifies a high number of failed Okta user authentication attempts from a single IP address, which could be indicative of a brute force or password spraying attack. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts. false_positives = [ Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Okta Brute Force or Password Spraying Attack" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "42bf698b-4738-445b-8231-c834ddefd8a0" severity = "medium" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Identity and Access"] type = "threshold" query = " event.dataset:okta.system and event.category:authentication and event.outcome:failure " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["source.ip"] value = 25
<li><a href="#">description = Identifies a high number of Okta user password reset or account unlock attempts. An adversary may attempt to obtain unauthorized access to Okta user accounts using these methods and attempt to blend in with normal activity in their target's environment and evade detection. false_positives = [ The number of Okta user password reset or account unlock attempts will likely vary between organizations. To fit this rule to their organization, users can duplicate this rule and edit the schedule and threshold values in the new rule., ] query = " event.dataset:okta.system and event.action:(system.email.account_unlock.sent_message or system.email.password_reset.sent_message or system.sms.send_account_unlock_message or system.sms.send_password_reset_message or system.voice.send_account_unlock_call or system.voice.send_password_reset_call or user.account.unlock_token) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [rule.threshold] field = ["okta.actor.alternate_id"] value = 5
<li><a href="#">description = Identifies a Logging bucket deletion in Google Cloud Platform (GCP). Log buckets are containers that store and organize log data. A deleted bucket stays in a pending state for 7 days, and Logging continues to route logs to the bucket during that time. To stop routing logs to a deleted bucket, you can delete the log sinks that have the bucket as their destination, or modify the filter for the sinks to stop it from routing logs to the deleted bucket. An adversary may delete a log bucket to evade detection. false_positives = [ Logging bucket deletions may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Logging bucket deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Logging Bucket Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [, ] risk_score = 47 rule_id = "5663b693-0dea-4f2e-8275-f1ae5ff2de8e" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.logging.v*.ConfigServiceV*.DeleteBucket and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a Logging sink deletion in Google Cloud Platform (GCP). Every time a log entry arrives, Logging compares the log entry to the sinks in that resource. Each sink whose filter matches the log entry writes a copy of the log entry to the sink's export destination. An adversary may delete a Logging sink to evade detection. false_positives = [ Logging sink deletions may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Logging sink deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Logging Sink Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "51859fa0-d86b-4214-bf48-ebb30ed91305" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.logging.v*.ConfigServiceV*.DeleteSink and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from the SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded will remain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in these groups. query = " any where event.action == "Directory Service Changes" and event.code == "5136" and winlog.event_data.AttributeLDAPDisplayName : "dSHeuristics" and length(winlog.event_data.AttributeValue) > 15 and winlog.event_data.AttributeValue regex~ "[0-9]{15}([1-9a-f]).*" " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a modification to a Logging sink in Google Cloud Platform (GCP). Logging compares the log entry to the sinks in that resource. Each sink whose filter matches the log entry writes a copy of the log entry to the sink's export destination. An adversary may update a Logging sink to exfiltrate logs to a different export destination. false_positives = [ Logging sink modifications may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Sink modifications from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Logging Sink Modification" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "184dfe52-2999-42d9-b9d1-d1ca54495a61" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.logging.v*.ConfigServiceV*.UpdateSink and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1537" name = "Transfer Data to Cloud Account" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateral movement, but will be noisy if commonly done by administrators." query = " sequence by winlog.logon.id, winlog.computer_name with maxspan=1m [authentication where event.action == "logged-in" and winlog.logon.type : "Network" and event.outcome=="success" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1"] [iam where event.action == "service-installed" and not winlog.event_data.SubjectLogonId : "0x3e7" and not winlog.event_data.ServiceFileName : ("?:\\Windows\\ADCR_Agent\\adcrsvc.exe", "?:\\Windows\\System32\\VSSVC.exe", "?:\\Windows\\servicing\\TrustedInstaller.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Program Files\\*.exe", "?:\\Windows\\PSEXESVC.EXE", "?:\\Windows\\System32\\sppsvc.exe", "?:\\Windows\\System32\\wbem\\WmiApSrv.exe", "?:\\WINDOWS\\RemoteAuditService.exe", "?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe", "?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe", "?:\\Windows\\CAInvokerService.exe", "?:\\Windows\\System32\\upfc.exe", "?:\\Windows\\AdminArsenal\\PDQ*.exe", "?:\\Windows\\System32\\vds.exe", "?:\\Windows\\Veeam\\Backup\\VeeamDeploymentSvc.exe", "?:\\Windows\\ProPatches\\Scheduler\\STSchedEx.exe", "?:\\Windows\\System32\\certsrv.exe", "?:\\Windows\\eset-remote-install-service.exe", "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe", "?:\\Pella Corporation\\OSCToGPAutoService\\OSCToGPAutoSvc.exe", "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe", "?:\\Windows\\SysWOW64\\NwxExeSvc\\NwxExeSvc.exe", "?:\\Windows\\System32\\taskhostex.exe")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a new or modified federation domain, which can be used to create a trust between O365 and an external identity provider. index = ["filebeat-*", "logs-o365*"] language = "kuery" license = "Elastic License v2" name = "New or Modified Federation Domain" note =## Setup The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , , , ] risk_score = 21 rule_id = "684554fc-0777-47ce-8c9b-3d01f198d7f8" severity = "low" tags = ["Elastic", "Cloud", "Microsoft 365", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:("Set-AcceptedDomain" or "Set-MsolDomainFederationSettings" or "Add-FederatedDomain" or "New-AcceptedDomain" or "Remove-AcceptedDomain" or "Remove-FederatedDomain") and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1484" name = "Domain Policy Modification" reference = [[rule.threat.technique.subtechnique]] id = "T1484.002" name = "Domain Trust Modification" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies a new process starting from a process ID (PID), lock or reboot file within the temporary file storage paradigm (tmpfs) directory /var/run directory. On Linux, the PID files typically hold the process ID to track previous copies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising itself or these files as legitimate PID files. false_positives = [ False-Positives (FP) should be at a minimum with this detection as PID files are meant to hold process IDs, not inherently be executables that spawn processes., ] query = " process where event.type == "start" and user.id == "0" and process.executable regex~/var/run/\w+\.(pid|lock|reboot)" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated) registry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit). query = " /* Registry Path ends with backslash */ registry where /* length(registry.data.strings) > 0 and */ registry.path : ("HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\", "HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\", "HKLM\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\", "HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a potential exploitation of InstallerTakeOver (CVE-2021-41379) default PoC execution. Successful exploitation allows an unprivileged user to escalate privileges to SYSTEM. query = " /* This rule is compatible with both Sysmon and Elastic Endpoint */ process where event.type == "start" and (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and ( (process.name : "elevation_service.exe" and not process.pe.original_file_name == "elevation_service.exe") or (process.parent.name : "elevation_service.exe" and process.name : ("rundll32.exe", "cmd.exe", "powershell.exe")) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies a potential Gatekeeper bypass. In macOS, when applications or programs are downloaded from the internet, there is a quarantine flag set on the file. This attribute is read by Apple's Gatekeeper defense program at execution time. An adversary may disable this attribute to evade defenses. query = " process where event.type in ("start", "process_started") and process.name : "xattr" and ( (process.args : "com.apple.quarantine" and process.args : ("-d", "-w")) or (process.args : "-c") or (process.command_line : ("/bin/bash -c xattr -c *", "/bin/zsh -c xattr -c *", "/bin/sh -c xattr -c *")) ) and not process.args_count > 12 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a PowerShell process launched by either cscript.exe or wscript.exe. Observing Windows scripting processes executing a PowerShell script, may be indicative of malicious activity. query = " process where event.type == "start" and process.parent.name : ("cscript.exe", "wscript.exe") and process.name : "powershell.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies a privilege escalation attempt via a rogue Windows directory (Windir) environment variable. This is a known primitive that is often combined with other vulnerabilities to elevate privileges. query = " registry where registry.path : ("HKEY_USERS\\*\\Environment\\windir", "HKEY_USERS\\*\\Environment\\systemroot") and not registry.data.strings : ("C:\\windows", "%SystemRoot%") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.007" name = "Path Interception by PATH Environment Variable" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies a privilege escalation attempt via named pipe impersonation. An adversary may abuse this technique by utilizing a framework such Metasploit's meterpreter getsystem command. query = " process where event.type == "start" and process.pe.original_file_name in ("Cmd.Exe", "PowerShell.EXE") and process.args : "echo" and process.args : ">" and process.args : "\\\\.\\pipe\\*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique by masquerading as a known named pipe and manipulating a privileged process to connect to it. query = " file where event.action : "Pipe Created*" and /* normal sysmon named pipe creation events truncate the pipe keyword */ file.name : "\\*\\Pipe\\*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other non-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint. query = " sequence by host.id with maxspan=5s [process where event.type == "end" and process.code_signature.trusted != true and not process.executable : ("C:\\Windows\\SoftwareDistribution\\*.exe", "C:\\Windows\\WinSxS\\*.exe") ] by process.executable [file where event.type == "deletion" and file.extension : ("exe", "scr", "com") and not process.executable : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\drvinst.exe") and not file.path : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe") ] by file.path " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.004" name = "File Deletion" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data staging activity. query = " process where event.type == "start" and process.name : ("cmd.exe", "powershell.exe", "robocopy.exe", "xcopy.exe") and process.args : ("copy*", "move*", "cp", "mv") and process.args : "*$*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies a remote logon followed by a scheduled task creation on the target host. This could be indicative of adversary lateral movement. query = " /* Network Logon followed by Scheduled Task creation */ sequence by winlog.computer_name with maxspan=1m [authentication where event.action == "logged-in" and winlog.logon.type == "Network" and event.outcome == "success" and not user.name == "ANONYMOUS LOGON" and not winlog.event_data.SubjectUserName : "*$" and not user.domain == "NT AUTHORITY" and source.ip != "127.0.0.1" and source.ip !="::1"] by winlog.event_data.TargetLogonId [iam where event.action == "scheduled-task-created"] by winlog.event_data.SubjectLogonId " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies a reverse shell via the abuse of named pipes on Linux with the help of OpenSSL or Netcat. First in, first out (FIFO) files are special files for reading and writing to by Linux processes. For this to work, a named pipe is created and passed to a Linux shell where the use of a network connection tool such as Netcat or OpenSSL has been established. The stdout and stderr are captured in the named pipe from the network connection and passed back to the shell for execution. false_positives = [ Netcat and OpenSSL are common tools used for establishing network connections and creating encryption keys. While they are popular, capturing the stdout and stderr in a named pipe pointed to a shell is anomalous., ] query = " sequence by host.id with maxspan = 5s [process where event.type == "start" and process.executable : ("/usr/bin/mkfifo","/usr/bin/mknod") and process.args:("/tmp/*","$*")] [process where process.executable : ("/bin/sh","/bin/bash") and process.args:("-i") or (process.executable: ("/usr/bin/openssl") and process.args: ("-connect"))] [process where (process.name:("nc","ncat","netcat","netcat.openbsd","netcat.traditional") or (process.name: "openssl" and process.executable: "/usr/bin/openssl"))] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.004" name = "Unix Shell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies a rotation to storage account access keys in Azure. Regenerating access keys can affect any applications or Azure services that are dependent on the storage account key. Adversaries may regenerate a key as a means of acquiring credentials to access systems and resources. false_positives = [ It's recommended that you rotate your access keys periodically to help keep your storage account secure. Normal key rotation can be exempted from the rule. An abnormal time frame and/or a key rotation from unfamiliar users, hosts, or locations should be investigated., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.STORAGE/STORAGEACCOUNTS/REGENERATEKEY/ACTION" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1528" name = "Steal Application Access Token" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies a Secure Shell (SSH) client or server process creating or writing to a known SSH backdoor log file. Adversaries may modify SSH related binaries for persistence or credential access via patching sensitive functions to enable unauthorized access or to log SSH credentials for exfiltration. false_positives = ["Updates to approved and trusted SSH executables can trigger this rule."] query = " file where event.type == "change" and process.executable : ("/usr/sbin/sshd", "/usr/bin/ssh") and ( (file.name : (".*", "~*", "*~") and not file.name : (".cache", ".viminfo", ".bash_history")) or file.extension : ("in", "out", "ini", "h", "gz", "so", "sock", "sync", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9") or file.path : ( "/private/etc/*--", "/usr/share/*", "/usr/include/*", "/usr/local/include/*", "/private/tmp/*", "/private/var/tmp/*", "/usr/tmp/*", "/usr/share/man/*", "/usr/local/share/*", "/usr/lib/*.so.*", "/private/etc/ssh/.sshd_auth", "/usr/bin/ssd", "/private/var/opt/power", "/private/etc/ssh/ssh_known_hosts", "/private/var/html/lol", "/private/var/log/utmp", "/private/var/lib", "/var/run/sshd/sshd.pid", "/var/run/nscd/ns.pid", "/var/run/udev/ud.pid", "/var/run/udevd.pid" ) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1554" name = "Compromise Client Software Binary" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a sign-in using the Azure Active Directory PowerShell module. PowerShell for Azure Active Directory allows for managing settings from the command line, which is intended for users who are members of an admin role. false_positives = [ Sign-ins using PowerShell may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be signing into your environment. Sign-ins from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.signinlogs and azure.signinlogs.properties.app_display_name:"Azure Active Directory PowerShell" and azure.signinlogs.properties.token_issuer_type:AzureAD and event.outcome:(success or Success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.004" name = "Cloud Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse this technique to manipulate relevant security services. query = " registry where registry.path : ( "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\Start", "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\Start" ) and registry.data.strings : ("4", "0x00000004") and process.name : ( "SolarWinds.BusinessLayerHost*.exe", "ConfigurationWizard*.exe", "NetflowDatabaseMaintenance*.exe", "NetFlowService*.exe", "SolarWinds.Administration*.exe", "SolarWinds.Collector.Service*.exe", "SolarwindsDiagnostics*.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1195" name = "Supply Chain Compromise" reference = [[rule.threat.technique.subtechnique]] id = "T1195.002" name = "Compromise Software Supply Chain" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies a suspicious AutoIt process execution. Malware written as an AutoIt script tends to rename the AutoIt executable to avoid detection. query = " process where event.type == "start" and process.pe.original_file_name : "AutoIt*.exe" and not process.name : "AutoIt*.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.003" name = "Rename System Utilities" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to elevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a security vulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing. query = " iam where event.action == "renamed-user-account" and /* machine account name renamed to user like account name */ winlog.event_data.OldTargetUserName : "*$" and not winlog.event_data.NewTargetUserName : "*$" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.002" name = "Domain Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes are often launched via exploitation of PDF applications. query = " sequence with maxspan=2h [file where event.type != "deletion" and file.extension : "exe" and (process.name : "AcroRd32.exe" or process.name : "rdrcef.exe" or process.name : "FoxitPhantomPDF.exe" or process.name : "FoxitReader.exe") and not (file.name : "FoxitPhantomPDF.exe" or file.name : "FoxitPhantomPDFUpdater.exe" or file.name : "FoxitReader.exe" or file.name : "FoxitReaderUpdater.exe" or file.name : "AcroRd32.exe" or file.name : "rdrcef.exe") ] by host.id, file.path [process where event.type == "start"] by host.id, process.executable " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique can be used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary (schtasks.exe) used to manage scheduled tasks. query = " any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and process.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "MSPUB.EXE", "MSACCESS.EXE") and (dll.name : "taskschd.dll" or file.name : "taskschd.dll") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where child processes are spawned via Windows Management Instrumentation (WMI). This technique can be used to execute code and evade traditional parent/child processes spawned from Microsoft Office products. query = " any where (event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) and process.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "MSPUB.EXE", "MSACCESS.EXE") and (dll.name : "wmiutils.dll" or file.name : "wmiutils.dll") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1047" name = "Windows Management Instrumentation" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to localhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberos relay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges. query = " sequence by winlog.computer_name with maxspan=5m [authentication where /* event 4624 need to be logged */ event.action == "logged-in" and event.outcome == "success" and /* authenticate locally using relayed kerberos Ticket */ winlog.event_data.AuthenticationPackageName :"Kerberos" and winlog.logon.type == "Network" and cidrmatch(source.ip, "127.0.0.0/8", "::1") and source.port > 0] by winlog.event_data.TargetLogonId [any where /* event 4697 need to be logged */ event.action : "service-installed"] by winlog.event_data.SubjectLogonId " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious code execution. query = " sequence by process.entity_id with maxspan=5m [process where event.type == "start" and process.name : ("wscript.exe", "cscript.exe", "mshta.exe", "wmic.exe", "regsvr32.exe", "svchost.exe", "dllhost.exe", "cmstp.exe")] [file where event.type != "deletion" and file.name : ("wscript.exe.log", "cscript.exe", "mshta.exe.log", "wmic.exe.log", "svchost.exe.log", "dllhost.exe.log", "cmstp.exe.log", "regsvr32.exe.log")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies a suspicious Windows explorer child process. Explorer.exe can be abused to launch malicious scripts or executables from a trusted parent process. query = " process where event.type == "start" and ( process.name : ("cscript.exe", "wscript.exe", "powershell.exe", "rundll32.exe", "cmd.exe", "mshta.exe", "regsvr32.exe") or process.pe.original_file_name in ("cscript.exe", "wscript.exe", "PowerShell.EXE", "RUNDLL32.EXE", "Cmd.Exe", "MSHTA.EXE", "REGSVR32.EXE") ) and /* Explorer started via DCOM */ process.parent.name : "explorer.exe" and process.parent.args : "-Embedding" and not process.parent.args: ( /* Noisy CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs */ "/factory,{5BD95610-9434-43C2-886C-57852CC8A120}", "/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies a transport rule creation in Microsoft 365. As a best practice, Exchange Online mail transport rules should not be set to forward email to domains outside of your organization. An adversary may create transport rules to exfiltrate data. false_positives = [ A new transport rule may be created by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"New-TransportRule" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1537" name = "Transfer Data to Cloud Account" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems. query = " iam where event.action == "added-member-to-group" and group.name : ("Admin*", "Local Administrators", "Domain Admins", "Enterprise Admins", "Backup Admins", "Schema Admins", "DnsAdmins", "Exchange Organization Administrators") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses via side-loading a malicious DLL within the memory space of one of those processes. false_positives = ["Microsoft Antimalware Service Executable installed on non default installation path."] query = " process where event.type == "start" and (process.pe.original_file_name == "MsMpEng.exe" and not process.name : "MsMpEng.exe") or (process.name : "MsMpEng.exe" and not process.executable : ("?:\\ProgramData\\Microsoft\\Windows Defender\\*.exe", "?:\\Program Files\\Windows Defender\\*.exe", "?:\\Program Files (x86)\\Windows Defender\\*.exe", "?:\\Program Files\\Microsoft Security Client\\*.exe", "?:\\Program Files (x86)\\Microsoft Security Client\\*.exe")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.002" name = "DLL Side-Loading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is used as a defense evasion technique to blend-in malicious activity with legitimate Windows software. query = " process where event.type == "start" and (process.pe.original_file_name == "wuauclt.exe" or process.name : "wuauclt.exe") and /* necessary windows update client args to load a dll */ process.args : "/RunHandlerComServer" and process.args : "/UpdateDeploymentProvider" and /* common paths writeable by a standard user where the target DLL can be placed */ process.args : ("C:\\Users\\*.dll", "C:\\ProgramData\\*.dll", "C:\\Windows\\Temp\\*.dll", "C:\\Windows\\Tasks\\*.dll") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies access to the /etc/shadow file via the commandline using standard system utilities. After elevating privileges to root, threat actors may attempt to read or dump this file in order to gain valid credentials. They may utilize these to move laterally undetected and access additional resources. query = " process where event.type == "start" and event.action == "exec" and user.name == "root" and (process.args : "/etc/shadow" or (process.working_directory: "/etc" and process.args: "shadow")) and not process.executable: ("/usr/bin/tar", "/bin/tar", "/usr/bin/gzip", "/bin/gzip", "/usr/bin/zip", "/bin/zip", "/usr/bin/stat", "/bin/stat", "/usr/bin/cmp", "/bin/cmp", "/usr/bin/sudo", "/bin/sudo", "/usr/bin/find", "/bin/find", "/usr/bin/ls", "/bin/ls", "/usr/bin/uniq", "/bin/uniq", "/usr/bin/unzip", "/bin/unzip") and not process.parent.executable: "/bin/dracut" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.008" name = "/etc/passwd and /etc/shadow" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies accounts with a high number of single sign-on (SSO) logon errors. Excessive logon errors may indicate an attempt to brute force a password or SSO token. false_positives = [ Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives., ] query = " event.dataset:o365.audit and event.provider:AzureActiveDirectory and event.category:authentication and o365.audit.LogonError:"SsoArtifactInvalidOrExpired" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["user.id"] value = 5
<li><a href="#">description = Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.args : ("C:\\Windows \\system32\\*.exe", "C:\\Windows \\SysWOW64\\*.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies an attempt to exploit a local privilege escalation in polkit pkexec (CVE-2021-4034) via unsecure environment variable injection. Successful exploitation allows an unprivileged user to escalate to the root user. query = " file where file.path : "/*GCONV_PATH*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.007" name = "Path Interception by PATH Environment Variable" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies an attempt to export an AWS EC2 instance. A virtual machine (VM) export may indicate an attempt to extract or exfiltrate information. false_positives = [ VM exports may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. VM exports from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:CreateInstanceExportTask and event.outcome:failure " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1537" name = "Transfer Data to Cloud Account" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1005" name = "Data from Local System" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate account passwords to maintain access or evade password duration policies and preserve compromised credentials. false_positives = ["Legitimate remote account administration."] query = " sequence by winlog.computer_name with maxspan=5m [authentication where event.action == "logged-in" and /* event 4624 need to be logged */ winlog.logon.type : "Network" and event.outcome == "success" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1"] by winlog.event_data.TargetLogonId /* event 4724 need to be logged */ [iam where event.action == "reset-password" and ( /* This rule is very noisy if not scoped to privileged accounts, duplicate the rule and add your own naming convention and accounts of interest here. */ winlog.event_data.TargetUserName: ("*Admin*", "*super*", "*SVC*", "*DC0*", "*service*", "*DMZ*", "*ADM*") or winlog.event_data.TargetSid : ("S-1-5-21-*-500", "S-1-12-1-*-500") ) ] by winlog.event_data.SubjectLogonId " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies an Azure Active Directory (AD) Global Administrator role addition to a Privileged Identity Management (PIM) user account. PIM is a service that enables you to manage, control, and monitor access to important resources in an organization. Users who are assigned to the Global administrator role can read and modify any administrative setting in your Azure AD organization. false_positives = [ Global administrator additions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Global administrator additions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-azure*"] language = "kuery" license = "Elastic License v2" name = "Azure Global Administrator Role Addition to PIM User" note =## Setup The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , ] risk_score = 73 rule_id = "ed9ecd27-e3e6-4fd9-8586-7754803f7fc8" severity = "high" tags = ["Elastic", "Cloud", "Azure", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:azure.auditlogs and azure.auditlogs.properties.category:RoleManagement and azure.auditlogs.operation_name:("Add eligible member to role in PIM completed (permanent)" or "Add member to role in PIM completed (timebound)") and azure.auditlogs.properties.target_resources.*.display_name:"Global Administrator" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies an Event Hub deletion in Azure. An Event Hub is an event processing service that ingests and processes large volumes of events and data. An adversary may delete an Event Hub in an attempt to evade detection. false_positives = [ Event Hub deletions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Event Hub deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies an executable created by a Microsoft Office application and subsequently executed. These processes are often launched via scripts inside documents or during exploitation of Microsoft Office applications. query = " sequence with maxspan=2h [file where event.type != "deletion" and file.extension : "exe" and (process.name : "WINWORD.EXE" or process.name : "EXCEL.EXE" or process.name : "OUTLOOK.EXE" or process.name : "POWERPNT.EXE" or process.name : "eqnedt32.exe" or process.name : "fltldr.exe" or process.name : "MSPUB.EXE" or process.name : "MSACCESS.EXE") ] by host.id, file.path [process where event.type == "start"] by host.id, process.executable " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies an Identity and Access Management (IAM) custom role creation in Google Cloud Platform (GCP). Custom roles are user-defined, and allow for the bundling of one or more supported permissions to meet specific needs. Custom roles will not be updated automatically and could lead to privilege creep if not carefully scrutinized. false_positives = [ Custom role creations may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Role creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP IAM Custom Role Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "aa8007f0-d1df-49ef-8520-407857594827" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.CreateRole and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies an Identity and Access Management (IAM) role deletion in Google Cloud Platform (GCP). A role contains a set of permissions that allows you to perform specific actions on Google Cloud resources. An adversary may delete an IAM role to inhibit access to accounts utilized by legitimate users. false_positives = [ Role deletions may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Role deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP IAM Role Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "e2fb5b18-e33c-4270-851e-c3d675c9afcd" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.DeleteRole and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies an instance of a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses via side loading a malicious DLL within the memory space of one of those processes. query = " process where event.type == "start" and process.pe.original_file_name in ("WinWord.exe", "EXPLORER.EXE", "w3wp.exe", "DISM.EXE") and not (process.name : ("winword.exe", "explorer.exe", "w3wp.exe", "Dism.exe") or process.executable : ("?:\\Windows\\explorer.exe", "?:\\Program Files\\Microsoft Office\\root\\Office*\\WINWORD.EXE", "?:\\Program Files?(x86)\\Microsoft Office\\root\\Office*\\WINWORD.EXE", "?:\\Windows\\System32\\Dism.exe", "?:\\Windows\\SysWOW64\\Dism.exe", "?:\\Windows\\System32\\inetsrv\\w3wp.exe") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies an invitation to an external user in Azure Active Directory (AD). Azure AD is extended to include collaboration, allowing you to invite people from outside your organization to be guest users in your cloud account. Unless there is a business need to provision guest access, it is best practice avoid creating guest users. Guest users could potentially be overlooked indefinitely leading to a potential vulnerability. false_positives = [ Guest user invitations may be sent out by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Guest user invitations from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Invite external user" and azure.auditlogs.properties.target_resources.*.display_name:guest and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies an outbound network connection attempt followed by a session id change as the root user by the same process entity. This particular instantiation of a network connection is abnormal and should be investigated as it may indicate a potential reverse shell activity via a privileged process. false_positives = [ False-Positives (FP) can appear if another remote terminal service is being used to connect to it's listener but typically SSH is used in these scenarios., ] query = " sequence by process.entity_id with maxspan=1m [network where event.type == "start" and event.action == "connection_attempted" and user.id == "0" and not process.executable : ("/bin/ssh", "/sbin/ssh", "/usr/lib/systemd/systemd", "/usr/sbin/sshd")] [process where event.action == "session_id_change" and user.id == "0" and not process.executable : ("/bin/ssh", "/sbin/ssh", "/usr/lib/systemd/systemd", "/usr/sbin/sshd")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1095" name = "Non-Application Layer Protocol" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.003" name = "Sudo and Sudo Caching" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies an outbound network connection by JAVA to LDAP, RMI or DNS standard ports followed by a suspicious JAVA child processes. This may indicate an attempt to exploit a JAVA/NDI (Java Naming and Directory Interface) injection vulnerability. query = " sequence by host.id with maxspan=1m [network where event.action == "connection_attempted" and process.name : "java" and /* outbound connection attempt to LDAP, RMI or DNS standard ports by JAVA process */ destination.port in (1389, 389, 1099, 53, 5353)] by process.pid [process where event.type == "start" and /* Suspicious JAVA child process */ process.parent.name : "java" and process.name : ("sh", "bash", "dash", "ksh", "tcsh", "zsh", "curl", "perl*", "python*", "ruby*", "php*", "wget")] by process.parent.pid " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.007" name = "JavaScript" reference = [[rule.threat.technique]] id = "T1203" name = "Exploitation for Client Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies an unexpected executable file being created or modified by a Windows system critical process, which may indicate activity related to remote code execution or other forms of exploitation. query = " file where event.type != "deletion" and file.extension : ("exe", "dll") and process.name : ("smss.exe", "autochk.exe", "csrss.exe", "wininit.exe", "services.exe", "lsass.exe", "winlogon.exe", "userinit.exe", "LogonUI.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1211" name = "Exploitation for Defense Evasion" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies an unexpected file being modified by dns.exe, the process responsible for Windows DNS Server services, which may indicate activity related to remote code execution or other forms of exploitation. query = " file where process.name : "dns.exe" and event.type in ("creation", "deletion", "change") and not file.name : "dns.log" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1133" name = "External Remote Services" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, which may indicate activity related to remote code execution or other forms of exploitation. false_positives = [ Werfault.exe will legitimately spawn when dns.exe crashes, but the DNS service is very stable and so this is a low occurring event. Denial of Service (DoS) attempts by intentionally crashing the service will also cause werfault.exe to spawn., ] query = " process where event.type == "start" and process.parent.name : "dns.exe" and not process.name : "conhost.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1133" name = "External Remote Services" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target. An adversary may use this primitive in combination with other techniques to elevate privileges on a compromised system. query = " process where event.type == "start" and process.name : "rundll32.exe" and /* Rundll32 WbeDav Client */ process.args : ("?:\\Windows\\System32\\davclnt.dll,DavSetCookie", "?:\\Windows\\SysWOW64\\davclnt.dll,DavSetCookie") and /* Access to named pipe via http */ process.args : ("http*/print/pipe/*", "http*/pipe/spoolss", "http*/pipe/srvsvc") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1212" name = "Exploitation for Credential Access" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies attempts to add an account to the admin group via the command line. This could be an indication of privilege escalation activity. query = " event.category:process and event.type:(start or process_started) and process.name:(dscl or dseditgroup) and process.args:(("/Groups/admin" or admin) and ("-a" or "-append")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.003" name = "Local Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies attempts to brute force a Microsoft 365 user account. An adversary may attempt a brute force attack to obtain unauthorized access to user accounts. false_positives = [ Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives., ] query = " event.dataset:o365.audit and event.provider:(AzureActiveDirectory or Exchange) and event.category:authentication and event.action:(UserLoginFailed or PasswordLogonInitialAuthUsingPassword) and not o365.audit.LogonError:(UserAccountNotFound or EntitlementGrantsNotFound or UserStrongAuthEnrollmentRequired or UserStrongAuthClientAuthNRequired or InvalidReplyTo) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["user.id"] value = 10
<li><a href="#">description = Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue Windows ClipUp program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.name : "Clipup.exe" and not process.executable : "C:\\Windows\\System32\\ClipUp.exe" and process.parent.name : "dllhost.exe" and /* CLSID of the Elevated COM Interface IEditionUpgradeManager */ process.parent.args : "/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows Firewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.parent.name == "mmc.exe" and /* process.Ext.token.integrity_level_name == "high" can be added in future for tuning */ /* args of the Windows Firewall SnapIn */ process.parent.args == "WF.msc" and process.name != "WerFault.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies attempts to bypass User Account Control (UAC) via DLL side-loading. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions. query = " file where event.type : "change" and process.name : "dllhost.exe" and /* Known modules names side loaded into process running with high or system integrity level for UAC Bypass, update here for new modules */ file.name : ("wow64log.dll", "comctl32.dll", "DismCore.dll", "OskSupport.dll", "duser.dll", "Accessibility.ni.dll") and /* has no impact on rule logic just to avoid OS install related FPs */ not file.path : ("C:\\Windows\\SoftwareDistribution\\*", "C:\\Windows\\WinSxS\\*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system. query = " process where event.type == "start" and ( (process.name : "wevtutil.exe" or process.pe.original_file_name == "wevtutil.exe") and process.args : ("/e:false", "cl", "clear-log") ) or ( process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and process.args : "Clear-EventLog" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.001" name = "Clear Windows Event Logs" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to clear Windows event log stores. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system. query = " event.action:("audit-log-cleared" or "Log clear") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.001" name = "Clear Windows Event Logs" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to create a local account that will be hidden from the macOS logon window. This may indicate an attempt to evade user attention while maintaining persistence using a separate local account. query = " event.category:process and event.type:(start or process_started) and process.name:dscl and process.args:(IsHidden and create and (true or 1 or yes)) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.003" name = "Local Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies attempts to create a Windows User Account. This is sometimes done by attackers to persist or increase access to a system or domain. false_positives = [ Legitimate local user creations may be done by a system or network administrator. Verify whether this is known behavior in your environment. Local user creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["winlogbeat-*", "logs-system.*", "logs-windows.*"] language = "kuery" license = "Elastic License v2" name = "Windows User Account Creation" risk_score = 21 rule_id = "38e17753-f581-4644-84da-0d60a8318694" severity = "low" tags = ["Elastic", "Host", "Windows", "Threat Detection", "Persistence"] timestamp_override = "event.ingested" type = "query = " event.module : ("system" or "security") and (event.code : "4720" or event.action : "added-user-account") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [[rule.threat.technique.subtechnique]] id = "T1136.001" name = "Local Account" reference = [[rule.threat.technique.subtechnique]] id = "T1136.002" name = "Domain Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistence on a system or domain. query = " process where event.type == "start" and process.name : ("net.exe", "net1.exe") and not process.parent.name : "net.exe" and (process.args : "user" and process.args : ("/ad", "/add")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [[rule.threat.technique.subtechnique]] id = "T1136.001" name = "Local Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies attempts to create or modify a crontab via a process that is not crontab (i.e python, osascript, etc.). This activity should not be highly prevalent and could indicate the use of cron as a persistence mechanism by a threat actor. query = " file where event.type != "deletion" and process.name != null and file.path : "/private/var/at/tabs/*" and not process.executable == "/usr/bin/crontab" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.003" name = "Cron" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies attempts to delete an AWS Config Service resource. An adversary may tamper with Config services in order to reduce visibility into the security posture of an account and / or its workload instances. false_positives = [ Privileged IAM users with security responsibilities may be expected to make changes to the Config service in order to align with local security policies and requirements. Automation, orchestration, and security tools may also make changes to the Config service, where they are used to automate setup or configuration of AWS accounts. Other kinds of user or service contexts do not commonly make changes to this service., ] query = " event.dataset:aws.cloudtrail and event.provider:config.amazonaws.com and event.action:(DeleteConfigRule or DeleteOrganizationConfigRule or DeleteConfigurationAggregator or DeleteConfigurationRecorder or DeleteConformancePack or DeleteOrganizationConformancePack or DeleteDeliveryChannel or DeleteRemediationConfiguration or DeleteRetentionConfiguration) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to disable EventLog via the logman Windows utility, PowerShell, or auditpol. This is often done by attackers in an attempt to evade detection on a system. query = " process where event.type == "start" and ((process.name:"logman.exe" or process.pe.original_file_name == "Logman.exe") and process.args : "EventLog-*" and process.args : ("stop", "delete")) or ((process.name : ("pwsh.exe", "powershell.exe", "powershell_ise.exe") or process.pe.original_file_name in ("pwsh.exe", "powershell.exe", "powershell_ise.exe")) and process.args : "Set-Service" and process.args: "EventLog" and process.args : "Disabled") or ((process.name:"auditpol.exe" or process.pe.original_file_name == "AUDITPOL.EXE") and process.args : "/success:disable") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.001" name = "Clear Windows Event Logs" reference = [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.006" name = "Indicator Blocking" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to disable or schedule the deletion of an AWS KMS Customer Managed Key (CMK). Deleting an AWS KMS key is destructive and potentially dangerous. It deletes the key material and all metadata associated with the KMS key and is irreversible. After a KMS key is deleted, the data that was encrypted under that KMS key can no longer be decrypted, which means that data becomes unrecoverable. false_positives = [ A KMS customer managed key may be disabled or scheduled for deletion by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Key deletions by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:kms.amazonaws.com and event.action:("DisableKey" or "ScheduleKeyDeletion") and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies attempts to disable PowerShell Script Block Logging via registry modification. Attackers may disable this logging to conceal their activities in the host and evade detection. query = " registry where event.type == "change" and registry.path : ( "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\\EnableScriptBlockLogging", "\\REGISTRY\\MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\\EnableScriptBlockLogging" ) and registry.data.strings : ("0", "0x00000000") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.002" name = "Disable Windows Event Logging" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to enable the root account using the dsenableroot command. This command may be abused by adversaries for persistence, as the root account is disabled by default. query = " event.category:process and event.type:(start or process_started) and process.name:dsenableroot and not process.args:"-d" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.003" name = "Local Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies attempts to enable the Windows scheduled tasks AT command via the registry. Attackers may use this method to move laterally or persist locally. The AT command has been deprecated since Windows 8 and Windows Server 2012, but still exists for backwards compatibility. query = " registry where registry.path : ( "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt", "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt" ) and registry.data.strings : ("1", "0x00000001") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to execute a child process from within the context of an Electron application using the child_process Node.js module. Adversaries may abuse this technique to inherit permissions from parent processes. query = " event.category:process and event.type:(start or process_started) and process.args:("-e" and const*require*child_process*) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies attempts to login to AWS as the root user without using multi-factor authentication (MFA). Amazon AWS best practices indicate that the root user should be protected by MFA. false_positives = [ Some organizations allow login with the root user without MFA, however, this is not considered best practice by AWS and increases the risk of compromised credentials., ] query = " event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and aws.cloudtrail.user_identity.type:Root and aws.cloudtrail.console_login.additional_eventdata.mfa_used:false and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies attempts to modify an AWS IAM Assume Role Policy. An adversary may attempt to modify the AssumeRolePolicy of a misconfigured role in order to gain the privileges of that role. false_positives = [ Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Policy updates from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:UpdateAssumeRolePolicy and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies attempts to modify the WDigest security provider in the registry to force the user's password to be stored in clear text in memory. This behavior can be indicative of an adversary attempting to weaken the security configuration of an endpoint. Once the UseLogonCredential value is modified, the adversary may attempt to dump clear text passwords from memory. query = " registry where event.type : ("creation", "change") and registry.path : ( "HKLM\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredential", "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredential" ) and registry.data.strings : ("1", "0x00000001") and not (process.executable : "?:\\Windows\\System32\\svchost.exe" and user.id : "S-1-5-18") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies attempts to revoke an Okta API token. An adversary may attempt to revoke or delete an Okta API token to disrupt an organization's business operations. false_positives = [ If the behavior of revoking Okta API tokens is expected, consider adding exceptions to this rule to filter false positives., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Attempt to Revoke Okta API Token" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 21 rule_id = "676cff2b-450b-4cf1-8ed2-c0c58a4a2dd7" severity = "low" tags = ["Elastic", "Identity", "Okta", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:system.api_token.revoke " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies AWS IAM password recovery requests. An adversary may attempt to gain unauthorized AWS access by abusing password recovery mechanisms. false_positives = [ Verify whether the user identity, user agent, and/or hostname should be requesting changes in your environment. Password reset attempts from unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:PasswordRecoveryRequested and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable file from a remote destination. query = " sequence by host.id, process.entity_id [network where process.name : ("wscript.exe", "cscript.exe") and network.protocol != "dns" and network.direction : ("outgoing", "egress") and network.type == "ipv4" and destination.ip != "127.0.0.1" ] [file where event.type == "creation" and file.extension : ("exe", "dll")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies certutil.exe making a network connection. Adversaries could abuse certutil.exe to download a certificate, or malware, from a remote URL. query = " sequence by process.entity_id [process where process.name : "certutil.exe" and event.type == "start"] [network where process.name : "certutil.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies changes to container access levels in Azure. Anonymous public read access to containers and blobs in Azure is a way to share data broadly, but can present a security risk if access to sensitive data is not managed judiciously. false_positives = [ Access level modifications may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Access level modifications from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICES/CONTAINERS/WRITE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1526" name = "Cloud Service Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies changes to the Safari configuration using the built-in defaults command. Adversaries may attempt to enable or disable certain Safari settings, such as enabling JavaScript from Apple Events to ease in the hijacking of the users browser. query = " event.category:process and event.type:start and process.name:defaults and process.args: (com.apple.Safari and write and not ( UniversalSearchEnabled or SuppressSearchSuggestions or WebKitTabToLinksPreferenceKey or ShowFullURLInSmartSearchField or com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks ) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies changes to the SoftwareUpdate preferences using the built-in defaults command. Adversaries may abuse this in an attempt to disable security updates. false_positives = ["Authorized SoftwareUpdate Settings Changes"] query = " event.category:process and event.type:(start or process_started) and process.name:defaults and process.args:(write and "-bool" and (com.apple.SoftwareUpdate or /Library/Preferences/com.apple.SoftwareUpdate.plist) and not (TRUE or true)) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse of RunDLL32 could indicate malicious activity. query = " sequence with maxspan=1h [process where event.type == "start" and (process.name : "rundll32.exe" or process.pe.original_file_name == "RUNDLL32.EXE") and process.args_count == 1 ] by process.entity_id [process where event.type == "start" and process.parent.name : "rundll32.exe" ] by process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.011" name = "Rundll32" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from a remote URL. false_positives = [ Administrators may use the command prompt for regular administrative tasks. It's important to baseline your environment for network connections being made from the command prompt to determine any abnormal use of this tool., ] query = " sequence by process.entity_id [process where process.name : "cmd.exe" and event.type == "start"] [network where process.name : "cmd.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies command execution on a virtual machine (VM) in Azure. A Virtual Machine Contributor role lets you manage virtual machines, but not access them, nor access the virtual network or storage account theyre connected to. However, commands can be run via PowerShell on the VM, which execute as System. Other roles, such as certain Administrator roles may be able to execute commands on a VM as well. false_positives = [ Command execution on a virtual machine may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Command execution from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies Component Object Model (COM) hijacking via registry modification. Adversaries may establish persistence by executing malicious content triggered by hijacked references to COM objects. query = " registry where /* not necessary but good for filtering privileged installations */ user.domain != "NT AUTHORITY" and ( (registry.path : "HK*\\InprocServer32\\" and registry.data.strings: ("scrobj.dll", "C:\\*\\scrobj.dll") and not registry.path : "*\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\*") or /* in general COM Registry changes on Users Hive is less noisy and worth alerting */ (registry.path : ("HKEY_USERS\\*\\InprocServer32\\*", "HKEY_USERS\\*\\LocalServer32\\*", "HKEY_USERS\\*\\DelegateExecute\\*", "HKEY_USERS\\*\\TreatAs\\*", "HKEY_USERS\\*\\ScriptletURL\\*") and not (process.executable : "?:\\Program Files*\\Veeam\\Backup and Replication\\Console\\veeam.backup.shell.exe" and registry.path : "HKEY_USERS\\S-1-*_Classes\\CLSID\\*\\LocalServer32\\")) or (registry.path : "HKLM\\*\\InProcServer32\\*" and registry.data.strings : ("*\\Users\\*", "*\\ProgramData\\*")) ) and /* removes false-positives generated by OneDrive and Teams */ not process.name : ("OneDrive.exe","OneDriveSetup.exe","FileSyncConfig.exe","Teams.exe") and /* Teams DLL loaded by regsvr */ not (process.name: "regsvr32.exe" and registry.data.strings : "*Microsoft.Teams.*.dll") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.015" name = "Component Object Model Hijacking" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies disabling of Amazon Elastic Block Store (EBS) encryption by default in the current region. Disabling encryption by default does not change the encryption status of your existing volumes. false_positives = [ Disabling encryption may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Disabling encryption by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:DisableEbsEncryptionByDefault and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1565" name = "Data Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1565.001" name = "Stored Data Manipulation" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies domains commonly used by adversaries for post-exploitation IP lookups. It is common for adversaries to test for Internet access and acquire their external IP address after they have gained access to a system. Among others, this has been observed in campaigns leveraging the information stealer, Trickbot. false_positives = [ If the domains listed in this rule are used as part of an authorized workflow, this rule will be triggered by those events. Validate that this is expected activity and tune the rule to fit your environment variables., ] query = " network where network.protocol == "dns" and process.name != null and user.id not in ("S-1-5-19", "S-1-5-20") and event.action == "lookup_requested" and /* Add new external IP lookup services here */ dns.question.name : ( "*api.ipify.org", "*freegeoip.app", "*checkip.amazonaws.com", "*checkip.dyndns.org", "*freegeoip.app", "*icanhazip.com", "*ifconfig.*", "*ipecho.net", "*ipgeoapi.com", "*ipinfo.io", "*ip.anysrc.net", "*myexternalip.com", "*myipaddress.com", "*showipaddress.com", "*whatismyipaddress.com", "*wtfismyip.com", "*ipapi.co", "*ip-lookup.net", "*ipstack.com" ) and /* Insert noisy false positives here */ not process.executable : ( "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Windows\\System32\\WWAHost.exe", "?:\\Windows\\System32\\smartscreen.exe", "?:\\Windows\\System32\\MicrosoftEdgeCP.exe", "?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe", "?:\\Users\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrome.exe", "?:\\Users\\*\\AppData\\Local\\Programs\\Fiddler\\Fiddler.exe", "?:\\Users\\*\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe", "?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1016" name = "System Network Configuration Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1016.001" name = "Internet Connection Discovery" reference = [[rule.threat.technique]] id = "T1614" name = "System Location Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies Elasticsearch nodes that do not have Transport Layer Security (TLS), and/or lack authentication, and are accepting inbound network connections over the default Elasticsearch port. false_positives = [ If you have front-facing proxies that provide authentication and TLS, this rule would need to be tuned to eliminate the source IP address of your reverse-proxy., ] query = " event.category:network_traffic AND network.protocol:http AND status:OK AND destination.port:9200 AND network.direction:inbound AND NOT http.response.headers.content-type:"image/x-icon" AND NOT _exists_:http.request.headers.authorization " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies execution from a directory masquerading as the Windows Program Files directories. These paths are trusted and usually host trusted third party programs. An adversary may leverage masquerading, along with low privileges to bypass detections allowlisting those folders. query = " process where event.type == "start" and process.executable : "C:\\*Program*Files*\\*.exe" and not process.executable : ("C:\\Program Files\\*.exe", "C:\\Program Files (x86)\\*.exe", "C:\\Users\\*.exe", "C:\\ProgramData\\*.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.005" name = "Match Legitimate Name or Location" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies execution from the Remote Desktop Protocol (RDP) shared mountpoint tsclient on the target host. This may indicate a lateral movement attempt. query = " process where event.type == "start" and process.executable : "\\Device\\Mup\\tsclient\\*.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage and command line usage. query = " /* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */ sequence by host.id, user.name with maxspan=1m [process where event.type == "start" and process.name : "userinit.exe" and process.parent.name : "winlogon.exe"] [process where event.type == "start" and process.name : "explorer.exe"] [process where event.type == "start" and process.parent.name : "explorer.exe" and /* add suspicious programs here */ process.pe.original_file_name in ("cscript.exe", "wscript.exe", "PowerShell.EXE", "MSHTA.EXE", "RUNDLL32.EXE", "REGSVR32.EXE", "RegAsm.exe", "MSBuild.exe", "InstallUtil.exe") and /* add potential suspicious paths here */ process.args : ("C:\\Users\\*", "C:\\ProgramData\\*", "C:\\Windows\\Temp\\*", "C:\\Windows\\Tasks\\*", "C:\\PerfLogs\\*", "C:\\Intel\\*") ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies execution of the Apple script interpreter (osascript) without a password prompt and with administrator privileges. query = " process where event.type in ("start", "process_started") and process.name : "osascript" and process.command_line : "osascript*with administrator privileges" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies execution of the security_authtrampoline process via a scripting interpreter. This occurs when programs use AuthorizationExecute-WithPrivileges from the Security.framework to run another program with root privileges. It should not be run by itself, as this is a sign of execution with explicit logon credentials. query = " event.category:process and event.type:(start or process_started) and process.name:"security_authtrampoline" and process.parent.name:(osascript or com.apple.automator.runner or sh or bash or dash or zsh or python* or Python or perl* or php* or ruby or pwsh) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.004" name = "Elevated Execution with Prompt" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies execution via MSSQL xp_cmdshell stored procedure. Malicious users may attempt to elevate their privileges by using xp_cmdshell, which is disabled by default, thus, it's important to review the context of it's use. query = " process where event.type == "start" and process.name : "cmd.exe" and process.parent.name : "sqlservr.exe" and not process.args : ("\\\\*", "diskfree", "rmdir", "mkdir", "dir", "del", "rename", "bcp", "*XMLNAMESPACES*", "?:\\MSSQL\\Backup\\Jobs\\sql_agent_backup_job.ps1", "K:\\MSSQL\\Backup\\msdb", "K:\\MSSQL\\Backup\\Logins") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies file permission modifications in common writable directories by a non-root user. Adversaries often drop files or payloads into a writable directory and change permissions prior to execution. false_positives = [ Certain programs or applications may modify files or change ownership in writable directories. These can be exempted by username., ] query = " event.category:process and event.type:(start or process_started) and process.name:(chmod or chown or chattr or chgrp) and process.working_directory:(/tmp or /var/tmp or /dev/shm) and not user.name:root " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1222" name = "File and Directory Permissions Modification" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies files written or modified in the startup folder by unsigned processes. Adversaries may abuse this technique to maintain persistence in an environment. query = " sequence by host.id, process.entity_id with maxspan=5s [process where event.type == "start" and process.code_signature.trusted == false and /* suspicious paths can be added here */ process.executable : ("C:\\Users\\*.exe", "C:\\ProgramData\\*.exe", "C:\\Windows\\Temp\\*.exe", "C:\\Windows\\Tasks\\*.exe", "C:\\Intel\\*.exe", "C:\\PerfLogs\\*.exe") ] [file where event.type != "deletion" and user.domain != "NT AUTHORITY" and file.path : ("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*", "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\*") ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies files written to or modified in the startup folder by commonly abused processes. Adversaries may use this technique to maintain persistence. query = " file where event.type != "deletion" and user.domain != "NT AUTHORITY" and file.path : ("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*", "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\*") and process.name : ("cmd.exe", "powershell.exe", "wmic.exe", "mshta.exe", "pwsh.exe", "cscript.exe", "wscript.exe", "regsvr32.exe", "RegAsm.exe", "rundll32.exe", "EQNEDT32.EXE", "WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "MSPUB.EXE", "MSACCESS.EXE", "iexplore.exe", "InstallUtil.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies handle requests for the Local Security Authority Subsystem Service (LSASS) object access with specific access masks that many tools with a capability to dump memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is tool agnostic as it has been validated against a host of various LSASS dump tools such as SharpDump, Procdump, Mimikatz, Comsvcs etc. It detects this behavior at a low level and does not depend on a specific tool or dump file name. query = " any where event.action == "File System" and event.code == "4656" and winlog.event_data.ObjectName : ( "?:\\Windows\\System32\\lsass.exe", "\\Device\\HarddiskVolume?\\Windows\\System32\\lsass.exe", "\\Device\\HarddiskVolume??\\Windows\\System32\\lsass.exe") and /* The right to perform an operation controlled by an extended access right. */ (winlog.event_data.AccessMask : ("0x1fffff" , "0x1010", "0x120089", "0x1F3FFF") or winlog.event_data.AccessMaskDescription : ("READ_CONTROL", "Read from process memory")) /* Common Noisy False Positives */ and not winlog.event_data.ProcessName : ( "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Windows\\system32\\wbem\\WmiPrvSE.exe", "?:\\Windows\\System32\\dllhost.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\msiexec.exe", "?:\\ProgramData\\Microsoft\\Windows Defender\\*.exe", "?:\\Windows\\explorer.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies high risk Azure Active Directory (AD) sign-ins by leveraging Microsoft Identity Protection machine learning and heuristics. query = " event.dataset:azure.signinlogs and azure.signinlogs.properties.risk_state:("confirmedCompromised" or "atRisk") and event.outcome:(success or Success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies high risk Azure Active Directory (AD) sign-ins by leveraging Microsoft's Identity Protection machine learning and heuristics. Identity Protection categorizes risk into three tiers: low, medium, and high. While Microsoft does not provide specific details about how risk is calculated, each level brings higher confidence that the user or sign-in is compromised. query = " event.dataset:azure.signinlogs and (azure.signinlogs.properties.risk_level_during_signin:high or azure.signinlogs.properties.risk_level_aggregated:high) and event.outcome:(success or Success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is often leveraged by adversaries to execute code and evade detection. query = " /* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */ sequence by process.entity_id [process where event.type == "start" and process.name : "installutil.exe"] [network where process.name : "installutil.exe" and network.direction : ("outgoing", "egress")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.004" name = "InstallUtil" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies instances of an unusual process enumerating built-in Windows privileged local groups membership like Administrators or Remote Desktop users. query = " iam where event.action == "user-member-enumerated" and /* excluding machine account */ not winlog.event_data.SubjectUserName: ("*$", "LOCAL SERVICE", "NETWORK SERVICE") and /* noisy and usual legit processes excluded */ not winlog.event_data.CallerProcessName: ("-", "?:\\Windows\\System32\\VSSVC.exe", "?:\\Windows\\System32\\SearchIndexer.exe", "?:\\Windows\\System32\\CompatTelRunner.exe", "?:\\Windows\\System32\\oobe\\msoobe.exe", "?:\\Windows\\System32\\net1.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\Netplwiz.exe", "?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe", "?:\\Windows\\System32\\CloudExperienceHostBroker.exe", "?:\\Windows\\System32\\wbem\\WmiPrvSE.exe", "?:\\Windows\\System32\\SrTasks.exe", "?:\\Windows\\System32\\lsass.exe", "?:\\Windows\\System32\\diskshadow.exe", "?:\\Windows\\System32\\dfsrs.exe", "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\WindowsAzure\\*\\WaAppAgent.exe", "?:\\Windows\\System32\\vssadmin.exe", "?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe", "?:\\Windows\\System32\\dllhost.exe", "?:\\Windows\\System32\\mmc.exe", "?:\\Windows\\System32\\SettingSyncHost.exe", "?:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe", "?:\\Windows\\System32\\SystemSettingsAdminFlows.exe", "?:\\Windows\\Temp\\rubrik_vmware???\\snaptool.exe", "?:\\Windows\\System32\\inetsrv\\w3wp.exe", "?:\\$WINDOWS.~BT\\Sources\\*.exe", "?:\\Windows\\System32\\wsmprovhost.exe", "?:\\Windows\\System32\\spool\\drivers\\x64\\3\\x3jobt3?.exe", "?:\\Windows\\System32\\mstsc.exe", "?:\\Windows\\System32\\esentutl.exe", "?:\\Windows\\System32\\RecoveryDrive.exe", "?:\\Windows\\System32\\SystemPropertiesComputerName.exe") and /* privileged local groups */ (group.name:("admin*","RemoteDesktopUsers") or winlog.event_data.TargetSid:("S-1-5-32-544","S-1-5-32-555")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1069" name = "Permission Groups Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1069.001" name = "Local Groups" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) making unusual network connections. Adversaries could abuse Internet Explorer via COM to avoid suspicious processes making network connections and bypass host-based firewall restrictions. false_positives = ["Processes such as MS Office using IEproxy to render HTML content."] query = " sequence by host.id, user.name with maxspan = 5s [library where dll.name : "IEProxy.dll" and process.name : ("rundll32.exe", "regsvr32.exe")] [process where event.type == "start" and process.parent.name : "iexplore.exe" and process.parent.args : "-Embedding"] /* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */ [network where network.protocol == "dns" and process.name : "iexplore.exe" and not dns.question.name : ( "*.microsoft.com", "*.digicert.com", "*.msocsp.com", "*.windowsupdate.com", "*.bing.com", "*.identrust.com", "*.sharepoint.com", "*.office365.com", "*.office.com" ) ] /* with runs=5 */ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1559" name = "Inter-Process Communication" reference = [[rule.threat.technique.subtechnique]] id = "T1559.001" name = "Component Object Model" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windows tools. query = " process where event.type == "start" and (((process.name : "net.exe" or process.pe.original_file_name == "net.exe") or ((process.name : "net1.exe" or process.pe.original_file_name == "net1.exe") and not process.parent.name : "net.exe")) and process.args : ("group", "user", "localgroup") and process.args : ("admin", "Domain Admins", "Remote Desktop Users", "Enterprise Admins", "Organization Management") and not process.args : "/add") or ((process.name : "wmic.exe" or process.pe.original_file_name == "wmic.exe") and process.args : ("group", "useraccount")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1069" name = "Permission Groups Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1069.002" name = "Domain Groups" reference = [[rule.threat.technique]] id = "T1087" name = "Account Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies Linux binary(s) abuse to breakout of restricted shells or environments by spawning an interactive system shell. The linux utility(s) activity of spawning shell is not a standard use of the binary for a user or system administrator. It may indicates an attempt to improve the capabilities or stability of an adversary access. query = " process where event.type == "start" and /* launch shells from unusual process */ (process.name == "capsh" and process.args == "--") or /* launching shells from unusual parents or parent+arg combos */ (process.name in ("bash", "sh", "dash","ash") and (process.parent.name in ("byebug","git","ftp","strace")) or /* shells specified in parent args */ /* nice rule is broken in 8.2 */ (process.parent.args in ("/bin/sh", "/bin/bash", "/bin/dash", "/bin/ash", "sh", "bash", "dash", "ash") and ( (process.parent.name == "nice") or (process.parent.name == "cpulimit" and process.parent.args == "-f") or (process.parent.name == "find" and process.parent.args == "-exec" and process.parent.args == ";") or (process.parent.name == "flock" and process.parent.args == "-u" and process.parent.args == "/") ) ) or /* shells specified in args */ (process.args in ("/bin/sh", "/bin/bash", "/bin/dash", "/bin/ash", "sh", "bash", "dash", "ash") and (process.parent.name == "crash" and process.parent.args == "-h") or (process.name == "sensible-pager" and process.parent.name in ("apt", "apt-get") and process.parent.args == "changelog") /* scope to include more sensible-pager invoked shells with different parent process to reduce noise and remove false positives */ ) ) or (process.name == "busybox" and process.args_count == 2 and process.args in ("/bin/sh", "/bin/bash", "/bin/dash", "/bin/ash", "sh", "bash", "dash", "ash") )or (process.name == "env" and process.args_count == 2 and process.args in ("/bin/sh", "/bin/bash", "/bin/dash", "/bin/ash", "sh", "bash", "dash", "ash")) or (process.parent.name in ("vi", "vim") and process.parent.args == "-c" and process.parent.args in (":!/bin/bash", ":!/bin/sh", ":!bash", ":!sh")) or (process.parent.name in ("c89","c99", "gcc") and process.parent.args in ("sh,-s", "bash,-s", "dash,-s", "ash,-s", "/bin/sh,-s", "/bin/bash,-s", "/bin/dash,-s", "/bin/ash,-s") and process.parent.args == "-wrapper") or (process.parent.name == "expect" and process.parent.args == "-c" and process.parent.args in ("spawn /bin/sh;interact", "spawn /bin/bash;interact", "spawn /bin/dash;interact", "spawn sh;interact", "spawn bash;interact", "spawn dash;interact")) or (process.parent.name == "mysql" and process.parent.args == "-e" and process.parent.args in ("\\!*sh", "\\!*bash", "\\!*dash", "\\!*/bin/sh", "\\!*/bin/bash", "\\!*/bin/dash")) or (process.parent.name == "ssh" and process.parent.args == "-o" and process.parent.args in ("ProxyCommand=;sh 0<&2 1>&2", "ProxyCommand=;bash 0<&2 1>&2", "ProxyCommand=;dash 0<&2 1>&2", "ProxyCommand=;/bin/sh 0<&2 1>&2", "ProxyCommand=;/bin/bash 0<&2 1>&2", "ProxyCommand=;/bin/dash 0<&2 1>&2")) or (process.parent.name in ("nawk", "mawk", "awk", "gawk") and process.parent.args : "BEGIN {system(*)}") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.004" name = "Unix Shell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies LSASS loading an unsigned or untrusted DLL. Windows Security Support Provider (SSP) DLLs are loaded into LSSAS process at system start. Once loaded into the LSA, SSP DLLs have access to encrypted and plaintext passwords that are stored in Windows, such as any logged-on user's Domain password or smart card PINs. query = " library where process.executable : "?:\\Windows\\System32\\lsass.exe" and not (dll.code_signature.subject_name : ("Microsoft Windows", "Microsoft Corporation", "Microsoft Windows Publisher", "Microsoft Windows Software Compatibility Publisher", "Microsoft Windows Hardware Compatibility Publisher", "McAfee, Inc.", "SecMaker AB", "HID Global Corporation", "HID Global", "Apple Inc.", "Citrix Systems, Inc.", "Dell Inc", "Hewlett-Packard Company", "Symantec Corporation", "National Instruments Corporation", "DigitalPersona, Inc.", "Novell, Inc.", "gemalto", "EasyAntiCheat Oy", "Entrust Datacard Corporation", "AuriStor, Inc.", "LogMeIn, Inc.", "VMware, Inc.", "Istituto Poligrafico e Zecca dello Stato S.p.A.", "Nubeva Technologies Ltd", "Micro Focus (US), Inc.", "Yubico AB", "GEMALTO SA", "Secure Endpoints, Inc.", "Sophos Ltd", "Morphisec Information Security 2014 Ltd", "Entrust, Inc.", "Nubeva Technologies Ltd", "Micro Focus (US), Inc.", "F5 Networks Inc", "Bit4id", "Thales DIS CPL USA, Inc.", "Micro Focus International plc", "HYPR Corp", "Intel(R) Software Development Products", "PGP Corporation", "Parallels International GmbH", "FrontRange Solutions Deutschland GmbH", "SecureLink, Inc.", "Tidexa OU", "Amazon Web Services, Inc.", "SentryBay Limited", "Audinate Pty Ltd", "CyberArk Software Ltd.", "McAfeeSysPrep", "NVIDIA Corporation PE Sign v2016") and dll.code_signature.status : ("trusted", "errorExpired", "errorCode_endpoint*", "errorChaining")) and not dll.hash.sha256 : ("811a03a5d7c03802676d2613d741be690b3461022ea925eb6b2651a5be740a4c", "1181542d9cfd63fb00c76242567446513e6773ea37db6211545629ba2ecf26a1", "ed6e735aa6233ed262f50f67585949712f1622751035db256811b4088c214ce3", "26be2e4383728eebe191c0ab19706188f0e9592add2e0bf86b37442083ae5e12", "9367e78b84ef30cf38ab27776605f2645e52e3f6e93369c674972b668a444faa", "d46cc934765c5ecd53867070f540e8d6f7701e834831c51c2b0552aba871921b", "0f77a3826d7a5cd0533990be0269d951a88a5c277bc47cff94553330b715ec61", "4aca034d3d85a9e9127b5d7a10882c2ef4c3e0daa3329ae2ac1d0797398695fb", "86031e69914d9d33c34c2f4ac4ae523cef855254d411f88ac26684265c981d95") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies modification of the dynamic linker preload shared object (ld.so.preload). Adversaries may execute malicious payloads by hijacking the dynamic linker used to load libraries. query = " event.category:file and not event.type:deletion and file.path:/etc/ld.so.preload " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.006" name = "Dynamic Linker Hijacking" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies modification of the Time Provider. Adversaries may establish persistence by registering and enabling a malicious DLL as a time provider. Windows uses the time provider architecture to obtain accurate time stamps from other network devices or clients in the network. Time providers are implemented in the form of a DLL file which resides in the System32 folder. The service W32Time initiates during the startup of Windows and loads w32time.dll. query = " registry where event.type:"change" and registry.path:"HKLM\\SYSTEM\\*ControlSet*\\Services\\W32Time\\TimeProviders\\*" and registry.data.strings:"*.dll" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.003" name = "Time Providers" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies modifications of the AmsiEnable registry key to 0, which disables the Antimalware Scan Interface (AMSI). An adversary can modify this key to disable AMSI protections. query = " registry where event.type in ("creation", "change") and registry.path : ( "HKEY_USERS\\*\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable", "HKU\\*\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable", "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable" ) and registry.data.strings: ("0", "0x00000000") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies modifications to a Key Vault in Azure. The Key Vault is a service that safeguards encryption keys and secrets like certificates, connection strings, and passwords. Because this data is sensitive and business critical, access to key vaults should be secured to allow only authorized applications and users. false_positives = [ Key vault modifications may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Key vault modifications from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.KEYVAULT/VAULTS/WRITE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1552" name = "Unsecured Credentials" reference = [[rule.threat.technique.subtechnique]] id = "T1552.001" name = "Credentials In Files" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies modifications to an environment variable using the built-in launchctl command. Adversaries may execute their own malicious payloads by hijacking certain environment variables to load arbitrary libraries or bypass certain restrictions. query = " event.category:process and event.type:start and process.name:launchctl and process.args:(setenv and not (JAVA*_HOME or RUNTIME_JAVA_HOME or DBUS_LAUNCHD_SESSION_BUS_SOCKET or ANT_HOME or LG_WEBOS_TV_SDK_HOME or WEBOS_CLI_TV or EDEN_ENV) ) and not process.parent.executable:("/Applications/NoMachine.app/Contents/Frameworks/bin/nxserver.bin" or "/usr/local/bin/kr" or "/Applications/NoMachine.app/Contents/Frameworks/bin/nxserver.bin" or "/Applications/IntelliJ IDEA CE.app/Contents/jbr/Contents/Home/lib/jspawnhelper") and not process.args : "*.vmoptions" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.007" name = "Path Interception by PATH Environment Variable" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies modifications to the Atom desktop text editor Init File. Adversaries may add malicious JavaScript code to the init.coffee file that will be executed upon the Atom application opening. query = " event.category:"file" and not event.type:"deletion" and file.path:/Users/*/.atom/init.coffee and not process.name:(Atom or xpcproxy) and not user.name:root " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1037" name = "Boot or Logon Initialization Scripts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the Windows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signature validation checks or inject code into critical processes. query = " registry where event.type:"change" and registry.path: ( "*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType 0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll", "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType 0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll", "*\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll", "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll" ) and registry.data.strings:"*.dll" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1553" name = "Subvert Trust Controls" reference = [[rule.threat.technique.subtechnique]] id = "T1553.003" name = "SIP and Trust Provider Hijacking" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies modifications to the root crontab file. Adversaries may overwrite this file to gain code execution with root privileges by exploiting privileged file write or move related vulnerabilities. query = " event.category:file and not event.type:deletion and file.path:/private/var/at/tabs/root and not process.executable:/usr/bin/crontab " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.003" name = "Cron" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folder directory or process level. query = " process where event.type == "start" and (process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or process.pe.original_file_name in ("powershell.exe", "pwsh.dll", "powershell_ise.exe")) and process.args : ("*Add-MpPreference*", "*Set-MpPreference*") and process.args : ("*-Exclusion*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [[rule.threat.technique.subtechnique]] id = "T1562.006" name = "Indicator Blocking" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies modifications to the Windows Defender registry settings to disable the service or set the service to be started manually. query = " registry where event.type in ("creation", "change") and ( ( registry.path: ( "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware", "\\REGISTRY\\MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware" ) and registry.data.strings: ("1", "0x00000001") ) or ( registry.path: ( "HKLM\\System\\*ControlSet*\\Services\\WinDefend\\Start", "\\REGISTRY\\MACHINE\\System\\*ControlSet*\\Services\\WinDefend\\Start" ) and registry.data.strings in ("3", "4", "0x00000003", "0x00000004") ) ) and not process.executable : ("?:\\WINDOWS\\system32\\services.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Program Files (x86)\\Trend Micro\\Security Agent\\NTRmv.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [[rule.threat.technique.subtechnique]] id = "T1562.006" name = "Indicator Blocking" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is often leveraged by adversaries to execute code and evade detection. query = " /* duplicate of MsBuild Making Network Connections - 0e79980b-4250-4a50-a509-69294c14e84b */ sequence by process.entity_id [process where event.type == "start" and process.name : "MSBuild.exe"] [network where process.name : "MSBuild.exe" and not (destination.ip == "127.0.0.1" and source.ip == "127.0.0.1")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1127.001" name = "MSBuild" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is often leveraged by adversaries to execute code and evade detection. query = " sequence by process.entity_id [process where process.name : "MSBuild.exe" and event.type == "start"] [network where process.name : "MSBuild.exe" and not cidrmatch(destination.ip, "127.0.0.1", "::1")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1127.001" name = "MSBuild" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is often leveraged by adversaries to execute malicious scripts and evade detection. query = " sequence by process.entity_id with maxspan=10m [process where event.type == "start" and process.name : "mshta.exe" and not process.parent.name : "Microsoft.ConfigurationManagement.exe" and not (process.parent.executable : "C:\\Amazon\\Amazon Assistant\\amazonAssistantService.exe" or process.parent.executable : "C:\\TeamViewer\\TeamViewer.exe") and not process.args : "ADSelfService_Enroll.hta"] [network where process.name : "mshta.exe"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.005" name = "Mshta" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged by adversaries to execute malicious scripts and evade detection. query = " sequence by process.entity_id [process where process.name : "msxsl.exe" and event.type == "start"] [network where process.name : "msxsl.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1220" name = "XSL Script Processing" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies MsXsl.exe making outbound network connections. This may indicate adversarial activity as MsXsl is often leveraged by adversaries to execute malicious scripts and evade detection. query = " /* duplicate of Network Connection via MsXsl - b86afe07-0d98-4738-b15d-8d7465f95ff5 */ sequence by process.entity_id [process where event.type == "start" and process.name : "msxsl.exe"] [network where process.name : "msxsl.exe" and network.direction : ("outgoing", "egress")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1220" name = "XSL Script Processing" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies multiple consecutive login failures targeting a root user account from the same source address and within a short time interval. Adversaries will often brute force login attempts on privileged accounts with a common or known password, in an attempt to gain privileged access to systems. query = " sequence by host.id, source.ip with maxspan=10s [authentication where event.action in ("ssh_login", "user_login") and event.outcome == "failure" and source.ip != null and source.ip != "0.0.0.0" and source.ip != "::" and user.name in ("*root*" , "*admin*")] with runs=3 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [[rule.threat.technique.subtechnique]] id = "T1110.001" name = "Password Guessing" reference = [[rule.threat.technique.subtechnique]] id = "T1110.003" name = "Password Spraying" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies multiple consecutive login failures targeting an user account from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts. query = " sequence by host.id, source.ip, user.name with maxspan=10s [authentication where event.action in ("ssh_login", "user_login") and event.outcome == "failure" and source.ip != null and source.ip != "0.0.0.0" and source.ip != "::" ] with runs=10 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [[rule.threat.technique.subtechnique]] id = "T1110.001" name = "Password Guessing" reference = [[rule.threat.technique.subtechnique]] id = "T1110.003" name = "Password Spraying" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies multiple consecutive logon failures from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts. query = " sequence by winlog.computer_name, source.ip with maxspan=10s [authentication where event.action == "logon-failed" and /* event 4625 need to be logged */ winlog.logon.type : "Network" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" and not user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT AUTHORITY" and /* noisy failure status codes often associated to authentication misconfiguration : 0xC000015B - The user has not been granted the requested logon type (also called the logon right) at this machine. 0XC000005E - There are currently no logon servers available to service the logon request. 0XC0000133 - Clocks between DC and other computer too far out of sync. 0XC0000192 An attempt was made to logon, but the Netlogon service was not started. */ not winlog.event_data.Status : ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with runs=10 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [[rule.threat.technique.subtechnique]] id = "T1110.001" name = "Password Guessing" reference = [[rule.threat.technique.subtechnique]] id = "T1110.003" name = "Password Spraying" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts. query = " sequence by winlog.computer_name, source.ip with maxspan=10s [authentication where event.action == "logon-failed" and winlog.logon.type : "Network" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" and user.name : "*admin*" and /* noisy failure status codes often associated to authentication misconfiguration */ not winlog.event_data.Status : ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with runs=5 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [[rule.threat.technique.subtechnique]] id = "T1110.001" name = "Password Guessing" reference = [[rule.threat.technique.subtechnique]] id = "T1110.003" name = "Password Spraying" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies multiple logon failures followed by a successful one from the same source address. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts. query = " sequence by winlog.computer_name, source.ip with maxspan=5s [authentication where event.action == "logon-failed" and /* event 4625 need to be logged */ winlog.logon.type : "Network" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" and not user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT AUTHORITY" and /* noisy failure status codes often associated to authentication misconfiguration */ not winlog.event_data.Status : ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with runs=5 [authentication where event.action == "logged-in" and /* event 4624 need to be logged */ winlog.logon.type : "Network" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" and not user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT AUTHORITY"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [[rule.threat.technique.subtechnique]] id = "T1110.001" name = "Password Guessing" reference = [[rule.threat.technique.subtechnique]] id = "T1110.003" name = "Password Spraying" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies multiple SSH login failures followed by a successful one from the same source address. Adversaries can attempt to login into multiple users with a common or known password to gain access to accounts. query = " sequence by host.id, source.ip, user.name with maxspan=3s [authentication where event.action in ("ssh_login", "user_login") and event.outcome == "failure" and source.ip != null and source.ip != "0.0.0.0" and source.ip != "::" ] with runs=2 [authentication where event.action in ("ssh_login", "user_login") and event.outcome == "success" and source.ip != null and source.ip != "0.0.0.0" and source.ip != "::" ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [[rule.threat.technique.subtechnique]] id = "T1110.001" name = "Password Guessing" reference = [[rule.threat.technique.subtechnique]] id = "T1110.003" name = "Password Spraying" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation Provider Service (WMIPrvSE). query = " process where event.type == "start" and process.name: ( "arp.exe", "dsquery.exe", "dsget.exe", "gpresult.exe", "hostname.exe", "ipconfig.exe", "nbtstat.exe", "net.exe", "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "ping.exe", "qprocess.exe", "quser.exe", "qwinsta.exe", "reg.exe", "sc.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe", "whoami.exe" ) and process.parent.name:"wmiprvse.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1047" name = "Windows Management Instrumentation" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1018" name = "Remote System Discovery" reference = [[rule.threat.technique]] id = "T1087" name = "Account Discovery" reference = [[rule.threat.technique]] id = "T1518" name = "Software Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection. query = " sequence by process.entity_id with maxspan=5m [process where event.type == "start" and /* known applocker bypasses */ (process.name : "bginfo.exe" or process.name : "cdb.exe" or process.name : "control.exe" or process.name : "cmstp.exe" or process.name : "csi.exe" or process.name : "dnx.exe" or process.name : "fsi.exe" or process.name : "ieexec.exe" or process.name : "iexpress.exe" or process.name : "installutil.exe" or process.name : "Microsoft.Workflow.Compiler.exe" or process.name : "MSBuild.exe" or process.name : "msdt.exe" or process.name : "mshta.exe" or process.name : "msiexec.exe" or process.name : "msxsl.exe" or process.name : "odbcconf.exe" or process.name : "rcsi.exe" or process.name : "regsvr32.exe" or process.name : "xwizard.exe")] [network where (process.name : "bginfo.exe" or process.name : "cdb.exe" or process.name : "control.exe" or process.name : "cmstp.exe" or process.name : "csi.exe" or process.name : "dnx.exe" or process.name : "fsi.exe" or process.name : "ieexec.exe" or process.name : "iexpress.exe" or process.name : "installutil.exe" or process.name : "Microsoft.Workflow.Compiler.exe" or process.name : "MSBuild.exe" or process.name : "msdt.exe" or process.name : "mshta.exe" or process.name : "msiexec.exe" or process.name : "msxsl.exe" or process.name : "odbcconf.exe" or process.name : "rcsi.exe" or process.name : "regsvr32.exe" or process.name : "xwizard.exe")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection. query = " sequence by process.entity_id [process where (process.name : "Microsoft.Workflow.Compiler.exe" or process.name : "bginfo.exe" or process.name : "cdb.exe" or process.name : "cmstp.exe" or process.name : "csi.exe" or process.name : "dnx.exe" or process.name : "fsi.exe" or process.name : "ieexec.exe" or process.name : "iexpress.exe" or process.name : "odbcconf.exe" or process.name : "rcsi.exe" or process.name : "xwizard.exe") and event.type == "start"] [network where (process.name : "Microsoft.Workflow.Compiler.exe" or process.name : "bginfo.exe" or process.name : "cdb.exe" or process.name : "cmstp.exe" or process.name : "csi.exe" or process.name : "dnx.exe" or process.name : "fsi.exe" or process.name : "ieexec.exe" or process.name : "iexpress.exe" or process.name : "odbcconf.exe" or process.name : "rcsi.exe" or process.name : "xwizard.exe")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1127" name = "Trusted Developer Utilities Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies network connections to the standard Kerberos port from an unusual process. On Windows, the only process that normally performs Kerberos traffic from a domain joined host is lsass.exe. false_positives = [ HTTP traffic on a non standard port. Verify that the destination IP address is not related to a Domain Controller., ] query = " network where event.type == "start" and network.direction : ("outgoing", "egress") and destination.port == 88 and source.port >= 49152 and process.pid != 4 and not process.executable : ("?:\\Windows\\System32\\lsass.exe", "System", "?:\\Windows\\System32\\svchost.exe", "?:\\Program Files\\Puppet Labs\\Puppet\\puppet\\bin\\ruby.exe", "\\device\\harddiskvolume?\\windows\\system32\\lsass.exe", "?:\\Program Files\\rapid7\\nexpose\\nse\\.DLLCACHE\\nseserv.exe", "?:\\Program Files (x86)\\GFI\\LanGuard 12 Agent\\lnsscomm.exe", "?:\\Program Files (x86)\\SuperScan\\scanner.exe", "?:\\Program Files (x86)\\Nmap\\nmap.exe", "?:\\Program Files\\Tenable\\Nessus\\nessusd.exe", "\\device\\harddiskvolume?\\program files (x86)\\nmap\\nmap.exe", "?:\\Program Files\\Docker\\Docker\\resources\\vpnkit.exe", "?:\\Program Files\\Docker\\Docker\\resources\\com.docker.vpnkit.exe", "?:\\Program Files\\VMware\\VMware View\\Server\\bin\\ws_TomcatService.exe", "?:\\Program Files (x86)\\DesktopCentral_Agent\\bin\\dcpatchscan.exe", "\\device\\harddiskvolume?\\program files (x86)\\nmap oem\\nmap.exe", "?:\\Program Files (x86)\\Nmap OEM\\nmap.exe", "?:\\Program Files (x86)\\Zscaler\\ZSATunnel\\ZSATunnel.exe", "?:\\Program Files\\JetBrains\\PyCharm Community Edition*\\bin\\pycharm64.exe", "?:\\Program Files (x86)\\Advanced Port Scanner\\advanced_port_scanner.exe", "?:\\Program Files (x86)\\nwps\\NetScanTools Pro\\NSTPRO.exe", "?:\\Program Files\\BlackBerry\\UEM\\Proxy Server\\bin\\prunsrv.exe", "?:\\Program Files (x86)\\Microsoft Silverlight\\sllauncher.exe", "?:\\Windows\\System32\\MicrosoftEdgeCP.exe", "?:\\Windows\\SystemApps\\Microsoft.MicrosoftEdge_*\\MicrosoftEdge.exe", "?:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe", "?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", "?:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe", "?:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "?:\\Program Files\\Mozilla Firefox\\firefox.exe", "?:\\Program Files\\Internet Explorer\\iexplore.exe", "?:\\Program Files (x86)\\Internet Explorer\\iexplore.exe" ) and destination.address != "127.0.0.1" and destination.address != "::1" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies NullSessionPipe registry modifications that specify which pipes can be accessed anonymously. This could be indicative of adversary lateral movement preparation by making the added pipe available to everyone. query = " registry where event.type in ("creation", "change") and registry.path : "HKLM\\SYSTEM\\*ControlSet*\\services\\LanmanServer\\Parameters\\NullSessionPipes" and length(registry.data.strings) > 0 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies parent process spoofing used to create an elevated child process. Adversaries may spoof the parent process identifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges. query = " /* This rule is compatible with Elastic Endpoint only */ process where event.action == "start" and /* process creation via seclogon */ process.parent.Ext.real.pid > 0 and /* PrivEsc to SYSTEM */ user.id : "S-1-5-18" and /* Common FPs - evasion via hollowing is possible, should be covered by code injection */ not process.executable : ("?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWOW64\\WerFault.exe", "?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\Windows\\SysWOW64\\WerFaultSecure.exe", "?:\\Windows\\System32\\Wermgr.exe", "?:\\Windows\\SysWOW64\\Wermgr.exe", "?:\\Windows\\SoftwareDistribution\\Download\\Install\\securityhealthsetup.exe") and not process.parent.executable : "?:\\Windows\\System32\\AtBroker.exe" and not (process.code_signature.subject_name in ("philandro Software GmbH", "Freedom Scientific Inc.", "TeamViewer Germany GmbH", "Projector.is, Inc.", "TeamViewer GmbH", "Cisco WebEx LLC", "Dell Inc") and process.code_signature.trusted == true) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1134.002" name = "Create Process with Token" reference = [[rule.threat.technique.subtechnique]] id = "T1134.004" name = "Parent PID Spoofing" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies parent process spoofing used to thwart detection. Adversaries may spoof the parent process identifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges. query = " /* This rule is compatible with Elastic Endpoint only */ sequence by host.id, user.id with maxspan=3m [process where event.type == "start" and process.Ext.token.integrity_level_name != "system" and ( process.pe.original_file_name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe", "eqnedt32.exe", "fltldr.exe", "mspub.exe", "msaccess.exe", "powershell.exe", "pwsh.exe", "cscript.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "msbuild.exe", "mshta.exe", "wmic.exe", "cmstp.exe", "msxsl.exe") or (process.executable : ("?:\\Users\\*.exe", "?:\\ProgramData\\*.exe", "?:\\Windows\\Temp\\*.exe", "?:\\Windows\\Tasks\\*") and (process.code_signature.exists == false or process.code_signature.status : "errorBadDigest")) or process.executable : "?:\\Windows\\Microsoft.NET\\*.exe" ) and not process.executable : ("?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\WINDOWS\\SysWOW64\\WerFaultSecure.exe", "?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWOW64\\WerFault.exe") ] by process.pid [process where event.type == "start" and process.parent.Ext.real.pid > 0 and /* process.parent.Ext.real.pid is only populated if the parent process pid doesn't match */ not (process.name : "msedge.exe" and process.parent.name : "sihost.exe") and not process.executable : ("?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\WINDOWS\\SysWOW64\\WerFaultSecure.exe", "?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWOW64\\WerFault.exe") ] by process.parent.Ext.real.pid " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1134.004" name = "Parent PID Spoofing" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies port monitor and print processor registry modifications. Adversaries may abuse port monitor and print processors to run malicious DLLs during system boot that will be executed as SYSTEM for privilege escalation and/or persistence, if permissions allow writing a fully-qualified pathname for that DLL. query = " registry where event.type in ("creation", "change") and registry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\Print\\Monitors\\*", "HKLM\\SYSTEM\\*ControlSet*\\Control\\Print\\Environments\\Windows*\\Print Processors\\*") and registry.data.strings : "*.dll" and /* exclude SYSTEM SID - look for changes by non-SYSTEM user */ not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.010" name = "Port Monitors" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.010" name = "Port Monitors" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies potential abuse of the Microsoft Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious command or binary execution via malicious process arguments. query = " process where event.type == "start" and (process.pe.original_file_name == "msdt.exe" or process.name : "msdt.exe") and ( process.args : ("IT_RebrowseForFile=*", "ms-msdt:/id", "ms-msdt:-id", "*FromBase64*") or (process.args : "-af" and process.args : "/skip" and process.parent.name : ("explorer.exe", "cmd.exe", "powershell.exe", "cscript.exe", "wscript.exe", "mshta.exe", "rundll32.exe", "regsvr32.exe") and process.args : ("?:\\WINDOWS\\diagnostics\\index\\PCWDiagnostic.xml", "PCWDiagnostic.xml", "?:\\Users\\Public\\*", "?:\\Windows\\Temp\\*")) or (process.pe.original_file_name == "msdt.exe" and not process.name : "msdt.exe" and process.name != null) or (process.pe.original_file_name == "msdt.exe" and not process.executable : ("?:\\Windows\\system32\\msdt.exe", "?:\\Windows\\SysWOW64\\msdt.exe")) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies potential attempts to disable Security-Enhanced Linux (SELinux), which is a Linux kernel security feature to support access control policies. Adversaries may disable security tools to avoid possible detection of their tools and activities. query = " event.category:process and event.type:(start or process_started) and process.name:setenforce and process.args:0 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies potential behavior of SharpRDP, which is a tool that can be used to perform authenticated command execution against a remote target via Remote Desktop Protocol (RDP) for the purposes of lateral movement. query = " /* Incoming RDP followed by a new RunMRU string value set to cmd, powershell, taskmgr or tsclient, followed by process execution within 1m */ sequence by host.id with maxspan=1m [network where event.type == "start" and process.name : "svchost.exe" and destination.port == 3389 and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.ip != "127.0.0.1" and source.ip != "::1" ] [registry where process.name : "explorer.exe" and registry.path : ("HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU\\*") and registry.data.strings : ("cmd.exe*", "powershell.exe*", "taskmgr*", "\\\\tsclient\\*.exe\\*") ] [process where event.type == "start" and (process.parent.name : ("cmd.exe", "powershell.exe", "taskmgr.exe") or process.args : ("\\\\tsclient\\*.exe")) and not process.name : "conhost.exe" ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.001" name = "Remote Desktop Protocol" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies potential full network packet capture in Azure. Packet Capture is an Azure Network Watcher feature that can be used to inspect network traffic. This feature can potentially be abused to read sensitive data from unencrypted internal traffic. false_positives = [ Full Network Packet Capture may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Full Network Packet Capture from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name: ( "MICROSOFT.NETWORK/*/STARTPACKETCAPTURE/ACTION" or "MICROSOFT.NETWORK/*/VPNCONNECTIONS/STARTPACKETCAPTURE/ACTION" or "MICROSOFT.NETWORK/*/PACKETCAPTURES/WRITE" ) and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1040" name = "Network Sniffing" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integrity level of SYSTEM. query = " process where event.type == "start" and process.parent.executable : "C:\\Windows\\System32\\svchost.exe" and process.parent.args : "UsoSvc" and not process.executable : ("?:\\ProgramData\\Microsoft\\Windows\\UUS\\Packages\\*\\amd64\\MoUsoCoreWorker.exe", "?:\\Windows\\System32\\UsoClient.exe", "?:\\Windows\\System32\\MusNotification.exe", "?:\\Windows\\System32\\MusNotificationUx.exe", "?:\\Windows\\System32\\MusNotifyIcon.exe", "?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\System32\\WerMgr.exe", "?:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe", "?:\\Windows\\System32\\MoUsoCoreWorker.exe", "?:\\Windows\\UUS\\amd64\\UsoCoreWorker.exe", "?:\\Windows\\System32\\UsoCoreWorker.exe", "?:\\Program Files\\Common Files\\microsoft shared\\ClickToRun\\OfficeC2RClient.exe") and not process.name : ("MoUsoCoreWorker.exe", "OfficeC2RClient.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies potential Traffic Mirroring in an Amazon Elastic Compute Cloud (EC2) instance. Traffic Mirroring is an Amazon VPC feature that you can use to copy network traffic from an Elastic network interface. This feature can potentially be abused to exfiltrate sensitive data from unencrypted internal traffic. false_positives = [ Traffic Mirroring may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Traffic Mirroring from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(CreateTrafficMirrorFilter or CreateTrafficMirrorFilterRule or CreateTrafficMirrorSession or CreateTrafficMirrorTarget) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1020" name = "Automated Exfiltration" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1074" name = "Data Staged" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to enable routing of network packets that would otherwise not reach their intended destination. query = " process where event.type == "start" and /* RDP port and usual SSH tunneling related switches in command line */ process.args : "*:3389" and process.args : ("-L", "-P", "-R", "-pw", "-ssh") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1572" name = "Protocol Tunneling" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For example, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to the standard port a protocol uses to bypass filtering or muddle analysis/parsing of network data. false_positives = [ SSH over ports apart from the traditional port 22 is highly uncommon. This rule alerts the usage of the such uncommon ports by the ssh service. Tuning is needed to have higher confidence. If this activity is expected and noisy in your environment, consider adding exceptions  preferably with a combination whitelisted ports for such legitimate ssh activities., ] query = " sequence by process.entity_id with maxspan=1m [process where event.action == "exec" and process.name:"ssh"] [network where process.name:"ssh" and event.action in ("connection_attempted", "connection_accepted") and destination.port != 22 and destination.ip != "127.0.0.1" and network.transport: "tcp" ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1571" name = "Non-Standard Port" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies probable exploitation of the Web Proxy Auto-Discovery Protocol (WPAD) service. Attackers who have access to the local network or upstream DNS traffic can inject malicious JavaScript to the WPAD service which can lead to a full system compromise. query = " /* preference would be to use user.sid rather than domain+name, once it is available in ECS + datasources */ /* didn't trigger successfully during testing */ sequence with maxspan=5s [process where event.type == "start" and process.name : "svchost.exe" and user.domain : "NT AUTHORITY" and user.name : "LOCAL SERVICE"] by process.entity_id [network where network.protocol : "dns" and process.name : "svchost.exe" and dns.question.name : "wpad" and process.name : "svchost.exe"] by process.entity_id [network where process.name : "svchost.exe" and network.direction : ("outgoing", "egress") and destination.port == 80] by process.entity_id [library where event.type : "start" and process.name : "svchost.exe" and dll.name : "jscript.dll" and process.name : "svchost.exe"] by process.entity_id [process where event.type == "start" and process.parent.name : "svchost.exe"] by process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to escalate privileges and bypass access controls. query = " sequence by winlog.computer_name with maxspan=1m [authentication where event.action:"logged-in" and event.outcome == "success" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and /* seclogon service */ process.name == "svchost.exe" and winlog.event_data.LogonProcessName : "seclogo*" and source.ip == "::1" ] by winlog.event_data.TargetLogonId [process where event.type == "start"] by winlog.event_data.TargetLogonId " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1134.002" name = "Create Process with Token" reference = [[rule.threat.technique.subtechnique]] id = "T1134.003" name = "Make and Impersonate Token" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies process execution followed by a file overwrite of an executable by the same parent process. This may indicate an evasion attempt to execute malicious code in a stealthy way. query = " sequence with maxspan=5s [process where event.type == "start" and not process.parent.executable : ( "?:\\Windows\\SoftwareDistribution\\*.exe", "?:\\Program Files\\Elastic\\Agent\\data\\*.exe", "?:\\Program Files (x86)\\Trend Micro\\*.exe" ) ] by host.id, process.executable, process.parent.entity_id [file where event.type == "change" and event.action == "overwrite" and file.extension == "exe"] by host.id, file.path, process.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hide malware in trusted paths. query = " process where event.type == "start" and /* add suspicious execution paths here */ process.executable : ("C:\\PerfLogs\\*.exe","C:\\Users\\Public\\*.exe","C:\\Windows\\Tasks\\*.exe","C:\\Intel\\*.exe","C:\\AMD\\Temp\\*.exe","C:\\Windows\\AppReadiness\\*.exe", "C:\\Windows\\ServiceState\\*.exe","C:\\Windows\\security\\*.exe","C:\\Windows\\IdentityCRL\\*.exe","C:\\Windows\\Branding\\*.exe","C:\\Windows\\csc\\*.exe", "C:\\Windows\\DigitalLocker\\*.exe","C:\\Windows\\en-US\\*.exe","C:\\Windows\\wlansvc\\*.exe","C:\\Windows\\Prefetch\\*.exe","C:\\Windows\\Fonts\\*.exe", "C:\\Windows\\diagnostics\\*.exe","C:\\Windows\\TAPI\\*.exe","C:\\Windows\\INF\\*.exe","C:\\Windows\\System32\\Speech\\*.exe","C:\\windows\\tracing\\*.exe", "c:\\windows\\IME\\*.exe","c:\\Windows\\Performance\\*.exe","c:\\windows\\intel\\*.exe","c:\\windows\\ms\\*.exe","C:\\Windows\\dot3svc\\*.exe", "C:\\Windows\\panther\\*.exe","C:\\Windows\\RemotePackages\\*.exe","C:\\Windows\\OCR\\*.exe","C:\\Windows\\appcompat\\*.exe","C:\\Windows\\apppatch\\*.exe","C:\\Windows\\addins\\*.exe", "C:\\Windows\\Setup\\*.exe","C:\\Windows\\Help\\*.exe","C:\\Windows\\SKB\\*.exe","C:\\Windows\\Vss\\*.exe","C:\\Windows\\Web\\*.exe","C:\\Windows\\servicing\\*.exe","C:\\Windows\\CbsTemp\\*.exe", "C:\\Windows\\Logs\\*.exe","C:\\Windows\\WaaS\\*.exe","C:\\Windows\\ShellExperiences\\*.exe","C:\\Windows\\ShellComponents\\*.exe","C:\\Windows\\PLA\\*.exe", "C:\\Windows\\Migration\\*.exe","C:\\Windows\\debug\\*.exe","C:\\Windows\\Cursors\\*.exe","C:\\Windows\\Containers\\*.exe","C:\\Windows\\Boot\\*.exe","C:\\Windows\\bcastdvr\\*.exe", "C:\\Windows\\assembly\\*.exe","C:\\Windows\\TextInput\\*.exe","C:\\Windows\\security\\*.exe","C:\\Windows\\schemas\\*.exe","C:\\Windows\\SchCache\\*.exe","C:\\Windows\\Resources\\*.exe", "C:\\Windows\\rescache\\*.exe","C:\\Windows\\Provisioning\\*.exe","C:\\Windows\\PrintDialog\\*.exe","C:\\Windows\\PolicyDefinitions\\*.exe","C:\\Windows\\media\\*.exe", "C:\\Windows\\Globalization\\*.exe","C:\\Windows\\L2Schemas\\*.exe","C:\\Windows\\LiveKernelReports\\*.exe","C:\\Windows\\ModemLogs\\*.exe","C:\\Windows\\ImmersiveControlPanel\\*.exe") and not process.name : ("SpeechUXWiz.exe","SystemSettings.exe","TrustedInstaller.exe","PrintDialog.exe","MpSigStub.exe","LMS.exe","mpam-*.exe") and not process.executable : ("?:\\Intel\\Wireless\\WUSetupLauncher.exe", "?:\\Intel\\Wireless\\Setup.exe", "?:\\Intel\\Move Mouse.exe", "?:\\windows\\Panther\\DiagTrackRunner.exe", "?:\\Windows\\servicing\\GC64\\tzupd.exe", "?:\\Users\\Public\\res\\RemoteLite.exe", "?:\\Users\\Public\\IBM\\ClientSolutions\\*.exe", "?:\\Users\\Public\\Documents\\syspin.exe", "?:\\Users\\Public\\res\\FileWatcher.exe") /* uncomment once in winlogbeat */ /* and not (process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true) */ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.005" name = "Match Legitimate Name or Location" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies process execution from suspicious default Windows directories. This may be abused by adversaries to hide malware in trusted paths. query = " process where event.type == "start" and process.name : ("wscript.exe", "cscript.exe", "rundll32.exe", "regsvr32.exe", "cmstp.exe", "RegAsm.exe", "installutil.exe", "mshta.exe", "RegSvcs.exe", "powershell.exe", "pwsh.exe", "cmd.exe") and /* add suspicious execution paths here */ process.args : ("C:\\PerfLogs\\*", "C:\\Users\\Public\\*", "C:\\Windows\\Tasks\\*", "C:\\Intel\\*", "C:\\AMD\\Temp\\*", "C:\\Windows\\AppReadiness\\*", "C:\\Windows\\ServiceState\\*", "C:\\Windows\\security\\*", "C:\\Windows\\IdentityCRL\\*", "C:\\Windows\\Branding\\*", "C:\\Windows\\csc\\*", "C:\\Windows\\DigitalLocker\\*", "C:\\Windows\\en-US\\*", "C:\\Windows\\wlansvc\\*", "C:\\Windows\\Prefetch\\*", "C:\\Windows\\Fonts\\*", "C:\\Windows\\diagnostics\\*", "C:\\Windows\\TAPI\\*", "C:\\Windows\\INF\\*", "C:\\Windows\\System32\\Speech\\*", "C:\\windows\\tracing\\*", "c:\\windows\\IME\\*", "c:\\Windows\\Performance\\*", "c:\\windows\\intel\\*", "c:\\windows\\ms\\*", "C:\\Windows\\dot3svc\\*", "C:\\Windows\\panther\\*", "C:\\Windows\\RemotePackages\\*", "C:\\Windows\\OCR\\*", "C:\\Windows\\appcompat\\*", "C:\\Windows\\apppatch\\*", "C:\\Windows\\addins\\*", "C:\\Windows\\Setup\\*", "C:\\Windows\\Help\\*", "C:\\Windows\\SKB\\*", "C:\\Windows\\Vss\\*", "C:\\Windows\\servicing\\*", "C:\\Windows\\CbsTemp\\*", "C:\\Windows\\Logs\\*", "C:\\Windows\\WaaS\\*", "C:\\Windows\\twain_32\\*", "C:\\Windows\\ShellExperiences\\*", "C:\\Windows\\ShellComponents\\*", "C:\\Windows\\PLA\\*", "C:\\Windows\\Migration\\*", "C:\\Windows\\debug\\*", "C:\\Windows\\Cursors\\*", "C:\\Windows\\Containers\\*", "C:\\Windows\\Boot\\*", "C:\\Windows\\bcastdvr\\*", "C:\\Windows\\TextInput\\*", "C:\\Windows\\security\\*", "C:\\Windows\\schemas\\*", "C:\\Windows\\SchCache\\*", "C:\\Windows\\Resources\\*", "C:\\Windows\\rescache\\*", "C:\\Windows\\Provisioning\\*", "C:\\Windows\\PrintDialog\\*", "C:\\Windows\\PolicyDefinitions\\*", "C:\\Windows\\media\\*", "C:\\Windows\\Globalization\\*", "C:\\Windows\\L2Schemas\\*", "C:\\Windows\\LiveKernelReports\\*", "C:\\Windows\\ModemLogs\\*", "C:\\Windows\\ImmersiveControlPanel\\*", "C:\\$Recycle.Bin\\*") and /* noisy FP patterns */ not process.parent.executable : ("C:\\WINDOWS\\System32\\DriverStore\\FileRepository\\*\\igfxCUIService*.exe", "C:\\Windows\\System32\\spacedeskService.exe", "C:\\Program Files\\Dell\\SupportAssistAgent\\SRE\\SRE.exe") and not (process.name : "rundll32.exe" and process.args : ("uxtheme.dll,#64", "PRINTUI.DLL,PrintUIEntry", "?:\\Windows\\System32\\FirewallControlPanel.dll,ShowNotificationDialog", "?:\\WINDOWS\\system32\\Speech\\SpeechUX\\sapi.cpl", "?:\\Windows\\system32\\shell32.dll,OpenAs_RunDLL")) and not (process.name : "cscript.exe" and process.args : "?:\\WINDOWS\\system32\\calluxxprovider.vbs") and not (process.name : "cmd.exe" and process.args : "?:\\WINDOWS\\system32\\powercfg.exe" and process.args : "?:\\WINDOWS\\inf\\PowerPlan.log") and not (process.name : "regsvr32.exe" and process.args : "?:\\Windows\\Help\\OEM\\scripts\\checkmui.dll") and not (process.name : "cmd.exe" and process.parent.executable : ("?:\\Windows\\System32\\oobe\\windeploy.exe", "?:\\Program Files (x86)\\ossec-agent\\wazuh-agent.exe", "?:\\Windows\\System32\\igfxCUIService.exe", "?:\\Windows\\Temp\\IE*.tmp\\IE*-support\\ienrcore.exe")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.005" name = "Match Legitimate Name or Location" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies process execution with a single character process name. This is often done by adversaries while staging or executing temporary utilities. query = " process where event.type == "start" and length(process.name) > 0 and length(process.name) == 5 and host.os.name == "Windows" and length(process.pe.original_file_name) > 5 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.003" name = "Rename System Utilities" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts. query = " sequence by host.id with maxspan = 2s /* Accepted Incoming RPC connection by Winmgmt service */ [network where process.name : "svchost.exe" and network.direction : ("incoming", "ingress") and source.ip != "127.0.0.1" and source.ip != "::1" and source.port >= 49152 and destination.port >= 49152 ] /* Excluding Common FPs Nessus and SCCM */ [process where event.type == "start" and process.parent.name : "WmiPrvSE.exe" and not process.args : ("C:\\windows\\temp\\nessus_*.txt", "C:\\windows\\TEMP\\nessus_*.TMP", "C:\\Windows\\CCM\\SystemTemp\\*", "C:\\Windows\\CCMCache\\*", "C:\\CCM\\Cache\\*") ] " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1047" name = "Windows Management Instrumentation" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies processes modifying the services registry key directly, instead of through the expected Windows APIs. This could be an indication of an adversary attempting to stealthily persist through abnormal service creation or modification of an existing service. query = " registry where registry.path : ("HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ServiceDLL", "HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath") and not registry.data.strings : ("?:\\windows\\system32\\Drivers\\*.sys", "\\SystemRoot\\System32\\drivers\\*.sys", "\\??\\?:\\Windows\\system32\\Drivers\\*.SYS", "system32\\DRIVERS\\USBSTOR") and not (process.name : "procexp??.exe" and registry.data.strings : "?:\\*\\procexp*.sys") and not process.executable : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\winsxs\\*\\TiWorker.exe", "?:\\Windows\\System32\\drvinst.exe", "?:\\Windows\\System32\\services.exe", "?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\System32\\regsvr32.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies processes running from an Alternate Data Stream. This is uncommon for legitimate processes and sometimes done by adversaries to hide malware. query = " process where event.type == "start" and process.args : "?:\\*:*" and process.args_count == 1 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.004" name = "NTFS File Attributes" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn't by default) and is set to 1, then remote connections from all local members of Administrators are granted full high-integrity tokens during negotiation. query = " registry where registry.path : ( "HKLM\\*\\LocalAccountTokenFilterPolicy", "\\REGISTRY\\MACHINE\\*\\LocalAccountTokenFilterPolicy") and registry.data.strings : ("1", "0x00000001") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1112" name = "Modify Registry" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.003" name = "Local Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies registry modifications related to the Windows Security Support Provider (SSP) configuration. Adversaries may abuse this to establish persistence in an environment. query = " registry where registry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Security Packages*", "HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\OSConfig\\Security Packages*") and not process.executable : ("C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.005" name = "Security Support Provider" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies registry write modifications to enable Remote Desktop Protocol (RDP) access. This could be indicative of adversary lateral movement preparation. query = " registry where event.type in ("creation", "change") and registry.path : "HKLM\\SYSTEM\\*ControlSet*\\Control\\Terminal Server\\fDenyTSConnections" and registry.data.strings : ("0", "0x00000000") and not (process.name : "svchost.exe" and user.domain == "NT AUTHORITY") and not process.executable : "C:\\Windows\\System32\\SystemPropertiesRemote.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.001" name = "Remote Desktop Protocol" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversary defense evasion by avoiding the storing of malicious content directly on disk. query = " registry where /* update here with encoding combinations */ registry.data.strings : "TVqQAAMAAAAEAAAA*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1112" name = "Modify Registry" reference = [[rule.threat.technique]] id = "T1140" name = "Deobfuscate/Decode Files or Information" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies remote access to the registry to potentially dump credential data from the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation. query = " sequence by winlog.computer_name, user.id with maxspan=1m [authentication where event.outcome == "success" and event.action == "logged-in" and winlog.logon.type == "Network" and not user.name == "ANONYMOUS LOGON" and not user.domain == "NT AUTHORITY" and source.ip != "127.0.0.1" and source.ip !="::1"] [file where event.action == "creation" and process.name : "svchost.exe" and file.Ext.header_bytes : "72656766*" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and file.size >= 30000 and not file.path : ("?:\\Windows\\system32\\HKEY_LOCAL_MACHINE_SOFTWARE_Microsoft_*.registry", "?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat.LOG?", "?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat", "?:\\Users\\*\\ntuser.dat.LOG?", "?:\\Users\\*\\NTUSER.DAT")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.002" name = "Security Account Manager" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation. query = " sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m [iam where event.action == "logged-in-special" and winlog.event_data.PrivilegeList : "SeBackupPrivilege" and /* excluding accounts with existing privileged access */ not winlog.event_data.PrivilegeList : "SeDebugPrivilege"] [any where event.action == "Detailed File Share" and winlog.event_data.RelativeTargetName : "winreg"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.002" name = "Security Account Manager" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral movement, but will be noisy if commonly done by administrators." query = " sequence with maxspan=1s [network where process.name : "services.exe" and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.port >= 49152 and destination.port >= 49152 and source.ip != "127.0.0.1" and source.ip != "::1" ] by host.id, process.entity_id [process where event.type == "start" and process.parent.name : "services.exe" and not (process.name : "svchost.exe" and process.args : "tiledatamodelsvc") and not (process.name : "msiexec.exe" and process.args : "/V") and not process.executable : ("?:\\Windows\\ADCR_Agent\\adcrsvc.exe", "?:\\Windows\\System32\\VSSVC.exe", "?:\\Windows\\servicing\\TrustedInstaller.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Program Files\\*.exe", "?:\\Windows\\PSEXESVC.EXE", "?:\\Windows\\System32\\sppsvc.exe", "?:\\Windows\\System32\\wbem\\WmiApSrv.exe", "?:\\WINDOWS\\RemoteAuditService.exe", "?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe", "?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe", "?:\\Windows\\CAInvokerService.exe", "?:\\Windows\\System32\\upfc.exe", "?:\\Windows\\AdminArsenal\\PDQ*.exe", "?:\\Windows\\System32\\vds.exe", "?:\\Windows\\Veeam\\Backup\\VeeamDeploymentSvc.exe", "?:\\Windows\\ProPatches\\Scheduler\\STSchedEx.exe", "?:\\Windows\\System32\\certsrv.exe", "?:\\Windows\\eset-remote-install-service.exe", "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe", "?:\\Pella Corporation\\OSCToGPAutoService\\OSCToGPAutoSvc.exe", "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe", "?:\\Windows\\SysWOW64\\NwxExeSvc\\NwxExeSvc.exe", "?:\\Windows\\System32\\taskhostex.exe") ] by host.id, process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run any Windows PowerShell command on one or more remote computers. This could be an indication of lateral movement. false_positives = [ PowerShell remoting is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool., ] query = " sequence by host.id with maxspan = 30s [network where network.direction : ("incoming", "ingress") and destination.port in (5985, 5986) and network.protocol == "http" and source.ip != "127.0.0.1" and source.ip != "::1" ] [process where event.type == "start" and process.parent.name : "wsmprovhost.exe" and not process.name : "conhost.exe"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be an indication of lateral movement. false_positives = [ WinRM is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool., ] query = " sequence by host.id with maxspan=30s [network where process.pid == 4 and network.direction : ("incoming", "ingress") and destination.port in (5985, 5986) and network.protocol == "http" and source.ip != "127.0.0.1" and source.ip != "::1" ] [process where event.type == "start" and process.parent.name : "winrshost.exe" and not process.name : "conhost.exe"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies run key or startup key registry modifications. In order to survive reboots and other system interrupts, attackers will modify run keys within the registry or leverage startup folder items as a form of persistence. query = " registry where registry.data.strings != null and registry.path : ( /* Machine Hive */ "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*", /* Users Hive */ "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*" ) and /* add common legitimate changes without being too restrictive as this is one of the most abused AESPs */ not registry.data.strings : "ctfmon.exe /n" and not (registry.value : "Application Restart #*" and process.name : "csrss.exe") and user.id not in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and not registry.data.strings : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe") and not process.executable : ("?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe") and not (process.name : "OneDriveSetup.exe" and registry.value : ("Delete Cached Standalone Update Binary", "Delete Cached Update Binary", "amd64", "Uninstall *") and registry.data.strings : "?:\\Windows\\system32\\cmd.exe /q /c * \"?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\*\) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies script engines creating files in the Startup folder, or the creation of script files in the Startup folder. Adversaries may abuse this technique to maintain persistence in an environment. query = " file where event.type != "deletion" and user.domain != "NT AUTHORITY" and /* detect shortcuts created by wscript.exe or cscript.exe */ (file.path : "C:\\*\\Programs\\Startup\\*.lnk" and process.name : ("wscript.exe", "cscript.exe")) or /* detect vbs or js files created by any process */ file.path : ("C:\\*\\Programs\\Startup\\*.vbs", "C:\\*\\Programs\\Startup\\*.vbe", "C:\\*\\Programs\\Startup\\*.wsh", "C:\\*\\Programs\\Startup\\*.wsf", "C:\\*\\Programs\\Startup\\*.js") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies scrobj.dll loaded into unusual Microsoft processes. This usually means a malicious scriptlet is being executed in the target process. query = " sequence by process.entity_id with maxspan=2m [process where event.type == "start" and (process.code_signature.subject_name in ("Microsoft Corporation", "Microsoft Windows") and process.code_signature.trusted == true) and not process.executable : ( "?:\\Windows\\System32\\cscript.exe", "?:\\Windows\\SysWOW64\\cscript.exe", "?:\\Program Files (x86)\\Internet Explorer\\iexplore.exe", "?:\\Program Files\\Internet Explorer\\iexplore.exe", "?:\\Windows\\SystemApps\\Microsoft.MicrosoftEdge_*\\MicrosoftEdge.exe", "?:\\Windows\\system32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe", "?:\\Windows\\System32\\smartscreen.exe", "?:\\Windows\\system32\\taskhostw.exe", "?:\\windows\\system32\\inetsrv\\w3wp.exe", "?:\\windows\\SysWOW64\\inetsrv\\w3wp.exe", "?:\\Windows\\system32\\wscript.exe", "?:\\Windows\\SysWOW64\\wscript.exe", "?:\\Windows\\system32\\mobsync.exe", "?:\\Windows\\SysWOW64\\mobsync.exe", "?:\\Windows\\System32\\cmd.exe", "?:\\Windows\\SysWOW64\\cmd.exe")] [library where event.type == "start" and dll.name : "scrobj.dll"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services. This could be indicative of adversary lateral movement but will be noisy if commonly done by admins. query = " /* This rule is not compatible with Sysmon due to user.id issues */ process where event.type == "start" and (process.name : "sc.exe" or process.pe.original_file_name == "sc.exe") and process.parent.name : ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe","powershell.exe", "pwsh.exe") and process.args:("config", "create", "start", "delete", "stop", "pause") and /* exclude SYSTEM SID - look for service creations by non-SYSTEM user */ not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies suspending the recording of AWS API calls and log file delivery for the specified trail. An adversary may suspend trails in an attempt to evade defenses. false_positives = [ Suspending the recording of a trail may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail suspensions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:StopLogging and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies suspicious access to an LSASS handle via DuplicateHandle from an unknown call trace module. This may indicate an attempt to bypass the NtOpenProcess API to evade detection and dump LSASS memory for credential access. query = " process where event.code == "10" and /* LSASS requesting DuplicateHandle access right to another process */ process.name : "lsass.exe" and winlog.event_data.GrantedAccess == "0x40" and /* call is coming from an unknown executable region */ winlog.event_data.CallTrace : "*UNKNOWN*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies suspicious access to an LSASS handle via PssCaptureSnapShot where two successive process accesses are performed by the same process and target two different instances of LSASS. This may indicate an attempt to evade detection and dump LSASS memory for credential access. query = " event.category:process and event.code:10 and winlog.event_data.TargetImage:("C:\\Windows\\system32\\lsass.exe" or "c:\\Windows\\system32\\lsass.exe" or "c:\\Windows\\System32\\lsass.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["process.entity_id"] value = 2 [[rule.threshold.cardinality]] field = "winlog.event_data.TargetProcessId" value = 2
<li><a href="#">description = Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export the MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access. query = " process where event.code == "10" and winlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe" and /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/ winlog.event_data.CallTrace : ("*dbghelp*", "*dbgcore*") and /* case of lsass crashing */ not process.executable : ("?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\System32\\WerFaultSecure.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access rights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service in preparation for credential access. query = " process where event.code == "10" and winlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe" and /* seclogon service accessing lsass */ winlog.event_data.CallTrace : "*seclogon.dll*" and process.name : "svchost.exe" and /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */ winlog.event_data.GrantedAccess == "0x14c0" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, and Excel). These child processes are often launched during exploitation of Office applications or by documents with malicious macros. query = " process where event.type in ("start", "process_started") and process.parent.name:("Microsoft Word", "Microsoft PowerPoint", "Microsoft Excel") and process.name: ( "bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish", "python*", "perl*", "php*", "osascript", "pwsh", "curl", "wget", "cp", "mv", "base64", "launchctl" ) and /* noisy false positives related to product version discovery and office errors reporting */ not process.args: ( "ProductVersion", "hw.model", "ioreg", "ProductName", "ProductUserVisibleVersion", "ProductBuildVersion", "/Library/Application Support/Microsoft/MERP*/Microsoft Error Reporting.app/Contents/MacOS/Microsoft Error Reporting" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel). These child processes are often launched during exploitation of Office applications or from documents with malicious macros. query = " process where event.type == "start" and process.parent.name : ("eqnedt32.exe", "excel.exe", "fltldr.exe", "msaccess.exe", "mspub.exe", "powerpnt.exe", "winword.exe", "outlook.exe") and process.name : ("Microsoft.Workflow.Compiler.exe", "arp.exe", "atbroker.exe", "bginfo.exe", "bitsadmin.exe", "cdb.exe", "certutil.exe", "cmd.exe", "cmstp.exe", "control.exe", "cscript.exe", "csi.exe", "dnx.exe", "dsget.exe", "dsquery.exe", "forfiles.exe", "fsi.exe", "ftp.exe", "gpresult.exe", "hostname.exe", "ieexec.exe", "iexpress.exe", "installutil.exe", "ipconfig.exe", "mshta.exe", "msxsl.exe", "nbtstat.exe", "net.exe", "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "odbcconf.exe", "ping.exe", "powershell.exe", "pwsh.exe", "qprocess.exe", "quser.exe", "qwinsta.exe", "rcsi.exe", "reg.exe", "regasm.exe", "regsvcs.exe", "regsvr32.exe", "sc.exe", "schtasks.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe", "whoami.exe", "wmic.exe", "wscript.exe", "xwizard.exe", "explorer.exe", "rundll32.exe", "hh.exe", "msdt.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spear phishing activity. query = " process where event.type == "start" and process.parent.name : "outlook.exe" and process.name : ("Microsoft.Workflow.Compiler.exe", "arp.exe", "atbroker.exe", "bginfo.exe", "bitsadmin.exe", "cdb.exe", "certutil.exe", "cmd.exe", "cmstp.exe", "cscript.exe", "csi.exe", "dnx.exe", "dsget.exe", "dsquery.exe", "forfiles.exe", "fsi.exe", "ftp.exe", "gpresult.exe", "hostname.exe", "ieexec.exe", "iexpress.exe", "installutil.exe", "ipconfig.exe", "mshta.exe", "msxsl.exe", "nbtstat.exe", "net.exe", "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "odbcconf.exe", "ping.exe", "powershell.exe", "pwsh.exe", "qprocess.exe", "quser.exe", "qwinsta.exe", "rcsi.exe", "reg.exe", "regasm.exe", "regsvcs.exe", "regsvr32.exe", "sc.exe", "schtasks.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe", "whoami.exe", "wmic.exe", "wscript.exe", "xwizard.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies suspicious child processes of PDF reader applications. These child processes are often launched via exploitation of PDF applications or social engineering. query = " process where event.type == "start" and process.parent.name : ("AcroRd32.exe", "Acrobat.exe", "FoxitPhantomPDF.exe", "FoxitReader.exe") and process.name : ("arp.exe", "dsquery.exe", "dsget.exe", "gpresult.exe", "hostname.exe", "ipconfig.exe", "nbtstat.exe", "net.exe", "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "ping.exe", "qprocess.exe", "quser.exe", "qwinsta.exe", "reg.exe", "sc.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe", "whoami.exe", "bginfo.exe", "cdb.exe", "cmstp.exe", "csi.exe", "dnx.exe", "fsi.exe", "ieexec.exe", "iexpress.exe", "installutil.exe", "Microsoft.Workflow.Compiler.exe", "msbuild.exe", "mshta.exe", "msxsl.exe", "odbcconf.exe", "rcsi.exe", "regsvr32.exe", "xwizard.exe", "atbroker.exe", "forfiles.exe", "schtasks.exe", "regasm.exe", "regsvcs.exe", "cmd.exe", "cscript.exe", "powershell.exe", "pwsh.exe", "wmic.exe", "wscript.exe", "bitsadmin.exe", "certutil.exe", "ftp.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies suspicious child processes of the Java interpreter process. This may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a JAVA specific vulnerability. query = " process where event.type in ("start", "process_started") and process.parent.name : "java" and process.name : ("sh", "bash", "dash", "ksh", "tcsh", "zsh", "curl", "wget") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.007" name = "JavaScript" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement. query = " process where event.type == "start" and process.parent.name : "WmiPrvSE.exe" and process.name : "cmd.exe" and process.args : "\\\\127.0.0.1\\*" and process.args : ("2>&1", "1>") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1047" name = "Windows Management Instrumentation" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part of Certificate Services. CertUtil is often abused by attackers to live off the land for stealthier command and control or data exfiltration. query = " process where event.type == "start" and (process.name : "certutil.exe" or process.pe.original_file_name == "CertUtil.exe") and process.args : ("?decode", "?encode", "?urlcache", "?verifyctl", "?encodehex", "?decodehex", "?exportPFX") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1140" name = "Deobfuscate/Decode Files or Information" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate files and sometimes done by adversaries to hide malware. query = " file where event.type == "creation" and file.path : "C:\\*:*" and not file.path : "C:\\*:zone.identifier*" and not process.executable : ("?:\\windows\\System32\\svchost.exe", "?:\\Windows\\System32\\inetsrv\\w3wp.exe", "?:\\Windows\\explorer.exe", "?:\\Windows\\System32\\sihost.exe", "?:\\Windows\\System32\\PickerHost.exe", "?:\\Windows\\System32\\SearchProtocolHost.exe", "?:\\Program Files (x86)\\Dropbox\\Client\\Dropbox.exe", "?:\\Program Files\\Rivet Networks\\SmartByte\\SmartByteNetworkService.exe", "?:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "?:\\Program Files\\ExpressConnect\\ExpressConnectNetworkService.exe", "?:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe", "?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", "?:\\Program Files\\Mozilla Firefox\\firefox.exe") and file.extension : ( "pdf", "dll", "png", "exe", "dat", "com", "bat", "cmd", "sys", "vbs", "ps1", "hta", "txt", "vbe", "js", "wsh", "docx", "doc", "xlsx", "xls", "pptx", "ppt", "rtf", "gif", "jpg", "png", "bmp", "img", "iso" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.004" name = "NTFS File Attributes" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies suspicious file creations in the startup folder of a remote system. An adversary could abuse this to move laterally by dropping a malicious script or executable that will be executed after a reboot or user logon. query = " file where event.type in ("creation", "change") and /* via RDP TSClient mounted share or SMB */ (process.name : "mstsc.exe" or process.pid == 4) and file.path : ("?:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*", "?:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26858. false_positives = [ Files generated during installation will generate a lot of noise, so the rule should only be enabled after the fact., This rule was tuned using the following baseline: from Microsoft. Depending on version, consult to help determine normalcy., ] query = " file where event.type == "creation" and process.name : ("UMWorkerProcess.exe", "umservice.exe") and file.extension : ("php", "jsp", "js", "aspx", "asmx", "asax", "cfm", "shtml") and ( file.path : "?:\\inetpub\\wwwroot\\aspnet_client\\*" or (file.path : "?:\\*\\Microsoft\\Exchange Server*\\FrontEnd\\HttpProxy\\owa\\auth\\*" and not (file.path : "?:\\*\\Microsoft\\Exchange Server*\\FrontEnd\\HttpProxy\\owa\\auth\\version\\*" or file.name : ("errorFE.aspx", "expiredpassword.aspx", "frowny.aspx", "GetIdToken.htm", "logoff.aspx", "logon.aspx", "OutlookCN.aspx", "RedirSuiteServiceProxy.aspx", "signout.aspx"))) or (file.path : "?:\\*\\Microsoft\\Exchange Server*\\FrontEnd\\HttpProxy\\ecp\\auth\\*" and not file.name : "TimeoutLogoff.aspx") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate the presence of RDP lateral movement capability. query = " any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : "mstscax.dll" or file.name : "mstscax.dll") and /* depending on noise in your env add here extra paths */ process.executable : ( "C:\\Windows\\*", "C:\\Users\\Public\\*", "C:\\Users\\Default\\*", "C:\\Intel\\*", "C:\\PerfLogs\\*", "C:\\ProgramData\\*", "\\Device\\Mup\\*", "\\\\*" ) and /* add here FPs */ not process.executable : ("C:\\Windows\\System32\\mstsc.exe", "C:\\Windows\\SysWOW64\\mstsc.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matching command-line and process executable values performing outgoing network connections. This may be indicative of a masquerading attempt to evade suspicious child process behavior detections. false_positives = ["Legit Application Crash with rare Werfault commandline value"] query = " sequence by host.id, process.entity_id with maxspan = 5s [process where event.type:"start" and process.name : ("wermgr.exe", "WerFault.exe") and process.args_count == 1] [network where process.name : ("wermgr.exe", "WerFault.exe") and network.protocol != "dns" and network.direction : ("outgoing", "egress") and destination.ip !="::1" and destination.ip !="127.0.0.1" ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies suspicious modifications of the calendar file by an unusual process. Adversaries may create a custom calendar notification procedure to execute a malicious program at a recurring interval to establish persistence. false_positives = ["Trusted applications for managing calendars and reminders."] query = " event.category:file and event.action:modification and file.path:/Users/*/Library/Calendars/*.calendar/Events/*.ics and process.executable: (* and not ( /System/Library/* or /System/Applications/Calendar.app/Contents/MacOS/* or /System/Applications/Mail.app/Contents/MacOS/Mail or /usr/libexec/xpcproxy or /sbin/launchd or /Applications/* ) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly. query = " process where event.code == "10" and length(winlog.event_data.CallTrace) > 0 and /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */ not winlog.event_data.CallTrace : ("?:\\WINDOWS\\SYSTEM32\\ntdll.dll*", "?:\\WINDOWS\\SysWOW64\\ntdll.dll*", "?:\\Windows\\System32\\wow64cpu.dll*", "?:\\WINDOWS\\System32\\wow64win.dll*", "?:\\Windows\\System32\\win32u.dll*") and not winlog.event_data.TargetImage : ("?:\\Program Files (x86)\\Malwarebytes Anti-Exploit\\mbae-svc.exe", "?:\\Program Files\\Cisco\\AMP\\*\\sfc.exe", "?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\*\\msedgewebview2.exe", "?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\*\\AcroCEF.exe") and not (process.executable : ("?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe", "?:\\Program Files (x86)\\World of Warcraft\\_classic_\\WowClassic.exe") and not winlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26857. false_positives = [ Legitimate processes may be spawned from the Microsoft Exchange Server Unified Messaging (UM) service. If known processes are causing false positives, they can be exempted from the rule., ] query = " process where event.type == "start" and process.parent.name : ("UMService.exe", "UMWorkerProcess.exe") and not process.executable : ("?:\\Windows\\System32\\werfault.exe", "?:\\Windows\\System32\\wermgr.exe", "?:\\Program Files\\Microsoft\\Exchange Server\\V??\\Bin\\UMWorkerProcess.exe", "D:\\Exchange 2016\\Bin\\UMWorkerProcess.exe", "E:\\ExchangeServer\\Bin\\UMWorkerProcess.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies suspicious processes being spawned by the Microsoft Exchange Server worker process (w3wp). This activity may indicate exploitation activity or access to an existing web shell backdoor. query = " process where event.type == "start" and process.parent.name : "w3wp.exe" and process.parent.args : "MSExchange*AppPool" and (process.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe") or process.pe.original_file_name in ("cmd.exe", "powershell.exe", "pwsh.dll", "powershell_ise.exe")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies suspicious psexec activity which is executing from the psexec service that has been renamed, possibly to evade detection. query = " process where event.type == "start" and process.pe.original_file_name : "psexesvc.exe" and not process.name : "PSEXESVC.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1569" name = "System Services" reference = [[rule.threat.technique.subtechnique]] id = "T1569.002" name = "Service Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump a process memory. This may indicate an attempt to dump LSASS memory while bypassing command-line based detection in preparation for credential access. query = " sequence by process.entity_id with maxspan=1m [process where event.category == "process" and process.name : "rundll32.exe"] [process where event.category == "process" and event.dataset : "windows.sysmon_operational" and event.code == "7" and (file.pe.original_file_name : "COMSVCS.DLL" or file.pe.imphash : "EADBCCBB324829ACB5F2BBE87E5549A8") and /* renamed COMSVCS */ not file.name : "COMSVCS.DLL"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies suspicious startup shell folder modifications to change the default Startup directory in order to bypass detections monitoring file creation in the Windows Startup folder. query = " registry where registry.path : ( "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Common Startup", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Common Startup", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Startup" ) and registry.data.strings != null and /* Normal Startup Folder Paths */ not registry.data.strings : ( "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup", "%ProgramData%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup", "%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup", "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies suspicious usage of unshare to manipulate system namespaces. Unshare can be utilized to escalate privileges or escape container security boundaries. Threat actors have utilized this binary to allow themselves to escape to the host and access other resources or escalate privileges. query = " process where event.type == "start" and event.action == "exec" and process.executable: "/usr/bin/unshare" and not process.parent.executable: ("/usr/bin/udevadm", "*/lib/systemd/systemd-udevd", "/usr/bin/unshare") and not process.args : "/usr/bin/snap" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who is currently logged on to the local system. false_positives = [ Some normal use of this program, at varying levels of frequency, may originate from scripts, automation tools and frameworks. Usage by non-engineers and ordinary users is unusual., ] query = " process where event.type == "start" and process.name : "whoami.exe" and ( (/* scoped for whoami execution under system privileges */ (user.domain : ("NT AUTHORITY", "NT-AUTORITT", "AUTORITE NT", "IIS APPPOOL") or user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20")) and not (process.parent.name : "cmd.exe" and process.parent.args : ("chcp 437>nul 2>&1 & C:\\WINDOWS\\System32\\whoami.exe /groups", "chcp 437>nul 2>&1 & %systemroot%\\system32\\whoami /user", "C:\\WINDOWS\\System32\\whoami.exe /groups", "*WINDOWS\\system32\\config\\systemprofile*")) and not (process.parent.executable : "C:\\Windows\\system32\\inetsrv\\appcmd.exe" and process.parent.args : "LIST") and not process.parent.executable : ("C:\\Program Files\\Microsoft Monitoring Agent\\Agent\\MonitoringHost.exe", "C:\\Program Files\\Cohesity\\cohesity_windows_agent_service.exe")) or process.parent.name : ("wsmprovhost.exe", "w3wp.exe", "wmiprvse.exe", "rundll32.exe", "regsvr32.exe") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1033" name = "System Owner/User Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies the assignment of rights to access content from another mailbox. An adversary may use the compromised account to send messages to other accounts in the network of the target organization while creating inbox rules, so messages can evade spam/phishing detection mechanisms. false_positives = ["Assignment of rights to a service account."] index = ["filebeat-*", "logs-o365*"] language = "kuery" license = "Elastic License v2" name = "O365 Exchange Suspicious Mailbox Right Delegation" note =## Setup The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." risk_score = 21 rule_id = "0ce6487d-8069-4888-9ddd-61b52490cebc" severity = "low" tags = ["Elastic", "Cloud", "Microsoft 365", "Continuous Monitoring", "SecOps", "Configuration Audit"] timestamp_override = "event.ingested" type = "query = " event.dataset:o365.audit and event.provider:Exchange and event.action:Add-MailboxPermission and o365.audit.Parameters.AccessRights:(FullAccess or SendAs or SendOnBehalf) and event.outcome:success and not user.id : "NT AUTHORITY\SYSTEM (Microsoft.Exchange.Servicehost)" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.002" name = "Additional Email Delegate Permissions" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the assignment of the SeEnableDelegationPrivilege sensitive "user right" to a user. The SeEnableDelegationPrivilege "user right" enables computer and user accounts to be trusted for delegation. Attackers can abuse this right to compromise Active Directory accounts and elevate their privileges. query = " event.action: "Authorization Policy Change" and event.code:4704 and winlog.event_data.PrivilegeList:"SeEnableDelegationPrivilege" " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the attempted use of a heap-based buffer overflow vulnerability for the Sudo binary in Unix-like systems (CVE-2021-3156). Successful exploitation allows an unprivileged user to escalate to the root user. false_positives = [ This rule could generate false positives if the process arguments leveraged by the exploit are shared by custom scripts using the Sudo or Sudoedit binaries. Only Sudo versions 1.8.2 through 1.8.31p2 and 1.9.0 through 1.9.5p1 are affected; if those versions are not present on the endpoint, this could be a false positive., ] query = " event.category:process and event.type:start and process.name:(sudo or sudoedit) and process.args:(*\\ and ("-i" or "-s")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [rule.threshold] field = ["host.hostname"] value = 100
<li><a href="#">description = Identifies the creation of a group in AWS Identity and Access Management (IAM). Groups specify permissions for multiple users. Any user in a group automatically has the permissions that are assigned to the group. false_positives = [ A group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:CreateGroup and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [[rule.threat.technique.subtechnique]] id = "T1136.003" name = "Cloud Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation of a hidden launch agent or daemon. An adversary may establish persistence by installing a new launch agent or daemon which executes at login. query = " file where event.type != "deletion" and file.path : ( "/System/Library/LaunchAgents/.*.plist", "/Library/LaunchAgents/.*.plist", "/Users/*/Library/LaunchAgents/.*.plist", "/System/Library/LaunchDaemons/.*.plist", "/Library/LaunchDaemons/.*.plist" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.001" name = "Launch Agent" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.001" name = "Hidden Files and Directories" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation of a hidden local user account by appending the dollar sign to the account name. This is sometimes done by attackers to increase access to a system and avoid appearing in the results of accounts listing using the net users command. query = " registry where registry.path : "HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [[rule.threat.technique.subtechnique]] id = "T1136.001" name = "Local Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation of a hidden shared object (.so) file. Users can mark specific files as hidden simply by putting a "." as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion. query = " file where event.action : "creation" and file.extension == "so" and file.name : ".*.so" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.001" name = "Hidden Files and Directories" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation of a Local Security Authority Subsystem Service (lsass.exe) default memory dump. This may indicate a credential access attempt via trusted system utilities such as Task Manager (taskmgr.exe) and SQL Dumper (sqldumper.exe) or known pentesting tools such as Dumpert and AndrewSpecial. query = " file where file.name : ("lsass*.dmp", "dumpert.dmp", "Andrew.dmp", "SQLDmpr*.mdmp", "Coredump.dmp") and not (process.executable : ("?:\\Program Files\\Microsoft SQL Server\\*\\Shared\\SqlDumper.exe", "?:\\Windows\\System32\\dllhost.exe") and file.path : ("?:\\Program Files\\Microsoft SQL Server\\*\\Shared\\ErrorDumps\\SQLDmpr*.mdmp", "?:\\*\\Reporting Services\\Logfiles\\SQLDmpr*.mdmp")) and not (process.executable : "?:\\WINDOWS\\system32\\WerFault.exe" and file.path : "?:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\CrashDumps\\lsass.exe.*.dmp") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the creation of a new Amazon Relational Database Service (RDS) Aurora DB cluster or global database spread across multiple regions. false_positives = [ Valid clusters may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(CreateDBCluster or CreateGlobalCluster) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1133" name = "External Remote Services" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation of a new port forwarding rule. An adversary may abuse this technique to bypass network segmentation restrictions. query = " registry where registry.path : ( "HKLM\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\*", "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\*" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1572" name = "Protocol Tunneling" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically run as SYSTEM and can be used for privilege escalation and persistence. query = " any where (event.code : "4697" and (winlog.event_data.ServiceFileName : ("*COMSPEC*", "*\\172.0.0.1*", "*Admin$*", "*powershell*", "*rundll32*", "*cmd.exe*", "*PSEXESVC*", "*echo*", "*RemComSvc*") or winlog.event_data.ServiceFileName regex~%systemroot%\\[a-z0-9]+\.exe")) or (event.code : "7045" and winlog.event_data.ImagePath : ("*COMSPEC*", "*\\172.0.0.1*", "*Admin$*", "*powershell*", "*rundll32*", "*cmd.exe*", "*PSEXESVC*", "*echo*", "*RemComSvc*")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation of a Process ID (PID), lock or reboot file created in temporary file storage paradigm (tmpfs) directory /var/run. On Linux, the PID files typically hold the process ID to track previous copies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising itself or these files as legitimate PID files. false_positives = [ False-Positives (FP) can appear if the PID file is legitimate and holding a process ID as intended. To differentiate, if the PID file is an executable or larger than 10 bytes, it should be ruled suspicious., ] query = " /* add file size filters when data is available */ file where event.type == "creation" and user.id == "0" and file.path regex~/var/run/\w+\.(pid|lock|reboot)" and file.extension in ("pid","lock","reboot") and /* handle common legitimate files */ not file.name in ( "auditd.pid", "python*", "apport.pid", "apport.lock", "kworker*", "gdm3.pid", "sshd.pid", "acpid.pid", "unattended-upgrades.lock", "unattended-upgrades.pid", "cmd.pid", "cron*.pid", "yum.pid", "netconfig.pid", "docker.pid", "atd.pid", "lfd.pid", "atop.pid", "nginx.pid", "dhclient.pid", "smtpd.pid", "stunnel.pid", "1_waagent.pid" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1106" name = "Native API" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries may create a new process with a different token to escalate privileges and bypass access controls. query = " any where event.provider: "Microsoft-Windows-Security-Auditing" and event.action : "Token Right Adjusted Events" and winlog.event_data.EnabledPrivilegeList : "SeDebugPrivilege" and /* exclude processes with System Integrity */ not winlog.event_data.SubjectUserSid : ("S-1-5-18", "S-1-5-19", "S-1-5-20") and not winlog.event_data.ProcessName : ("?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe", "?:\\Windows\\System32\\lsass.exe", "?:\\Windows\\WinSxS\\*", "?:\\Program Files\\*", "?:\\Program Files (x86)\\*", "?:\\Windows\\System32\\MRT.exe", "?:\\Windows\\System32\\cleanmgr.exe", "?:\\Windows\\System32\\taskhostw.exe", "?:\\Windows\\System32\\mmc.exe", "?:\\Users\\*\\AppData\\Local\\Temp\\*-*\\DismHost.exe", "?:\\Windows\\System32\\auditpol.exe", "?:\\Windows\\System32\\wbem\\WmiPrvSe.exe", "?:\\Windows\\SysWOW64\\wbem\\WmiPrvSe.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries may create a new process with a different token to escalate privileges and bypass access controls. query = " /* This rule is only compatible with Elastic Endpoint 8.4+ */ process where event.action == "start" and /* CreateProcessWithToken and effective parent is a privileged MS native binary used as a target for token theft */ user.id : "S-1-5-18" and /* Token Theft target process usually running as service are located in one of the following paths */ process.Ext.effective_parent.executable : ("?:\\Windows\\*.exe", "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\ProgramData\\*") and not (process.Ext.effective_parent.executable : "?:\\Windows\\System32\\Utilman.exe" and process.parent.executable : "?:\\Windows\\System32\\Utilman.exe" and process.parent.args : "/debug") and not process.executable : ("?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWOW64\\WerFault.exe", "?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\Windows\\SysWOW64\\WerFaultSecure.exe", "?:\\windows\\system32\\WerMgr.exe", "?:\\Windows\\SoftwareDistribution\\Download\\Install\\securityhealthsetup.exe") and not process.parent.executable : ("?:\\Windows\\System32\\AtBroker.exe", "?:\\Windows\\system32\\svchost.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Program Files\\*.exe", "?:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\System32\\DriverStore\\*") and not (process.code_signature.trusted == true and process.code_signature.subject_name in ("philandro Software GmbH", "Freedom Scientific Inc.", "TeamViewer Germany GmbH", "Projector.is, Inc.", "TeamViewer GmbH", "Cisco WebEx LLC", "Dell Inc")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1134" name = "Access Token Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1134.002" name = "Create Process with Token" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies the creation of a subscription in Google Cloud Platform (GCP). In GCP, the publisher-subscriber relationship (Pub/Sub) is an asynchronous messaging service that decouples event-producing and event-processing services. A subscription is a named resource representing the stream of messages to be delivered to the subscribing application. false_positives = [ Subscription creations may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Subscription creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Pub/Sub Subscription Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "d62b64a8-a7c9-43e5-aee3-15a725a794e7" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.pubsub.v*.Subscriber.CreateSubscription and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1530" name = "Data from Cloud Storage" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies the creation of a suspicious ImagePath value. This could be an indication of an adversary attempting to stealthily persist or escalate privileges through abnormal service creation. query = " registry where registry.path : "HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath" and /* add suspicious registry ImagePath values here */ registry.data.strings : ("%COMSPEC%*", "*\\.\\pipe\\*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation of a suspicious zip file prepended with special characters. Sandboxed Microsoft Office applications on macOS are allowed to write files that start with special characters, which can be combined with an AutoStart location to achieve sandbox evasion. query = " event.category:file and not event.type:deletion and file.name:~$*.zip and host.os.type:macos " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1497" name = "Virtualization/Sandbox Evasion" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation of a topic in Google Cloud Platform (GCP). In GCP, the publisher-subscriber relationship (Pub/Sub) is an asynchronous messaging service that decouples event-producing and event-processing services. A topic is used to forward messages from publishers to subscribers. false_positives = [ Topic creations may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Topic creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Pub/Sub Topic Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "a10d3d9d-0f65-48f1-8b25-af175e2594f5" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.pubsub.v*.Publisher.CreateTopic and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1530" name = "Data from Cloud Storage" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies the creation of a Windows service by an unusual client process. Services may be created with administrator privileges but are executed under SYSTEM privileges, so an adversary may also use a service to escalate privileges from administrator to SYSTEM. query = " event.action:"service-installed" and (winlog.event_data.ClientProcessId:"0" or winlog.event_data.ParentProcessId:"0") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies the creation of an Amazon Redshift cluster. Unexpected creation of this cluster by a non-administrative user may indicate a permission or role issue with current users. If unexpected, the resource may not properly be configured and could introduce security vulnerabilities. false_positives = [ Valid clusters may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:redshift.amazonaws.com and event.action:CreateCluster and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation of an AWS Elastic Compute Cloud (EC2) network access control list (ACL) or an entry in a network ACL with a specified rule number. false_positives = [ Network ACL's may be created by a network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Network ACL creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(CreateNetworkAcl or CreateNetworkAclEntry) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1133" name = "External Remote Services" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS process instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access. query = " process where event.code:"4688" and process.executable : "?:\\Windows\\System32\\lsass.exe" and process.parent.executable : "?:\\Windows\\System32\\lsass.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the creation of role binding or cluster role bindings. You can assign these roles to Kubernetes subjects (users, groups, or service accounts) with role bindings and cluster role bindings. An adversary who has permissions to create bindings and cluster-bindings in the cluster can create a binding to the cluster-admin ClusterRole or to other high privileges roles. query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name: ("MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/RBAC.AUTHORIZATION.K8S.IO/ROLEBINDINGS/WRITE" or "MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/RBAC.AUTHORIZATION.K8S.IO/CLUSTERROLEBINDINGS/WRITE") and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies the creation of suppression rules in Azure. Suppression rules are a mechanism used to suppress alerts previously identified as false positives or too noisy to be in production. This mechanism can be abused or mistakenly configured, resulting in defense evasions and loss of security visibility. false_positives = [ Suppression Rules can be created legitimately by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Suppression Rules created by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.SECURITY/ALERTSSUPPRESSIONRULES/WRITE" and event.outcome: "success" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadow copy, including sensitive files such as ntds.dit, System Boot Key and browser offline credentials. false_positives = ["Legitimate administrative activity related to shadow copies."] query = " process where event.type in ("start","process_created") and process.pe.original_file_name in ("Cmd.Exe","PowerShell.EXE") and /* Create Symbolic Link to Shadow Copies */ process.args : ("*mklink*", "*SymbolicLink*") and process.command_line : ("*HarddiskVolumeShadowCopy*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the creation or change of a Windows executable file over network shares. Adversaries may transfer tools or other files between systems in a compromised environment. query = " sequence by host.id with maxspan=30s [network where event.type == "start" and process.pid == 4 and destination.port == 445 and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.ip != "127.0.0.1" and source.ip != "::1" ] by process.entity_id /* add more executable extensions here if they are not noisy in your environment */ [file where event.type in ("creation", "change") and process.pid == 4 and file.extension : ("exe", "dll", "bat", "cmd")] by process.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [[rule.threat.technique]] id = "T1570" name = "Lateral Tool Transfer" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the creation or modification of a DirectoryService PlugIns (dsplug) file. The DirectoryService daemon launches on each system boot and automatically reloads after crash. It scans and executes bundles that are located in the DirectoryServices PlugIns folder and can be abused by adversaries to maintain persistence. query = " event.category:file and not event.type:deletion and file.path:/Library/DirectoryServices/PlugIns/*.dsplug " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation or modification of a K Desktop Environment (KDE) AutoStart script or desktop file that will execute upon each user logon. Adversaries may abuse this method for persistence. query = " file where event.type != "deletion" and file.extension in ("sh", "desktop") and file.path : ( "/home/*/.config/autostart/*", "/root/.config/autostart/*", "/home/*/.kde/Autostart/*", "/root/.kde/Autostart/*", "/home/*/.kde4/Autostart/*", "/root/.kde4/Autostart/*", "/home/*/.kde/share/autostart/*", "/root/.kde/share/autostart/*", "/home/*/.kde4/share/autostart/*", "/root/.kde4/share/autostart/*", "/home/*/.local/share/autostart/*", "/root/.local/share/autostart/*", "/home/*/.config/autostart-scripts/*", "/root/.config/autostart-scripts/*", "/etc/xdg/autostart/*", "/usr/share/autostart/*" ) and not process.name in ("yum", "dpkg", "install", "dnf", "teams", "yum-cron", "dnf-automatic") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation or modification of a local trusted root certificate in Windows. The install of a malicious root certificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity (for example, Microsoft). It could also allow an attacker to decrypt SSL traffic. false_positives = ["Certain applications may install root certificates for the purpose of inspecting SSL traffic."] query = " registry where event.type in ("creation", "change") and registry.path : ( "HKLM\\Software\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob", "HKLM\\Software\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob", "HKLM\\Software\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob", "HKLM\\Software\\Policies\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob", "\\REGISTRY\\MACHINE\\Software\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob", "\\REGISTRY\\MACHINE\\Software\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob", "\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob", "\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob" ) and not process.executable : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Windows\\System32\\*.exe", "?:\\Windows\\SysWOW64\\*.exe", "?:\\Windows\\Sysmon64.exe", "?:\\Windows\\Sysmon.exe", "?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe", "?:\\Windows\\WinSxS\\*.exe", "?:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1553" name = "Subvert Trust Controls" reference = [[rule.threat.technique.subtechnique]] id = "T1553.004" name = "Install Root Certificate" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, which may indicate an exfiltration attempt of a previously dumped Security Account Manager (SAM) registry hive for credential extraction on an attacker-controlled system. query = " file where event.type == "creation" and /* regf file header */ file.Ext.header_bytes : "72656766*" and file.size >= 30000 and process.pid == 4 and user.id : ("S-1-5-21*", "S-1-12-1-*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.002" name = "Security Account Manager" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the creation or modification of a PowerShell profile. PowerShell profile is a script that is executed when PowerShell starts to customize the user environment, which can be abused by attackers to persist in a environment where PowerShell is common. query = " file where event.type != "deletion" and file.path : ("?:\\Users\\*\\Documents\\WindowsPowerShell\\*", "?:\\Users\\*\\Documents\\PowerShell\\*", "?:\\Windows\\System32\\WindowsPowerShell\\*") and file.name : ("profile.ps1", "Microsoft.Powershell_profile.ps1") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.013" name = "PowerShell Profile" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API (DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file. query = " file where event.type != "deletion" and file.name : ("ntds_capi_*.pfx", "ntds_capi_*.pvk") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1552" name = "Unsecured Credentials" reference = [[rule.threat.technique.subtechnique]] id = "T1552.004" name = "Private Keys" reference = [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the creation or modification of the default configuration for periodic tasks. Adversaries may abuse periodic tasks to execute malicious code or maintain persistence. query = " event.category:"file" and not event.type:"deletion" and file.path:(/private/etc/periodic/* or /private/etc/defaults/periodic.conf or /private/etc/periodic.conf) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.003" name = "Cron" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation or modification of the Event Monitor Daemon (emond) rules. Adversaries may abuse this service by writing a rule to execute commands when a defined event occurs, such as system start up or user authentication. query = " file where event.type != "deletion" and file.path : ("/private/etc/emond.d/rules/*.plist", "/etc/emon.d/rules/*.plist", "/private/var/db/emondClients/*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.014" name = "Emond" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the creation or modification of the login window property list (plist). Adversaries may modify plist files to run a program during system boot or user login for persistence. query = " event.category:"file" and not event.type:"deletion" and file.name:"com.apple.loginwindow.plist" and process.name:(* and not (systemmigrationd or DesktopServicesHelper or diskmanagementd or rsync or launchd or cfprefsd or xpcproxy or ManagedClient or MCXCompositor or backupd or "iMazing Profile Editor" )) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1647" name = "Plist File Modification" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuse shared modules to execute malicious payloads by instructing the Windows module loader to load DLLs from arbitrary local paths. query = " file where file.extension : "dll" and file.path : "C:\\*\\*.exe.local\\*.dll" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1129" name = "Shared Modules" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the deactivation of a specified multi-factor authentication (MFA) device and removes it from association with the user name for which it was originally enabled. In AWS Identity and Access Management (IAM), a device must be deactivated before it can be deleted. false_positives = [ A MFA device may be deactivated by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. MFA device deactivations from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:(DeactivateMFADevice or DeleteVirtualMFADevice) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies the deletion of a firewall policy in Azure. An adversary may delete a firewall policy in an attempt to evade defenses and/or to eliminate barriers to their objective. false_positives = [ Firewall policy deletions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Firewall policy deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.NETWORK/FIREWALLPOLICIES/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of a Frontdoor Web Application Firewall (WAF) Policy in Azure. An adversary may delete a Frontdoor Web Application Firewall (WAF) Policy in an attempt to evade defenses and/or to eliminate barriers to their objective. false_positives = [ Azure Front Web Application Firewall (WAF) Policy deletions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Azure Front Web Application Firewall (WAF) Policy deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.NETWORK/FRONTDOORWEBAPPLICATIONFIREWALLPOLICIES/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of a Network Watcher in Azure. Network Watchers are used to monitor, diagnose, view metrics, and enable or disable logs for resources in an Azure virtual network. An adversary may delete a Network Watcher in an attempt to evade defenses. false_positives = [ Network Watcher deletions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Network Watcher deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.NETWORK/NETWORKWATCHERS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of a resource group in Azure, which includes all resources within the group. Deletion is permanent and irreversible. An adversary may delete a resource group in an attempt to evade defenses or intentionally destroy data. false_positives = [ Deletion of a resource group may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Resource group deletions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.RESOURCES/SUBSCRIPTIONS/RESOURCEGROUPS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of a specified AWS CloudWatch log group. When a log group is deleted, all the archived log events associated with the log group are also permanently deleted. false_positives = [ Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Log group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogGroup and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of a specified AWS Identity and Access Management (IAM) resource group. Deleting a resource group does not delete resources that are members of the group; it only deletes the group structure. false_positives = [ A resource group may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Resource group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:DeleteGroup and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies the deletion of a subscription in Google Cloud Platform (GCP). In GCP, the publisher-subscriber relationship (Pub/Sub) is an asynchronous messaging service that decouples event-producing and event-processing services. A subscription is a named resource representing the stream of messages to be delivered to the subscribing application. false_positives = [ Subscription deletions may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Subscription deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Pub/Sub Subscription Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "cc89312d-6f47-48e4-a87c-4977bd4633c3" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.pubsub.v*.Subscriber.DeleteSubscription and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of a topic in Google Cloud Platform (GCP). In GCP, the publisher-subscriber relationship (Pub/Sub) is an asynchronous messaging service that decouples event-producing and event-processing services. A publisher application creates and sends messages to a topic. Deleting a topic can interrupt message flow in the Pub/Sub pipeline. false_positives = [ Topic deletions may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Topic deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Pub/Sub Topic Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "3202e172-01b1-4738-a932-d024c514ba72" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Log Auditing"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.pubsub.v*.Publisher.DeleteTopic and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of an Amazon Elastic Compute Cloud (EC2) network access control list (ACL) or one of its ingress/egress entries. false_positives = [ Network ACL's may be deleted by a network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Network ACL deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(DeleteNetworkAcl or DeleteNetworkAclEntry) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of an Amazon GuardDuty detector. Upon deletion, GuardDuty stops monitoring the environment and all existing findings are lost. false_positives = [ The GuardDuty detector may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Detector deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:guardduty.amazonaws.com and event.action:DeleteDetector and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of an Amazon Relational Database Service (RDS) Aurora database cluster, global database cluster, or database instance. false_positives = [ Clusters or instances may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Cluster or instance deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(DeleteDBCluster or DeleteGlobalCluster or DeleteDBInstance) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies the deletion of an anti-phishing policy in Microsoft 365. By default, Microsoft 365 includes built-in features that help protect users from phishing attacks. Anti-phishing polices increase this protection by refining settings to better detect and prevent attacks. false_positives = [ An anti-phishing policy may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Remove-AntiPhishPolicy" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the deletion of an AWS CloudWatch log stream, which permanently deletes all associated archived log events with the stream. false_positives = [ A log stream may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Log stream deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogStream and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of an Identity and Access Management (IAM) service account key in Google Cloud Platform (GCP). Each service account is associated with two sets of public/private RSA key pairs that are used to authenticate. If a key is deleted, the application will no longer be able to access Google Cloud resources using that key. A security best practice is to rotate your service account keys regularly. false_positives = [ Service account key deletions may be done by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Key deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP IAM Service Account Key Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 21 rule_id = "9890ee61-d061-403d-9bf6-64934c51f638" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.DeleteServiceAccountKey and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the deletion of Azure Kubernetes Pods. Adversaries may delete a Kubernetes pod to disrupt the normal behavior of the environment. false_positives = [ Pods may be deleted by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Pods deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/PODS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies the deletion of backup files, saved using third-party software, by a process outside of the backup suite. Adversaries may delete Backup files to ensure that recovery from a ransomware attack is less likely. false_positives = [ "Certain utilities that delete files for disk cleanup or Administrators manually removing backup files.", ] query = " file where event.type == "deletion" and ( /* Veeam Related Backup Files */ (file.extension : ("VBK", "VIB", "VBM") and not process.executable : ("?:\\Windows\\Veeam\\Backup\\*", "?:\\Program Files\\Veeam\\Backup and Replication\\*", "?:\\Program Files (x86)\\Veeam\\Backup and Replication\\*")) or /* Veritas Backup Exec Related Backup File */ (file.extension : "BKF" and not process.executable : ("?:\\Program Files\\Veritas\\Backup Exec\\*", "?:\\Program Files (x86)\\Veritas\\Backup Exec\\*")) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1490" name = "Inhibit System Recovery" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies the deletion of diagnostic settings in Azure, which send platform logs and metrics to different destinations. An adversary may delete diagnostic settings in an attempt to evade defenses. false_positives = [ Deletion of diagnostic settings may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Diagnostic settings deletion from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.INSIGHTS/DIAGNOSTICSETTINGS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of one or more flow logs in AWS Elastic Compute Cloud (EC2). An adversary may delete flow logs in an attempt to evade defenses. false_positives = [ Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Flow log deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:DeleteFlowLogs and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of sensitive Linux system logs. This may indicate an attempt to evade detection or destroy forensic evidence on a system. query = " file where event.type == "deletion" and file.path : ( "/var/run/utmp", "/var/log/wtmp", "/var/log/btmp", "/var/log/lastlog", "/var/log/faillog", "/var/log/syslog", "/var/log/messages", "/var/log/secure", "/var/log/auth.log", "/var/log/boot.log", "/var/log/kern.log" ) and not process.name : ("gzip") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.002" name = "Clear Linux or Mac System Logs" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensic evidence on a system. query = " file where event.type == "deletion" and file.path : ("C:\\inetpub\\logs\\LogFiles\\*.log", "/var/log/apache*/access.log", "/etc/httpd/logs/access_log", "/var/log/httpd/access_log", "/var/www/*/logs/access.log") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr to download arbitrary files as an alternative to certutil. query = " process where event.type == "start" and (process.name : "desktopimgdownldr.exe" or process.pe.original_file_name == "desktopimgdownldr.exe") and process.args : "/lockscreenurl:http*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1105" name = "Ingress Tool Transfer" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to disable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This may also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a stable state. query = " process where /* net, sc or wmic stopping or deleting Elastic Agent on Windows */ (event.type == "start" and process.name : ("net.exe", "sc.exe", "wmic.exe","powershell.exe","taskkill.exe","PsKill.exe","ProcessHacker.exe") and process.args : ("stopservice","uninstall", "stop", "disabled","Stop-Process","terminate","suspend") and process.args : ("elasticendpoint", "Elastic Agent","elastic-agent","elastic-endpoint")) or /* service or systemctl used to stop Elastic Agent on Linux */ (event.type == "end" and (process.name : ("systemctl", "service") and process.args : "elastic-agent" and process.args : "stop") or /* Unload Elastic Agent extension on MacOS */ (process.name : "kextunload" and process.args : "com.apple.iokit.EndpointSecurity" and event.action : "end")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the enable of the full user-mode dumps feature system-wide. This feature allows Windows Error Reporting (WER) to collect data after an application crashes. This setting is a requirement for the LSASS Shtinkering attack, which fakes the communication of a crash on LSASS, generating a dump of the process memory, which gives the attacker access to the credentials present on the system without having to bring malware to the system. This setting is not enabled by default, and applications must create their registry subkeys to hold settings that enable them to collect dumps. query = " registry where registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\LocalDumps\\DumpType" and registry.data.strings : ("2", "0x00000002") and not (process.executable : "?:\\Windows\\system32\\svchost.exe" and user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1112" name = "Modify Registry" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the execution of a binary by root in Linux shared memory directories: (/dev/shm/, /run/shm/, /var/run/, /var/lock/). This activity is to be considered highly abnormal and should be investigated. Threat actors have placed executables used for persistence on high-uptime servers in these directories as system backdoors. false_positives = [ Directories /dev/shm and /run/shm are temporary file storage directories in Linux. They are intended to appear as a mounted file system, but uses virtual memory instead of a persistent storage device and thus are used for mounting file systems in legitimate purposes., ] query = " process where event.type == "start" and event.action == "exec" and user.name == "root" and process.executable : ( "/dev/shm/*", "/run/shm/*", "/var/run/*", "/var/lock/*" ) and not process.executable : ( "/var/run/docker/*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggle data and files past content filters by hiding malicious payloads inside of seemingly benign HTML files. query = " sequence by user.id with maxspan=5m [file where event.action in ("creation", "rename") and file.extension : ("htm", "html") and file.path : ("?:\\Users\\*\\Downloads\\*", "?:\\Users\\*\\Content.Outlook\\*", "?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*", "?:\\Users\\*\\AppData\\Local\\Temp\\7z*", "?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*") and ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size >= 1000000)] [process where event.action == "start" and ( (process.name in ("chrome.exe", "msedge.exe", "brave.exe", "whale.exe", "browser.exe", "dragon.exe", "vivaldi.exe", "opera.exe") and process.args == "--single-argument") or (process.name == "iexplore.exe" and process.args_count == 2) or (process.name in ("firefox.exe", "waterfox.exe") and process.args == "-url") ) and process.args : ("?:\\Users\\*\\Downloads\\*.htm*", "?:\\Users\\*\\Content.Outlook\\*.htm*", "?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*.htm*", "?:\\Users\\*\\AppData\\Local\\Temp\\7z*.htm*", "?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*.htm*")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1027" name = "Obfuscated Files or Information" reference = [[rule.threat.technique.subtechnique]] id = "T1027.006" name = "HTML Smuggling" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the execution of a Chromium based browser with the debugging process argument, which may indicate an attempt to steal authentication cookies. An adversary may steal web application or service session cookies and use them to gain access web applications or Internet services as an authenticated user without needing credentials. false_positives = ["Developers performing browsers plugin or extension debugging."] query = " process where event.type in ("start", "process_started", "info") and process.name in ( "Microsoft Edge", "chrome.exe", "Google Chrome", "google-chrome-stable", "google-chrome-beta", "google-chrome", "msedge.exe") and process.args : ("--remote-debugging-port=*", "--remote-debugging-targets=*", "--remote-debugging-pipe=*") and process.args : "--user-data-dir=*" and not process.args:"--remote-debugging-port=0" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1539" name = "Steal Web Session Cookie" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movement via network file shares. query = " sequence with maxspan=1m [file where event.type in ("creation", "change") and process.pid == 4 and file.extension : "exe"] by host.id, file.path [process where event.type == "start"] by host.id, process.executable " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the execution of a launchd child process with a hidden file. An adversary can establish persistence by installing a new logon item, launch agent, or daemon that executes upon login. query = " event.category:process and event.type:(start or process_started) and process.name:.* and process.parent.executable:/sbin/launchd " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.001" name = "Launch Agent" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.001" name = "Hidden Files and Directories" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the execution of a process with arguments pointing to known browser files that store passwords and cookies. Adversaries may acquire credentials from web browsers by reading files specific to the target browser. query = " process where event.type in ("start", "process_started") and process.args : ( "/Users/*/Library/Application Support/Google/Chrome/Default/Login Data", "/Users/*/Library/Application Support/Google/Chrome/Default/Cookies", "/Users/*/Library/Application Support/Google/Chrome/Profile*/Cookies", "/Users/*/Library/Cookies*", "/Users/*/Library/Application Support/Firefox/Profiles/*.default/cookies.sqlite", "/Users/*/Library/Application Support/Firefox/Profiles/*.default/key*.db", "/Users/*/Library/Application Support/Firefox/Profiles/*.default/logins.json", "Login Data", "Cookies.binarycookies", "key4.db", "key3.db", "logins.json", "cookies.sqlite" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1539" name = "Steal Web Session Cookie" reference = [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.003" name = "Credentials from Web Browsers" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the execution of a suspicious browser child process. Adversaries may gain access to a system through a user visiting a website over the normal course of browsing. With this technique, the user's web browser is typically targeted for exploitation. query = " process where event.type in ("start", "process_started") and process.parent.name : ("Google Chrome", "Google Chrome Helper*", "firefox", "Opera", "Safari", "com.apple.WebKit.WebContent", "Microsoft Edge") and process.name : ("sh", "bash", "dash", "ksh", "tcsh", "zsh", "curl", "wget", "python*", "perl*", "php*", "osascript", "pwsh") and process.command_line != null and not process.command_line : "*/Library/Application Support/Microsoft/MAU*/Microsoft AutoUpdate.app/Contents/MacOS/msupdate*" and not process.args : ( "hw.model", "IOPlatformExpertDevice", "/Volumes/Google Chrome/Google Chrome.app/Contents/Frameworks/*/Resources/install.sh", "--defaults-torrc", "*Chrome.app", "Framework.framework/Versions/*/Resources/keystone_promote_preflight.sh", "/Users/*/Library/Application Support/Google/Chrome/recovery/*/ChromeRecovery", "$DISPLAY", "*GIO_LAUNCHED_DESKTOP_FILE_PID=$$*", "/opt/homebrew/*", "/usr/local/*brew*" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1203" name = "Exploitation for Client Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1189" name = "Drive-by Compromise" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the execution of a suspicious child process of the Event Monitor Daemon (emond). Adversaries may abuse this service by writing a rule to execute commands when a defined event occurs, such as system start up or user authentication. query = " process where event.type in ("start", "process_started") and process.parent.name : "emond" and process.name : ( "bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish", "Python", "python*", "perl*", "php*", "osascript", "pwsh", "curl", "wget", "cp", "mv", "touch", "echo", "base64", "launchctl") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.014" name = "Emond" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the execution of commands and scripts via System Manager. Execution methods such as RunShellScript, RunPowerShellScript, and alike can be abused by an authenticated attacker to install a backdoor or to interact with a compromised instance via reverse-shell using system only commands. false_positives = [ Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Suspicious commands from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:ssm.amazonaws.com and event.action:SendCommand and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.002" name = "Spearphishing Link" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the execution of discovery commands to enumerate system info or files and folders using the Windows Command Shell. query = " process where event.type == "start" and process.name : "cmd.exe" and process.args : "/c" and process.args : ("set", "dir") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1082" name = "System Information Discovery" reference = [[rule.threat.technique]] id = "T1083" name = "File and Directory Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.003" name = "Windows Command Shell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the execution of known Windows utilities often abused to dump LSASS memory or the Active Directory database (NTDS.dit) in preparation for credential access. query = " process where event.type == "start" and /* update here with any new lolbas with dump capability */ (process.pe.original_file_name == "procdump" and process.args : "-ma") or (process.name : "ProcessDump.exe" and not process.parent.executable regex~C:\\Program Files( \(x86\))?\\Cisco Systems\\.*") or (process.pe.original_file_name == "WriteMiniDump.exe" and not process.parent.executable regex~C:\\Program Files( \(x86\))?\\Steam\\.*") or (process.pe.original_file_name == "RUNDLL32.EXE" and (process.args : "MiniDump*" or process.command_line : "*comsvcs.dll*#24*")) or (process.pe.original_file_name == "RdrLeakDiag.exe" and process.args : "/fullmemdmp") or (process.pe.original_file_name == "SqlDumper.exe" and process.args : "0x01100*") or (process.pe.original_file_name == "TTTracer.exe" and process.args : "-dumpFull" and process.args : "-attach") or (process.pe.original_file_name == "ntdsutil.exe" and process.args : "create*full*") or (process.pe.original_file_name == "diskshadow.exe" and process.args : "/s") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [[rule.threat.technique.subtechnique]] id = "T1003.003" name = "NTDS" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the execution of macOS built-in commands related to account or group enumeration. Adversaries may use account and group information to orient themselves before deciding how to act. query = " process where event.type in ("start", "process_started") and ( process.name : ("ldapsearch", "dsmemberutil") or (process.name : "dscl" and process.args : ("read", "-read", "list", "-list", "ls", "search", "-search") and process.args : ("/Active Directory/*", "/Users*", "/Groups*")) ) and not process.parent.executable : ("/Applications/NoMAD.app/Contents/MacOS/NoMAD", "/Applications/ZoomPresence.app/Contents/MacOS/ZoomPresence", "/Applications/Sourcetree.app/Contents/MacOS/Sourcetree", "/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon", "/Applications/Jamf Connect.app/Contents/MacOS/Jamf Connect", "/usr/local/jamf/bin/jamf", "/Library/Application Support/AirWatch/hubd", "/opt/jc/bin/jumpcloud-agent", "/Applications/ESET Endpoint Antivirus.app/Contents/MacOS/esets_daemon", "/Applications/ESET Endpoint Security.app/Contents/MacOS/esets_daemon", "/Library/PrivilegedHelperTools/com.fortinet.forticlient.uninstall_helper" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1069" name = "Permission Groups Discovery" reference = [[rule.threat.technique]] id = "T1087" name = "Account Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies the execution of macOS built-in commands to connect to an existing Virtual Private Network (VPN). Adversaries may use VPN connections to laterally move and control remote systems on a network. query = " process where event.type in ("start", "process_started") and ( (process.name : "networksetup" and process.args : "-connectpppoeservice") or (process.name : "scutil" and process.args : "--nc" and process.args : "start") or (process.name : "osascript" and process.command_line : "osascript*set VPN to service*") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the execution of macOS built-in commands to mount a Server Message Block (SMB) network share. Adversaries may use valid accounts to interact with a remote network share using SMB. query = " process where event.type in ("start", "process_started") and ( process.name : "mount_smbfs" or (process.name : "open" and process.args : "smb://*") or (process.name : "mount" and process.args : "smbfs") or (process.name : "osascript" and process.command_line : "osascript*mount volume*smb://*") ) and not process.parent.executable : "/Applications/Google Drive.app/Contents/MacOS/Google Drive" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the execution of macOS built-in commands used to dump user account hashes. Adversaries may attempt to dump credentials to obtain account login information in the form of a hash. These hashes can be cracked or leveraged for lateral movement. query = " event.category:process and event.type:start and process.name:(defaults or mkpassdb) and process.args:(ShadowHashData or "-dump") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the execution of osascript to create a hidden login item. This may indicate an attempt to persist a malicious program while concealing its presence. query = " process where event.type in ("start", "process_started") and process.name : "osascript" and process.command_line : "osascript*login item*hidden:true*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.002" name = "AppleScript" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1647" name = "Plist File Modification" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the execution of the Automator Workflows process followed by a network connection from it's XPC service. Adversaries may drop a custom workflow template that hosts malicious JavaScript for Automation (JXA) code as an alternative to using osascript. query = " sequence by host.id with maxspan=30s [process where event.type in ("start", "process_started") and process.name == "automator"] [network where process.name:"com.apple.automator.runner"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the execution of the EarthWorm tunneler. Adversaries may tunnel network communications to and from a victim system within a separate protocol to avoid detection and network filtering, or to enable access to otherwise unreachable systems. query = " process where event.type == "start" and process.args : "-s" and process.args : "-d" and process.args : "rssocks" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1572" name = "Protocol Tunneling" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies the execution of the shell process (sh) via scripting (JXA or AppleScript). Adversaries may use the doShellScript functionality in JXA or do shell script in AppleScript to execute system commands. query = " sequence by host.id with maxspan=5s [process where event.type in ("start", "process_started", "info") and process.name == "osascript"] by process.pid [process where event.type in ("start", "process_started") and process.name == "sh" and process.args == "-c"] by process.parent.pid " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the installation of custom Application Compatibility Shim databases. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes. query = " sequence by process.entity_id with maxspan = 5m [process where event.type == "start" and not (process.name : "sdbinst.exe" and process.parent.name : "msiexec.exe")] [registry where event.type in ("creation", "change") and registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\*.sdb"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.011" name = "Application Shimming" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the Internet Information Services (IIS) command-line tool, AppCmd, being used to list passwords. An attacker with IIS web server access via a web shell can decrypt and dump the IIS AppPool service account password using AppCmd. query = " process where event.type == "start" and (process.name : "appcmd.exe" or process.pe.original_file_name == "appcmd.exe") and process.args : "/list" and process.args : "/text*password" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the load of a driver with an original file name and signature values that were observed for the first time during the last 30 days. This rule type can help baseline drivers installation within your environment. query = " event.category : "driver" and event.action : "load" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [rule.new_terms] field = "new_terms_fields" value = ["dll.pe.original_file_name", "dll.code_signature.subject_name"] [[rule.new_terms.history_window_start]] field = "history_window_start" value = "now-30d"
<li><a href="#">description = Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or one that can be loaded from a different location by a native Windows process. This may be abused to persist or elevate privileges via privileged file write vulnerabilities. query = " any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and ( /* compatible with Elastic Endpoint Library Events */ (dll.name : ("wlbsctrl.dll", "wbemcomn.dll", "WptsExtensions.dll", "Tsmsisrv.dll", "TSVIPSrv.dll", "Msfte.dll", "wow64log.dll", "WindowsCoreDeviceInfo.dll", "Ualapi.dll", "wlanhlp.dll", "phoneinfo.dll", "EdgeGdi.dll", "cdpsgshims.dll", "windowsperformancerecordercontrol.dll", "diagtrack_win.dll", "oci.dll", "TPPCOIPW32.dll", "tpgenlic.dll", "thinmon.dll", "fxsst.dll", "msTracer.dll") and (dll.code_signature.trusted == false or dll.code_signature.exists == false)) or /* compatible with Sysmon EventID 7 - Image Load */ (file.name : ("wlbsctrl.dll", "wbemcomn.dll", "WptsExtensions.dll", "Tsmsisrv.dll", "TSVIPSrv.dll", "Msfte.dll", "wow64log.dll", "WindowsCoreDeviceInfo.dll", "Ualapi.dll", "wlanhlp.dll", "phoneinfo.dll", "EdgeGdi.dll", "cdpsgshims.dll", "windowsperformancerecordercontrol.dll", "diagtrack_win.dll", "oci.dll", "TPPCOIPW32.dll", "tpgenlic.dll", "thinmon.dll", "fxsst.dll", "msTracer.dll") and not file.code_signature.status == "Valid") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.002" name = "DLL Side-Loading" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1574" name = "Hijack Execution Flow" reference = [[rule.threat.technique.subtechnique]] id = "T1574.001" name = "DLL Search Order Hijacking" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the modification of an account's Kerberos pre-authentication options. An adversary with GenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline password cracking attacks such as AS-REP roasting. query = " event.code:4738 and message:"'Don't Require Preauth' - Enabled" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [[rule.threat.technique.subtechnique]] id = "T1558.004" name = "AS-REP Roasting" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the modification of an anti-phishing rule in Microsoft 365. By default, Microsoft 365 includes built-in features that help protect users from phishing attacks. Anti-phishing rules increase this protection by refining settings to better detect and prevent attacks. false_positives = [ An anti-phishing rule may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:("Remove-AntiPhishRule" or "Disable-AntiPhishRule") and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique to maintain persistence to the domain by having the ability to request tickets for the KRBTGT service. query = " event.action:modified-user-account and event.code:4738 and winlog.event_data.AllowedToDelegateTo:*krbtgt* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon provider module for persistence and/or credential access via intercepting the authentication credentials in clear text during user logon. false_positives = ["Authorized third party network logon providers."] query = " registry where registry.data.strings != null and registry.path : ( "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\NetworkProvider\\ProviderPath", "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\NetworkProvider\\ProviderPath" ) and /* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */ not ( user.id : "S-1-5-18" and registry.data.strings in ("%SystemRoot%\\System32\\ntlanman.dll", "%SystemRoot%\\System32\\drprov.dll", "%SystemRoot%\\System32\\davclnt.dll") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the modification of the Remote Desktop Protocol (RDP) Shadow registry or the execution of processes indicative of an active RDP shadowing session. An adversary may abuse the RDP Shadowing feature to spy on or control other users active RDP sessions. query = " /* Identifies the modification of RDP Shadow registry or the execution of processes indicative of active shadow RDP session */ any where (event.category == "registry" and registry.path : "HKLM\\Software\\Policies\\Microsoft\\Windows NT\\Terminal Services\\Shadow" ) or (event.category == "process" and (process.name : ("RdpSaUacHelper.exe", "RdpSaProxy.exe") and process.parent.name : "svchost.exe") or (process.pe.original_file_name : "mstsc.exe" and process.args : "/shadow:*") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection. This may be indicative of an attacker bypassing allowlists or running arbitrary scripts via a signed Microsoft binary. false_positives = [ Security testing may produce events like this. Activity of this kind performed by non-engineers and ordinary users is unusual., ] query = " sequence by process.entity_id [process where event.type == "start" and process.name : ("regsvr32.exe", "RegAsm.exe", "RegSvcs.exe") and not ( (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and (process.parent.name : "msiexec.exe" or process.parent.executable : ("C:\\Program Files (x86)\\*.exe", "C:\\Program Files\\*.exe")) ) ] [network where process.name : ("regsvr32.exe", "RegAsm.exe", "RegSvcs.exe") and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8") and network.protocol != "dns"] " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.010" name = "Regsvr32" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain initial access to other endpoints in the environment. false_positives = ["Benign files can trigger signatures in the built-in virus protection"] query = " event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1080" name = "Taint Shared Content" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the occurence of files uploaded to SharePoint being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunities to gain initial access to other endpoints in the environment. false_positives = ["Benign files can trigger signatures in the built-in virus protection"] query = " event.dataset:o365.audit and event.provider:SharePoint and event.code:SharePointFileOperation and event.action:FileMalwareDetected " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1080" name = "Taint Shared Content" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the occurrence of a CyberArk Privileged Access Security (PAS) error level audit event. The event.code correlates to the CyberArk Vault Audit Action Code. false_positives = ["To tune this rule, add exceptions to exclude any event.code which should not trigger this rule."] query = " event.dataset:cyberarkpas.audit and event.type:error " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the occurrence of a CyberArk Privileged Access Security (PAS) non-error level audit event which is recommended for monitoring by the vendor. The event.code correlates to the CyberArk Vault Audit Action Code. false_positives = ["To tune this rule, add exceptions to exclude any event.code which should not trigger this rule."] query = " event.dataset:cyberarkpas.audit and event.code:(4 or 22 or 24 or 31 or 38 or 57 or 60 or 130 or 295 or 300 or 302 or 308 or 319 or 344 or 346 or 359 or 361 or 378 or 380 or 411) and not event.type:error " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the PowerShell engine being invoked by unexpected processes. Rather than executing PowerShell functionality with powershell.exe, some attackers do this to operate more stealthily. query = " any where (event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : ("System.Management.Automation.ni.dll", "System.Management.Automation.dll") or file.name : ("System.Management.Automation.ni.dll", "System.Management.Automation.dll")) and /* add false positives relevant to your environment here */ not process.executable : ("C:\\Windows\\System32\\RemoteFXvGPUDisablement.exe", "C:\\Windows\\System32\\sdiagnhost.exe") and not process.executable regex~C:\\Program Files( \(x86\))?\\*\.exe" and not process.name : ( "Altaro.SubAgent.exe", "AppV_Manage.exe", "azureadconnect.exe", "CcmExec.exe", "configsyncrun.exe", "choco.exe", "ctxappvservice.exe", "DVLS.Console.exe", "edgetransport.exe", "exsetup.exe", "forefrontactivedirectoryconnector.exe", "InstallUtil.exe", "JenkinsOnDesktop.exe", "Microsoft.EnterpriseManagement.ServiceManager.UI.Console.exe", "mmc.exe", "mscorsvw.exe", "msexchangedelivery.exe", "msexchangefrontendtransport.exe", "msexchangehmworker.exe", "msexchangesubmission.exe", "msiexec.exe", "MsiExec.exe", "noderunner.exe", "NServiceBus.Host.exe", "NServiceBus.Host32.exe", "NServiceBus.Hosting.Azure.HostProcess.exe", "OuiGui.WPF.exe", "powershell.exe", "powershell_ise.exe", "pwsh.exe", "SCCMCliCtrWPF.exe", "ScriptEditor.exe", "ScriptRunner.exe", "sdiagnhost.exe", "servermanager.exe", "setup100.exe", "ServiceHub.VSDetouredHost.exe", "SPCAF.Client.exe", "SPCAF.SettingsEditor.exe", "SQLPS.exe", "telemetryservice.exe", "UMWorkerProcess.exe", "w3wp.exe", "wsmprovhost.exe" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connection within a short time period. This may indicate lateral movement or remote discovery via scheduled tasks. false_positives = ["Legitimate scheduled tasks may be created during installation of new software."] query = " sequence by host.id, process.entity_id with maxspan = 5s [any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : "taskschd.dll" or file.name : "taskschd.dll") and process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe")] [network where process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and destination.port == 135 and not destination.address in ("127.0.0.1", "::1")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain controller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation step to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin privileges. query = " sequence by winlog.computer_name with maxspan=5m [authentication where event.action == "logged-in" and winlog.logon.type == "Network" and event.outcome == "success" and not user.name == "ANONYMOUS LOGON" and not winlog.event_data.SubjectUserName : "*$" and not user.domain == "NT AUTHORITY" and source.ip != "127.0.0.1" and source.ip !="::1"] by winlog.event_data.TargetLogonId [iam where event.action == "changed-computer-account" and /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */ winlog.event_data.DnsHostName : "??*" and /* exclude FPs where DnsHostName starts with the ComputerName that was changed */ not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1)) ] by winlog.event_data.SubjectLogonId " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.002" name = "Domain Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies the suspicious use of GetSessionToken. Tokens could be created and used by attackers to move laterally and escalate privileges. false_positives = [ GetSessionToken may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. GetSessionToken from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-aws*"] language = "kuery" license = "Elastic License v2" name = "AWS STS GetSessionToken Abuse" note =## Setup The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "b45ab1d2-712f-4f01-a751-df3826969807" severity = "low" tags = ["Elastic", "Cloud", "AWS", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:aws.cloudtrail and event.provider:sts.amazonaws.com and event.action:GetSessionToken and aws.cloudtrail.user_identity.type:IAMUser and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1550" name = "Use Alternate Authentication Material" reference = [[rule.threat.technique.subtechnique]] id = "T1550.001" name = "Application Access Token" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, which malware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses. false_positives = ["Legitimate PowerShell Scripts which makes use of compression and encoding."] query = " event.category:process and powershell.file.script_block_text : ( ( "System.IO.Compression.DeflateStream" or "System.IO.Compression.GzipStream" or "IO.Compression.DeflateStream" or "IO.Compression.GzipStream" ) and FromBase64String ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1027" name = "Obfuscated Files or Information" reference = [[rule.threat.technique]] id = "T1140" name = "Deobfuscate/Decode Files or Information" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies the use of a compression utility to collect known files containing sensitive information, such as credentials and system configurations. query = " event.category:process and event.type:start and process.name:(zip or tar or gzip or hdiutil or 7z) and process.args: ( /root/.ssh/id_rsa or /root/.ssh/id_rsa.pub or /root/.ssh/id_ed25519 or /root/.ssh/id_ed25519.pub or /root/.ssh/authorized_keys or /root/.ssh/authorized_keys2 or /root/.ssh/known_hosts or /root/.bash_history or /etc/hosts or /home/*/.ssh/id_rsa or /home/*/.ssh/id_rsa.pub or /home/*/.ssh/id_ed25519 or /home/*/.ssh/id_ed25519.pub or /home/*/.ssh/authorized_keys or /home/*/.ssh/authorized_keys2 or /home/*/.ssh/known_hosts or /home/*/.bash_history or /root/.aws/credentials or /root/.aws/config or /home/*/.aws/credentials or /home/*/.aws/config or /root/.docker/config.json or /home/*/.docker/config.json or /etc/group or /etc/passwd or /etc/shadow or /etc/gshadow ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1552" name = "Unsecured Credentials" reference = [[rule.threat.technique.subtechnique]] id = "T1552.001" name = "Credentials In Files" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1560" name = "Archive Collected Data" reference = [[rule.threat.technique.subtechnique]] id = "T1560.001" name = "Archive via Utility" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies the use of AssumeRole. AssumeRole returns a set of temporary security credentials that can be used to access AWS resources. An adversary could use those credentials to move laterally and escalate privileges. false_positives = ["Automated processes that use Terraform may lead to false positives."] index = ["filebeat-*", "logs-aws*"] language = "kuery" license = "Elastic License v2" name = "AWS Security Token Service (STS) AssumeRole Usage" note =## Setup The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "93075852-b0f5-4b8b-89c3-a226efae5726" severity = "low" tags = ["Elastic", "Cloud", "AWS", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:aws.cloudtrail and event.provider:sts.amazonaws.com and event.action:AssumedRole and aws.cloudtrail.user_identity.session_context.session_issuer.type:Role and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1550" name = "Use Alternate Authentication Material" reference = [[rule.threat.technique.subtechnique]] id = "T1550.001" name = "Application Access Token" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which are launched via the HTA Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally while attempting to evade detection. query = " sequence with maxspan=1m [process where event.type == "start" and process.name : "mshta.exe" and process.args : "-Embedding" ] by host.id, process.entity_id [network where event.type == "start" and process.name : "mshta.exe" and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.port > 49151 and destination.port > 49151 and source.ip != "127.0.0.1" and source.ip != "::1" ] by host.id, process.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.003" name = "Distributed Component Object Model" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.005" name = "Mshta" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the MMC20 Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally. query = " sequence by host.id with maxspan=1m [network where event.type == "start" and process.name : "mmc.exe" and source.port >= 49152 and destination.port >= 49152 and source.ip != "127.0.0.1" and source.ip != "::1" and network.direction : ("incoming", "ingress") and network.transport == "tcp" ] by process.entity_id [process where event.type == "start" and process.parent.name : "mmc.exe" ] by process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.003" name = "Distributed Component Object Model" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement or preparation for data exfiltration. query = " process where event.type == "start" and ((process.name : "net.exe" or process.pe.original_file_name == "net.exe") or ((process.name : "net1.exe" or process.pe.original_file_name == "net1.exe") and not process.parent.name : "net.exe")) and process.args : "use" and /* including hidden and webdav based online shares such as onedrive */ process.args : ("\\\\*\\*$*", "\\\\*@SSL\\*", "http*") and /* excluding shares deletion operation */ not process.args : "/d*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.003" name = "Local Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC) replication in a Microsoft Windows NT Domain. false_positives = [ Domain administrators may use this command-line utility for legitimate information gathering purposes, but it is not common for environments with Windows Server 2012 and newer., ] query = " process where event.type == "start" and process.name : "nltest.exe" and process.args : ( "/DCLIST:*", "/DCNAME:*", "/DSGET*", "/LSAQUERYFTI:*", "/PARENTDOMAIN", "/DOMAIN_TRUSTS", "/BDC_QUERY:*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1482" name = "Domain Trust Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies the use of osascript to execute scripts via standard input that may prompt a user with a rogue dialog for credentials. query = " process where event.type in ("start", "process_started") and process.name : "osascript" and process.command_line : "osascript*display dialog*password*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1056" name = "Input Capture" reference = [[rule.threat.technique.subtechnique]] id = "T1056.002" name = "GUI Input Capture" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the use of sqlite3 to directly modify the Transparency, Consent, and Control (TCC) SQLite database. This may indicate an attempt to bypass macOS privacy controls, including access to sensitive resources like the system camera, microphone, address book, and calendar. query = " process where event.type in ("start", "process_started") and process.name : "sqlite*" and process.args : "/*/Application Support/com.apple.TCC/TCC.db" and not process.parent.executable : "/Library/Bitdefender/AVP/product/bin/*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the use of the built-in networksetup command to configure webproxy settings. This may indicate an attempt to hijack web browser traffic for credential access via traffic sniffing or redirection. false_positives = ["Legitimate WebProxy Settings Modification"] query = " event.category : process and event.type : start and process.name : networksetup and process.args : (("-setwebproxy" or "-setsecurewebproxy" or "-setautoproxyurl") and not (Bluetooth or off)) and not process.parent.executable : ("/Library/PrivilegedHelperTools/com.80pct.FreedomHelper" or "/Applications/Fiddler Everywhere.app/Contents/Resources/app/out/WebServer/Fiddler.WebUi" or "/usr/libexec/xpcproxy") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1539" name = "Steal Web Session Cookie" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information. false_positives = ["Legitimate exchange system administration activity."] query = " process where event.type == "start" and process.name: ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and process.command_line : ("*MailboxExportRequest*", "*-Mailbox*-ContentFilter*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1005" name = "Data from Local System" reference = [[rule.threat.technique]] id = "T1114" name = "Email Collection" reference = [[rule.threat.technique.subtechnique]] id = "T1114.002" name = "Remote Email Collection" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information. false_positives = ["Legitimate exchange system administration activity."] query = " event.category:process and powershell.file.script_block_text : "New-MailboxExportRequest" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1114" name = "Email Collection" reference = [[rule.threat.technique.subtechnique]] id = "T1114.001" name = "Local Email Collection" reference = [[rule.threat.technique.subtechnique]] id = "T1114.002" name = "Remote Email Collection" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device. Adversaries may target user email to collect sensitive information. false_positives = ["Legitimate exchange system administration activity."] query = " process where event.type == "start" and process.name: ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and process.args : "Set-CASMailbox*ActiveSyncAllowedDeviceIDs*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.002" name = "Additional Email Delegate Permissions" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirus or Host Firewall details. false_positives = ["Endpoint Security installers, updaters and post installation verification scripts."] query = " process where event.type == "start" and process.name : "grep" and user.id != "0" and not process.parent.executable : "/Library/Application Support/*" and process.args : ("Little Snitch*", "Avast*", "Avira*", "ESET*", "BlockBlock*", "360Sec*", "LuLu*", "KnockKnock*", "kav", "KIS", "RTProtectionDaemon*", "Malware*", "VShieldScanner*", "WebProtection*", "webinspectord*", "McAfee*", "isecespd*", "macmnsvc*", "masvc*", "kesl*", "avscan*", "guard*", "rtvscand*", "symcfgd*", "scmdaemon*", "symantec*", "sophos*", "osquery*", "elastic-endpoint*" ) and not (process.args : "Avast" and process.args : "Passwords") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1518" name = "Software Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1518.001" name = "Security Software Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies the use of the Kerberos credential cache (kcc) utility to dump locally cached Kerberos tickets. Adversaries may attempt to dump credential material in the form of tickets that can be leveraged for lateral movement. query = " event.category:process and event.type:(start or process_started) and process.name:kcc and process.args:copy_cred_cache " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [[rule.threat.technique.subtechnique]] id = "T1558.003" name = "Kerberoasting" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies the use of the mount_apfs command to mount the entire file system through Apple File System (APFS) snapshots as read-only and with the noowners flag set. This action enables the adversary to access almost any file in the file system, including all user data and files protected by Apples privacy framework (TCC). query = " event.category : process and event.type : (start or process_started) and process.name : mount_apfs and process.args : (/System/Volumes/Data and noowners) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1006" name = "Direct Volume Access" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonly occurs in tandem with ransomware or other destructive attacks. query = " process where event.type == "start" and process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and process.args : ("*Get-WmiObject*", "*gwmi*", "*Get-CimInstance*", "*gcim*") and process.args : ("*Win32_ShadowCopy*") and process.args : ("*.Delete()*", "*Remove-WmiObject*", "*rwmi*", "*Remove-CimInstance*", "*rcim*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1490" name = "Inhibit System Recovery" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies the use of Windows Management Instrumentation Command (WMIC) to discover certain System Security Settings such as AntiVirus or Host Firewall details. query = " process where event.type == "start" and (process.name:"wmic.exe" or process.pe.original_file_name:"wmic.exe") and process.args:"/namespace:\\\\root\\SecurityCenter2" and process.args:"Get" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1518" name = "Software Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1518.001" name = "Security Software Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working directory. Misuse of Windows Work Folders could indicate malicious activity. query = " process where event.type == "start" and process.name : "control.exe" and process.parent.name : "WorkFolders.exe" and not process.executable : ("?:\\Windows\\System32\\control.exe", "?:\\Windows\\SysWOW64\\control.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies unexpected processes making network connections over port 445. Windows File Sharing is typically implemented over Server Message Block (SMB), which communicates between hosts using port 445. When legitimate, these network connections are established by the kernel. Processes making 445/tcp connections may be port scanners, exploits, or suspicious user-level processes moving laterally. query = " sequence by process.entity_id [process where event.type == "start" and host.os.name == "Windows" and process.pid != 4 and not (process.executable : "D:\\EnterpriseCare\\tools\\jre.1\\bin\\java.exe" and process.args : "com.emeraldcube.prism.launcher.Invoker") and not (process.executable : "C:\\Docusnap 11\\Tools\\nmap\\nmap.exe" and process.args : "smb-os-discovery.nse") and not process.executable : ("?:\\Program Files\\SentinelOne\\Sentinel Agent *\\Ranger\\SentinelRanger.exe", "?:\\Program Files\\Ivanti\\Security Controls\\ST.EngineHost.exe", "?:\\Program Files (x86)\\Fortinet\\FSAE\\collectoragent.exe", "?:\\Program Files (x86)\\Nmap\\nmap.exe", "?:\\Program Files\\Azure Advanced Threat Protection Sensor\\*\\Microsoft.Tri.Sensor.exe", "?:\\Program Files\\CloudMatters\\auvik\\AuvikService-release-*\\AuvikService.exe", "?:\\Program Files\\uptime software\\uptime\\UptimeDataCollector.exe", "?:\\Program Files\\CloudMatters\\auvik\\AuvikAgentService.exe", "?:\\Program Files\\Rumble\\rumble-agent-*.exe")] [network where destination.port == 445 and process.pid != 4 and not cidrmatch(destination.ip, "127.0.0.1", "::1")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.002" name = "SMB/Windows Admin Shares" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes. This may indicate a code injection or an equivalent form of exploitation. false_positives = ["Changes to Windows services or a rarely executed child process."] query = " process where event.type == "start" and process.parent.name : "svchost.exe" and /* based on svchost service arguments -s svcname where the service is known to be childless */ process.parent.args : ("WdiSystemHost","LicenseManager", "StorSvc","CDPSvc","cdbhsvc","BthAvctpSvc","SstpSvc","WdiServiceHost", "imgsvc","TrkWks","WpnService","IKEEXT","PolicyAgent","CryptSvc", "netprofm","ProfSvc","StateRepository","camsvc","LanmanWorkstation", "NlaSvc","EventLog","hidserv","DisplayEnhancementService","ShellHWDetection", "AppHostSvc","fhsvc","CscService","PushToInstall") and /* unknown FPs can be added here */ not process.name : ("WerFault.exe","WerFaultSecure.exe","wermgr.exe") and not (process.executable : "?:\\Windows\\System32\\RelPost.exe" and process.parent.args : "WdiSystemHost") and not (process.name : "rundll32.exe" and process.args : "?:\\WINDOWS\\System32\\winethc.dll,ForceProxyDetectionOnNextRun" and process.parent.args : "WdiServiceHost") and not (process.executable : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*", "?:\\Windows\\System32\\Kodak\\kds_i4x50\\lib\\lexexe.exe") and process.parent.args : "imgsvc") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [[rule.threat.technique.subtechnique]] id = "T1055.012" name = "Process Hollowing" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies unusual instances of Control Panel with suspicious keywords or paths in the process command line value. Adversaries may abuse control.exe to proxy execution of malicious code. query = " process where event.type == "start" and process.executable : ("?:\\Windows\\SysWOW64\\control.exe", "?:\\Windows\\System32\\control.exe") and process.command_line : ("*.jpg*", "*.png*", "*.gif*", "*.bmp*", "*.jpeg*", "*.TIFF*", "*.inf*", "*.cpl:*/*", "*../../..*", "*/AppData/Local/*", "*:\\Users\\Public\\*", "*\\AppData\\Local\\*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.002" name = "Control Panel" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Command and Control activity. query = " sequence by host.id, process.entity_id with maxspan=1m [process where event.type == "start" and process.name : "dllhost.exe" and process.args_count == 1] [network where process.name : "dllhost.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Command and Control activity. query = " sequence by host.id, process.entity_id with maxspan=1m [process where event.type == "start" and process.name : "rundll32.exe" and process.args_count == 1] [network where process.name : "rundll32.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.011" name = "Rundll32" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a known encryption algorithm to conceal command and control traffic. query = " network where network.protocol == "dns" and /* Add new free SSL certificate provider domains here */ dns.question.name : ("*letsencrypt.org", "*.sslforfree.com", "*.zerossl.com", "*.freessl.org") and /* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */ process.executable : ("C:\\Windows\\System32\\*.exe", "C:\\Windows\\System\\*.exe", "C:\\Windows\\SysWOW64\\*.exe", "C:\\Windows\\Microsoft.NET\\Framework*\\*.exe", "C:\\Windows\\explorer.exe", "C:\\Windows\\notepad.exe") and /* Insert noisy false positives here */ not process.name : ("svchost.exe", "MicrosoftEdge*.exe", "msedge.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1573" name = "Encrypted Channel" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web server access via a webshell or alike can decrypt and dump any hardcoded connection strings, such as the MSSQL service account password using aspnet_regiis command. query = " process where event.type == "start" and (process.name : "aspnet_regiis.exe" or process.pe.original_file_name == "aspnet_regiis.exe") and process.args : "connectionStrings" and process.args : "-pdf" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an attacker as a destructive technique. query = " process where event.type == "start" and (process.name : "bcdedit.exe" or process.pe.original_file_name == "bcdedit.exe") and ( (process.args : "/set" and process.args : "bootstatuspolicy" and process.args : "ignoreallfailures") or (process.args : "no" and process.args : "recoveryenabled") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1490" name = "Inhibit System Recovery" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies use of Bifrost, a known macOS Kerberos pentesting tool, which can be used to dump cached Kerberos tickets or attempt unauthorized authentication techniques such as pass-the-ticket/hash and kerberoasting. query = " event.category:process and event.type:start and process.args:("-action" and ("-kerberoast" or askhash or asktgs or asktgt or s4u or ("-ticket" and ptt) or (dump and (tickets or keytab)))) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1550" name = "Use Alternate Authentication Material" reference = [[rule.threat.technique.subtechnique]] id = "T1550.003" name = "Pass the Ticket" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1558" name = "Steal or Forge Kerberos Tickets" reference = [[rule.threat.technique.subtechnique]] id = "T1558.003" name = "Kerberoasting" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the ShellBrowserWindow or ShellWindows Application COM Object. This behavior may indicate an attacker abusing a DCOM application to stealthily move laterally. query = " sequence by host.id with maxspan=5s [network where event.type == "start" and process.name : "explorer.exe" and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.port > 49151 and destination.port > 49151 and source.ip != "127.0.0.1" and source.ip != "::1" ] by process.entity_id [process where event.type == "start" and process.parent.name : "explorer.exe" ] by process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [[rule.threat.technique.subtechnique]] id = "T1021.003" name = "Distributed Component Object Model" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversary lateral movement but will be noisy if commonly done by admins. query = " sequence by process.entity_id with maxspan = 1m [process where event.type == "start" and (process.name : "sc.exe" or process.pe.original_file_name : "sc.exe") and process.args : "\\\\*" and process.args : ("binPath=*", "binpath=*") and process.args : ("create", "config", "failure", "start")] [network where process.name : "sc.exe" and destination.ip != "127.0.0.1"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1569" name = "System Services" reference = [[rule.threat.technique.subtechnique]] id = "T1569.002" name = "Service Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process via Windows Management Instrumentation (WMI). This may be indicative of malicious activity. query = " sequence by host.id with maxspan = 5s [any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : "wmiutils.dll" or file.name : "wmiutils.dll") and process.name : ("wscript.exe", "cscript.exe")] [process where event.type == "start" and process.parent.name : "wmiprvse.exe" and user.domain != "NT AUTHORITY" and (process.pe.original_file_name : ( "cscript.exe", "wscript.exe", "PowerShell.EXE", "Cmd.Exe", "MSHTA.EXE", "RUNDLL32.EXE", "REGSVR32.EXE", "MSBuild.exe", "InstallUtil.exe", "RegAsm.exe", "RegSvcs.exe", "msxsl.exe", "CONTROL.EXE", "EXPLORER.EXE", "Microsoft.Workflow.Compiler.exe", "msiexec.exe" ) or process.executable : ("C:\\Users\\*.exe", "C:\\ProgramData\\*.exe") ) ] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [[rule.threat.technique.subtechnique]] id = "T1566.001" name = "Spearphishing Attachment" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies use of the Defaults command to install a login or logoff hook in MacOS. An adversary may abuse this capability to establish persistence in an environment by inserting code to be executed at login or logout. query = " process where event.type == "start" and process.name == "defaults" and process.args == "write" and process.args in ("LoginHook", "LogoutHook") and not process.args : ( "Support/JAMF/ManagementFrameworkScripts/logouthook.sh", "Support/JAMF/ManagementFrameworkScripts/loginhook.sh", "/Library/Application Support/JAMF/ManagementFrameworkScripts/logouthook.sh", "/Library/Application Support/JAMF/ManagementFrameworkScripts/loginhook.sh" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1037" name = "Boot or Logon Initialization Scripts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidence of files created during post-exploitation activities. query = " process where event.type == "start" and (process.name : "fsutil.exe" or process.pe.original_file_name == "fsutil.exe") and process.args : "deletejournal" and process.args : "usn" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.004" name = "File Deletion" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-line tool to weaken the host firewall settings. false_positives = ["Host Windows Firewall planned system administration changes."] query = " process where event.type == "start" and process.name : "netsh.exe" and process.args : ("firewall", "advfirewall") and process.args : "group=Network Discovery" and process.args : "enable=Yes" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.004" name = "Disable or Modify System Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies use of the netsh.exe to disable or weaken the local firewall. Attackers will use this command line tool to disable the firewall during troubleshooting or to enable network mobility. query = " process where event.type == "start" and process.name : "netsh.exe" and ( (process.args : "disable" and process.args : "firewall" and process.args : "set") or (process.args : "advfirewall" and process.args : "off" and process.args : "state") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.004" name = "Disable or Modify System Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies use of the network shell utility (netsh.exe) to enable inbound Remote Desktop Protocol (RDP) connections in the Windows Firewall. query = " process where event.type == "start" and (process.name : "netsh.exe" or process.pe.original_file_name == "netsh.exe") and process.args : ("localport=3389", "RemoteDesktop", "group=\"remote desktop\) and process.args : ("action=allow", "enable=Yes", "enable") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.004" name = "Disable or Modify System Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies use of the Secure Copy Protocol (SCP) to copy files locally by abusing the auto addition of the Secure Shell Daemon (sshd) to the authorized application list for Full Disk Access. This may indicate attempts to bypass macOS privacy controls to access sensitive files. query = " process where event.type in ("start", "process_started") and process.name:"scp" and process.args:"StrictHostKeyChecking=no" and process.command_line:("scp *localhost:/*", "scp *127.0.0.1:/*") and not process.args:"vagrant@*127.0.0.1*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateral movement. false_positives = [ PsExec is a dual-use tool that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool., ] query = " sequence by process.entity_id [process where process.name : "PsExec.exe" and event.type == "start" and /* This flag suppresses the display of the license dialog and may indicate that psexec executed for the first time in the machine */ process.args : "-accepteula" and not process.executable : ("?:\\ProgramData\\Docusnap\\Discovery\\discovery\\plugins\\17\\Bin\\psexec.exe", "?:\\Docusnap 11\\Bin\\psexec.exe", "?:\\Program Files\\Docusnap X\\Bin\\psexec.exe", "?:\\Program Files\\Docusnap X\\Tools\\dsDNS.exe") and not process.parent.executable : "?:\\Program Files (x86)\\Cynet\\Cynet Scanner\\CynetScanner.exe"] [network where process.name : "PsExec.exe"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1569" name = "System Services" reference = [[rule.threat.technique.subtechnique]] id = "T1569.002" name = "Service Execution" reference = [rule.threat.tactic] id = "TA0002" name = "Execution" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Identifies use of the wbadmin.exe to delete the backup catalog. Ransomware and other malware may do this to prevent system recovery. query = " process where event.type == "start" and (process.name : "wbadmin.exe" or process.pe.original_file_name == "WBADMIN.EXE") and process.args : "catalog" and process.args : "delete" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1490" name = "Inhibit System Recovery" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies use of the Windows file system utility (fsutil.exe) to gather information about attached peripheral devices and components connected to a computer system. query = " process where event.type == "start" and (process.name : "fsutil.exe" or process.pe.original_file_name == "fsutil.exe") and process.args : "fsinfo" and process.args : "drives" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1120" name = "Peripheral Device Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies use of the Windows Management Instrumentation StdRegProv (registry provider) to modify commonly abused registry locations for persistence. query = " registry where registry.data.strings != null and process.name : "WmiPrvSe.exe" and registry.path : ( "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKLM\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*", "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ServiceDLL", "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ImagePath", "HKEY_USERS\\*\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*", "HKEY_USERS\\*\\Environment\\UserInitMprLogonScript", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Load", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script", "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script", "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Command Processor\\Autorun" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.001" name = "Registry Run Keys / Startup Folder" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1047" name = "Windows Management Instrumentation" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks. query = " process where event.type == "start" and (process.name : "vssadmin.exe" or process.pe.original_file_name == "VSSADMIN.EXE") and process.args in ("delete", "resize") and process.args : "shadows*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1490" name = "Inhibit System Recovery" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data in preparation for exfiltration. query = " process where event.type == "start" and ((process.name:"rar.exe" or process.code_signature.subject_name == "win.rar GmbH" or process.pe.original_file_name == "Command line RAR") and process.args == "a" and process.args : ("-hp*", "-p*", "-dw", "-tb", "-ta", "/hp*", "/p*", "/dw", "/tb", "/ta")) or (process.pe.original_file_name in ("7z.exe", "7za.exe") and process.args == "a" and process.args : ("-p*", "-sdel")) /* uncomment if noisy for backup software related FPs */ /* not process.parent.executable : ("C:\\Program Files\\*.exe", "C:\\Program Files (x86)\\*.exe") */ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1560" name = "Archive Collected Data" reference = [[rule.threat.technique.subtechnique]] id = "T1560.001" name = "Archive via Utility" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks. query = " process where event.type == "start" and (process.name : "WMIC.exe" or process.pe.original_file_name == "wmic.exe") and process.args : "delete" and process.args : "shadowcopy" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1490" name = "Inhibit System Recovery" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies User Account Control (UAC) bypass attempts by abusing an elevated COM Interface to launch a malicious program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.executable : "C:\\*\\AppData\\*\\Temp\\IDC*.tmp\\*.exe" and process.parent.name : "ieinstal.exe" and process.parent.args : "-Embedding" /* uncomment once in winlogbeat */ /* and not (process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true) */ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.parent.name == "dllhost.exe" and process.parent.args in ("/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}", "/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}") and process.pe.original_file_name != "WerFault.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies User Account Control (UAC) bypass via eventvwr.exe. Attackers bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.parent.name : "eventvwr.exe" and not process.executable : ("?:\\Windows\\SysWOW64\\mmc.exe", "?:\\Windows\\System32\\mmc.exe", "?:\\Windows\\SysWOW64\\WerFault.exe", "?:\\Windows\\System32\\WerFault.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to stealthily execute code with elevated permissions. query = " process where event.type == "start" and process.args : "/autoclean" and process.args : "/d" and not process.executable : ("C:\\Windows\\System32\\cleanmgr.exe", "C:\\Windows\\SysWOW64\\cleanmgr.exe", "C:\\Windows\\System32\\taskhostw.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies User Account Control (UAC) bypass via sdclt.exe. Attackers bypass UAC to stealthily execute code with elevated permissions. query = " /* add winlogbeat-* when process.code_signature.* fields are populated */ /* still needs testing, applicable binary was not available on test machine */ sequence with maxspan=1m [process where event.type == "start" and process.name : "sdclt.exe" and /* uncomment once in winlogbeat */ /* process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true and */ process.args : "/kickoffelev" ] by process.entity_id [process where event.type == "start" and process.parent.name : "sdclt.exe" and not (process.executable : "C:\\Windows\\System32\\sdclt.exe" or process.executable : "C:\\Windows\\System32\\control.exe" or process.executable : "C:\\Windows\\SysWOW64\\sdclt.exe" or process.executable : "C:\\Windows\\SysWOW64\\control.exe") ] by process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies when a child process is spawned by the screensaver engine process, which is consistent with an attacker's malicious payload being executed after the screensaver activated on the endpoint. An adversary can maintain persistence on a macOS endpoint by creating a malicious screensaver (.saver) file and configuring the screensaver plist file to execute code each time the screensaver is activated. query = " process where event.type == "start" and process.parent.name == "ScreenSaverEngine" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.002" name = "Screensaver" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a Data Loss Prevention (DLP) policy is removed in Microsoft 365. An adversary may remove a DLP policy to evade existing DLP monitoring. false_positives = [ A DLP policy may be removed by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Remove-DlpPolicy" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a DomainKeys Identified Mail (DKIM) signing configuration is disabled in Microsoft 365. With DKIM in Microsoft 365, messages that are sent from Exchange Online will be cryptographically signed. This will allow the receiving email system to validate that the messages were generated by a server that the organization authorized and were not spoofed. false_positives = [ Disabling a DKIM configuration may be done by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Set-DkimSigningConfig" and o365.audit.Parameters.Enabled:False and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a firewall rule is created in Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or App Engine. These firewall rules can be configured to allow or deny connections to or from virtual machine (VM) instances or specific applications. An adversary may create a new firewall rule in order to weaken their target's security controls and allow more permissive ingress or egress traffic flows for their benefit. false_positives = [ Firewall rules may be created by system administrators. Verify that the firewall configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Firewall Rule Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 21 rule_id = "30562697-9859-4ae0-a8c5-dab45d664170" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Configuration Audit"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:(*.compute.firewalls.insert or google.appengine.*.Firewall.Create*Rule) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a firewall rule is deleted in Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or App Engine. These firewall rules can be configured to allow or deny connections to or from virtual machine (VM) instances or specific applications. An adversary may delete a firewall rule in order to weaken their target's security controls. false_positives = [ Firewall rules may be deleted by system administrators. Verify that the firewall configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Firewall Rule Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "ff9b571e-61d6-4f6c-9561-eb4cca3bafe1" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Configuration Audit"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:(*.compute.firewalls.delete or google.appengine.*.Firewall.Delete*Rule) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a firewall rule is modified in Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or App Engine. These firewall rules can be modified to allow or deny connections to or from virtual machine (VM) instances or specific applications. An adversary may modify an existing firewall rule in order to weaken their target's security controls and allow more permissive ingress or egress traffic flows for their benefit. false_positives = [ Firewall rules may be modified by system administrators. Verify that the firewall configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Firewall Rule Modification" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "2783d84f-5091-4d7d-9319-9fceda8fa71b" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Configuration Audit"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:(*.compute.firewalls.patch or google.appengine.*.Firewall.Update*Rule) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a Google Cloud Platform (GCP) storage bucket is deleted. An adversary may delete a storage bucket in order to disrupt their target's business operations. false_positives = [ Storage buckets may be deleted by a system or network administrator. Verify whether the user email, resource name, and/or hostname should be making changes in your environment. Bucket deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Storage Bucket Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "bc0f2d83-32b8-4ae2-b0e6-6a45772e9331" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:"storage.buckets.delete" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1485" name = "Data Destruction" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when a malware filter policy has been deleted in Microsoft 365. A malware filter policy is used to alert administrators that an internal user sent a message that contained malware. This may indicate an account or machine compromise that would need to be investigated. Deletion of a malware filter policy may be done to evade detection. false_positives = [ A malware filter policy may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Remove-MalwareFilterPolicy" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a malware filter rule has been deleted or disabled in Microsoft 365. An adversary or insider threat may want to modify a malware filter rule to evade detection. false_positives = [ A malware filter rule may be deleted by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:("Remove-MalwareFilterRule" or "Disable-MalwareFilterRule") and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a Microsoft Cloud App Security reported a risky sign-in attempt due to a login associated with an impossible travel. false_positives = ["User using a VPN may lead to false positives."] query = " event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:"Impossible travel activity" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies when a new credential is added to an application in Azure. An application may use a certificate or secret string to prove its identity when requesting a token. Multiple certificates and secrets can be added for an application and an adversary may abuse this by creating an additional authentication method to evade defenses or persist in an environment. false_positives = [ Application credential additions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Application credential additions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Update application - Certificates and secrets management" and event.outcome:(success or Success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1550" name = "Use Alternate Authentication Material" reference = [[rule.threat.technique.subtechnique]] id = "T1550.001" name = "Application Access Token" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a new Inbox forwarding rule is created in Microsoft 365. Inbox rules process messages in the Inbox based on conditions and take actions. In this case, the rules will forward the emails to a defined address. Attackers can abuse Inbox Rules to intercept and exfiltrate email data without making organization-wide configuration changes or having the corresponding privileges. false_positives = [ Users and Administrators can create inbox rules for legitimate purposes. Verify if it complies with the company policy and done with the user's consent. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:("New-InboxRule" or "Set-InboxRule") and ( o365.audit.Parameters.ForwardTo:* or o365.audit.Parameters.ForwardAsAttachmentTo:* or o365.audit.Parameters.RedirectTo:* ) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1114" name = "Email Collection" reference = [[rule.threat.technique.subtechnique]] id = "T1114.003" name = "Email Forwarding Rule" reference = [rule.threat.tactic] id = "TA0009" name = "Collection"
<li><a href="#">description = Identifies when a new key is created for a service account in Google Cloud Platform (GCP). A service account is a special type of account used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users through domain-wide delegation. If private keys are not tracked and managed properly, they can present a security risk. An adversary may create a new key for a service account in order to attempt to abuse the permissions assigned to that account and evade detection. false_positives = [ Service account keys may be created by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Service Account Key Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 21 rule_id = "0e5acaae-6a64-4bbc-adb8-27649c03f7e1" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.CreateServiceAccountKey and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a new role is assigned to a management group in Microsoft 365. An adversary may attempt to add a role in order to maintain persistence in an environment. false_positives = [ A new role may be assigned to a management group by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"New-ManagementRoleAssignment" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a new service account is created in Google Cloud Platform (GCP). A service account is a special type of account used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users through domain-wide delegation. If service accounts are not tracked and managed properly, they can present a security risk. An adversary may create a new service account to use during their operations in order to avoid using a standard user account and attempt to evade detection. false_positives = [ Service accounts can be created by system administrators. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Service Account Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 21 rule_id = "7ceb2216-47dd-4e64-9433-cddc99727623" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.CreateServiceAccount and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1136" name = "Create Account" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a new service principal is added in Azure. An application, hosted service, or automated tool that accesses or modifies resources needs an identity created. This identity is known as a service principal. For security reasons, it's always recommended to use service principals with automated tools rather than allowing them to log in with a user identity. false_positives = [ A service principal may be created by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Service principal additions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Add service principal" and event.outcome:(success or Success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1550" name = "Use Alternate Authentication Material" reference = [[rule.threat.technique.subtechnique]] id = "T1550.001" name = "Application Access Token" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parent process. This may indicate a code injection attempt. query = " sequence by host.id with maxspan=1m [process where event.code == "1" and /* sysmon process creation */ process.parent.name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe", "eqnedt32.exe", "fltldr.exe", "mspub.exe", "msaccess.exe","cscript.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "mshta.exe", "wmic.exe", "cmstp.exe", "msxsl.exe") and /* noisy FP patterns */ not (process.parent.name : "EXCEL.EXE" and process.executable : "?:\\Program Files\\Microsoft Office\\root\\Office*\\ADDINS\\*.exe") and not (process.executable : "?:\\Windows\\splwow64.exe" and process.args in ("8192", "12288") and process.parent.name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")) and not (process.parent.name : "rundll32.exe" and process.parent.args : ("?:\\WINDOWS\\Installer\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc", "--no-sandbox")) and not (process.executable : ("?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\*\\msedgewebview2.exe", "?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe", "?:\\Windows\\SysWOW64\\DWWIN.EXE") and process.parent.name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")) and not (process.parent.name : "regsvr32.exe" and process.parent.args : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*")) ] by process.parent.entity_id, process.entity_id [process where event.code == "10" and /* Sysmon process access event from unknown module */ winlog.event_data.CallTrace : "*UNKNOWN*"] by process.entity_id, winlog.event_data.TargetProcessGUID " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a Python script is executed using command line input and imports the sys module. Attackers often use this method to execute malicious scripts and avoiding writing it to disk. false_positives = ["Legitimate Python scripting activity."] query = " process where event.type in ("start", "process_started") and process.name : "python*" and process.args : "-c" and process.args : "*import*sys*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.006" name = "Python" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies when a safe attachment rule is disabled in Microsoft 365. Safe attachment rules can extend malware protections to include routing all messages and attachments without a known malware signature to a special hypervisor environment. An adversary or insider threat may disable a safe attachment rule to exfiltrate data or evade defenses. false_positives = [ A safe attachment rule may be disabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Disable-SafeAttachmentRule" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a Safe Link policy is disabled in Microsoft 365. Safe Link policies for Office applications extend phishing protection to documents that contain hyperlinks, even after they have been delivered to a user. false_positives = [ Disabling safe links may be done by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Disable-SafeLinksRule" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1566" name = "Phishing" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies when a screensaver plist file is modified by an unexpected process. An adversary can maintain persistence on a macOS endpoint by creating a malicious screensaver (.saver) file and configuring the screensaver plist file to execute code each time the screensaver is activated. query = " file where event.type != "deletion" and file.name: "com.apple.screensaver.*.plist" and file.path : ( "/Users/*/Library/Preferences/ByHost/*", "/Library/Managed Preferences/*", "/System/Library/Preferences/*" ) and ( process.code_signature.trusted == false or process.code_signature.exists == false or /* common script interpreters and abused native macOS bins */ process.name : ( "curl", "mktemp", "tail", "funzip", "python*", "osascript", "perl" ) ) and /* Filter OS processes modifying screensaver plist files */ not process.executable : ( "/usr/sbin/cfprefsd", "/usr/libexec/xpcproxy", "/System/Library/CoreServices/ManagedClient.app/Contents/Resources/MCXCompositor", "/System/Library/CoreServices/ManagedClient.app/Contents/MacOS/ManagedClient" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker may use this technique to evade defenses. query = " process where event.type == "start" and process.executable : "C:\\*" and (process.working_directory : "?:\\" and not process.working_directory: "C:\\") and process.parent.name : "explorer.exe" and process.name : ("rundll32.exe", "mshta.exe", "powershell.exe", "pwsh.exe", "cmd.exe", "regsvr32.exe", "cscript.exe", "wscript.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1218" name = "System Binary Proxy Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1218.005" name = "Mshta" reference = [[rule.threat.technique.subtechnique]] id = "T1218.010" name = "Regsvr32" reference = [[rule.threat.technique.subtechnique]] id = "T1218.011" name = "Rundll32" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies when a service account is deleted in Google Cloud Platform (GCP). A service account is a special type of account used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users through domain-wide delegation. An adversary may delete a service account in order to disrupt their target's business operations. false_positives = [ Service accounts may be deleted by system administrators. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Service Account Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "8fb75dda-c47a-4e34-8ecd-34facf7aad13" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.DeleteServiceAccount and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when a service account is disabled in Google Cloud Platform (GCP). A service account is a special type of account used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users through domain-wide delegation. An adversary may disable a service account in order to disrupt to disrupt their target's business operations. false_positives = [ Service accounts may be disabled by system administrators. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Service Account Disabled" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "bca7d28e-4a48-47b1-adb7-5074310e9a61" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:google.iam.admin.v*.DisableServiceAccount and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1531" name = "Account Access Removal" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when a terminal (tty) is spawned via Perl. Attackers may upgrade a simple reverse shell to a fully interactive tty after obtaining initial access to a host. query = " event.category:process and event.type:(start or process_started) and process.name:perl and process.args:("exec \"/bin/sh\";" or "exec \"/bin/dash\";" or "exec \"/bin/bash\";") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies when a terminal (tty) is spawned via Python. Attackers may upgrade a simple reverse shell to a fully interactive tty after obtaining initial access to a host. query = " event.category:process and event.type:(start or process_started) and process.name:python* and process.args:("import pty; pty.spawn(\"/bin/sh\")" or "import pty; pty.spawn(\"/bin/dash\")" or "import pty; pty.spawn(\"/bin/bash\")") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Identifies when a transfer lock was removed from a Route 53 domain. It is recommended to refrain from performing this action unless intending to transfer the domain to a different registrar. false_positives = [ A domain transfer lock may be disabled by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Activity from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:DisableDomainTransferLock and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identifies when a transport rule has been disabled or deleted in Microsoft 365. Mail flow rules (also known as transport rules) are used to identify and take action on messages that flow through your organization. An adversary or insider threat may modify a transport rule to exfiltrate data or evade defenses. false_positives = [ A transport rule may be modified by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:("Remove-TransportRule" or "Disable-TransportRule") and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1537" name = "Transfer Data to Cloud Account" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion. query = " process where event.type == "start" and (process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or process.pe.original_file_name == "PowerShell.EXE") and (process.args : "*Clear-History*" or (process.args : ("*Remove-Item*", "rm") and process.args : ("*ConsoleHost_history.txt*", "*(Get-PSReadlineOption).HistorySavePath*")) or (process.args : "*Set-PSReadlineOption*" and process.args : "*SaveNothing*")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.003" name = "Clear Command History" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltrating data. With this enabled, an organization will lose visibility into data such as query type, response, and originating IP, which are used to determine bad actors. query = " registry where event.type in ("creation", "change") and (registry.path : "*\\SOFTWARE\\Policies\\Microsoft\\Edge\\BuiltInDnsClientEnabled" and registry.data.strings : "1") or (registry.path : "*\\SOFTWARE\\Google\\Chrome\\DnsOverHttpsMode" and registry.data.strings : "secure") or (registry.path : "*\\SOFTWARE\\Policies\\Mozilla\\Firefox\\DNSOverHTTPS" and registry.data.strings : "1") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a user has been restricted from sending email due to exceeding sending limits of the service policies per the Security Compliance Center. false_positives = ["A user sending emails using personal distribution folders may trigger the event."] query = " event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:"User restricted from sending email" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = Identifies when a user has disabled or deleted an EventBridge rule. This activity can result in an unintended loss of visibility in applications or a break in the flow with other AWS services. false_positives = [ EventBridge Rules could be deleted or disabled by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. EventBridge Rules being deleted or disabled by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:aws.cloudtrail and event.provider:eventbridge.amazonaws.com and event.action:(DeleteRule or DisableRule) and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1489" name = "Service Stop" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when a user is added as an owner for an Azure application. An adversary may add a user account as an owner for an Azure application in order to grant additional permissions and modify the application's configuration using another account. query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Add owner to application" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a user is added as an owner for an Azure service principal. The service principal object defines what the application can do in the specific tenant, who can access the application, and what resources the app can access. A service principal object is created when an application is given permission to access resources in a tenant. An adversary may add a user account as an owner for a service principal and use that account in order to define what an application can do in the Azure AD tenant. query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Add owner to service principal" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when a virtual network device is modified or deleted. This can be a network virtual appliance, virtual hub, or virtual router. false_positives = [ Virtual Network Device modification or deletion may be performed by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Virtual Network Device modification or deletion by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:("MICROSOFT.NETWORK/NETWORKINTERFACES/TAPCONFIGURATIONS/WRITE" or "MICROSOFT.NETWORK/NETWORKINTERFACES/TAPCONFIGURATIONS/DELETE" or "MICROSOFT.NETWORK/NETWORKINTERFACES/WRITE" or "MICROSOFT.NETWORK/NETWORKINTERFACES/JOIN/ACTION" or "MICROSOFT.NETWORK/NETWORKINTERFACES/DELETE" or "MICROSOFT.NETWORK/NETWORKVIRTUALAPPLIANCES/DELETE" or "MICROSOFT.NETWORK/NETWORKVIRTUALAPPLIANCES/WRITE" or "MICROSOFT.NETWORK/VIRTUALHUBS/DELETE" or "MICROSOFT.NETWORK/VIRTUALHUBS/WRITE" or "MICROSOFT.NETWORK/VIRTUALROUTERS/WRITE" or "MICROSOFT.NETWORK/VIRTUALROUTERS/DELETE") and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when a Virtual Private Cloud (VPC) network is deleted in Google Cloud Platform (GCP). A VPC network is a virtual version of a physical network within a GCP project. Each VPC network has its own subnets, routes, and firewall, as well as other elements. An adversary may delete a VPC network in order to disrupt their target's network and business operations. false_positives = [ Virtual Private Cloud networks may be deleted by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Virtual Private Cloud Network Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "c58c3081-2e1d-4497-8491-e73a45d1a6d6" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Configuration Audit", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:v*.compute.networks.delete and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a virtual private cloud (VPC) route is created in Google Cloud Platform (GCP). Google Cloud routes define the paths that network traffic takes from a virtual machine (VM) instance to other destinations. These destinations can be inside a Google VPC network or outside it. An adversary may create a route in order to impact the flow of network traffic in their target's cloud environment. false_positives = [ Virtual Private Cloud routes may be created by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Virtual Private Cloud Route Creation" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [, ] risk_score = 21 rule_id = "9180ffdf-f3d0-4db3-bf66-7a14bcff71b8" severity = "low" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Configuration Audit", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:(v*.compute.routes.insert or "beta.compute.routes.insert") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when a Virtual Private Cloud (VPC) route is deleted in Google Cloud Platform (GCP). Google Cloud routes define the paths that network traffic takes from a virtual machine (VM) instance to other destinations. These destinations can be inside a Google VPC network or outside it. An adversary may delete a route in order to impact the flow of network traffic in their target's cloud environment. false_positives = [ Virtual Private Cloud routes may be deleted by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Virtual Private Cloud Route Deletion" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [, ] risk_score = 47 rule_id = "a17bcc91-297b-459b-b5ce-bc7460d8f82a" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Configuration Audit", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:v*.compute.routes.delete and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.007" name = "Disable or Modify Cloud Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when an administrator role is assigned to an Okta user. An adversary may attempt to assign an administrator role to an Okta user in order to assign additional permissions to a user account and maintain access to their target's environment. false_positives = [ Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-okta*"] language = "kuery" license = "Elastic License v2" name = "Administrator Role Assigned to an Okta User" note =## Setup The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "f06414a6-f2a4-466d-8eba-10f85e8abf71" severity = "medium" tags = ["Elastic", "Okta", "SecOps", "Monitoring", "Continuous Monitoring"] timestamp_override = "event.ingested" type = "query = " event.dataset:okta.system and event.action:user.account.privilege.grant " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when an attempt was made to restore an RDS Snapshot. Snapshots are sometimes shared by threat actors in order to exfiltrate bulk data or evade detection after performing malicious activities. If the permissions were modified, verify if the snapshot was shared with an unauthorized or unexpected AWS account. false_positives = [ Restoring snapshots may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Snapshot restoration by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] index = ["filebeat-*", "logs-aws*"] language = "kuery" license = "Elastic License v2" name = "AWS RDS Snapshot Restored" note =## Setup The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "bf1073bf-ce26-4607-b405-ba1ed8e9e204" severity = "medium" tags = ["Elastic", "Cloud", "AWS", "Continuous Monitoring", "SecOps", "Asset Visibility", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:RestoreDBInstanceFromDBSnapshot and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1578" name = "Modify Cloud Compute Infrastructure" reference = [[rule.threat.technique.subtechnique]] id = "T1578.004" name = "Revert Cloud Instance" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when an Azure Automation account is created. Azure Automation accounts can be used to automate management tasks and orchestrate actions across systems. An adversary may create an Automation account in order to maintain persistence in their target's environment. query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WRITE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when an Azure Automation runbook is created or modified. An adversary may create or modify an Azure Automation runbook to execute malicious code and maintain persistence in their target's environment. query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name: ( "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/DRAFT/WRITE" or "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/WRITE" or "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/PUBLISH/ACTION" ) and event.outcome:(Success or success) "
<li><a href="#">description = Identifies when an Azure Automation runbook is deleted. An adversary may delete an Azure Automation runbook in order to disrupt their target's automated business operations or to remove a malicious runbook for defense evasion. query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when an Azure Automation webhook is created. Azure Automation runbooks can be configured to execute via a webhook. A webhook uses a custom URL passed to Azure Automation along with a data payload specific to the runbook. An adversary may create a webhook in order to trigger a runbook that contains malicious code. query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name: ( "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WEBHOOKS/ACTION" or "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WEBHOOKS/WRITE" ) and event.outcome:(Success or success) "
<li><a href="#">description = Identifies when an Azure Conditional Access policy is modified. Azure Conditional Access policies control access to resources via if-then statements. For example, if a user wants to access a resource, then they must complete an action such as using multi-factor authentication to access it. An adversary may modify a Conditional Access policy in order to weaken their target's security controls. query = " event.dataset:(azure.activitylogs or azure.auditlogs) and event.action:"Update conditional access policy" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when an Event Hub Authorization Rule is created or updated in Azure. An authorization rule is associated with specific rights, and carries a pair of cryptographic keys. When you create an Event Hubs namespace, a policy rule named RootManageSharedAccessKey is created for the namespace. This has manage permissions for the entire namespace and it's recommended that you treat this rule like an administrative root account and don't use it in your application. false_positives = [ Authorization rule additions or modifications may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Authorization rule additions or modifications from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.EVENTHUB/NAMESPACES/AUTHORIZATIONRULES/WRITE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1530" name = "Data from Cloud Storage" reference = [rule.threat.tactic] id = "TA0009" name = "Collection" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1537" name = "Transfer Data to Cloud Account" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = Identifies when an Okta user account is locked out 3 times within a 3 hour window. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts. The default Okta authentication policy ensures that a user account is locked out after 10 failed authentication attempts. query = " event.dataset:okta.system and event.action:user.account.lock " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1110" name = "Brute Force" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [rule.threshold] field = ["okta.actor.alternate_id"] value = 3
<li><a href="#">description = Identifies when custom applications are allowed in Microsoft Teams. If an organization requires applications other than those available in the Teams app store, custom applications can be developed as packages and uploaded. An adversary may abuse this behavior to establish persistence in an environment. false_positives = [ Custom applications may be allowed by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:MicrosoftTeams and event.category:web and event.action:TeamsTenantSettingChanged and o365.audit.Name:"Allow sideloading and interaction of custom apps" and o365.audit.NewValue:True and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when events are deleted in Azure Kubernetes. Kubernetes events are objects that log any state changes. Example events are a container creation, an image pull, or a pod scheduling on a node. An adversary may delete events in Azure Kubernetes in an attempt to evade detection. false_positives = [ Events deletions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Events deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/EVENTS.K8S.IO/EVENTS/DELETE" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when external access is enabled in Microsoft Teams. External access lets Teams and Skype for Business users communicate with other users that are outside their organization. An adversary may enable external access or add an allowed domain to exfiltrate data or maintain persistence in an environment. false_positives = [ Teams external access may be enabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and event.category:web and event.action:"Set-CsTenantFederationConfiguration" and o365.audit.Parameters.AllowFederatedUsers:True and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when guest access is enabled in Microsoft Teams. Guest access in Teams allows people outside the organization to access teams and channels. An adversary may enable guest access to maintain persistence in an environment. false_positives = [ Teams guest access may be enabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] query = " event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and event.category:web and event.action:"Set-CsTeamsClientConfiguration" and o365.audit.Parameters.AllowGuestUser:True and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS server access via a webshell or other mechanism can disable HTTP Logging as an effective anti-forensics measure. query = " process where event.type == "start" and (process.name : "appcmd.exe" or process.pe.original_file_name == "appcmd.exe") and process.args : "/dontLog*:*True" and not process.parent.name : "iissetup.exe" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.002" name = "Disable Windows Event Logging" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when Microsoft Cloud App Security reports that a user has uploaded files to the cloud that might be infected with ransomware. false_positives = [ If Cloud App Security identifies, for example, a high rate of file uploads or file deletion activities it may represent an adverse encryption process., ] query = " event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:"Potential ransomware activity" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1486" name = "Data Encrypted for Impact" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when multi-factor authentication (MFA) is disabled for an Azure user account. An adversary may disable MFA for a user account in order to weaken the authentication requirements for the account. query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Disable Strong Authentication" and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Identifies when new Service Principal credentials have been added in Azure. In most organizations, credentials will be added to service principals infrequently. Hijacking an application (by adding a rogue secret or certificate) with granted permissions will allow the attacker to access data that is normally protected by MFA requirements. false_positives = [ Service principal credential additions may be done by a system or network administrator. Verify whether the username, hostname, and/or resource name should be making changes in your environment. Credential additions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Add service principal credentials" and event.outcome:(success or Success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1496" name = "Resource Hijacking" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = Identifies when one or more features on Microsoft Defender are disabled. Adversaries may disable or tamper with Microsoft Defender features to evade detection and conceal malicious behavior. false_positives = ["Legitimate Windows Defender configuration changes"] query = " registry where event.type in ("creation", "change") and (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\PUAProtection" and registry.data.strings : ("0", "0x00000000")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\App and Browser protection\\DisallowExploitProtectionOverride" and registry.data.strings : ("0", "0x00000000")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Features\\TamperProtection" and registry.data.strings : ("0", "0x00000000")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableRealtimeMonitoring" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableIntrusionPreventionSystem" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableScriptScanning" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\EnableControlledFolderAccess" and registry.data.strings : ("0", "0x00000000")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableIOAVProtection" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Reporting\\DisableEnhancedNotifications" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\DisableBlockAtFirstSeen" and registry.data.strings : ("1", "0x00000001")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\SpynetReporting" and registry.data.strings : ("0", "0x00000000")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\SubmitSamplesConsent" and registry.data.strings : ("0", "0x00000000")) or (registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableBehaviorMonitoring" and registry.data.strings : ("1", "0x00000001")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when the Azure role-based access control (Azure RBAC) permissions are modified for an Azure Blob. An adversary may modify the permissions on a blob to weaken their target's security controls or an administrator may inadvertently modify the permissions, which could lead to data exposure or loss. false_positives = [ Blob permissions may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-azure*"] language = "kuery" license = "Elastic License v2" name = "Azure Blob Permissions Modification" note =## Setup The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "d79c4b2a-6134-4edd-86e6-564a92a933f9" severity = "medium" tags = ["Elastic", "Cloud", "Azure", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:azure.activitylogs and azure.activitylogs.operation_name:( "MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICES/CONTAINERS/BLOBS/MANAGEOWNERSHIP/ACTION" or "MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICES/CONTAINERS/BLOBS/MODIFYPERMISSIONS/ACTION") and event.outcome:(Success or success) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1222" name = "File and Directory Permissions Modification" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when the configuration is modified for a storage bucket in Google Cloud Platform (GCP). An adversary may modify the configuration of a storage bucket in order to weaken the security controls of their target's environment. false_positives = [ Storage bucket configuration may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Storage Bucket Configuration Modification" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "97359fd8-757d-4b1d-9af1-ef29e4a8680e" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:"storage.buckets.update" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1578" name = "Modify Cloud Compute Infrastructure" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when the Identity and Access Management (IAM) permissions are modified for a Google Cloud Platform (GCP) storage bucket. An adversary may modify the permissions on a storage bucket to weaken their target's security controls or an administrator may inadvertently modify the permissions, which could lead to data exposure or loss. false_positives = [ Storage bucket permissions may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior., ] index = ["filebeat-*", "logs-gcp*"] language = "kuery" license = "Elastic License v2" name = "GCP Storage Bucket Permissions Modification" note =## Setup The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule." references = [] risk_score = 47 rule_id = "2326d1b2-9acf-4dee-bd21-867ea7378b4d" severity = "medium" tags = ["Elastic", "Cloud", "GCP", "Continuous Monitoring", "SecOps", "Identity and Access"] timestamp_override = "event.ingested" type = "query = " event.dataset:gcp.audit and event.action:"storage.setIamPermissions" and event.outcome:success " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1222" name = "File and Directory Permissions Modification" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies when the SYSTEM account uses an account discovery utility. This could be a sign of discovery activity after an adversary has achieved privilege escalation. query = " process where event.type == "start" and (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and (process.name : "whoami.exe" or (process.name : "net1.exe" and not process.parent.name : "net.exe")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1033" name = "System Owner/User Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade network constraints, like internet and network lateral communication restrictions. false_positives = [ Windows Firewall can be disabled by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Windows Profile being disabled by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule., ] query = " process where event.action == "start" and (process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or process.pe.original_file_name == "PowerShell.EXE") and process.args : "*Set-NetFirewallProfile*" and (process.args : "*-Enabled*" and process.args : "*False*") and (process.args : "*-All*" or process.args : ("*Public*", "*Domain*", "*Private*")) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.004" name = "Disable or Modify System Firewall" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strange activity on a system. query = " process where event.type == "start" and process.parent.name != null and ( /* suspicious parent processes */ (process.name:"autochk.exe" and not process.parent.name:"smss.exe") or (process.name:("fontdrvhost.exe", "dwm.exe") and not process.parent.name:("wininit.exe", "winlogon.exe")) or (process.name:("consent.exe", "RuntimeBroker.exe", "TiWorker.exe") and not process.parent.name:"svchost.exe") or (process.name:"SearchIndexer.exe" and not process.parent.name:"services.exe") or (process.name:"SearchProtocolHost.exe" and not process.parent.name:("SearchIndexer.exe", "dllhost.exe")) or (process.name:"dllhost.exe" and not process.parent.name:("services.exe", "svchost.exe")) or (process.name:"smss.exe" and not process.parent.name:("System", "smss.exe")) or (process.name:"csrss.exe" and not process.parent.name:("smss.exe", "svchost.exe")) or (process.name:"wininit.exe" and not process.parent.name:"smss.exe") or (process.name:"winlogon.exe" and not process.parent.name:"smss.exe") or (process.name:("lsass.exe", "LsaIso.exe") and not process.parent.name:"wininit.exe") or (process.name:"LogonUI.exe" and not process.parent.name:("wininit.exe", "winlogon.exe")) or (process.name:"services.exe" and not process.parent.name:"wininit.exe") or (process.name:"svchost.exe" and not process.parent.name:("MsMpEng.exe", "services.exe")) or (process.name:"spoolsv.exe" and not process.parent.name:"services.exe") or (process.name:"taskhost.exe" and not process.parent.name:("services.exe", "svchost.exe")) or (process.name:"taskhostw.exe" and not process.parent.name:("services.exe", "svchost.exe")) or (process.name:"userinit.exe" and not process.parent.name:("dwm.exe", "winlogon.exe")) or (process.name:("wmiprvse.exe", "wsmprovhost.exe", "winrshost.exe") and not process.parent.name:"svchost.exe") or /* suspicious child processes */ (process.parent.name:("SearchProtocolHost.exe", "taskhost.exe", "csrss.exe") and not process.name:("werfault.exe", "wermgr.exe", "WerFaultSecure.exe")) or (process.parent.name:"autochk.exe" and not process.name:("chkdsk.exe", "doskey.exe", "WerFault.exe")) or (process.parent.name:"smss.exe" and not process.name:("autochk.exe", "smss.exe", "csrss.exe", "wininit.exe", "winlogon.exe", "setupcl.exe", "WerFault.exe")) or (process.parent.name:"wermgr.exe" and not process.name:("WerFaultSecure.exe", "wermgr.exe", "WerFault.exe")) or (process.parent.name:"conhost.exe" and not process.name:("mscorsvw.exe", "wermgr.exe", "WerFault.exe", "WerFaultSecure.exe")) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1055" name = "Process Injection" reference = [[rule.threat.technique.subtechnique]] id = "T1055.012" name = "Process Hollowing" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scripting libraries it may be indicative of an allowlist bypass. query = " sequence by process.entity_id with maxspan = 2m [process where event.type == "start" and (process.name : "WMIC.exe" or process.pe.original_file_name : "wmic.exe") and process.args : ("format*:*", "/format*:*", "*-format*:*") and not process.command_line : "* /format:table *"] [any where (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (dll.name : ("jscript.dll", "vbscript.dll") or file.name : ("jscript.dll", "vbscript.dll"))] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1220" name = "XSL Script Processing" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as unixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens. query = " any where event.action == "Directory Service Access" and event.code == "4662" and not winlog.event_data.SubjectUserSid : "S-1-5-18" and winlog.event_data.Properties : ( /* unixUserPassword */ "*612cb747-c0e8-4f92-9221-fdd5f15b550d*", /* ms-PKI-AccountCredentials */ "*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*", /* ms-PKI-DPAPIMasterKeys */ "*b3f93023-9239-4f7c-b99c-6745d87adbc2*", /* msPKI-CredentialRoamingTokens */ "*b7ff5a38-0818-42b0-8110-d3d154c97f24*" ) and /* Excluding noisy AccessMasks 0x0 undefined and 0x100 Control Access */ not winlog.event_data.AccessMask in ("0x0", "0x100") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object. Attackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target user or computer object. false_positives = [ Modifications in the msDS-KeyCredentialLink attribute can be done legitimately by the Azure AD Connect synchronization account or the ADFS service account. These accounts can be added as Exceptions., ] query = " event.action:"Directory Service Changes" and event.code:"5136" and winlog.event_data.AttributeLDAPDisplayName:"msDS-KeyCredentialLink" and winlog.event_data.AttributeValue :B\:828* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1556" name = "Modify Authentication Process" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests. query = " event.action:"Directory Service Changes" and event.code:"5136" and winlog.event_data.AttributeLDAPDisplayName:"msPKIAccountCredentials" and winlog.event_data.OperationType:"%%14674" and not winlog.event_data.SubjectUserSid : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1068" name = "Exploitation for Privilege Escalation" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = In Azure Active Directory (Azure AD), permissions to manage resources are assigned using roles. The Global Administrator is a role that enables users to have access to all administrative features in Azure AD and services that use Azure AD identities like the Microsoft 365 Defender portal, the Microsoft 365 compliance center, Exchange, SharePoint Online, and Skype for Business Online. Attackers can add users as Global Administrators to maintain access and manage all subscriptions and their settings and resources. query = " event.dataset:azure.auditlogs and azure.auditlogs.properties.category:RoleManagement and azure.auditlogs.operation_name:"Add member to role" and azure.auditlogs.properties.target_resources.0.modified_properties.1.new_value:"\"Global Administrator\ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.003" name = "Additional Cloud Roles" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = In Azure Active Directory (Azure AD), permissions to manage resources are assigned using roles. The Global Administrator is a role that enables users to have access to all administrative features in Azure AD and services that use Azure AD identities like the Microsoft 365 Defender portal, the Microsoft 365 compliance center, Exchange, SharePoint Online, and Skype for Business Online. Attackers can add users as Global Administrators to maintain access and manage all subscriptions and their settings and resources. query = " event.dataset:o365.audit and event.code:"AzureActiveDirectory" and event.action:"Add member to role." and o365.audit.ModifiedProperties.Role_DisplayName.NewValue:"Global Administrator" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.003" name = "Additional Cloud Roles" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxy malicious execution via the schedule service and perform clean up. false_positives = ["Legitimate scheduled tasks may be created during installation of new software."] query = " sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m [iam where event.action == "scheduled-task-created" and not user.name : "*$"] [iam where event.action == "scheduled-task-deleted" and not user.name : "*$"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges. false_positives = ["Legitimate scheduled tasks may be created during installation of new software."] query = " iam where event.action == "scheduled-task-created" and /* excluding tasks created by the computer account */ not user.name : "*$" and /* TaskContent is not parsed, exclude by full taskname noisy ones */ not winlog.event_data.TaskName : ("\\OneDrive Standalone Update Task-S-1-5-21*", "\\OneDrive Standalone Update Task-S-1-12-1-*", "\\Hewlett-Packard\\HP Web Products Detection", "\\Hewlett-Packard\\HPDeviceCheck") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges. false_positives = ["Legitimate scheduled tasks may be created during installation of new software."] query = " sequence with maxspan=1m [process where event.type != "end" and ((process.name : ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe", "WmiPrvSe.exe", "wsmprovhost.exe", "winrshost.exe") or process.pe.original_file_name : ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe", "powershell.exe", "pwsh.dll", "powershell_ise.exe", "WmiPrvSe.exe", "wsmprovhost.exe", "winrshost.exe")) or process.code_signature.trusted == false)] by process.entity_id [process where event.type == "start" and (process.name : "schtasks.exe" or process.pe.original_file_name == "schtasks.exe") and process.args : ("/create", "-create") and process.args : ("/RU", "/SC", "/TN", "/TR", "/F", "/XML") and /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */ not (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") ] by process.parent.entity_id " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Indicates the creation or modification of a launch daemon, which adversaries may use to repeatedly execute malicious payloads as part of persistence. false_positives = ["Trusted applications persisting via LaunchDaemons"] query = " sequence by host.id with maxspan=1m [file where event.type != "deletion" and file.path : ("/System/Library/LaunchDaemons/*", "/Library/LaunchDaemons/*")] [process where event.type in ("start", "process_started") and process.name == "launchctl" and process.args == "load"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Indicates the update of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, by changing the configuration of a legit scheduled task. Some changes such as disabling or enabling a scheduled task are common and may may generate noise. false_positives = ["Legitimate scheduled tasks may be created during installation of new software."] query = " iam where event.action == "scheduled-task-updated" and /* excluding tasks created by the computer account */ not user.name : "*$" and not winlog.event_data.TaskName : ("\\User_Feed_Synchronization-*", "\\OneDrive Reporting Task-S-1-5-21*", "\\OneDrive Reporting Task-S-1-12-1-*", "\\Hewlett-Packard\\HP Web Products Detection", "\\Hewlett-Packard\\HPDeviceCheck") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1053" name = "Scheduled Task/Job" reference = [[rule.threat.technique.subtechnique]] id = "T1053.005" name = "Scheduled Task" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Iodine is a tool for tunneling Internet protocol version 4 (IPV4) traffic over the DNS protocol to circumvent firewalls, network security groups, and network access lists while evading detection. false_positives = [ Normal use of Iodine is uncommon apart from security testing and research. Use by non-security engineers is very uncommon., ] query = " event.category:process and event.type:(start or process_started) and process.name:(iodine or iodined) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1572" name = "Protocol Tunneling" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This rule identifies attempts to remove a kernel module. false_positives = [ There is usually no reason to remove modules, but some buggy modules require it. These can be exempted by username. Note that some Linux distributions are not built to support the removal of modules at all., ] query = " event.category:process and event.type:(start or process_started) and process.args:((rmmod and sudo) or (modprobe and sudo and ("--remove" or "-r"))) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1547" name = "Boot or Logon Autostart Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1547.006" name = "Kernel Modules and Extensions" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos. Adversaries may collect the keychain storage data from a system to acquire credentials. query = " event.category:process and event.type:(start or process_started) and process.args:("/private/var/db/SystemKey" or "/var/db/SystemKey") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.001" name = "Keychain" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module. false_positives = [ Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username., ] query = " event.category:process and event.type:(start or process_started) and process.args:(kmod and list and sudo or sudo and (depmod or lsmod or modinfo)) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1082" name = "System Information Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Malware or other files dropped or created on a system by an adversary may leave traces behind as to what was done within a network and how. Adversaries may remove these files over the course of an intrusion to keep their footprint low or remove them at the end as part of the post-intrusion cleanup process. query = " event.category:process and event.type:(start or process_started) and process.name:shred and process.args:("-u" or "--remove" or "-z" or "--zero") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.004" name = "File Deletion" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Masquerading can allow an adversary to evade defenses and better blend in with the environment. One way it occurs is when the name or location of a file is manipulated as a means of tricking a user into executing what they think is a benign file type but is actually executable code. query = " file where event.type == "creation" and file.extension : "exe" and file.name regex~.*\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|gif|jpg|png|bmp|hta|txt|img|iso)\.exe" and not (process.executable : ("?:\\Windows\\System32\\msiexec.exe", "C:\\Users\\*\\QGIS_SCCM\\Files\\QGIS-OSGeo4W-*-Setup-x86_64.exe") and file.path : "?:\\Program Files\\QGIS *\\apps\\grass\\*.exe") and not process.executable : ("/bin/sh", "/usr/sbin/MailScanner", "/usr/bin/perl") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.007" name = "Double File Extension" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1204.002" name = "Malicious File" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Microsoft Office Products offer options for users and developers to control the security settings for running and using Macros. Adversaries may abuse these security settings to modify the default behavior of the Office Application to trust future macros and/or disable security warnings, which could increase their chances of establishing persistence. query = " registry where event.type == "change" and registry.path : ( "HKU\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM", "HKU\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings", "HKU\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM", "HKU\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings", "\\REGISTRY\\USER\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM", "\\REGISTRY\\USER\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings", "\\REGISTRY\\USER\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM", "\\REGISTRY\\USER\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings" ) and registry.data.strings : ("0x00000001", "1") and process.name : ("cscript.exe", "wscript.exe", "mshta.exe", "mshta.exe", "winword.exe", "excel.exe") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1112" name = "Modify Registry" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1204" name = "User Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1204.002" name = "Malicious File" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with many other features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShell script and alike. query = " event.category:process and powershell.file.script_block_text:( (DumpCreds and DumpCerts) or "sekurlsa::logonpasswords" or ("crypto::certificates" and "CERT_SYSTEM_STORE_LOCAL_MACHINE") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Nping ran on a Linux host. Nping is part of the Nmap tool suite and has the ability to construct raw packets for a wide variety of security testing applications, including denial of service testing. false_positives = [ Some normal use of this command may originate from security engineers and network or server administrators, but this is usually not routine or unannounced. Use of `Nping` by non-engineers or ordinary users is uncommon., ] query = " event.category:process and event.type:(start or process_started) and process.name:nping " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1046" name = "Network Service Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = Specially crafted DNS requests can manipulate a known overflow vulnerability in some Windows DNS servers, resulting in Remote Code Execution (RCE) or a Denial of Service (DoS) from crashing the service. false_positives = [ Environments that leverage DNS responses over 60k bytes will result in false positives - if this traffic is predictable and expected, it should be filtered out. Additionally, this detection rule could be triggered by an authorized vulnerability scan or compromise assessment., ] index = ["packetbeat-*", "filebeat-*"] language = "kuery" license = "Elastic License v2" name = "Abnormally Large DNS Response" note =## Triage and analysis ### Investigating Abnormally Large DNS Response Detection alerts from this rule indicate possible anomalous activity around large byte DNS responses from a Windows DNS server. This detection rule was created based on activity represented in exploitation of vulnerability (CVE-2020-1350) also known as [SigRed]() during July 2020. #### Possible investigation steps - This specific rule is sourced from network log activity such as DNS or network level data. It's important to validate the source of the incoming traffic and determine if this activity has been observed previously within an environment. - Activity can be further investigated and validated by reviewing any associated Intrusion Detection Signatures (IDS) alerts. - Further examination can include a review of the `dns.question_type` network fieldset with a protocol analyzer, such as Zeek, Packetbeat, or Suricata, for `SIG` or `RRSIG` data. - Validate the patch level and OS of the targeted DNS server to validate the observed activity was not large-scale internet vulnerability scanning. - Validate that the source of the network activity was not from an authorized vulnerability scan or compromise assessment. #### False positive analysis - Based on this rule, which looks for a threshold of 60k bytes, it is possible for activity to be generated under 65k bytes and related to legitimate behavior. In packet capture files received by the [SANS Internet Storm Center](), byte responses were all observed as greater than 65k bytes. - This activity can be triggered by compliance/vulnerability scanning or compromise assessment; it's important to determine the source of the activity and potentially allowlist the source host. ### Related rules - Unusual Child Process of dns.exe - 8c37dc0e-e3ac-4c97-8aa0-cf6a9122de45 - Unusual File Modification by dns.exe - c7ce36c0-32ff-4f9a-bfc2-dcb242bf99f9 ### Response and remediation - Initiate the incident response process based on the outcome of the triage. - Ensure that you have deployed the latest Microsoft [Security Update]() (Monthly Rollup or Security Only) and restarted the patched machines. If unable to patch immediately, Microsoft [released]() a registry-based workaround that doesnt require a restart. This can be used as a temporary solution before the patch is applied. - Maintain backups of your critical systems to aid in quick recovery. - Perform routine vulnerability scans of your systems, monitor [CISA advisories]() and patch identified vulnerabilities. - If you observe a true positive, implement a remediation plan and monitor host-based artifacts for additional post-exploitation behavior. references = [ , , , ] risk_score = 47 rule_id = "11013227-0301-4a8c-b150-4db924484475" severity = "medium" tags = ["Elastic", "Network", "Threat Detection", "Lateral Movement", "Investigation Guide"] timestamp_override = "event.ingested" type = "query = " event.category:(network or network_traffic) and destination.port:53 and (event.dataset:zeek.dns or type:dns or event.type:connection) and network.bytes > 60000 " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1210" name = "Exploitation of Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Telnet provides a command line interface for communication with a remote device or server. This rule identifies Telnet network connections to non-publicly routable IP addresses. false_positives = [ Telnet can be used for both benign or malicious purposes. Telnet is included by default in some Linux distributions, so its presence is not inherently suspicious. The use of Telnet to manage devices remotely has declined in recent years in favor of more secure protocols such as SSH. Telnet usage by non-automated tools or frameworks may be suspicious., ] query = " sequence by process.entity_id [process where process.name == "telnet" and event.type == "start"] [network where process.name == "telnet" and cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = Telnet provides a command line interface for communication with a remote device or server. This rule identifies Telnet network connections to publicly routable IP addresses. false_positives = [ Telnet can be used for both benign or malicious purposes. Telnet is included by default in some Linux distributions, so its presence is not inherently suspicious. The use of Telnet to manage devices remotely has declined in recent years in favor of more secure protocols such as SSH. Telnet usage by non-automated tools or frameworks may be suspicious., ] query = " sequence by process.entity_id [process where process.name == "telnet" and event.type == "start"] [network where process.name == "telnet" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement"
<li><a href="#">description = The Application Shim was created to allow for backward compatibility of software as the operating system codebase changes over time. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes. query = " process where event.type == "start" and process.name : "sdbinst.exe" and not (process.args : "-m" and process.args : "-bg") and not process.args : "-mm" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.011" name = "Application Shimming" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.011" name = "Application Shimming" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing a different process to be executed. This functionality can be abused by an adversary to establish persistence. query = " registry where length(registry.data.strings) > 0 and registry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*.exe\\Debugger", "HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*\\Debugger", "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess", "HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess") and /* add FPs here */ not registry.data.strings regex~ ("C:\\Program Files( \(x86\))?\\ThinKiosk\\thinkiosk\.exe",.*\\PSAppDeployToolkit\\.*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.012" name = "Image File Execution Options Injection" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evade defenses. query = " process where event.type == "start" and process.name : "fltMC.exe" and process.args : "unload" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1562" name = "Impair Defenses" reference = [[rule.threat.technique.subtechnique]] id = "T1562.001" name = "Disable or Modify Tools" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the first point of lookup for DNS hostname resolution so if adversaries can modify the endpoint hosts file, they can route traffic to malicious infrastructure. This rule detects modifications to the hosts file on Microsoft Windows, Linux (Ubuntu or RHEL) and macOS systems. query = " any where /* file events for creation; file change events are not captured by some of the included sources for linux and so may miss this, which is the purpose of the process + command line args logic below */ ( event.category == "file" and event.type in ("change", "creation") and file.path : ("/private/etc/hosts", "/etc/hosts", "?:\\Windows\\System32\\drivers\\etc\\hosts") ) or /* process events for change targeting linux only */ ( event.category == "process" and event.type in ("start") and process.name in ("nano", "vim", "vi", "emacs", "echo", "sed") and process.args : ("/etc/hosts") ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1565" name = "Data Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1565.001" name = "Stored Data Manipulation" reference = [rule.threat.tactic] id = "TA0040" name = "Impact"
<li><a href="#">description = The malware known as SUNBURST targets the SolarWind's Orion business software for command and control. This rule detects post-exploitation command and control activity of the SUNBURST backdoor. query = " network where event.type == "protocol" and network.protocol == "http" and process.name : ("ConfigurationWizard.exe", "NetFlowService.exe", "NetflowDatabaseMaintenance.exe", "SolarWinds.Administration.exe", "SolarWinds.BusinessLayerHost.exe", "SolarWinds.BusinessLayerHostx64.exe", "SolarWinds.Collector.Service.exe", "SolarwindsDiagnostics.exe") and ( ( (http.request.body.content : "*/swip/Upload.ashx*" and http.request.body.content : ("POST*", "PUT*")) or (http.request.body.content : ("*/swip/SystemDescription*", "*/swip/Events*") and http.request.body.content : ("GET*", "HEAD*")) ) and not http.request.body.content : "*solarwinds.com*" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique.subtechnique]] id = "T1071.001" name = "Web Protocols" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1195" name = "Supply Chain Compromise" reference = [[rule.threat.technique.subtechnique]] id = "T1195.002" name = "Compromise Software Supply Chain" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = The Secure Shell (SSH) authorized_keys file specifies which users are allowed to log into a server using public key authentication. Adversaries may modify it to maintain persistence on a victim host by adding their own public key(s). query = " event.category:file and event.type:(change or creation) and file.name:("authorized_keys" or "authorized_keys2") and not process.executable: (/Library/Developer/CommandLineTools/usr/bin/git or /usr/local/Cellar/maven/*/libexec/bin/mvn or /Library/Java/JavaVirtualMachines/jdk*.jdk/Contents/Home/bin/java or /usr/bin/vim or /usr/local/Cellar/coreutils/*/bin/gcat or /usr/bin/bsdtar or /usr/bin/nautilus or /usr/bin/scp or /usr/bin/touch or /var/lib/docker/* or /usr/bin/google_guest_agent) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.004" name = "SSH Authorized Keys" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = This is an example of how to detect an unwanted web client user agent. This search matches the user agent for sqlmap 1.3.11, which is a popular FOSS tool for testing web applications for SQL injection vulnerabilities. false_positives = [ This rule does not indicate that a SQL injection attack occurred, only that the `sqlmap` tool was used. Security scans and tests may result in these errors. If the source is not an authorized security tester, this is generally suspicious or malicious activity., ] index = ["apm-*-transaction*", "traces-apm*"] language = "kuery" license = "Elastic License v2" name = "Web Application Suspicious Activity: sqlmap User Agent" references = [] risk_score = 47 rule_id = "d49cc73f-7a16-4def-89ce-9fc7127d7820" severity = "medium" tags = ["Elastic", "APM"] timestamp_override = "event.ingested" type = "query = " user_agent.original:"sqlmap/1.3.11#stable ()" "
<li><a href="#">description = This rule detects a container deployed with one or more dangerously permissive Linux capabilities. An attacker with the ability to deploy a container with added capabilities could use this for further execution, lateral movement, or privilege escalation within a cluster. The capabilities detected in this rule have been used in container escapes to the host machine. false_positives = [ Some container images require the addition of privileged capabilities. This rule leaves space for the exception of trusted container images. To add an exception, add the trusted container image name to the query field, kubernetes.audit.requestObject.spec.containers.image., ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Container Created with Excessive Linux Capabilities" note =## Triage and analysis ### Investigating Kubernetes Container Created with Excessive Linux Capabilities Linux capabilities were designed to divide root privileges into smaller units. Each capability grants a thread just enough power to perform specific privileged tasks. In Kubernetes, containers are given a set of default capabilities that can be dropped or added to at the time of creation. Added capabilities entitle containers in a pod with additional privileges that can be used to change core processes, change network settings of a cluster, or directly access the underlying host. The following have been used in container escape techniques: BPF - Allow creating BPF maps, loading BPF Type Format (BTF) data, retrieve JITed code of BPF programs, and more. DAC_READ_SEARCH - Bypass file read permission checks and directory read and execute permission checks. NET_ADMIN - Perform various network-related operations. SYS_ADMIN - Perform a range of system administration operations. SYS_BOOT - Use reboot(2) and kexec_load(2), reboot and load a new kernel for later execution. SYS_MODULE - Load and unload kernel modules. SYS_PTRACE - Trace arbitrary processes using ptrace(2). SYS_RAWIO - Perform I/O port operations (iopl(2) and ioperm(2)). SYSLOG - Perform privileged syslog(2) operations. ### False positive analysis - While these capabilities are not included by default in containers, some legitimate images may need to add them. This rule leaves space for the exception of trusted container images. To add an exception, add the trusted container image name to the query field, kubernetes.audit.requestObject.spec.containers.image. ## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , , , ] risk_score = 47 rule_id = "7164081a-3930-11ed-a261-0242ac120002" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset: kubernetes.audit_logs and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.verb: create and kubernetes.audit.objectRef.resource: pods and kubernetes.audit.requestObject.spec.containers.securityContext.capabilities.add: ("BPF" or "DAC_READ_SEARCH" or "NET_ADMIN" or "SYS_ADMIN" or "SYS_BOOT" or "SYS_MODULE" or "SYS_PTRACE" or "SYS_RAWIO" or "SYSLOG") and not kubernetes.audit.requestObject.spec.containers.image : ("docker.elastic.co/beats/elastic-agent:8.4.0" or "rancher/klipper-lb:v0.3.5" or ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1611" name = "Escape to Host" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1610" name = "Deploy Container" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects a known command and control pattern in network events. The FIN7 threat group is known to use this command and control technique, while maintaining persistence in their target's network. false_positives = [ This rule could identify benign domains that are formatted similarly to FIN7's command and control algorithm. Alerts should be investigated by an analyst to assess the validity of the individual observations., ] query = " event.category:(network OR network_traffic) AND type:(tls OR http) AND network.transport:tcp AND destination.domain:/[a-zA-Z]{4,5}\.(pw|us|club|info|site|top)/ AND NOT destination.domain:zoom.us " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique]] id = "T1568" name = "Dynamic Resolution" reference = [[rule.threat.technique.subtechnique]] id = "T1568.002" name = "Domain Generation Algorithms" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = This rule detects a request to attach a controller service account to an existing or new pod running in the kube-system namespace. By default, controllers running as part of the API Server utilize admin-equivalent service accounts hosted in the kube-system namespace. Controller service accounts aren't normally assigned to running pods and could indicate adversary behavior within the cluster. An attacker that can create or modify pods or pod controllers in the kube-system namespace, can assign one of these admin-equivalent service accounts to a pod and abuse their powerful token to escalate privileges and gain complete cluster control. false_positives = [ Controller service accounts aren't normally assigned to running pods, this is abnormal behavior with very few legitimate use-cases and should result in very few false positives., ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Suspicious Assignment of Controller Service Account" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , ] risk_score = 47 rule_id = "63c05204-339a-11ed-a261-0242ac120002" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.verb : "create" and kubernetes.audit.objectRef.resource : "pods" and kubernetes.audit.objectRef.namespace : "kube-system" and kubernetes.audit.requestObject.spec.serviceAccountName:*controller " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.001" name = "Default Accounts" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = This rule detects a user attempt to establish a shell session into a pod using the 'exec' command. Using the 'exec' command in a pod allows a user to establish a temporary shell session and execute any process/commands in the pod. An adversary may call bash to gain a persistent interactive shell which will allow access to any data the pod has permissions to, including secrets. false_positives = [ An administrator may need to exec into a pod for a legitimate reason like debugging purposes. Containers built from Linux and Windows OS images, tend to include debugging utilities. In this case, an admin may choose to run commands inside a specific container with kubectl exec ${POD_NAME} -c ${CONTAINER_NAME} -- ${CMD} ${ARG1} ${ARG2} ... ${ARGN}. For example, the following command can be used to look at logs from a running Cassandra pod: kubectl exec cassandra --cat /var/log/cassandra/system.log . Additionally, the -i and -t arguments might be used to run a shell connected to the terminal: kubectl exec -i -t cassandra -- sh, ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes User Exec into Pod" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "14de811c-d60f-11ec-9fd7-f661ea17fbce" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.verb:"create" and kubernetes.audit.objectRef.resource:"pods" and kubernetes.audit.objectRef.subresource:"exec" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1609" name = "Container Administration Command" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects an attempt to create or modify a pod attached to the host PID namespace. HostPID allows a pod to access all the processes running on the host and could allow an attacker to take malicious action. When paired with ptrace this can be used to escalate privileges outside of the container. When paired with a privileged container, the pod can see all of the processes on the host. An attacker can enter the init system (PID 1) on the host. From there, they could execute a shell and continue to escalate privileges to root. false_positives = [ An administrator or developer may want to use a pod that runs as root and shares the hosts IPC, Network, and PID namespaces for debugging purposes. If something is going wrong in the cluster and there is no easy way to SSH onto the host nodes directly, a privileged pod of this nature can be useful for viewing things like iptable rules and network namespaces from the host's perspective. Add exceptions for trusted container images using the query field "kubernetes.audit.requestObject.spec.container.image", ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Pod Created With HostPID" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "df7fda76-c92b-4943-bc68-04460a5ea5ba" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.objectRef.resource:"pods" and kubernetes.audit.verb:("create" or "update" or "patch") and kubernetes.audit.requestObject.spec.hostPID:true and not kubernetes.audit.requestObject.spec.containers.image: ("docker.elastic.co/beats/elastic-agent:8.4.0") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1611" name = "Escape to Host" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1610" name = "Deploy Container" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects an attempt to create or modify a pod using the host IPC namespace. This gives access to data used by any pod that also use the hosts IPC namespace. If any process on the host or any processes in a pod uses the hosts inter-process communication mechanisms (shared memory, semaphore arrays, message queues, etc.), an attacker can read/write to those same mechanisms. They may look for files in /dev/shm or use ipcs to check for any IPC facilities being used. false_positives = [ An administrator or developer may want to use a pod that runs as root and shares the host's IPC, Network, and PID namespaces for debugging purposes. If something is going wrong in the cluster and there is no easy way to SSH onto the host nodes directly, a privileged pod of this nature can be useful for viewing things like iptable rules and network namespaces from the host's perspective. Add exceptions for trusted container images using the query field "kubernetes.audit.requestObject.spec.container.image", ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Pod Created With HostIPC" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "764c8437-a581-4537-8060-1fdb0e92c92d" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.objectRef.resource:"pods" and kubernetes.audit.verb:("create" or "update" or "patch") and kubernetes.audit.requestObject.spec.hostIPC:true and not kubernetes.audit.requestObject.spec.containers.image: ("docker.elastic.co/beats/elastic-agent:8.4.0") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1611" name = "Escape to Host" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1610" name = "Deploy Container" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects an attempt to create or modify a service as type NodePort. The NodePort service allows a user to externally expose a set of labeled pods to the internet. This creates an open port on every worker node in the cluster that has a pod for that service. When external traffic is received on that open port, it directs it to the specific pod through the service representing it. A malicious user can configure a service as type Nodeport in order to intercept traffic from other pods or nodes, bypassing firewalls and other network security measures configured for load balancers within a cluster. This creates a direct method of communication between the cluster and the outside world, which could be used for more malicious behavior and certainly widens the attack surface of your cluster. false_positives = [ Developers may have a legitimate use for NodePorts. For frontend parts of an application you may want to expose a Service onto an external IP address without using cloud specific Loadbalancers. NodePort can be used to expose the Service on each Node's IP at a static port (the NodePort). You'll be able to contact the NodePort Service from outside the cluster, by requesting <NodeIP>:<NodePort>. NodePort unlike Loadbalancers, allow the freedom to set up your own load balancing solution, configure environments that aren't fully supported by Kubernetes, or even to expose one or more node's IPs directly., ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Exposed Service Created With Type NodePort" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "65f9bccd-510b-40df-8263-334f03174fed" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Persistence"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.objectRef.resource:"services" and kubernetes.audit.verb:("create" or "update" or "patch") and kubernetes.audit.requestObject.spec.type:"NodePort" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1133" name = "External Remote Services" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = This rule detects events that could be describing IPSEC NAT Traversal traffic. IPSEC is a VPN technology that allows one system to talk to another using encrypted tunnels. NAT Traversal enables these tunnels to communicate over the Internet where one of the sides is behind a NAT router gateway. This may be common on your network, but this technique is also used by threat actors to avoid detection. false_positives = [ Some networks may utilize these protocols but usage that is unfamiliar to local network administrators can be unexpected and suspicious. Because this port is in the ephemeral range, this rule may false under certain conditions, such as when an application server with a public IP address replies to a client which has used a UDP port in the range by coincidence. This is uncommon but such servers can be excluded., ] query = " event.category:(network or network_traffic) and network.transport:udp and destination.port:4500 " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = This rule detects events that may indicate use of SMTP on TCP port 26. This port is commonly used by several popular mail transfer agents to deconflict with the default SMTP port 25. This port has also been used by a malware family called BadPatch for command and control of Windows systems. false_positives = [ Servers that process email traffic may cause false positives and should be excluded from this rule as this is expected behavior., ] query = " event.category:(network or network_traffic) and network.transport:tcp and (destination.port:26 or (event.dataset:zeek.smtp and destination.port:26)) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1048" name = "Exfiltration Over Alternative Protocol" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = This rule detects network events that may indicate the use of RDP traffic from the Internet. RDP is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. false_positives = [ Some network security policies allow RDP directly from the Internet but usage that is unfamiliar to server or network owners can be unexpected and suspicious. RDP services may be exposed directly to the Internet in some networks such as cloud environments. In such cases, only RDP gateways, bastions or jump servers may be expected expose RDP directly to the Internet and can be exempted from this rule. RDP may be required by some work-flows such as remote access and support for specialized software products and servers. Such work-flows are usually known and not unexpected., ] query = " event.category:(network or network_traffic) and network.transport:tcp and (destination.port:3389 or event.dataset:zeek.rdp) and not source.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) and destination.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule detects network events that may indicate the use of RPC traffic from the Internet. RPC is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. query = " event.category:(network or network_traffic) and network.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) and not source.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) and destination.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule detects network events that may indicate the use of RPC traffic to the Internet. RPC is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. query = " event.category:(network or network_traffic) and network.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) and source.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) and not destination.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule detects network events that may indicate the use of Telnet traffic. Telnet is commonly used by system administrators to remotely control older or embedded systems using the command line shell. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. As a plain-text protocol, it may also expose usernames and passwords to anyone capable of observing the traffic. false_positives = [ IoT (Internet of Things) devices and networks may use telnet and can be excluded if desired. Some business work-flows may use Telnet for administration of older devices. These often have a predictable behavior. Telnet activity involving an unusual source or destination may be more suspicious. Telnet activity involving a production server that has no known associated Telnet work-flow or business requirement is often suspicious., ] query = " event.category:(network or network_traffic) and destination.port:23 and network.direction:(inbound or ingress or outbound or egress) and not event.action:( flow_dropped or denied or deny or flow_terminated or timeout or Reject or network_flow) " [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1021" name = "Remote Services" reference = [rule.threat.tactic] id = "TA0008" name = "Lateral Movement" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule detects network events that may indicate the use of VNC traffic from the Internet. VNC is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. false_positives = [ VNC connections may be received directly to Linux cloud server instances but such connections are usually made only by engineers. VNC is less common than SSH or RDP but may be required by some work-flows such as remote access and support for specialized software products or servers. Such work-flows are usually known and not unexpected. Usage that is unfamiliar to server or network owners can be unexpected and suspicious., ] query = " event.category:(network or network_traffic) and network.transport:tcp and destination.port >= 5800 and destination.port <= 5810 and not source.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) and destination.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1219" name = "Remote Access Software" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule detects network events that may indicate the use of VNC traffic to the Internet. VNC is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. false_positives = [ VNC connections may be made directly to Linux cloud server instances but such connections are usually made only by engineers. VNC is less common than SSH or RDP but may be required by some work flows such as remote access and support for specialized software products or servers. Such work-flows are usually known and not unexpected. Usage that is unfamiliar to server or network owners can be unexpected and suspicious., ] query = " event.category:(network or network_traffic) and network.transport:tcp and destination.port >= 5800 and destination.port <= 5810 and source.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) and not destination.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1219" name = "Remote Access Software" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = This rule detects network events that may indicate the use of Windows file sharing (also called SMB or CIFS) traffic to the Internet. SMB is commonly used within networks to share files, printers, and other system resources amongst trusted systems. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector or for data exfiltration. query = " event.category:(network or network_traffic) and network.transport:tcp and (destination.port:(139 or 445) or event.dataset:zeek.smb) and source.ip:( 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16 ) and not destination.ip:( 10.0.0.0/8 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or 192.0.0.0/29 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.2.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.168.0.0/16 or 192.88.99.0/24 or 224.0.0.0/4 or 100.64.0.0/10 or 192.175.48.0/24 or 198.18.0.0/15 or 198.51.100.0/24 or 203.0.113.0/24 or 240.0.0.0/4 or "::1" or "FE80::/10" or "FF00::/8" ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1048" name = "Exfiltration Over Alternative Protocol" reference = [rule.threat.tactic] id = "TA0010" name = "Exfiltration"
<li><a href="#">description = This rule detects PowerShell scripts capable of dumping process memory using WindowsErrorReporting or Dbghelp.dll MiniDumpWriteDump. Attackers can use this tooling to dump LSASS and get access to credentials. false_positives = ["PowerShell scripts that use this capability for troubleshooting."] query = " event.category:process and powershell.file.script_block_text:(MiniDumpWriteDump or MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.001" name = "LSASS Memory" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequently leveraged by threat actors to perform post-exploitation Active Directory reconnaissance. The AdFind tool has been observed in Trickbot, Ryuk, Maze, and FIN6 campaigns. For Winlogbeat, this rule requires Sysmon. query = " process where event.type == "start" and (process.name : "AdFind.exe" or process.pe.original_file_name == "AdFind.exe") and process.args : ("objectcategory=computer", "(objectcategory=computer)", "objectcategory=person", "(objectcategory=person)", "objectcategory=subnet", "(objectcategory=subnet)", "objectcategory=group", "(objectcategory=group)", "objectcategory=organizationalunit", "(objectcategory=organizationalunit)", "objectcategory=attributeschema", "(objectcategory=attributeschema)", "domainlist", "dcmodes", "adinfo", "dclist", "computers_pwnotreqd", "trustdmp") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1018" name = "Remote System Discovery" reference = [[rule.threat.technique]] id = "T1069" name = "Permission Groups Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1069.002" name = "Domain Groups" reference = [[rule.threat.technique]] id = "T1087" name = "Account Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1087.002" name = "Domain Account" reference = [[rule.threat.technique]] id = "T1482" name = "Domain Trust Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = This rule detects the use of discovery-related Windows API functions in PowerShell Scripts. Attackers can use these functions to perform various situational awareness related activities, like enumerating users, shares, sessions, domain trusts, groups, etc. false_positives = ["Legitimate PowerShell scripts that make use of these functions."] query = " event.category:process and powershell.file.script_block_text : ( NetShareEnum or NetWkstaUserEnum or NetSessionEnum or NetLocalGroupEnum or NetLocalGroupGetMembers or DsGetSiteName or DsEnumerateDomainTrusts or WTSEnumerateSessionsEx or WTSQuerySessionInformation or LsaGetLogonSessionData or QueryServiceObjectSecurity ) and not user.id : "S-1-5-18" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1069" name = "Permission Groups Discovery" reference = [[rule.threat.technique.subtechnique]] id = "T1069.001" name = "Local Groups" reference = [[rule.threat.technique]] id = "T1135" name = "Network Share Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1059" name = "Command and Scripting Interpreter" reference = [[rule.threat.technique.subtechnique]] id = "T1059.001" name = "PowerShell" reference = [[rule.threat.technique]] id = "T1106" name = "Native API" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects the use of the default Cobalt Strike Team Server TLS certificate. Cobalt Strike is software for Adversary Simulations and Red Team Operations which are security assessments that replicate the tactics and techniques of an advanced adversary in a network. Modifications to the Packetbeat configuration can be made to include MD5 and SHA256 hashing algorithms (the default is SHA1). See the References section for additional information on module configuration. query = " event.category:(network or network_traffic) and (tls.server.hash.md5:950098276A495286EB2A2556FBAB6D83 or tls.server.hash.sha1:6ECE5ECE4192683D2D84E25B0BA7E04F9CB7EB7C or tls.server.hash.sha256:87F2085C32B6A2CC709B365F55873E207A9CAA10BFFECF2FD16D3CF9D94D390C) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique.subtechnique]] id = "T1071.001" name = "Web Protocols" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control"
<li><a href="#">description = This rule detects when a pod is created with a sensitive volume of type hostPath. A hostPath volume type mounts a sensitive file or folder from the node to the container. If the container gets compromised, the attacker can use this mount for gaining access to the node. There are many ways a container with unrestricted access to the host filesystem can escalate privileges, including reading data from other containers, and accessing tokens of more privileged pods. false_positives = [ An administrator may need to attach a hostPath volume for a legitimate reason. This alert should be investigated for legitimacy by determining if the kuberenetes.audit.requestObject.spec.volumes.hostPath.path triggered is one needed by its target container/pod. For example, when the fleet managed elastic agent is deployed as a daemonset it creates several hostPath volume mounts, some of which are sensitive host directories like /proc, /etc/kubernetes, and /var/log. Add exceptions for trusted container images using the query field "kubernetes.audit.requestObject.spec.container.image", ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Pod created with a Sensitive hostPath Volume" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "2abda169-416b-4bb3-9a6b-f8d239fd78ba" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.objectRef.resource:"pods" and kubernetes.audit.verb:("create" or "update" or "patch") and kubernetes.audit.requestObject.spec.volumes.hostPath.path: ("/" or "/proc" or "/root" or "/var" or "/var/run" or "/var/run/docker.sock" or "/var/run/crio/crio.sock" or "/var/run/cri-dockerd.sock" or "/var/lib/kubelet" or "/var/lib/kubelet/pki" or "/var/lib/docker/overlay2" or "/etc" or "/etc/kubernetes" or "/etc/kubernetes/manifests" or "/etc/kubernetes/pki" or "/home/admin") and not kubernetes.audit.requestObject.spec.containers.image: ("docker.elastic.co/beats/elastic-agent:8.4.0") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1611" name = "Escape to Host" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1610" name = "Deploy Container" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects when a service account makes an unauthorized request for resources from the API server. Service accounts follow a very predictable pattern of behavior. A service account should never send an unauthorized request to the API server. This behavior is likely an indicator of compromise or of a problem within the cluster. An adversary may have gained access to credentials/tokens and this could be an attempt to access or create resources to facilitate further movement or execution within the cluster. false_positives = [ Unauthorized requests from service accounts are highly abnormal and more indicative of human behavior or a serious problem within the cluster. This behavior should be investigated further., ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Denied Service Account Request" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "63c056a0-339a-11ed-a261-0242ac120002" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Discovery"] timestamp_override = "event.ingested" type = "query = " event.dataset: "kubernetes.audit_logs" and kubernetes.audit.user.username: system\:serviceaccount\:* and kubernetes.audit.annotations.authorization_k8s_io/decision: "forbid" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1613" name = "Container and Resource Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = This rule detects when a service account or node attempts to enumerate their own permissions via the selfsubjectaccessreview or selfsubjectrulesreview APIs. This is highly unusual behavior for non-human identities like service accounts and nodes. An adversary may have gained access to credentials/tokens and this could be an attempt to determine what privileges they have to facilitate further movement or execution within the cluster. false_positives = [ An administrator may submit this request as an "impersonatedUser" to determine what privileges a particular service account has been granted. However, an adversary may utilize the same technique as a means to determine the privileges of another token other than that of the compromised account., ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Suspicious Self-Subject Review" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "12a2f15d-597e-4334-88ff-38a02cb1330b" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Discovery"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.verb:"create" and kubernetes.audit.objectRef.resource:("selfsubjectaccessreviews" or "selfsubjectrulesreviews") and (kubernetes.audit.user.username:(system\:serviceaccount\:* or system\:node\:*) or kubernetes.audit.impersonatedUser.username:(system\:serviceaccount\:* or system\:node\:*)) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1613" name = "Container and Resource Discovery" reference = [rule.threat.tactic] id = "TA0007" name = "Discovery"
<li><a href="#">description = This rule detects when a user creates a pod/container running in privileged mode. A highly privileged container has access to the node's resources and breaks the isolation between containers. If compromised, an attacker can use the privileged container to gain access to the underlying host. Gaining access to the host may provide the adversary with the opportunity to achieve follow-on objectives, such as establishing persistence, moving laterally within the environment, or setting up a command and control channel on the host. false_positives = [ By default a container is not allowed to access any devices on the host, but a "privileged" container is given access to all devices on the host. This allows the container nearly all the same access as processes running on the host. An administrator may want to run a privileged container to use operating system administrative capabilities such as manipulating the network stack or accessing hardware devices from within the cluster. Add exceptions for trusted container images using the query field "kubernetes.audit.requestObject.spec.container.image", ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Privileged Pod Created" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "c7908cac-337a-4f38-b50d-5eeb78bdb531" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.objectRef.resource:pods and kubernetes.audit.verb:create and kubernetes.audit.requestObject.spec.containers.securityContext.privileged:true and not kubernetes.audit.requestObject.spec.containers.image: ("docker.elastic.co/beats/elastic-agent:8.4.0") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1611" name = "Escape to Host" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1610" name = "Deploy Container" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rule detects when an unauthenticated user request is authorized within the cluster. Attackers may attempt to use anonymous accounts to gain initial access to the cluster or to avoid attribution of their activities within the cluster. This rule excludes the /healthz, /livez and /readyz endpoints which are commonly accessed anonymously. false_positives = [ Anonymous access to the API server is a dangerous setting enabled by default. Common anonymous connections (e.g., health checks) have been excluded from this rule. All other instances of authorized anonymous requests should be investigated., ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Anonymous Request Authorized" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , ] risk_score = 47 rule_id = "63c057cc-339a-11ed-a261-0242ac120002" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Initial Access", "Defense Evasion"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and (kubernetes.audit.user.username:("system:anonymous" or "system:unauthenticated") or not kubernetes.audit.user.username:*) and not kubernetes.audit.objectRef.resource:("healthz" or "livez" or "readyz") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1078" name = "Valid Accounts" reference = [[rule.threat.technique.subtechnique]] id = "T1078.001" name = "Default Accounts" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule helps you test and practice using alerts with Elastic Security as you get set up. Its not a sign of threat activity. enabled = false false_positives = [ "This rule is not looking for threat activity. Disable the rule if you're already familiar with alerts.", ] query = " event.kind:"event" " [rule.threshold] field = ["host.name"] value = 1
<li><a href="#">description = This rule identifies a high number (10) of process terminations (stop, delete, or suspend) from the same host within a short time period. query = " event.category:process and event.type:start and process.name:(net.exe or sc.exe or taskkill.exe) and process.args:(stop or pause or delete or "/PID" or "/IM" or "/T" or "/F" or "/t" or "/f" or "/im" or "/pid") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1489" name = "Service Stop" reference = [rule.threat.tactic] id = "TA0040" name = "Impact" reference = [rule.threshold] field = ["host.id"] value = 10
<li><a href="#">description = This rule identifies a large number (15) of nslookup.exe executions with an explicit query type from the same host. This may indicate command and control activity utilizing the DNS protocol. query = " event.category:process and event.type:start and process.name:nslookup.exe and process.args:(-querytype=* or -qt=* or -q=* or -type=*) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1071" name = "Application Layer Protocol" reference = [[rule.threat.technique.subtechnique]] id = "T1071.004" name = "DNS" reference = [rule.threat.tactic] id = "TA0011" name = "Command and Control" reference = [rule.threshold] field = ["host.id"] value = 15
<li><a href="#">description = This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain. query = " any where event.action == "Directory Service Access" and event.code == "4662" and winlog.event_data.Properties : ( /* Control Access Rights/Permissions Symbol */ "*DS-Replication-Get-Changes*", "*DS-Replication-Get-Changes-All*", "*DS-Replication-Get-Changes-In-Filtered-Set*", /* Identifying GUID used in ACE */ "*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*", "*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*", "*89e95b76-444d-4c62-991a-0facbeda640c*") /* The right to perform an operation controlled by an extended access right. */ and winlog.event_data.AccessMask : "0x100" and not winlog.event_data.SubjectUserName : ("*$", "MSOL_*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique.subtechnique]] id = "T1003.006" name = "DCSync" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = This rule identifies Zoom meetings that are created without a passcode. Meetings without a passcode are susceptible to Zoombombing. Zoombombing is carried out by taking advantage of Zoom sessions that are not protected with a passcode. Zoombombing refers to the unwanted, disruptive intrusion, generally by Internet trolls and hackers, into a video conference call. In a typical Zoombombing incident, a teleconferencing session is hijacked by the insertion of material that is lewd, obscene, racist, or antisemitic in nature, typically resulting of the shutdown of the session. index = ["filebeat-*"] language = "kuery" license = "Elastic License v2" name = "Zoom Meeting with no Passcode" note =## Setup The Zoom Filebeat module or similarly structured data is required to be compatible with this rule." references = [ , , ] risk_score = 47 rule_id = "58ac2aa5-6718-427c-a845-5f3ac5af00ba" severity = "medium" tags = [ "Elastic", "Application", "Communication", "Zoom", "Continuous Monitoring", "SecOps", "Configuration Audit", ] timestamp_override = "event.ingested" type = "query = " event.type:creation and event.module:zoom and event.dataset:zoom.webhook and event.action:meeting.created and not zoom.meeting.password:* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1190" name = "Exploit Public-Facing Application" reference = [rule.threat.tactic] id = "TA0001" name = "Initial Access"
<li><a href="#">description = This rule is triggered when indicators from the Threat Intel Filebeat module (v8.x) has a match against local file or network observations. query = " @timestamp >= "now-30d/d" and event.module:threatintel and (threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:* or threat.indicator.ip:* or threat.indicator.registry.path:* or threat.indicator.url.full:*) " query = file.hash.*:* or file.pe.imphash:* or source.ip:* or destination.ip:* or url.full:* or registry.path:* [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.module" [rule.threat_filters.meta.params] query = "threatintel" [rule.threat_filters.query.match_phrase] "event.module" = "threatintel" [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.category" [rule.threat_filters.meta.params] query = "threat" [rule.threat_filters.query.match_phrase] "event.category" = "threat" [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.kind" [rule.threat_filters.meta.params] query = "enrichment" [rule.threat_filters.query.match_phrase] "event.kind" = "enrichment" [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.type" [rule.threat_filters.meta.params] query = "indicator" [rule.threat_filters.query.match_phrase] "event.type" = "indicator" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.hash.md5" type = "mapping" value = "threat.indicator.file.hash.md5" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.hash.sha1" type = "mapping" value = "threat.indicator.file.hash.sha1" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.hash.sha256" type = "mapping" value = "threat.indicator.file.hash.sha256" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.pe.imphash" type = "mapping" value = "threat.indicator.file.pe.imphash" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "source.ip" type = "mapping" value = "threat.indicator.ip" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "destination.ip" type = "mapping" value = "threat.indicator.ip" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "url.full" type = "mapping" value = "threat.indicator.url.full" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "registry.path" type = "mapping" value = "threat.indicator.registry.path"
<li><a href="#">description = This rule is triggered when indicators from the Threat Intel integrations have a match against local file or network observations. query = " @timestamp >= "now-30d/d" and event.dataset:ti_* and (threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:* or threat.indicator.ip:* or threat.indicator.registry.path:* or threat.indicator.url.full:*) " query = file.hash.*:* or file.pe.imphash:* or source.ip:* or destination.ip:* or url.full:* or registry.path:* [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.dataset" [rule.threat_filters.meta.params] query = "ti_*" [rule.threat_filters.query.match_phrase] "event.dataset" = "ti_*" [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.category" [rule.threat_filters.meta.params] query = "threat" [rule.threat_filters.query.match_phrase] "event.category" = "threat" [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.kind" [rule.threat_filters.meta.params] query = "enrichment" [rule.threat_filters.query.match_phrase] "event.kind" = "enrichment" [[rule.threat_filters]] [rule.threat_filters."$state"] store = "appState" [rule.threat_filters.meta] negate = false disabled = false type = "phrase" key = "event.type" [rule.threat_filters.meta.params] query = "indicator" [rule.threat_filters.query.match_phrase] "event.type" = "indicator" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.hash.md5" type = "mapping" value = "threat.indicator.file.hash.md5" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.hash.sha1" type = "mapping" value = "threat.indicator.file.hash.sha1" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.hash.sha256" type = "mapping" value = "threat.indicator.file.hash.sha256" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "file.pe.imphash" type = "mapping" value = "threat.indicator.file.pe.imphash" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "source.ip" type = "mapping" value = "threat.indicator.ip" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "destination.ip" type = "mapping" value = "threat.indicator.ip" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "url.full" type = "mapping" value = "threat.indicator.url.full" [[rule.threat_mapping]] [[rule.threat_mapping.entries]] field = "registry.path" type = "mapping" value = "threat.indicator.registry.path"
<li><a href="#">description = This rule uses alert data to determine when multiple alerts in different phases of an attack involving the same host are triggered. Analysts can use this to prioritize triage and response, as these hosts are more likely to be compromised. false_positives = [ False positives can occur because the rules may be mapped to a few MITRE ATT&CK tactics. Use the attached Timeline to determine which detections were triggered on the host., ] query = " signal.rule.name:* and kibana.alert.rule.threat.tactic.id:* " [rule.threshold] field = ["host.id"] value = 1 [[rule.threshold.cardinality]] field = "kibana.alert.rule.threat.tactic.id" value = 3
<li><a href="#">description = This rule uses alert data to determine when multiple different alerts involving the same user are triggered. Analysts can use this to prioritize triage and response, as these users are more likely to be compromised. false_positives = [ False positives can occur with Generic built-in accounts, such as Administrator, admin, etc. if they are widespread used in your environment. As a best practice, they shouldn't be used in day-to-day tasks, as it prevents the ability to quickly identify and contact the account owner to find out if an alert is a planned activity, regular business activity, or an upcoming incident., ] query = " signal.rule.name:* and user.name:* and not user.id:("S-1-5-18" or "S-1-5-19" or "S-1-5-20") " [rule.threshold] field = ["user.name"] value = 1 [[rule.threshold.cardinality]] field = "signal.rule.rule_id" value = 5
<li><a href="#">description = This rules detects an attempt to create or modify a pod attached to the host network. HostNetwork allows a pod to use the node network namespace. Doing so gives the pod access to any service running on localhost of the host. An attacker could use this access to snoop on network activity of other pods on the same node or bypass restrictive network policies applied to its given namespace. false_positives = [ An administrator or developer may want to use a pod that runs as root and shares the hosts IPC, Network, and PID namespaces for debugging purposes. If something is going wrong in the cluster and there is no easy way to SSH onto the host nodes directly, a privileged pod of this nature can be useful for viewing things like iptable rules and network namespaces from the host's perspective. Add exceptions for trusted container images using the query field "kubernetes.audit.requestObject.spec.container.image", ] index = ["logs-kubernetes.*"] language = "kuery" license = "Elastic License v2" name = "Kubernetes Pod Created With HostNetwork" note =## Setup The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule." references = [ , , , ] risk_score = 47 rule_id = "12cbf709-69e8-4055-94f9-24314385c27e" severity = "medium" tags = ["Elastic", "Kubernetes", "Continuous Monitoring", "Execution", "Privilege Escalation"] timestamp_override = "event.ingested" type = "query = " event.dataset : "kubernetes.audit_logs" and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow" and kubernetes.audit.objectRef.resource:"pods" and kubernetes.audit.verb:("create" or "update" or "patch") and kubernetes.audit.requestObject.spec.hostNetwork:true and not kubernetes.audit.requestObject.spec.containers.image: ("docker.elastic.co/beats/elastic-agent:8.4.0") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1611" name = "Escape to Host" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1610" name = "Deploy Container" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = This rules identifies a process created from an executable with a space appended to the end of the filename. This may indicate an attempt to masquerade a malicious file as benign to gain user execution. When a space is added to the end of certain files, the OS will execute the file according to it's true filetype instead of it's extension. Adversaries can hide a program's true filetype by changing the extension of the file. They can then add a space to the end of the name so that the OS automatically executes the file when it's double-clicked. query = " process where host.os.type:("linux","macos") and event.type == "start" and (process.executable regex~/[a-z0-9\s_\-\\./]+\s") and not process.name in ("ls", "find", "grep", "xkbcomp") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [[rule.threat.technique.subtechnique]] id = "T1036.006" name = "Space after Filename" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Timestomping is an anti-forensics technique which is used to modify the timestamps of a file, often to mimic files that are in the same folder. query = " process where event.type == "start" and process.name : "touch" and user.id != "0" and process.args : ("-r", "-t", "-a*","-m*") and not process.args : ("/usr/lib/go-*/bin/go", "/usr/lib/dracut/dracut-functions.sh", "/tmp/KSInstallAction.*/m/.patch/*") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1070" name = "Indicator Removal" reference = [[rule.threat.technique.subtechnique]] id = "T1070.006" name = "Timestomp" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = User Account Control (UAC) can help mitigate the impact of malware on Windows hosts. With UAC, apps and tasks always run in the security context of a non-administrator account, unless an administrator specifically authorizes administrator-level access to the system. This rule identifies registry value changes to bypass User Access Control (UAC) protection. query = " registry where event.type == "change" and registry.path : ( "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA", "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin", "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop" ) and registry.data.strings : ("0", "0x00000000") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1548" name = "Abuse Elevation Control Mechanism" reference = [[rule.threat.technique.subtechnique]] id = "T1548.002" name = "Bypass User Account Control" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = User groups in Google Workspace are created to help manage users permissions and access to various resources and applications. The security label is only applied to a group when users within that group are expected to access sensitive data and/or resources so administrators add this label to easily manage security groups better. Adversaries with administrator access may modify a security group to allow external access from members outside the organization. This detection does not capture all modifications to security groups, but only those that could increase the risk associated with them. false_positives = [ User group access may be modified by an administrator to allow external access for community purposes. Doing so for a user group whom has access to sensitive information or operational resources should be monitored closely., ] query = " event.dataset:"google_workspace.admin" and event.action:"CHANGE_GROUP_SETTING" and event.category:"iam" and ((google_workspace.admin.setting.name:"ALLOW_EXTERNAL_MEMBERS" and google_workspace.admin.new_value:"true") or (google_workspace.admin.setting.name:"WHO_CAN_JOIN" and not (google_workspace.admin.new_value:"INVITED_CAN_JOIN" or google_workspace.admin.new_value:"CAN_REQUEST_TO_JOIN"))) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.003" name = "Additional Cloud Roles" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Users can mark specific files as hidden simply by putting a "." as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion. This rule looks for hidden files or folders in common writable directories. false_positives = [ Certain tools may create hidden temporary files or directories upon installation or as part of their normal behavior. These events can be filtered by the process arguments, username, or process name values., ] query = " process where event.type in ("start", "process_started") and process.working_directory in ("/tmp", "/var/tmp", "/dev/shm") and process.args regex~\.[a-z0-9_\-][a-z0-9_\-\.]{1,254}" and not process.name in ("ls", "find", "grep") " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1564" name = "Hide Artifacts" reference = [[rule.threat.technique.subtechnique]] id = "T1564.001" name = "Hidden Files and Directories" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [[rule.threat]] framework = "MITRE ATT&CK" [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Users in Google Workspace are typically assigned a specific organizational unit that grants them permissions to certain services and roles that are inherited from this organizational unit. Adversaries may compromise a valid account and change which organizational account the user belongs to which then could allow them to inherit permissions to applications and resources inaccessible prior to. false_positives = [ Google Workspace administrators may adjust change which organizational unit a user belongs to as a result of internal role adjustments., ] query = " event.dataset:"google_workspace.admin" and event.type:change and event.category:iam and google_workspace.event.type:"USER_SETTINGS" and event.action:"MOVE_USER_TO_ORG_UNIT" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1098" name = "Account Manipulation" reference = [[rule.threat.technique.subtechnique]] id = "T1098.003" name = "Additional Cloud Roles" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows application programming interface (API) that enables interaction between software objects or executable code. Xwizard can be used to run a COM object created in registry to evade defensive counter measures. query = " process where event.type == "start" and process.pe.original_file_name : "xwizard.exe" and ( (process.args : "RunWizard" and process.args : "{*}") or (process.executable != null and not process.executable : ("C:\\Windows\\SysWOW64\\xwizard.exe", "C:\\Windows\\System32\\xwizard.exe") ) ) " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1559" name = "Inter-Process Communication" reference = [[rule.threat.technique.subtechnique]] id = "T1559.001" name = "Component Object Model" reference = [rule.threat.tactic] id = "TA0002" name = "Execution"
<li><a href="#">description = Windows contains accessibility features that may be launched with a key combination before a user has logged in. An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system. query = " process where event.type == "start" and process.parent.name : ("Utilman.exe", "winlogon.exe") and user.name == "SYSTEM" and process.args : ( "C:\\Windows\\System32\\osk.exe", "C:\\Windows\\System32\\Magnify.exe", "C:\\Windows\\System32\\Narrator.exe", "C:\\Windows\\System32\\Sethc.exe", "utilman.exe", "ATBroker.exe", "DisplaySwitch.exe", "sethc.exe" ) and not process.pe.original_file_name in ( "osk.exe", "sethc.exe", "utilman2.exe", "DisplaySwitch.exe", "ATBroker.exe", "ScreenMagnifier.exe", "SR.exe", "Narrator.exe", "magnify.exe", "MAGNIFY.EXE" ) /* uncomment once in winlogbeat to avoid bypass with rogue process with matching pe original file name */ /* and process.code_signature.subject_name == "Microsoft Windows" and process.code_signature.status == "trusted" */ " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.008" name = "Accessibility Features" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence" reference = [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1546" name = "Event Triggered Execution" reference = [[rule.threat.technique.subtechnique]] id = "T1546.008" name = "Accessibility Features" reference = [rule.threat.tactic] id = "TA0004" name = "Privilege Escalation"
<li><a href="#">description = Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement. query = " process where event.type == "start" and (process.pe.original_file_name:"vaultcmd.exe" or process.name:"vaultcmd.exe") and process.args:"/list*" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.004" name = "Windows Credential Manager" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement. query = " sequence by winlog.computer_name, winlog.process.pid with maxspan=1s /* 2 consecutive vault reads from same pid for web creds */ [any where event.code : "5382" and (winlog.event_data.SchemaFriendlyName : "Windows Web Password Credential" or winlog.event_data.Resource : "http*") and not winlog.event_data.SubjectLogonId : "0x3e7"] [any where event.code : "5382" and (winlog.event_data.SchemaFriendlyName : "Windows Web Password Credential" or winlog.event_data.Resource : "http*") and not winlog.event_data.SubjectLogonId : "0x3e7"] " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1003" name = "OS Credential Dumping" reference = [[rule.threat.technique]] id = "T1555" name = "Credentials from Password Stores" reference = [[rule.threat.technique.subtechnique]] id = "T1555.004" name = "Windows Credential Manager" reference = [rule.threat.tactic] id = "TA0006" name = "Credential Access"
<li><a href="#">description = Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetration testers may run a shell as a service to gain SYSTEM permissions. query = " process where event.type == "start" and process.parent.name : "services.exe" and process.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe") and /* Third party FP's */ not process.args : "NVDisplay.ContainerLocalSystem" " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1543" name = "Create or Modify System Process" reference = [[rule.threat.technique.subtechnique]] id = "T1543.003" name = "Windows Service" reference = [rule.threat.tactic] id = "TA0003" name = "Persistence"
<li><a href="#">description = Detects events that have a mismatch on the expected event agent ID. The status "agent_id_mismatch" occurs when the expected agent ID associated with the API key does not match the actual agent ID in an event. This could indicate attempts to spoof events in order to masquerade actual activity to evade detection. false_positives = [ This is meant to run only on datasources using Elastic Agent 7.14+ since versions prior to that will be missing the necessary field, resulting in false positives., ] query = " event.agent_id_status:agent_id_mismatch " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion"
<li><a href="#">description = Detects when multiple hosts are using the same agent ID. This could occur in the event of an agent being taken over and used to inject illegitimate documents into an instance as an attempt to spoof events in order to masquerade actual activity to evade detection. false_positives = [ This is meant to run only on datasources using Elastic Agent 7.14+ since versions prior to that will be missing the necessary field, resulting in false positives., ] query = " event.agent_id_status:* " [[rule.threat]] framework = "MITRE ATT&CK" [[rule.threat.technique]] id = "T1036" name = "Masquerading" reference = [rule.threat.tactic] id = "TA0005" name = "Defense Evasion" reference = [rule.threshold] field = ["agent.id"] value = 2 [[rule.threshold.cardinality]] field = "host.id" value = 2
</div>
<script>
function myFunction() {
var input, filter, ul, li, a, i, txtValue;
input = document.getElementById("myInput");
filter = input.value.toUpperCase();
ul = document.getElementById("myUL");
li = ul.getElementsByTagName("li");
for (i = 0; i < li.length; i++) {
a = li[i].getElementsByTagName("a")[0];
txtValue = a.textContent || a.innerText;
if (txtValue.toUpperCase().indexOf(filter) > -1) {
li[i].style.display = "";
} else {
li[i].style.display = "none";
}
}
}
</script>
<script src="hilitor.js"></script>
<script>
var myHilitor = new Hilitor("content"); // id of the element to parse
// myHilitor.setBreakRegExp(new RegExp('[^\\w\' -]+', "g")); // expanded to include spaces
myHilitor.apply();
</script>
<script>
window.addEventListener("DOMContentLoaded", function(e) {
var myHilitor2 = new Hilitor("playground");
myHilitor2.setMatchType("left");
document.getElementById("keywords").addEventListener("keyup", function(e) {
myHilitor2.apply(this.value);
}, false);
}, false);
</script>
</html>