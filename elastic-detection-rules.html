<html>
<title>ELASTIC Detection Rules</title>
<meta name="robots" content="noindex,nofollow" />
<link rel="stylesheet" href="w2.css">

<head>
<style>
html, body {
background-color: #f0f0f0;
}

.w3-topbar {
width: 100%;
height:5%;
background-color: black;
position: fixed;
top: 1px;
overflow: hidden;
}
#myInput {
background-repeat: no-repeat;
width: 40%;
border: 1px solid #ddd;
margin-left: 300px;
text-align: center;
font-family: "Roboto", sans-serif
}
#keywords {
background-repeat: no-repeat;
width: 28%;
border: 1px solid #ddd;
border: 1px solid #ddd;
margin-bottom: 2px;
margin-left: 300px;
text-align: center;
font-family: "Roboto", sans-serif
}
#myUL {
list-style-type: none;
padding: 1
text-align: center;
margin-top: 10px;
width: 80%;
word-wrap: break-word;
}
#myUL li a {
margin-top: -1px;
padding: 8px;
text-decoration: none;
font-size: 14px;
color: black;
display: block
}
}
</style>
</head>
<body>
<!-- Topbar -->
<div class="w3-topbar"></div>
<!-- Sidebar -->
<BR>
<p>
<BR>
<center><H3>ELASTIC Detection Rules</H3></center>
<BR>
<input type="text" id="myInput" onkeyup="myFunction()" placeholder="Filter Paragraph by Keyword" title="Search">
<form method="GET" onsubmit="myHilitor.apply(hilite.value); return false;">
<input type="text" id="keywords" size="20" name="hilite" placeholder="Highlight Multiple Keywords">
<input type="submit" value="Apply">
<input type="button" value="Remove" onclick="myHilitor.remove();">
</span>
</form>
</nav>
<div class="w3-main w3-theme-l5" style="margin-left:200px, margin-right:150px">
<div id="playground">
<center>
<ul id="myUL">
<p>

<li><a href="#">DESCRIPTION = Identifies attempts to bypass User Account Control (UAC) via DLL side-loading. Attackers may attempt to bypass UAC tostealthily execute code with elevated permissions.

NAME = "UAC Bypass Attempt via Privileged IFileOperation COM Interface"

QUERY = '''file where host.os.type == "windows" and event.type : "change" and process.name : "dllhost.exe" and/* Known modules names side loaded into process running with high or system integrity level for UAC Bypass, update here for new modules */file.name : ("wow64log.dll", "comctl32.dll", "DismCore.dll", "OskSupport.dll", "duser.dll", "Accessibility.ni.dll") and/* has no impact on rule logic just to avoid OS install related FPs */not file.path : ("C:\\Windows\\SoftwareDistribution\\*", "C:\\Windows\\WinSxS\\*")'''


<li><a href="#">DESCRIPTION = Identifies User Account Control (UAC) bypass via eventvwr.exe. Attackers bypass UAC to stealthily execute code withelevated permissions.

NAME = "Bypass UAC via Event Viewer"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "eventvwr.exe" andnot process.executable :("?:\\Windows\\SysWOW64\\mmc.exe", "?:\\Windows\\System32\\mmc.exe", "?:\\Windows\\SysWOW64\\WerFault.exe", "?:\\Windows\\System32\\WerFault.exe")'''


<li><a href="#">DESCRIPTION = Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory.Attackers may bypass UAC to stealthily execute code with elevated permissions.

NAME = "UAC Bypass Attempt via Windows Directory Masquerading"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.args : ("C:\\Windows \\system32\\*.exe", "C:\\Windows \\SysWOW64\\*.exe")'''


<li><a href="#">DESCRIPTION = Identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) WindowsFirewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions.

NAME = "UAC Bypass via Windows Firewall Snap-In Hijack"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name == "mmc.exe" and /* process.Ext.token.integrity_level_name == "high" can be added in future for tuning */ /* args of the Windows Firewall SnapIn */process.parent.args == "WF.msc" and process.name != "WerFault.exe'''


<li><a href="#">DESCRIPTION = Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strangeactivity on a system.

NAME = "Unusual Parent-Child Relationship"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name != null and ( /* suspicious parent processes */ (process.name:"autochk.exe" and not process.parent.name:"smss.exe") or (process.name:("fontdrvhost.exe", "dwm.exe") and not process.parent.name:("wininit.exe", "winlogon.exe")) or (process.name:("consent.exe", "RuntimeBroker.exe", "TiWorker.exe") and not process.parent.name:"svchost.exe") or (process.name:"SearchIndexer.exe" and not process.parent.name:"services.exe") or (process.name:"SearchProtocolHost.exe" and not process.parent.name:("SearchIndexer.exe", "dllhost.exe")) or (process.name:"dllhost.exe" and not process.parent.name:("services.exe", "svchost.exe")) or (process.name:"smss.exe" and not process.parent.name:("System", "smss.exe")) or (process.name:"csrss.exe" and not process.parent.name:("smss.exe", "svchost.exe")) or (process.name:"wininit.exe" and not process.parent.name:"smss.exe") or (process.name:"winlogon.exe" and not process.parent.name:"smss.exe") or (process.name:("lsass.exe", "LsaIso.exe") and not process.parent.name:"wininit.exe") or (process.name:"LogonUI.exe" and not process.parent.name:("wininit.exe", "winlogon.exe")) or (process.name:"services.exe" and not process.parent.name:"wininit.exe") or (process.name:"svchost.exe" and not process.parent.name:("MsMpEng.exe", "services.exe", "svchost.exe")) or (process.name:"spoolsv.exe" and not process.parent.name:"services.exe") or (process.name:"taskhost.exe" and not process.parent.name:("services.exe", "svchost.exe", "ngentask.exe")) or (process.name:"taskhostw.exe" and not process.parent.name:("services.exe", "svchost.exe")) or (process.name:"userinit.exe" and not process.parent.name:("dwm.exe", "winlogon.exe")) or (process.name:("wmiprvse.exe", "wsmprovhost.exe", "winrshost.exe") and not process.parent.name:"svchost.exe") or /* suspicious child processes */ (process.parent.name:("SearchProtocolHost.exe", "taskhost.exe", "csrss.exe") and not process.name:("werfault.exe", "wermgr.exe", "WerFaultSecure.exe", "conhost.exe")) or (process.parent.name:"autochk.exe" and not process.name:("chkdsk.exe", "doskey.exe", "WerFault.exe")) or (process.parent.name:"smss.exe" and not process.name:("autochk.exe", "smss.exe", "csrss.exe", "wininit.exe", "winlogon.exe", "setupcl.exe", "WerFault.exe")) or (process.parent.name:"wermgr.exe" and not process.name:("WerFaultSecure.exe", "wermgr.exe", "WerFault.exe")) or (process.parent.name:"conhost.exe" and not process.name:("mscorsvw.exe", "wermgr.exe", "WerFault.exe", "WerFaultSecure.exe")))'''


<li><a href="#">DESCRIPTION = Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilegeescalation vulnerabilities related to the Printing Service on Windows.

NAME = "Unusual Print Spooler Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : "spoolsv.exe" and process.command_line != null and(?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and /* exclusions for FP control below */ not process.name : ("splwow64.exe", "PDFCreator.exe", "acrodist.exe", "spoolsv.exe", "msiexec.exe", "route.exe", "WerFault.exe") and not process.command_line : "*\\WINDOWS\\system32\\spool\\DRIVERS*" and not (process.name : "net.exe" and process.command_line : ("*stop*", "*start*")) and not (process.name : ("cmd.exe", "powershell.exe") and process.command_line : ("*.spl*", "*\\program files*", "*route add*")) and not (process.name : "netsh.exe" and process.command_line : ("*add portopening*", "*rule name*")) and not (process.name : "regsvr32.exe" and process.command_line : "*PrintConfig.dll*") and not process.executable : ("?:\\Program Files (x86)\\CutePDF Writer\\CPWriter2.exe","?:\\Program Files (x86)\\GPLGS\\gswin32c.exe" )'''


<li><a href="#">DESCRIPTION = Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes.This may indicate a code injection or an equivalent form of exploitation.

NAME = "Unusual Service Host Child Process - Childless Service"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "svchost.exe" and/* based on svchost service arguments -s svcname where the service is known to be childless */process.parent.args : ("WdiSystemHost", "LicenseManager", "StorSvc", "CDPSvc", "cdbhsvc", "BthAvctpSvc", "SstpSvc", "WdiServiceHost","imgsvc", "TrkWks", "WpnService", "IKEEXT", "PolicyAgent", "CryptSvc", "netprofm", "ProfSvc", "StateRepository","camsvc", "LanmanWorkstation", "NlaSvc", "EventLog", "hidserv", "DisplayEnhancementService", "ShellHWDetection","AppHostSvc", "fhsvc", "CscService", "PushToInstall") and/* unknown FPs can be added here */not process.name : ("WerFault.exe", "WerFaultSecure.exe", "wermgr.exe") andnot (process.executable : "?:\\Windows\\System32\\RelPost.exe" and process.parent.args : "WdiSystemHost") andnot (process.name : "rundll32.exe" andprocess.args : "?:\\WINDOWS\\System32\\winethc.dll,ForceProxyDetectionOnNextRun" andprocess.parent.args : "WdiServiceHost") andnot (process.executable : ("?:\\Program Files\\*","?:\\Program Files (x86)\\*","?:\\Windows\\System32\\Kodak\\kds_?????\\lib\\lexexe.exe") and process.parent.args : "imgsvc")'''


<li><a href="#">DESCRIPTION = Identifies parent process spoofing used to create an elevated child process. Adversaries may spoof the parent processidentifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges.

NAME = "Privileges Elevation via Parent Process PID Spoofing"

QUERY = '''/* This rule is compatible with Elastic Endpoint only */process where host.os.type == "windows" and event.action == "start" and /* process creation via seclogon */ process.parent.Ext.real.pid > 0 and /* PrivEsc to SYSTEM */ user.id : "S-1-5-18"and /* Common FPs - evasion via hollowing is possible, should be covered by code injection */ not process.executable : ("?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWOW64\\WerFault.exe", "?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\Windows\\SysWOW64\\WerFaultSecure.exe", "?:\\Windows\\System32\\Wermgr.exe", "?:\\Windows\\SysWOW64\\Wermgr.exe", "?:\\Windows\\SoftwareDistribution\\Download\\Install\\securityhealthsetup.exe") and /* Logon Utilities */ not (process.parent.executable : "?:\\Windows\\System32\\Utilman.exe" and process.executable : ("?:\\Windows\\System32\\osk.exe", "?:\\Windows\\System32\\Narrator.exe", "?:\\Windows\\System32\\Magnify.exe")) and not process.parent.executable : "?:\\Windows\\System32\\AtBroker.exe" and not (process.code_signature.subject_name in ("philandro Software GmbH", "Freedom Scientific Inc.", "TeamViewer Germany GmbH", "Projector.is, Inc.","TeamViewer GmbH", "Cisco WebEx LLC", "Dell Inc") and process.code_signature.trusted == true) and/* AM_Delta_Patch Windows Update */ not (process.executable : ("?:\\Windows\\System32\\MpSigStub.exe", "?:\\Windows\\SysWOW64\\MpSigStub.exe") andprocess.parent.executable : ("?:\\Windows\\System32\\wuauclt.exe","?:\\Windows\\SysWOW64\\wuauclt.exe","?:\\Windows\\UUS\\Packages\\Preview\\*\\wuaucltcore.exe","?:\\Windows\\UUS\\amd64\\wuauclt.exe","?:\\Windows\\UUS\\amd64\\wuaucltcore.exe","?:\\ProgramData\\Microsoft\\Windows\\UUS\\*\\wuaucltcore.exe")) and not (process.executable : ("?:\\Windows\\System32\\MpSigStub.exe", "?:\\Windows\\SysWOW64\\MpSigStub.exe") and process.parent.executable == null) and /* Other third party SW */ not process.parent.executable : ("?:\\Program Files (x86)\\HEAT Software\\HEAT Remote\\HEATRemoteServer.exe","?:\\Program Files (x86)\\VisualCron\\VisualCronService.exe","?:\\Program Files\\BinaryDefense\\Vision\\Agent\\bds-vision-agent-app.exe","?:\\Program Files\\Tablet\\Wacom\\WacomHost.exe","?:\\Program Files (x86)\\LogMeIn\\x64\\LogMeIn.exe","?:\\Program Files (x86)\\EMC Captiva\\Captiva Cloud Runtime\\Emc.Captiva.WebCaptureRunner.exe","?:\\Program Files\\Freedom Scientific\\*.exe","?:\\Program Files (x86)\\Google\\Chrome Remote Desktop\\*\\remoting_host.exe","?:\\Program Files (x86)\\GoToAssist Remote Support Customer\\*\\g2ax_comm_customer.exe") and not (process.code_signature.trusted == true and process.code_signature.subject_name == "Netwrix Corporation" andprocess.name : "adcrcpy.exe" and process.parent.executable : ("?:\\Program Files (x86)\\Netwrix Auditor\\Active Directory Auditing\\Netwrix.ADA.EventCollector.exe","?:\\Program Files (x86)\\Netwrix Auditor\\Active Directory Auditing\\Netwrix.ADA.Analyzer.exe","?:\\Netwrix Auditor\\Active Directory Auditing\\Netwrix.ADA.EventCollector.exe") )'''


<li><a href="#">DESCRIPTION = Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique bymasquerading as a known named pipe and manipulating a privileged process to connect to it.

NAME = "Privilege Escalation via Rogue Named Pipe Impersonation"

QUERY = '''file where host.os.type == "windows" and event.action : "Pipe Created*" and /* normal sysmon named pipe creation events truncate the pipe keyword */file.name : "\\*\\Pipe\\*'''


<li><a href="#">DESCRIPTION = Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversariesmay create a new process with a different token to escalate privileges and bypass access controls.

NAME = "Process Created with an Elevated Token"

QUERY = '''/* This rule is only compatible with Elastic Endpoint 8.4+ */process where host.os.type == "windows" and event.action == "start" and /* CreateProcessWithToken and effective parent is a privileged MS native binary used as a target for token theft */ user.id : "S-1-5-18"and /* Token Theft target process usually running as service are located in one of the following paths */ process.Ext.effective_parent.executable :("?:\\Windows\\*.exe", "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\ProgramData\\*") and/* Ignores Utility Manager in Windows running in debug mode */ not (process.Ext.effective_parent.executable : "?:\\Windows\\System32\\Utilman.exe" andprocess.parent.executable : "?:\\Windows\\System32\\Utilman.exe" and process.parent.args : "/debug") and/* Ignores Windows print spooler service with correlation to Access Intelligent Form */not (process.parent.executable : "?\\Windows\\System32\\spoolsv.exe" and process.executable: "?:\\Program Files*\\Access\\Intelligent Form\\*\\LaunchCreate.exe") and /* Ignores Windows error reporting executables */ not process.executable : ("?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWOW64\\WerFault.exe", "?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\Windows\\SysWOW64\\WerFaultSecure.exe", "?:\\windows\\system32\\WerMgr.exe", "?:\\Windows\\SoftwareDistribution\\Download\\Install\\securityhealthsetup.exe")and /* Ignores Windows updates from TiWorker.exe that runs with elevated privileges */ not (process.parent.executable : "?:\\Windows\\WinSxS\\*\\TiWorker.exe" andprocess.executable : ("?:\\Windows\\Microsoft.NET\\Framework*.exe","?:\\Windows\\WinSxS\\*.exe","?:\\Windows\\System32\\inetsrv\\iissetup.exe","?:\\Windows\\SysWOW64\\inetsrv\\iissetup.exe","?:\\Windows\\System32\\inetsrv\\aspnetca.exe","?:\\Windows\\SysWOW64\\inetsrv\\aspnetca.exe","?:\\Windows\\System32\\lodctr.exe","?:\\Windows\\SysWOW64\\lodctr.exe","?:\\Windows\\System32\\netcfg.exe","?:\\Windows\\Microsoft.NET\\Framework*\\*\\ngen.exe","?:\\Windows\\Microsoft.NET\\Framework*\\*\\aspnet_regiis.exe")) and/* Ignores additional parent executables that run with elevated privileges */ not process.parent.executable :("?:\\Windows\\System32\\AtBroker.exe", "?:\\Windows\\system32\\svchost.exe", "?:\\Program Files (x86)\\*.exe", "?:\\Program Files\\*.exe", "?:\\Windows\\System32\\msiexec.exe","?:\\Windows\\System32\\DriverStore\\*") and/* Ignores Windows binaries with a trusted signature and specific signature name */ not (process.code_signature.trusted == true andprocess.code_signature.subject_name : ("philandro Software GmbH","Freedom Scientific Inc.","TeamViewer Germany GmbH","Projector.is, Inc.","TeamViewer GmbH","Cisco WebEx LLC","Dell Inc"))'''


<li><a href="#">DESCRIPTION = Identifies the creation of a Windows service by an unusual client process. Services may be created with administratorprivileges but are executed under SYSTEM privileges, so an adversary may also use a service to escalate privileges fromadministrator to SYSTEM.

NAME = "Windows Service Installed via an Unusual Client"

QUERY = '''event.action:"service-installed" and(winlog.event_data.ClientProcessId:"0" or winlog.event_data.ParentProcessId:"0") andnot winlog.event_data.ServiceFileName : ("C:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe" or"%SystemRoot%\\system32\\Drivers\\Crowdstrike\\17706-CsInstallerService.exe")'''


<li><a href="#">DESCRIPTION = Identifies probable exploitation of the Web Proxy Auto-Discovery Protocol (WPAD) service. Attackers who have access tothe local network or upstream DNS traffic can inject malicious JavaScript to the WPAD service which can lead to a fullsystem compromise.

NAME = "WPAD Service Exploit"

QUERY = '''/* preference would be to use user.sid rather than domain+name, once it is available in ECS + datasources *//* didn't trigger successfully during testing */sequence with maxspan=5s[process where host.os.type == "windows" and event.type == "start" and process.name : "svchost.exe" and user.domain : "NT AUTHORITY" and user.name : "LOCAL SERVICE"] by process.entity_id[network where host.os.type == "windows" and network.protocol : "dns" and process.name : "svchost.exe" and dns.question.name : "wpad" and process.name : "svchost.exe"] by process.entity_id[network where host.os.type == "windows" and process.name : "svchost.exe" and network.direction : ("outgoing", "egress") and destination.port == 80] by process.entity_id[library where host.os.type == "windows" and event.type : "start" and process.name : "svchost.exe" and dll.name : "jscript.dll" and process.name : "svchost.exe"] by process.entity_id[process where host.os.type == "windows" and event.type == "start" and process.parent.name : "svchost.exe"] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = This rule is triggered when an IP address indicator from the Threat Intel Filebeat module or integrations has a matchagainst a network event.

NAME = "Threat Intel IP Address Indicator Match"

QUERY = '''@timestamp >= "now-30d/d" and event.module:(threatintel or ti_*) and threat.indicator.ip:* andnot labels.is_ioc_transform_source:"true'''query = source.ip:* or destination.ip:*[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.category"[rule.threat_filters.meta.params]query = "threat"[rule.threat_filters.query.match_phrase]"event.category" = "threat"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.kind"[rule.threat_filters.meta.params]query = "enrichment"[rule.threat_filters.query.match_phrase]"event.kind" = "enrichment"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.type"[rule.threat_filters.meta.params]query = "indicator"[rule.threat_filters.query.match_phrase]"event.type" = "indicator"


<li><a href="#">DESCRIPTION = This rule is triggered when a hash indicator from the Threat Intel Filebeat module or integrations has a match against anevent that contains file hashes, such as antivirus alerts, process creation, library load, and file operation events.

NAME = "Threat Intel Hash Indicator Match"

QUERY = '''@timestamp >= "now-30d/d" and event.module:(threatintel or ti_*) and(threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:*) andnot labels.is_ioc_transform_source:"true'''query = file.hash.*:* or process.hash.*:* or dll.hash.*:*[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.category"[rule.threat_filters.meta.params]query = "threat"[rule.threat_filters.query.match_phrase]"event.category" = "threat"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.kind"[rule.threat_filters.meta.params]query = "enrichment"[rule.threat_filters.query.match_phrase]"event.kind" = "enrichment"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.type"[rule.threat_filters.meta.params]query = "indicator"[rule.threat_filters.query.match_phrase]"event.type" = "indicator"


<li><a href="#">DESCRIPTION = This rule is triggered when a Windows registry indicator from the Threat Intel Filebeat module or integrations has amatch against an event that contains registry data.

NAME = "Threat Intel Windows Registry Indicator Match"

QUERY = '''@timestamp >= "now-30d/d" and event.module:(threatintel or ti_*) and threat.indicator.registry.path:* andnot labels.is_ioc_transform_source:"true'''query = registry.path:*[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.category"[rule.threat_filters.meta.params]query = "threat"[rule.threat_filters.query.match_phrase]"event.category" = "threat"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.kind"[rule.threat_filters.meta.params]query = "enrichment"[rule.threat_filters.query.match_phrase]"event.kind" = "enrichment"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.type"[rule.threat_filters.meta.params]query = "indicator"[rule.threat_filters.query.match_phrase]"event.type" = "indicator"


<li><a href="#">DESCRIPTION = This rule is triggered when a URL indicator from the Threat Intel Filebeat module or integrations has a match against anevent that contains URL data, like DNS events, network logs, etc.

NAME = "Threat Intel URL Indicator Match"

QUERY = '''@timestamp >= "now-30d/d" and event.module:(threatintel or ti_*) andthreat.indicator.url.full:* and not labels.is_ioc_transform_source:"true'''query = url.full:*[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.category"[rule.threat_filters.meta.params]query = "threat"[rule.threat_filters.query.match_phrase]"event.category" = "threat"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.kind"[rule.threat_filters.meta.params]query = "enrichment"[rule.threat_filters.query.match_phrase]"event.kind" = "enrichment"[[rule.threat_filters]][rule.threat_filters."$state"]store = "appState"[rule.threat_filters.meta]negate = falsedisabled = falsetype = "phrase"key = "event.type"[rule.threat_filters.meta.params]query = "indicator"[rule.threat_filters.query.match_phrase]"event.type" = "indicator"


<li><a href="#">DESCRIPTION = Detects Inter-Process Communication with Outlook via Component Object Model from an unusual process. Adversaries may target user email to collectsensitive information or send email on their behalf via API.

NAME = "Suspicious Inter-Process Communication via Outlook"

QUERY = '''sequence with maxspan=1m[process where host.os.type == "windows" and event.action == "start" and(process.name : ("rundll32.exe", "mshta.exe", "powershell.exe", "pwsh.exe","cmd.exe", "regsvr32.exe", "cscript.exe", "wscript.exe") or((process.code_signature.trusted == false or process.code_signature.exists == false) and (process.Ext.relative_file_creation_time <= 500 or process.Ext.relative_file_name_modify_time <= 500)))] by process.executable[process where host.os.type == "windows" and event.action == "start" and process.name : "OUTLOOK.EXE" andprocess.Ext.effective_parent.name != null] by process.Ext.effective_parent.executable'''


<li><a href="#">DESCRIPTION = Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primarymailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.

NAME = "Exporting Exchange Mailbox via PowerShell"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name: ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and process.command_line : ("*MailboxExportRequest*", "*-Mailbox*-ContentFilter*")'''


<li><a href="#">DESCRIPTION = Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.

NAME = "Exchange Mailbox Export via PowerShell"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : "New-MailboxExportRequest" andnot (file.path : (?\:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Exchange\\\\RemotePowerShell\\\\* or?\:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp_????????.???\\\\tmp_????????.???.ps?1* or?\:\\\\Windows\\\\TEMP\\\\tmp_????????.???\\\\tmp_????????.???.ps?1*) and file.name:(*.psd1 or *.psm1))'''


<li><a href="#">DESCRIPTION = "Detects PowerShell scripts that can record audio, a common feature in popular post-exploitation tooling."from =

NAME = "PowerShell Suspicious Script with Audio Capture Capabilities"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ("Get-MicrophoneAudio" or"WindowsAudioDevice-Powershell-Cmdlet" or(waveInGetNumDevs and mciSendStringA))and not powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint" and "PowerSploitIndicators")and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that can get the contents of the clipboard, which attackers can abuse to retrieve sensitiveinformation like credentials, messages, etc.

NAME = "PowerShell Suspicious Script with Clipboard Retrieval Capabilities"

QUERY = '''event.category:process and host.os.type:windows and(powershell.file.script_block_text : ("Windows.Clipboard" or"Windows.Forms.Clipboard" or"Windows.Forms.TextBox" ) and powershell.file.script_block_text : ("]::GetText" or".Paste()")) or powershell.file.script_block_text : "Get-Clipboard" andnot powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint" and "PowerSploitIndicators") andnot user.id : "S-1-5-18" andnot file.path : (?\:\\\\program?files\\\\powershell\\\\?\\\\Modules\\\\*.psd1 or?\:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\*.psd1 or?\:\\\\WINDOWS\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\*.psd1 or?\:\\\\Program?Files\\\\WindowsPowerShell\\\\Modules\\\\*.psd1 or?\:\\\\Program?Files\\\\WindowsPowerShell\\\\Modules\\\\*.psm1) and not (file.path : ?\:\\\\Program?Files\\\\WindowsPowerShell\\\\*Modules*.ps1 andfile.name : ("Convert-ExcelRangeToImage.ps1" or "Read-Clipboard.ps1"))'''


<li><a href="#">DESCRIPTION = Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers usethis technique to capture user input, looking for credentials and/or other valuable data.

NAME = "PowerShell Keylogging Script"

QUERY = '''event.category:process and host.os.type:windows and( powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or "Get-Keystrokes") or powershell.file.script_block_text : ((SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and(GetForegroundWindow or GetWindowTextA or GetWindowTextW or "WM_KEYBOARD_LL" or "WH_MOUSE_LL") ) ) and not user.id : "S-1-5-18"and not powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint")'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that can be used to collect data from mailboxes. Adversaries may target user email to collectsensitive information.

NAME = "PowerShell Mailbox Collection Script"

QUERY = '''event.category:process and host.os.type:windows and( powershell.file.script_block_text : ("Microsoft.Office.Interop.Outlook" or"Interop.Outlook.olDefaultFolders" or"::olFolderInBox" ) or powershell.file.script_block_text : ("Microsoft.Exchange.WebServices.Data.Folder" or"Microsoft.Exchange.WebServices.Data.FileAttachment" )) and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that can take screenshots, which is a common feature in post-exploitation kits and remoteaccess tools (RATs).

NAME = "PowerShell Suspicious Script with Screenshot Capabilities"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : (CopyFromScreen and("System.Drawing.Bitmap" or "Drawing.Bitmap")) and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that can be used to record webcam video. Attackers can capture this information to extort orspy on victims.

NAME = "PowerShell Script with Webcam Video Capture Capabilities"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ("NewFrameEventHandler" or"VideoCaptureDevice" or"DirectX.Capture.Filters" or"VideoCompressors" or"Start-WebcamRecorder" or(("capCreateCaptureWindowA" or "capCreateCaptureWindow" or "capGetDriverDescription") and("avicap32.dll" or "avicap32")))'''


<li><a href="#">DESCRIPTION = Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data inpreparation for exfiltration.

NAME = "Encrypting Files with WinRar or 7z"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(((process.name:"rar.exe" or ?process.code_signature.subject_name == "win.rar GmbH" or?process.pe.original_file_name == "Command line RAR") andprocess.args == "a" and process.args : ("-hp*", "-p*", "/hp*", "/p*")) or(?process.pe.original_file_name in ("7z.exe", "7za.exe") andprocess.args == "a" and process.args : "-p*")) andnot process.parent.executable : ("C:\\Program Files\\*.exe","C:\\Program Files (x86)\\*.exe","?:\\ManageEngine\\*\\jre\\bin\\java.exe","?:\\Nox\\bin\\Nox.exe")'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of Telnet traffic. Telnet is commonly used by systemadministrators to remotely control older or embedded systems using the command line shell. It should almost never bedirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access orbackdoor vector. As a plain-text protocol, it may also expose usernames and passwords to anyone capable of observing thetraffic.

NAME = "Accepted Default Telnet Port Connection"

QUERY = '''(event.dataset:network_traffic.flow or event.category:(network or network_traffic))and event.type:connection and not event.action:(flow_dropped or denied or deny orflow_terminated or timeout or Reject or network_flow)and destination.port:23'''


<li><a href="#">DESCRIPTION = Identifies Certreq making an HTTP Post request. Adversaries could abuse Certreq to download files or upload data to a remote URL.

NAME = "Potential File Transfer via Certreq"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : "CertReq.exe" or ?process.pe.original_file_name == "CertReq.exe") and process.args : "-Post'''


<li><a href="#">DESCRIPTION = Cobalt Strike is a threat emulation platform commonly modified and used by adversaries to conduct network attack andexploitation campaigns. This rule detects a network activity algorithm leveraged by Cobalt Strike implant beacons forcommand and control.

NAME = "Cobalt Strike Command and Control Beacon"

QUERY = '''((event.category: (network OR network_traffic) AND type: (tls OR http))OR event.dataset: (network_traffic.tls OR network_traffic.http)) AND destination.domain:/[a-z]{3}.stage.[0-9]{8}\..*/'''


<li><a href="#">DESCRIPTION = This rule detects the use of the default Cobalt Strike Team Server TLS certificate. Cobalt Strike is software forAdversary Simulations and Red Team Operations which are security assessments that replicate the tactics and techniquesof an advanced adversary in a network. Modifications to the Packetbeat configuration can be made to include MD5 andSHA256 hashing algorithms (the default is SHA1). See the References section for additional information on moduleconfiguration.

NAME = "Default Cobalt Strike Team Server Certificate"

QUERY = '''(event.dataset: network_traffic.tls or event.category: (network or network_traffic))and (tls.server.hash.md5:950098276A495286EB2A2556FBAB6D83or tls.server.hash.sha1:6ECE5ECE4192683D2D84E25B0BA7E04F9CB7EB7Cor tls.server.hash.sha256:87F2085C32B6A2CC709B365F55873E207A9CAA10BFFECF2FD16D3CF9D94D390C)'''


<li><a href="#">DESCRIPTION = Adversaries may implement command and control (C2) communications that use common web services to hide their activity.This attack technique is typically targeted at an organization and uses web services common to the victim network, whichallows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since theyhave most likely been used before compromise, which helps malicious traffic blend in.

NAME = "Connection to Commonly Abused Web Services"

QUERY = '''network where host.os.type == "windows" and network.protocol == "dns" andprocess.name != null and user.id not in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and/* Add new WebSvc domains here */dns.question.name :("raw.githubusercontent.*","*.pastebin.*","*drive.google.*","*docs.live.*","*api.dropboxapi.*","*dropboxusercontent.*","*onedrive.*","*4shared.*","*.file.io","*filebin.net","*slack-files.com","*ghostbin.*","*ngrok.*","*portmap.*","*serveo.net","*localtunnel.me","*pagekite.me","*localxpose.io","*notabug.org","rawcdn.githack.*","paste.nrecom.net","zerobin.net","controlc.com","requestbin.net","cdn.discordapp.com","discordapp.com","discord.com","script.google.com","script.googleusercontent.com") and/* Insert noisy false positives here */not ((process.executable : ("?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\System32\\WWAHost.exe","?:\\Windows\\System32\\smartscreen.exe","?:\\Windows\\System32\\MicrosoftEdgeCP.exe","?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe","?:\\Users\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrome.exe","?:\\Users\\*\\AppData\\Local\\BraveSoftware\\*\\Application\\brave.exe","?:\\Users\\*\\AppData\\Local\\Vivaldi\\Application\\vivaldi.exe","?:\\Users\\*\\AppData\\Local\\Programs\\Opera*\\opera.exe","?:\\Users\\*\\AppData\\Local\\Programs\\Fiddler\\Fiddler.exe","?:\\Users\\*\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe","?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe","?:\\Windows\\system32\\mobsync.exe","?:\\Windows\\SysWOW64\\mobsync.exe") and process.code_signature.trusted == true) or/* Discord App */(process.name : "Discord.exe" and (process.code_signature.subject_name : "Discord Inc." and process.code_signature.trusted == true) and dns.question.name : ("discord.com", "cdn.discordapp.com", "discordapp.com")) or /* MS Sharepoint */(process.name : "Microsoft.SharePoint.exe" and (process.code_signature.subject_name : "Microsoft Corporation" and process.code_signature.trusted == true) and dns.question.name : "onedrive.live.com") or /* Firefox */(process.name : "firefox.exe" and (process.code_signature.subject_name : "Mozilla Corporation" and process.code_signature.trusted == true)) or /* Dropbox */(process.name : "Dropbox.exe" and (process.code_signature.subject_name : "Dropbox, Inc" and process.code_signature.trusted == true) and dns.question.name : ("api.dropboxapi.com", "*.dropboxusercontent.com")) or /* Obsidian - Plugins are stored on raw.githubusercontent.com */(process.name : "Obsidian.exe" and (process.code_signature.subject_name : "Dynalist Inc" and process.code_signature.trusted == true) and dns.question.name : "raw.githubusercontent.com") or /* WebExperienceHostApp */(process.name : "WebExperienceHostApp.exe" and (process.code_signature.subject_name : "Microsoft Windows" and process.code_signature.trusted == true) and dns.question.name : ("onedrive.live.com", "skyapi.onedrive.live.com"))) '''


<li><a href="#">DESCRIPTION = This rule identifies a large number (15) of nslookup.exe executions with an explicit query type from the same host. Thismay indicate command and control activity utilizing the DNS protocol.

NAME = "Potential DNS Tunneling via NsLookup"

QUERY = '''sequence by host.id with maxspan=5m[process where host.os.type == "windows" and event.type == "start" andprocess.name : "nslookup.exe" and process.args:("-querytype=*", "-qt=*", "-q=*", "-type=*")] with runs = 10'''


<li><a href="#">DESCRIPTION = Detects a Roshal Archive (RAR) file or PowerShell script downloaded from the internet by an internal host. Gaininginitial access to a system and then downloading encoded or encrypted tools to move laterally is a common practice foradversaries as a way to protect their more valuable tools and tactics, techniques, and procedures (TTPs). This may beatypical behavior for a managed network and can be indicative of malware, exfiltration, or command and control.

NAME = "Roshal Archive (RAR) or PowerShell File Downloaded from the Internet"

QUERY = '''(event.dataset: (network_traffic.http or network_traffic.tls) or(event.category: (network or network_traffic) and network.protocol: http)) and(url.extension:(ps1 or rar) or url.path:(*.ps1 or *.rar)) andnot destination.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8") andsource.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a knownencryption algorithm to conceal command and control traffic.

NAME = "Connection to Commonly Abused Free SSL Certificate Providers"

QUERY = '''network where host.os.type == "windows" and network.protocol == "dns" and/* Add new free SSL certificate provider domains here */dns.question.name : ("*letsencrypt.org", "*.sslforfree.com", "*.zerossl.com", "*.freessl.org") and/* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */process.executable : ("C:\\Windows\\System32\\*.exe","C:\\Windows\\System\\*.exe",	"C:\\Windows\\SysWOW64\\*.exe",		"C:\\Windows\\Microsoft.NET\\Framework*\\*.exe",		"C:\\Windows\\explorer.exe",		"C:\\Windows\\notepad.exe") and/* Insert noisy false positives here */not process.name : ("svchost.exe", "MicrosoftEdge*.exe", "msedge.exe")'''


<li><a href="#">DESCRIPTION = This rule detects a known command and control pattern in network events. The FIN7 threat group is known to use thiscommand and control technique, while maintaining persistence in their target's network.

NAME = "Possible FIN7 DGA Command and Control Behavior"

QUERY = '''(event.dataset: (network_traffic.tls OR network_traffic.http) OR(event.category: (network OR network_traffic) AND type: (tls OR http) AND network.transport: tcp)) ANDdestination.domain:/[a-zA-Z]{4,5}\.(pw|us|club|info|site|top)/ AND NOT destination.domain:zoom.us'''


<li><a href="#">DESCRIPTION = Identifies suspicious file download activity from a Google Drive URL. This could indicate an attempt to deliver phishing payloads via a trusted webservice.

NAME = "Suspicious File Downloaded from Google Drive"

QUERY = '''process where/* common browser processes*/event.action in ("exec", "fork", "start") and process.name : ("Microsoft Edge", "chrome.exe", "Google Chrome", "google-chrome-stable", "google-chrome-beta", "google-chrome", "msedge.exe", "firefox.exe", "brave.exe", "whale.exe", "browser.exe", "dragon.exe", "vivaldi.exe", "opera.exe", "firefox", "powershell.exe", "curl", "curl.exe", "wget", "wget.exe") and /* Look for Google Drive download URL with AV flag skipping */(process.command_line : "*drive.google.com*" and process.command_line : "*export=download*" and process.command_line : "*confirm=no_antivirus*")'''


<li><a href="#">DESCRIPTION = Halfbaked is a malware family used to establish persistence in a contested network. This rule detects a network activityalgorithm leveraged by Halfbaked implant beacons for command and control.

NAME = "Halfbaked Command and Control Beacon"

QUERY = '''(event.dataset: (network_traffic.tls OR network_traffic.http) OR(event.category: (network OR network_traffic) AND network.protocol: http)) ANDnetwork.transport:tcp AND url.full:/http:\/\/[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}\/cd/ ANDdestination.port:(53 OR 80 OR 8080 OR 443)'''


<li><a href="#">DESCRIPTION = Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) makingunusual network connections. Adversaries could abuse Internet Explorer via COM to avoid suspicious processes makingnetwork connections and bypass host-based firewall restrictions.

NAME = "Potential Command and Control via Internet Explorer"

QUERY = '''sequence by host.id, user.name with maxspan = 5s[library where host.os.type == "windows" and dll.name : "IEProxy.dll" and process.name : ("rundll32.exe", "regsvr32.exe")][process where host.os.type == "windows" and event.type == "start" and process.parent.name : "iexplore.exe" and process.parent.args : "-Embedding"]/* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */[network where host.os.type == "windows" and network.protocol == "dns" and process.name : "iexplore.exe" and not dns.question.name : ("*.microsoft.com","*.digicert.com","*.msocsp.com","*.windowsupdate.com","*.bing.com","*.identrust.com","*.sharepoint.com","*.office365.com","*.office.com")] /* with runs=5 */'''


<li><a href="#">DESCRIPTION = Identifies downloads of executable and archive files via the Windows Background Intelligent Transfer Service (BITS). Adversaries could leverage Windows BITS transfer jobs to download remote payloads.

NAME = "Ingress Transfer via Windows BITS"

QUERY = '''file where host.os.type == "windows" and event.action == "rename" andprocess.name : "svchost.exe" and file.Ext.original.name : "BIT*.tmp" and (file.extension : ("exe", "zip", "rar", "bat", "dll", "ps1", "vbs", "wsh", "js", "vbe", "pif", "scr", "cmd", "cpl") or file.Ext.header_bytes : "4d5a*") and/* noisy paths, for hunting purposes you can use the same query without the following exclusions */not file.path : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*", "?:\\Windows\\*", "?:\\ProgramData\\*\\*") and/* lot of third party SW use BITS to download executables with a long file name */not length(file.name) > 30 andnot file.path : ("?:\\Users\\*\\AppData\\Local\\Temp*\\wct*.tmp","?:\\Users\\*\\AppData\\Local\\Adobe\\ARM\\*\\RdrServicesUpdater*.exe","?:\\Users\\*\\AppData\\Local\\Adobe\\ARM\\*\\AcroServicesUpdater2_x64.exe","?:\\Users\\*\\AppData\\Local\\Docker Desktop Installer\\update-*.exe")'''


<li><a href="#">DESCRIPTION = This rule detects events that could be describing IPSEC NAT Traversal traffic. IPSEC is a VPN technology that allows onesystem to talk to another using encrypted tunnels. NAT Traversal enables these tunnels to communicate over the Internetwhere one of the sides is behind a NAT router gateway. This may be common on your network, but this technique is alsoused by threat actors to avoid detection.

NAME = "IPSEC NAT Traversal Port Activity"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and network.transport:udp and destination.port:4500'''


<li><a href="#">DESCRIPTION = Adversaries may install legitimate remote access tools (RAT) to compromised endpoints for further command-and-control(C2). Adversaries can rely on installed RATs for persistence, execution of native commands and more. This rule detectswhen a process is started whose name or code signature resembles commonly abused RATs. This is a New Terms rule typeindicating the host has not seen this RAT process started before within the last 30 days.

NAME = "First Time Seen Commonly Abused Remote Access Tool Execution"

QUERY = '''host.os.type: "windows" and event.category: "process" and event.type : "start" and(process.code_signature.subject_name : (TeamViewer* or "NetSupport Ltd" or "GlavSoft" or "LogMeIn, Inc." or "Ammyy LLC" or"Nanosystems S.r.l." or "Remote Utilities LLC" or "ShowMyPC" or "Splashtop Inc." or"Yakhnovets Denis Aleksandrovich IP" or "Pro Softnet Corporation" or "BeamYourScreen GmbH" or"RealVNC" or "uvnc" or "SAFIB") orprocess.name.caseless : ("teamviewer.exe" or "apc_Admin.exe" or "apc_host.exe" or "SupremoHelper.exe" or "rfusclient.exe" or"spclink.exe" or "smpcview.exe" or "ROMServer.exe" or "strwinclt.exe" or "RPCSuite.exe" or "RemotePCDesktop.exe" or"RemotePCService.exe" or "tvn.exe" or "LMIIgnition.exe" or "B4-Service.exe" or "Mikogo-Service.exe" or "AnyDesk.exe" or"Splashtop-streamer.exe" or AA_v*.exe, or "rutserv.exe" or "rutview.exe" or "vncserver.exe" or "vncviewer.exe" or"tvnserver.exe" or "tvnviewer.exe" or "winvnc.exe" or "RemoteDesktopManager.exe" or "LogMeIn.exe" or ScreenConnect*.exe or"RemotePC.exe" or "r_server.exe" or "radmin.exe" or "ROMServer.exe" or "ROMViewer.exe" or "DWRCC.exe" or "AeroAdmin.exe" or"ISLLightClient.exe" or "ISLLight.exe" or "AteraAgent.exe" or "SRService.exe")	) and	not (process.pe.original_file_name : ("G2M.exe" or "Updater.exe" or "powershell.exe") and process.code_signature.subject_name : "LogMeIn, Inc.")'''


<li><a href="#">DESCRIPTION = Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. Forexample, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to thestandard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.

NAME = "Potential Non-Standard Port SSH connection"

QUERY = '''sequence by process.entity_id with maxspan=1m[process where event.action == "exec" and process.name:"ssh" and not process.parent.name in ( "rsync", "pyznap", "git", "ansible-playbook", "scp", "pgbackrest", "git-lfs", "expect", "Sourcetree", "ssh-copy-id", "run" )][network where process.name:"ssh" and event.action in ("connection_attempted", "connection_accepted") anddestination.port != 22 and destination.ip != "127.0.0.1" and network.transport: "tcp"]'''


<li><a href="#">DESCRIPTION = This rule detects events that may indicate use of SMTP on TCP port 26. This port is commonly used by several popularmail transfer agents to deconflict with the default SMTP port 25. This port has also been used by a malware familycalled BadPatch for command and control of Windows systems.

NAME = "SMTP on Port 26/TCP"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) andnetwork.transport:tcp and (destination.port:26 or (event.dataset:zeek.smtp and destination.port:26))'''


<li><a href="#">DESCRIPTION = Identifies the creation of a new port forwarding rule. An adversary may abuse this technique to bypass networksegmentation restrictions.

NAME = "Port Forwarding Rule Addition"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\*")'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of RDP traffic from the Internet. RDP is commonly used bysystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never bedirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access orbackdoor vector.

NAME = "RDP (Remote Desktop Protocol) from the Internet"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) andnetwork.transport:tcp and (destination.port:3389 or event.dataset:zeek.rdp) andnot source.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8") anddestination.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers toenable routing of network packets that would otherwise not reach their intended destination.

NAME = "Potential Remote Desktop Tunneling Detected"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and/* RDP port and usual SSH tunneling related switches in command line */process.args : "*:3389" andprocess.args : ("-L", "-P", "-R", "-pw", "-ssh")'''


<li><a href="#">DESCRIPTION = Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr todownload arbitrary files as an alternative to certutil.

NAME = "Remote File Download via Desktopimgdownldr Utility"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "desktopimgdownldr.exe" or ?process.pe.original_file_name == "desktopimgdownldr.exe") andprocess.args : "/lockscreenurl:http*'''


<li><a href="#">DESCRIPTION = "Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file."from =

NAME = "Remote File Download via MpCmdRun"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "MpCmdRun.exe" or ?process.pe.original_file_name == "MpCmdRun.exe") and process.args : "-DownloadFile" and process.args : "-url" and process.args : "-path'''


<li><a href="#">DESCRIPTION = "Identifies powershell.exe being used to download an executable file from an untrusted remote destination."from =

NAME = "Remote File Download via PowerShell"

QUERY = '''sequence by process.entity_id with maxspan=30s[network where host.os.type == "windows" andprocess.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and network.protocol == "dns" and not dns.question.name : ("localhost", "*.microsoft.com", "*.azureedge.net", "*.powershellgallery.com","*.windowsupdate.com", "metadata.google.internal", "dist.nuget.org","artifacts.elastic.co", "*.digicert.com", "packages.chocolatey.org","outlook.office365.com" ) and not user.id : "S-1-5-18"][file where host.os.type == "windows" and event.type == "creation" andprocess.name : "powershell.exe" and file.extension : ("exe", "dll", "ps1", "bat") andnot file.name : "__PSScriptPolicy*.ps1"]'''


<li><a href="#">DESCRIPTION = Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable filefrom a remote destination.

NAME = "Remote File Download via Script Interpreter"

QUERY = '''sequence by host.id, process.entity_id[network where host.os.type == "windows" and process.name : ("wscript.exe", "cscript.exe") and network.protocol != "dns" and network.direction : ("outgoing", "egress") and network.type == "ipv4" and destination.ip != "127.0.0.1"][file where host.os.type == "windows" and event.type == "creation" and file.extension : ("exe", "dll")]'''


<li><a href="#">DESCRIPTION = The malware known as SUNBURST targets the SolarWind's Orion business software for command and control. This rule detectspost-exploitation command and control activity of the SUNBURST backdoor.

NAME = "SUNBURST Command and Control Activity"

QUERY = '''network where host.os.type == "windows" and event.type == "protocol" and network.protocol == "http" andprocess.name : ("ConfigurationWizard.exe","NetFlowService.exe","NetflowDatabaseMaintenance.exe","SolarWinds.Administration.exe","SolarWinds.BusinessLayerHost.exe","SolarWinds.BusinessLayerHostx64.exe","SolarWinds.Collector.Service.exe","SolarwindsDiagnostics.exe") and(((http.request.body.content : "*/swip/Upload.ashx*" and http.request.body.content : ("POST*", "PUT*")) or(http.request.body.content : ("*/swip/SystemDescription*", "*/swip/Events*") and http.request.body.content : ("GET*", "HEAD*"))) andnot http.request.body.content : "*solarwinds.com*")'''


<li><a href="#">DESCRIPTION = "Identifies an executable or script file remotely downloaded via a TeamViewer transfer session."from =

NAME = "Remote File Copy via TeamViewer"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" and process.name : "TeamViewer.exe" andfile.extension : ("exe", "dll", "scr", "com", "bat", "ps1", "vbs", "vbe", "js", "wsh", "hta") andnot (file.path : ("?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\INetCache\\*.js","?:\\Users\\*\\AppData\\Local\\Temp\\TeamViewer\\update.exe","?:\\Users\\*\\AppData\\Local\\Temp\\?\\TeamViewer\\update.exe") and process.code_signature.trusted == true)'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of VNC traffic from the Internet. VNC is commonly used bysystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never bedirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access orbackdoor vector.

NAME = "VNC (Virtual Network Computing) from the Internet"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) andnetwork.transport:tcp and destination.port >= 5800 and destination.port <= 5810 andnot source.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8") anddestination.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of VNC traffic to the Internet. VNC is commonly used bysystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never bedirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access orbackdoor vector.

NAME = "VNC (Virtual Network Computing) to the Internet"

QUERY = '''(event.dataset: network_traffic.flowor (event.category: (network or network_traffic))) andnetwork.transport:tcp and destination.port >= 5800 and destination.port <= 5810 andsource.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16) andnot destination.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8")'''


<li><a href="#">DESCRIPTION = Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within ashort time interval. Adversaries will often brute force login attempts across multiple users with a common or knownpassword, in an attempt to gain access to accounts.

NAME = "Privileged Account Brute Force"

QUERY = '''sequence by winlog.computer_name, source.ip with maxspan=10s[authentication where event.action == "logon-failed" and winlog.logon.type : "Network" andsource.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" and user.name : "*admin*" and/* noisy failure status codes often associated to authentication misconfiguration */not winlog.event_data.Status : ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with runs=5'''


<li><a href="#">DESCRIPTION = Identifies multiple logon failures followed by a successful one from the same source address. Adversaries will oftenbrute force login attempts across multiple users with a common or known password, in an attempt to gain access toaccounts.

NAME = "Multiple Logon Failure Followed by Logon Success"

QUERY = '''sequence by winlog.computer_name, source.ip with maxspan=5s[authentication where event.action == "logon-failed" and/* event 4625 need to be logged */winlog.logon.type : "Network" and user.id != null and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" and not winlog.event_data.TargetUserSid : "S-1-0-0" and not user.id : "S-1-0-0" and not user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT AUTHORITY" and/* noisy failure status codes often associated to authentication misconfiguration */not winlog.event_data.Status : ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with runs=5[authentication where event.action == "logged-in" and/* event 4624 need to be logged */winlog.logon.type : "Network" andsource.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" andnot user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT AUTHORITY"]'''


<li><a href="#">DESCRIPTION = Identifies multiple consecutive logon failures from the same source address and within a short time interval.Adversaries will often brute force login attempts across multiple users with a common or known password, in an attemptto gain access to accounts.

NAME = "Multiple Logon Failure from the same Source Address"

QUERY = '''sequence by winlog.computer_name, source.ip with maxspan=10s[authentication where event.action == "logon-failed" and/* event 4625 need to be logged */winlog.logon.type : "Network" andsource.ip != null and source.ip != "127.0.0.1" and source.ip != "::1" andnot user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT AUTHORITY" and/*noisy failure status codes often associated to authentication misconfiguration : 0xC000015B - The user has not been granted the requested logon type (also called the logon right) at this machine. 0XC000005E	- There are currently no logon servers available to service the logon request. 0XC0000133	- Clocks between DC and other computer too far out of sync. 0XC0000192	An attempt was made to logon, but the Netlogon service was not started.*/not winlog.event_data.Status : ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with runs=10'''


<li><a href="#">DESCRIPTION = Identifies the execution of known Windows utilities often abused to dump LSASS memory or the Active Directory database(NTDS.dit) in preparation for credential access.

NAME = "Potential Credential Access via Windows Utilities"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(((?process.pe.original_file_name : "procdump" or process.name : "procdump.exe") and process.args : "-ma") or(process.name : "ProcessDump.exe" and not process.parent.executable regex~ C:\\Program Files( \(x86\))?\\Cisco Systems\\.*) or((?process.pe.original_file_name : "WriteMiniDump.exe" or process.name : "WriteMiniDump.exe") andnot process.parent.executable regex~ C:\\Program Files( \(x86\))?\\Steam\\.*) or((?process.pe.original_file_name : "RUNDLL32.EXE" or process.name : "RUNDLL32.exe") and(process.args : "MiniDump*" or process.command_line : "*comsvcs.dll*#24*")) or((?process.pe.original_file_name : "RdrLeakDiag.exe" or process.name : "RdrLeakDiag.exe") andprocess.args : "/fullmemdmp") or((?process.pe.original_file_name : "SqlDumper.exe" or process.name : "SqlDumper.exe") andprocess.args : "0x01100*") or((?process.pe.original_file_name : "TTTracer.exe" or process.name : "TTTracer.exe") andprocess.args : "-dumpFull" and process.args : "-attach") or((?process.pe.original_file_name : "ntdsutil.exe" or process.name : "ntdsutil.exe") andprocess.args : "create*full*") or((?process.pe.original_file_name : "diskshadow.exe" or process.name : "diskshadow.exe") and process.args : "/s"))'''


<li><a href="#">DESCRIPTION = Identifies the execution of a Chromium based browser with the debugging process argument, which may indicate an attemptto steal authentication cookies. An adversary may steal web application or service session cookies and use them to gainaccess web applications or Internet services as an authenticated user without needing credentials.

NAME = "Potential Cookies Theft via Browser Debugging"

QUERY = '''process where event.type in ("start", "process_started", "info") andprocess.name in ( "Microsoft Edge", "chrome.exe", "Google Chrome", "google-chrome-stable", "google-chrome-beta", "google-chrome", "msedge.exe") and process.args : ("--remote-debugging-port=*", "--remote-debugging-targets=*", "--remote-debugging-pipe=*") and process.args : "--user-data-dir=*" and not process.args:"--remote-debugging-port=0'''


<li><a href="#">DESCRIPTION = Identifies a copy operation of the Active Directory Domain Database (ntds.dit) or Security Account Manager (SAM) files.Those files contain sensitive information including hashed domain and/or local credentials.

NAME = "NTDS or SAM Database File Copied"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(((?process.pe.original_file_name in ("Cmd.Exe", "PowerShell.EXE", "XCOPY.EXE") or process.name : ("Cmd.Exe", "PowerShell.EXE", "XCOPY.EXE")) and process.args : ("copy", "xcopy", "Copy-Item", "move", "cp", "mv")) or((?process.pe.original_file_name : "esentutl.exe" or process.name : "esentutl.exe") and process.args : ("*/y*", "*/vss*", "*/d*"))) andprocess.command_line : ("*\\ntds.dit*", "*\\config\\SAM*", "*\\*\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy*\\*", "*/system32/config/SAM*", "*\\User Data\\*")'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windowscredential management. This technique is sometimes used for credential dumping.

NAME = "Potential Credential Access via Trusted Developer Utility"

QUERY = '''sequence by process.entity_id [process where host.os.type == "windows" and event.type == "start" and (process.name : "MSBuild.exe" or process.pe.original_file_name == "MSBuild.exe")] [any where host.os.type == "windows" and (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and(?dll.name : ("vaultcli.dll", "SAMLib.DLL") or file.name : ("vaultcli.dll", "SAMLib.DLL"))]'''


<li><a href="#">DESCRIPTION = This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.

NAME = "FirstTime Seen Account Performing DCSync"

QUERY = '''event.action:("Directory Service Access" or "object-operation-performed") and event.code:"4662" and winlog.event_data.Properties:(*DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and not winlog.event_data.SubjectUserName:(*$ or MSOL_*)'''


<li><a href="#">DESCRIPTION = This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSynctechnique to get credential information of individual accounts or the entire domain, thus compromising the entiredomain.

NAME = "Potential Credential Access via DCSync"

QUERY = '''any where event.action : ("Directory Service Access", "object-operation-performed") andevent.code == "4662" and winlog.event_data.Properties : (/* Control Access Rights/Permissions Symbol */"*DS-Replication-Get-Changes*","*DS-Replication-Get-Changes-All*","*DS-Replication-Get-Changes-In-Filtered-Set*",/* Identifying GUID used in ACE */"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*","*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*","*89e95b76-444d-4c62-991a-0facbeda640c*")/* The right to perform an operation controlled by an extended access right. */and winlog.event_data.AccessMask : "0x100" andnot winlog.event_data.SubjectUserName : ("*$", "MSOL_*", "OpenDNS_Connector", "adconnect", "SyncADConnect","SyncADConnectCM", "aadsync", "svcAzureADSync", "-")/* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */'''


<li><a href="#">DESCRIPTION = Identifies the modification of an account's Kerberos pre-authentication options. An adversary withGenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline passwordcracking attacks such as AS-REP roasting.

NAME = "Kerberos Pre-authentication Disabled for User"

QUERY = '''event.code:4738 and winlog.api:"wineventlog" and message:"'Don't Require Preauth' - Enabled'''


<li><a href="#">DESCRIPTION = Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API(DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.

NAME = "Creation or Modification of Domain Backup DPAPI private key"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" and file.name : ("ntds_capi_*.pfx", "ntds_capi_*.pvk")'''


<li><a href="#">DESCRIPTION = "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool."from =

NAME = "Credential Acquisition via Registry Hive Dumping"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (?process.pe.original_file_name == "reg.exe" or process.name : "reg.exe") and process.args : ("save", "export") and process.args : ("hklm\\sam", "hklm\\security")'''


<li><a href="#">DESCRIPTION = Identifies the enable of the full user-mode dumps feature system-wide. This feature allows Windows Error Reporting (WER)to collect data after an application crashes. This setting is a requirement for the LSASS Shtinkering attack, whichfakes the communication of a crash on LSASS, generating a dump of the process memory, which gives the attacker access tothe credentials present on the system without having to bring malware to the system. This setting is not enabled bydefault, and applications must create their registry subkeys to hold settings that enable them to collect dumps.

NAME = "Full User-Mode Dumps Enabled System-Wide"

QUERY = '''registry where host.os.type == "windows" andregistry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\LocalDumps\\DumpType","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\LocalDumps\\DumpType") andregistry.data.strings : ("2", "0x00000002") andnot (process.executable : "?:\\Windows\\system32\\svchost.exe" and user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20"))'''


<li><a href="#">DESCRIPTION = Identifies the Internet Information Services (IIS) command-line tool, AppCmd, being used to list passwords. An attackerwith IIS web server access via a web shell can decrypt and dump the IIS AppPool service account password using AppCmd.

NAME = "Microsoft IIS Service Account Password Dumped"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : "appcmd.exe" or ?process.pe.original_file_name == "appcmd.exe") and process.args : "/list" and process.args : "/text*password'''


<li><a href="#">DESCRIPTION = Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web serveraccess via a webshell or alike can decrypt and dump any hardcoded connection strings, such as the MSSQL service accountpassword using aspnet_regiis command.

NAME = "Microsoft IIS Connection Strings Decryption"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "aspnet_regiis.exe" or ?process.pe.original_file_name == "aspnet_regiis.exe") andprocess.args : "connectionStrings" and process.args : "-pdf'''


<li><a href="#">DESCRIPTION = Identifies network connections to the standard Kerberos port from an unusual process. On Windows, the only process thatnormally performs Kerberos traffic from a domain joined host is lsass.exe.

NAME = "Kerberos Traffic from Unusual Process"

QUERY = '''network where host.os.type == "windows" and event.type == "start" and network.direction == "egress" anddestination.port == 88 and source.port >= 49152 and process.pid != 4 and destination.address : "*" andnot (process.executable : ("\\device\\harddiskvolume?\\program files (x86)\\nmap\\nmap.exe","\\device\\harddiskvolume?\\program files (x86)\\nmap oem\\nmap.exe","\\device\\harddiskvolume?\\windows\\system32\\lsass.exe","?:\\Program Files\\Amazon Corretto\\jdk1*\\bin\\java.exe","?:\\Program Files\\BlackBerry\\UEM\\Proxy Server\\bin\\prunsrv.exe","?:\\Program Files\\BlackBerry\\UEM\\Core\\tomcat-core\\bin\\tomcat9.exe","?:\\Program Files\\DBeaver\\dbeaver.exe","?:\\Program Files\\Docker\\Docker\\resources\\com.docker.backend.exe","?:\\Program Files\\Docker\\Docker\\resources\\com.docker.vpnkit.exe","?:\\Program Files\\Docker\\Docker\\resources\\vpnkit.exe","?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe","?:\\Program Files\\Internet Explorer\\iexplore.exe","?:\\Program Files\\JetBrains\\PyCharm Community Edition*\\bin\\pycharm64.exe","?:\\Program Files\\Mozilla Firefox\\firefox.exe","?:\\Program Files\\Oracle\\VirtualBox\\VirtualBoxVM.exe","?:\\Program Files\\Puppet Labs\\Puppet\\puppet\\bin\\ruby.exe","?:\\Program Files\\rapid7\\nexpose\\nse\\.DLLCACHE\\nseserv.exe","?:\\Program Files\\Silverfort\\Silverfort AD Adapter\\SilverfortServer.exe","?:\\Program Files\\Tenable\\Nessus\\nessusd.exe","?:\\Program Files\\VMware\\VMware View\\Server\\bin\\ws_TomcatService.exe","?:\\Program Files (x86)\\Advanced Port Scanner\\advanced_port_scanner.exe","?:\\Program Files (x86)\\DesktopCentral_Agent\\bin\\dcpatchscan.exe","?:\\Program Files (x86)\\GFI\\LanGuard 12 Agent\\lnsscomm.exe","?:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe","?:\\Program Files (x86)\\Internet Explorer\\iexplore.exe","?:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe","?:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe","?:\\Program Files (x86)\\Microsoft Silverlight\\sllauncher.exe","?:\\Program Files (x86)\\Nmap\\nmap.exe","?:\\Program Files (x86)\\Nmap OEM\\nmap.exe","?:\\Program Files (x86)\\nwps\\NetScanTools Pro\\NSTPRO.exe","?:\\Program Files (x86)\\SAP BusinessObjects\\tomcat\\bin\\tomcat9.exe","?:\\Program Files (x86)\\SuperScan\\scanner.exe","?:\\Program Files (x86)\\Zscaler\\ZSATunnel\\ZSATunnel.exe","?:\\Windows\\System32\\lsass.exe","?:\\Windows\\System32\\MicrosoftEdgeCP.exe","?:\\Windows\\System32\\svchost.exe","?:\\Windows\\SysWOW64\\vmnat.exe","?:\\Windows\\SystemApps\\Microsoft.MicrosoftEdge_*\\MicrosoftEdge.exe","System") and process.code_signature.trusted == true) and destination.address != "127.0.0.1" and destination.address != "::1'''


<li><a href="#">DESCRIPTION = Identifies the creation of .kirbi files. The creation of this kind of file is an indicator of an attacker runningKerberos ticket dump utilities, such as Mimikatz, and precedes attacks such as Pass-The-Ticket (PTT), which allows theattacker to impersonate users using Kerberos tickets.

NAME = "Kirbi File Creation"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" and file.extension : "kirbi'''


<li><a href="#">DESCRIPTION = Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such asunixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.

NAME = "Access to a Sensitive LDAP Attribute"

QUERY = '''any where event.action == "Directory Service Access" and event.code == "4662" andnot winlog.event_data.SubjectUserSid : "S-1-5-18" andwinlog.event_data.Properties : ( /* unixUserPassword */"*612cb747-c0e8-4f92-9221-fdd5f15b550d*",/* ms-PKI-AccountCredentials */"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*",/*ms-PKI-DPAPIMasterKeys */"*b3f93023-9239-4f7c-b99c-6745d87adbc2*",/* msPKI-CredentialRoamingTokens */"*b7ff5a38-0818-42b0-8110-d3d154c97f24*") and/* Excluding noisy AccessMasks 0x0 undefined and 0x100 Control Access https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662 */not winlog.event_data.AccessMask in ("0x0", "0x100")'''


<li><a href="#">DESCRIPTION = Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious accessrights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service inpreparation for credential access.

NAME = "Suspicious LSASS Access via MalSecLogon"

QUERY = '''process where host.os.type == "windows" and event.code == "10" andwinlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe" and /* seclogon service accessing lsass */winlog.event_data.CallTrace : "*seclogon.dll*" and process.name : "svchost.exe" and /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */winlog.event_data.GrantedAccess == "0x14c0'''


<li><a href="#">DESCRIPTION = Identifies LSASS loading an unsigned or untrusted DLL. Windows Security Support Provider (SSP) DLLs are loaded intoLSSAS process at system start. Once loaded into the LSA, SSP DLLs have access to encrypted and plaintext passwords thatare stored in Windows, such as any logged-on user's Domain password or smart card PINs.

NAME = "Suspicious Module Loaded by LSASS"

QUERY = '''library where host.os.type == "windows" and process.executable : "?:\\Windows\\System32\\lsass.exe" andnot (dll.code_signature.subject_name : ("Microsoft Windows","Microsoft Corporation","Microsoft Windows Publisher","Microsoft Windows Software Compatibility Publisher","Microsoft Windows Hardware Compatibility Publisher","McAfee, Inc.","SecMaker AB","HID Global Corporation","HID Global","Apple Inc.","Citrix Systems, Inc.","Dell Inc","Hewlett-Packard Company","Symantec Corporation","National Instruments Corporation","DigitalPersona, Inc.","Novell, Inc.","gemalto","EasyAntiCheat Oy","Entrust Datacard Corporation","AuriStor, Inc.","LogMeIn, Inc.","VMware, Inc.","Istituto Poligrafico e Zecca dello Stato S.p.A.","Nubeva Technologies Ltd","Micro Focus (US), Inc.","Yubico AB","GEMALTO SA","Secure Endpoints, Inc.","Sophos Ltd","Morphisec Information Security 2014 Ltd","Entrust, Inc.","Nubeva Technologies Ltd","Micro Focus (US), Inc.","F5 Networks Inc","Bit4id","Thales DIS CPL USA, Inc.","Micro Focus International plc","HYPR Corp","Intel(R) Software Development Products","PGP Corporation","Parallels International GmbH","FrontRange Solutions Deutschland GmbH","SecureLink, Inc.","Tidexa OU","Amazon Web Services, Inc.","SentryBay Limited","Audinate Pty Ltd","CyberArk Software Ltd.","McAfeeSysPrep","NVIDIA Corporation PE Sign v2016","Trend Micro, Inc.","Fortinet Technologies (Canada) Inc.","Carbon Black, Inc.") and dll.code_signature.status : ("trusted", "errorExpired", "errorCode_endpoint*", "errorChaining")) and not dll.hash.sha256 :("811a03a5d7c03802676d2613d741be690b3461022ea925eb6b2651a5be740a4c", "1181542d9cfd63fb00c76242567446513e6773ea37db6211545629ba2ecf26a1", "ed6e735aa6233ed262f50f67585949712f1622751035db256811b4088c214ce3", "26be2e4383728eebe191c0ab19706188f0e9592add2e0bf86b37442083ae5e12", "9367e78b84ef30cf38ab27776605f2645e52e3f6e93369c674972b668a444faa", "d46cc934765c5ecd53867070f540e8d6f7701e834831c51c2b0552aba871921b", "0f77a3826d7a5cd0533990be0269d951a88a5c277bc47cff94553330b715ec61", "4aca034d3d85a9e9127b5d7a10882c2ef4c3e0daa3329ae2ac1d0797398695fb", "86031e69914d9d33c34c2f4ac4ae523cef855254d411f88ac26684265c981d95")'''


<li><a href="#">DESCRIPTION = Identifies the creation of a Local Security Authority Subsystem Service (lsass.exe) default memory dump. This mayindicate a credential access attempt via trusted system utilities such as Task Manager (taskmgr.exe) and SQL Dumper(sqldumper.exe) or known pentesting tools such as Dumpert and AndrewSpecial.

NAME = "LSASS Memory Dump Creation"

QUERY = '''file where host.os.type == "windows" and event.action != "deletion" andfile.name : ("lsass*.dmp", "dumpert.dmp", "Andrew.dmp", "SQLDmpr*.mdmp", "Coredump.dmp") andnot (process.executable : ("?:\\Program Files\\Microsoft SQL Server\\*\\Shared\\SqlDumper.exe","?:\\Windows\\System32\\dllhost.exe") andfile.path : ("?:\\*\\Reporting Services\\Logfiles\\SQLDmpr*.mdmp","?:\\Program Files\\Microsoft SQL Server\\*\\Shared\\ErrorDumps\\SQLDmpr*.mdmp","?:\\Program Files\\Microsoft SQL Server\\*\\MSSQL\\LOG\\SQLDmpr*.mdmp")) andnot (process.executable : "?:\\Windows\\system32\\WerFault.exe" andfile.path : ("?:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\CrashDumps\\lsass.exe.*.dmp","?:\\Windows\\System32\\%LOCALAPPDATA%\\CrashDumps\\lsass.exe.*.dmp"))'''


<li><a href="#">DESCRIPTION = Identifies handle requests for the Local Security Authority Subsystem Service (LSASS) object access with specific accessmasks that many tools with a capability to dump memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is toolagnostic as it has been validated against a host of various LSASS dump tools such as SharpDump, Procdump, Mimikatz,Comsvcs etc. It detects this behavior at a low level and does not depend on a specific tool or dump file name.

NAME = "LSASS Memory Dump Handle Access"

QUERY = '''any where event.action == "File System" and event.code == "4656" andwinlog.event_data.ObjectName : ("?:\\Windows\\System32\\lsass.exe","\\Device\\HarddiskVolume?\\Windows\\System32\\lsass.exe","\\Device\\HarddiskVolume??\\Windows\\System32\\lsass.exe") and/* The right to perform an operation controlled by an extended access right. */(winlog.event_data.AccessMask : ("0x1fffff" , "0x1010", "0x120089", "0x1F3FFF") or winlog.event_data.AccessMaskDescription : ("READ_CONTROL", "Read from process memory")) /* Common Noisy False Positives */and not winlog.event_data.ProcessName : ("?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\system32\\wbem\\WmiPrvSE.exe","?:\\Windows\\System32\\dllhost.exe","?:\\Windows\\System32\\svchost.exe","?:\\Windows\\System32\\msiexec.exe","?:\\ProgramData\\Microsoft\\Windows Defender\\*.exe","?:\\Windows\\explorer.exe","?:\\Windows\\System32\\poqexec.exe")'''


<li><a href="#">DESCRIPTION = Identifies access attempts to the LSASS handle, which may indicate an attempt to dump credentials from LSASS memory.

NAME = "LSASS Process Access via Windows API"

QUERY = '''api where host.os.type == "windows" and process.Ext.api.name in ("OpenProcess", "OpenThread") and Target.process.name : "lsass.exe" and not (process.executable : ("?:\\ProgramData\\GetSupportService*\\Updates\\Update_*.exe","?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe","?:\\Program Files (x86)\\Asiainfo Security\\OfficeScan Client\\NTRTScan.exe","?:\\Program Files (x86)\\Blackpoint\\SnapAgent\\SnapAgent.exe","?:\\Program Files (x86)\\eScan\\reload.exe","?:\\Program Files (x86)\\Google\\Update\\GoogleUpdate.exe","?:\\Program Files (x86)\\Kaspersky Lab\\*\\avp.exe","?:\\Program Files (x86)\\N-able Technologies\\Reactive\\bin\\NableReactiveManagement.exe","?:\\Program Files (x86)\\N-able Technologies\\Windows Agent\\bin\\agent.exe","?:\\Program Files (x86)\\Trend Micro\\*\\CCSF\\TmCCSF.exe","?:\\Program Files*\\Windows Defender\\MsMpEng.exe","?:\\Program Files\\Bitdefender\\Endpoint Security\\EPSecurityService.exe","?:\\Program Files\\Cisco\\AMP\\*\\sfc.exe","?:\\Program Files\\Common Files\\McAfee\\AVSolution\\mcshield.exe","?:\\Program Files\\EA\\AC\\EAAntiCheat.GameService.exe","?:\\Program Files\\Elastic\\Agent\\data\\elastic-agent-*\\components\\metricbeat.exe","?:\\Program Files\\Elastic\\Agent\\data\\elastic-agent-*\\components\\osqueryd.exe","?:\\Program Files\\Elastic\\Agent\\data\\elastic-agent-*\\components\\packetbeat.exe","?:\\Program Files\\ESET\\ESET Security\\ekrn.exe","?:\\Program Files\\Fortinet\\FortiClient\\FortiProxy.exe","?:\\Program Files\\Huntress\\HuntressAgent.exe","?:\\Program Files\\LogicMonitor\\Agent\\bin\\sbshutdown.exe","?:\\Program Files\\Microsoft Security Client\\MsMpEng.exe","?:\\Program Files\\Qualys\\QualysAgent\\QualysAgent.exe","?:\\Program Files\\TDAgent\\ossec-agent\\ossec-agent.exe","?:\\Program Files\\Topaz OFD\\Warsaw\\core.exe","?:\\Program Files\\VMware\\VMware Tools\\vmtoolsd.exe","?:\\Windows\\AdminArsenal\\PDQDeployRunner\\*\\exec\\Sysmon64.exe","?:\\Windows\\Sysmon.exe","?:\\Windows\\Sysmon64.exe","?:\\Windows\\System32\\csrss.exe","?:\\Windows\\System32\\MRT.exe","?:\\Windows\\System32\\msiexec.exe","?:\\Windows\\System32\\RtkAudUService64.exe","?:\\Windows\\System32\\wbem\\WmiPrvSE.exe","?:\\Windows\\SysWOW64\\wbem\\WmiPrvSE.exe") and process.code_signature.trusted == true)'''


<li><a href="#">DESCRIPTION = "Identifies the password log file from the default Mimikatz memssp module."from =

NAME = "Mimikatz Memssp Log File Detected"

QUERY = '''file where host.os.type == "windows" and file.name : "mimilsa.log" and process.name : "lsass.exe'''


<li><a href="#">DESCRIPTION = Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with manyother features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShellscript and alike.

NAME = "Potential Invoke-Mimikatz PowerShell Script"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text:((DumpCreds andDumpCerts) or"sekurlsa::logonpasswords" or("crypto::certificates" and"CERT_SYSTEM_STORE_LOCAL_MACHINE"))'''


<li><a href="#">DESCRIPTION = Identifies attempts to modify the WDigest security provider in the registry to force the user's password to be stored inclear text in memory. This behavior can be indicative of an adversary attempting to weaken the security configuration ofan endpoint. Once the UseLogonCredential value is modified, the adversary may attempt to dump clear text passwords frommemory.

NAME = "Modification of WDigest Security Provider"

QUERY = '''registry where host.os.type == "windows" and event.type : ("creation", "change") andregistry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredential","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredential") and registry.data.strings : ("1", "0x00000001") andnot (process.executable : "?:\\Windows\\System32\\svchost.exe" and user.id : "S-1-5-18")'''


<li><a href="#">DESCRIPTION = Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, whichmay indicate an exfiltration attempt of a previously dumped Security Account Manager (SAM) registry hive for credentialextraction on an attacker-controlled system.

NAME = "Windows Registry File Creation in SMB Share"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" and /* regf file header */ file.Ext.header_bytes : "72656766*" and file.size >= 30000 and process.pid == 4 and user.id : ("S-1-5-21*", "S-1-12-1-*") and not file.path : ("?:\\*\\UPM_Profile\\NTUSER.DAT","?:\\*\\UPM_Profile\\NTUSER.DAT.LASTGOOD.LOAD","?:\\Windows\\Netwrix\\Temp\\????????.???.offreg","?:\\*\\AppData\\Local\\Packages\\Microsoft.*\\Settings\\settings.dat*" )'''


<li><a href="#">DESCRIPTION = Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logonprovider module for persistence and/or credential access via intercepting the authentication credentials in clear textduring user logon.

NAME = "Network Logon Provider Registry Modification"

QUERY = '''registry where host.os.type == "windows" and registry.data.strings : "?*" andregistry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\NetworkProvider\\ProviderPath","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\NetworkProvider\\ProviderPath") and/* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */not (user.id : "S-1-5-18" andregistry.data.strings : ("%SystemRoot%\\System32\\ntlanman.dll","%SystemRoot%\\System32\\drprov.dll","%SystemRoot%\\System32\\davclnt.dll","%SystemRoot%\\System32\\vmhgfs.dll","?:\\Program Files (x86)\\Citrix\\ICA Client\\x64\\pnsson.dll","?:\\Program Files\\Dell\\SARemediation\\agent\\DellMgmtNP.dll","?:\\Program Files (x86)\\CheckPoint\\Endpoint Connect\\\\epcgina.dll"))'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that contain the default exported functions used on Invoke-NinjaCopy. Attackers can useInvoke-NinjaCopy to read SYSTEM files that are normally locked, such as the NTDS.dit file or registry hives.

NAME = "PowerShell Invoke-NinjaCopy script"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ("StealthReadFile" or"StealthReadFileAddr" or"StealthCloseFileDelegate" or"StealthOpenFile" or"StealthCloseFile" or"StealthReadFile" or"Invoke-NinjaCopy" )and not user.id : "S-1-5-18"and not powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint" and "PowerSploitIndicators")'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that have the capability of dumping Kerberos tickets from LSA, which potentially indicates anattacker's attempt to acquire credentials for lateral movement.

NAME = "PowerShell Kerberos Ticket Dump"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ("LsaCallAuthenticationPackage" and("KerbRetrieveEncodedTicketMessage" or"KerbQueryTicketCacheMessage" or"KerbQueryTicketCacheExMessage" or"KerbQueryTicketCacheEx2Message" or"KerbRetrieveTicketMessage" or"KerbDecryptDataMessage"))'''


<li><a href="#">DESCRIPTION = This rule detects PowerShell scripts capable of dumping process memory using WindowsErrorReporting or Dbghelp.dllMiniDumpWriteDump. Attackers can use this tooling to dump LSASS and get access to credentials.

NAME = "PowerShell MiniDump Script"

QUERY = '''event.category:process and host.os.type:windows and powershell.file.script_block_text:(MiniDumpWriteDump or MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step inKerberoasting toolkits to crack service accounts.

NAME = "PowerShell Kerberos Ticket Request"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : (KerberosRequestorSecurityToken) and not user.id : ("S-1-5-18" or "S-1-5-20") andnot powershell.file.script_block_text : (("sentinelbreakpoints" and ("Set-PSBreakpoint" or "Set-HookFunctionTabs")) or("function global" and "\\windows\\sentinel\\4"))'''


<li><a href="#">DESCRIPTION = Identifies suspicious access to an LSASS handle via DuplicateHandle from an unknown call trace module. This may indicatean attempt to bypass the NtOpenProcess API to evade detection and dump LSASS memory for credential access.

NAME = "Potential Credential Access via DuplicateHandle in LSASS"

QUERY = '''process where host.os.type == "windows" and event.code == "10" and /* LSASS requesting DuplicateHandle access right to another process */ process.name : "lsass.exe" and winlog.event_data.GrantedAccess == "0x40" and /* call is coming from an unknown executable region */ winlog.event_data.CallTrace : "*UNKNOWN*'''


<li><a href="#">DESCRIPTION = Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target.An adversary may use this primitive in combination with other techniques to elevate privileges on a compromised system.

NAME = "Potential Local NTLM Relay via HTTP"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "rundll32.exe" and/* Rundll32 WbeDav Client*/process.args : ("?:\\Windows\\System32\\davclnt.dll,DavSetCookie", "?:\\Windows\\SysWOW64\\davclnt.dll,DavSetCookie") and/* Access to named pipe via http */process.args : ("http*/print/pipe/*", "http*/pipe/spoolss", "http*/pipe/srvsvc")'''


<li><a href="#">DESCRIPTION = Identifies remote access to the registry to potentially dump credential data from the Security Account Manager (SAM)registry hive in preparation for credential access and privileges elevation.

NAME = "Potential Remote Credential Access via Registry"

QUERY = '''file where host.os.type == "windows" andevent.action == "creation" and process.name : "svchost.exe" andfile.Ext.header_bytes : "72656766*" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and file.size >= 30000 andfile.path : ("?:\\Windows\\system32\\*.tmp", "?:\\WINDOWS\\Temp\\*.tmp")'''


<li><a href="#">DESCRIPTION = Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connectedapplications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager forsaved usernames and passwords. This may also be performed in preparation of lateral movement.

NAME = "Multiple Vault Web Credentials Read"

QUERY = '''sequence by winlog.computer_name, winlog.process.pid with maxspan=1s /* 2 consecutive vault reads from same pid for web creds */ [any where event.code : "5382" and(winlog.event_data.SchemaFriendlyName : "Windows Web Password Credential" and winlog.event_data.Resource : "http*") andnot winlog.event_data.SubjectLogonId : "0x3e7" and not winlog.event_data.Resource : "http://localhost/"] [any where event.code : "5382" and(winlog.event_data.SchemaFriendlyName : "Windows Web Password Credential" and winlog.event_data.Resource : "http*") andnot winlog.event_data.SubjectLogonId : "0x3e7" and not winlog.event_data.Resource : "http://localhost/"]'''


<li><a href="#">DESCRIPTION = Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connectedapplications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager forsaved usernames and passwords. This may also be performed in preparation of lateral movement.

NAME = "Searching for Saved Credentials via VaultCmd"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(?process.pe.original_file_name:"vaultcmd.exe" or process.name:"vaultcmd.exe") andprocess.args:"/list*'''


<li><a href="#">DESCRIPTION = Identifies the assignment of the SeEnableDelegationPrivilege sensitive "user right" to a user. TheSeEnableDelegationPrivilege "user right" enables computer and user accounts to be trusted for delegation. Attackers canabuse this right to compromise Active Directory accounts and elevate their privileges.

NAME = "Sensitive Privilege SeEnableDelegationPrivilege assigned to a User"

QUERY = '''event.action:"Authorization Policy Change" and event.code:4704 andwinlog.event_data.PrivilegeList:"SeEnableDelegationPrivilege'''


<li><a href="#">DESCRIPTION = Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object.Attackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtainpersistent and stealthy access to the target user or computer object.

NAME = "Potential Shadow Credentials added to AD Object"

QUERY = '''event.action:"Directory Service Changes" and event.code:"5136" and winlog.event_data.AttributeLDAPDisplayName:"msDS-KeyCredentialLink" and winlog.event_data.AttributeValue :B\:828* and not winlog.event_data.SubjectUserName: MSOL_*'''


<li><a href="#">DESCRIPTION = Detects when a user account has the servicePrincipalName attribute modified. Attackers can abuse write privileges over auser to configure Service Principle Names (SPNs) so that they can perform Kerberoasting. Administrators can alsoconfigure this for legitimate purposes, exposing the account to Kerberoasting.

NAME = "User account exposed to Kerberoasting"

QUERY = '''event.action:"Directory Service Changes" and event.code:5136 andwinlog.event_data.OperationType:"%%14674" andwinlog.event_data.ObjectClass:"user" andwinlog.event_data.AttributeLDAPDisplayName:"servicePrincipalName'''


<li><a href="#">DESCRIPTION = Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump aprocess memory. This may indicate an attempt to dump LSASS memory while bypassing command-line based detection inpreparation for credential access.

NAME = "Potential Credential Access via Renamed COM+ Services DLL"

QUERY = '''sequence by process.entity_id with maxspan=1m [process where host.os.type == "windows" and event.category == "process" andprocess.name : "rundll32.exe"] [process where host.os.type == "windows" and event.category == "process" and event.dataset : "windows.sysmon_operational" and event.code == "7" and (file.pe.original_file_name : "COMSVCS.DLL" or file.pe.imphash : "EADBCCBB324829ACB5F2BBE87E5549A8") and/* renamed COMSVCS */not file.name : "COMSVCS.DLL"]'''


<li><a href="#">DESCRIPTION = Identifies access attempts to LSASS handle, this may indicate an attempt to dump credentials from Lsass memory.

NAME = "Suspicious Lsass Process Access"

QUERY = '''process where host.os.type == "windows" and event.code == "10" andwinlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe" andnot winlog.event_data.GrantedAccess :("0x1000", "0x1400", "0x101400", "0x101000", "0x101001", "0x100000", "0x100040", "0x3200", "0x40", "0x3200") andnot process.name : ("procexp64.exe", "procmon.exe", "procexp.exe", "Microsoft.Identity.AadConnect.Health.AadSync.Host.ex") andnot process.executable : ("?:\\ProgramData\\Microsoft\\Windows Defender\\platform\\*","?:\\ProgramData\\WebEx\\webex\\*","?:\\Program Files (x86)\\*","?:\\Program Files\\*","?:\\Windows\\CCM\\CcmExec.exe","?:\\Windows\\LTSvc\\LTSVC.exe","?:\\Windows\\Sysmon.exe","?:\\Windows\\Sysmon64.exe","?:\\Windows\\system32\\csrss.exe","?:\\Windows\\System32\\lsm.exe","?:\\Windows\\system32\\MRT.exe","?:\\Windows\\System32\\msiexec.exe","?:\\Windows\\system32\\wbem\\wmiprvse.exe","?:\\Windows\\system32\\wininit.exe","?:\\Windows\\SystemTemp\\GUM*.tmp\\GoogleUpdate.exe","?:\\Windows\\sysWOW64\\wbem\\wmiprvse.exe") andnot winlog.event_data.CallTrace : ("*mpengine.dll*", "*appresolver.dll*", "*sysmain.dll*")'''


<li><a href="#">DESCRIPTION = Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both exportthe MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access.

NAME = "Potential Credential Access via LSASS Memory Dump"

QUERY = '''process where host.os.type == "windows" and event.code == "10" andwinlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe" and /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/winlog.event_data.CallTrace : ("*dbghelp*", "*dbgcore*") and /* case of lsass crashing */not process.executable : ("?:\\Windows\\System32\\WerFault.exe","?:\\Windows\\SysWOW64\\WerFault.exe","?:\\Windows\\System32\\WerFaultSecure.exe")'''


<li><a href="#">DESCRIPTION = Identifies suspicious access to an LSASS handle via PssCaptureSnapShot where two successive process accesses areperformed by the same process and target two different instances of LSASS. This may indicate an attempt to evadedetection and dump LSASS memory for credential access.

NAME = "Potential LSASS Memory Dump via PssCaptureSnapShot"

QUERY = '''event.category:process and host.os.type:windows and event.code:10 and winlog.event_data.TargetImage:("C:\\Windows\\system32\\lsass.exe" or "c:\\Windows\\system32\\lsass.exe" or "c:\\Windows\\System32\\lsass.exe")'''


<li><a href="#">DESCRIPTION = Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate anattempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation forcredential access and privileges elevation.

NAME = "Suspicious Remote Registry Access via SeBackupPrivilege"

QUERY = '''sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m [iam where event.action == "logged-in-special"andwinlog.event_data.PrivilegeList : "SeBackupPrivilege" and/* excluding accounts with existing privileged access */not winlog.event_data.PrivilegeList : "SeDebugPrivilege"] [any where event.action == "Detailed File Share" and winlog.event_data.RelativeTargetName : "winreg"]'''


<li><a href="#">DESCRIPTION = Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadowcopy, including sensitive files such as ntds.dit, System Boot Key and browser offline credentials.

NAME = "Symbolic Link to Shadow Copy Created"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and ((?process.pe.original_file_name in ("Cmd.Exe","PowerShell.EXE")) or(process.name : ("cmd.exe", "powershell.exe")) ) and /* Create Symbolic Link to Shadow Copies */ process.args : ("*mklink*", "*SymbolicLink*") and process.command_line : ("*HarddiskVolumeShadowCopy*")'''


<li><a href="#">DESCRIPTION = Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASSprocess instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.

NAME = "Potential LSASS Clone Creation via PssCaptureSnapShot"

QUERY = '''process where host.os.type == "windows" and event.code:"4688" andprocess.executable : "?:\\Windows\\System32\\lsass.exe" andprocess.parent.executable : "?:\\Windows\\System32\\lsass.exe'''


<li><a href="#">DESCRIPTION = "Identifies attempts to dump Wireless saved access keys in clear text using the Windows built-in utility Netsh."from =

NAME = "Wireless Credential Dumping using Netsh Command"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : "netsh.exe" or ?process.pe.original_file_name == "netsh.exe") andprocess.args : "wlan" and process.args : "key*clear'''


<li><a href="#">DESCRIPTION = "Adversaries can add the 'hidden' attribute to files to hide them from the user in an attempt to evade detection."from =

NAME = "Adding Hidden File Attribute via Attrib"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "attrib.exe" or ?process.pe.original_file_name == "ATTRIB.EXE") and process.args : "+h" andnot (process.parent.name: "cmd.exe" and process.command_line: "attrib+R +H +S +A *.cui")'''


<li><a href="#">DESCRIPTION = Detects events that have a mismatch on the expected event agent ID. The status "agent_id_mismatch"occurs when the expected agent ID associated with the API key does not match the actual agent ID in an event. This couldindicate attempts to spoof events in order to masquerade actual activity to evade detection.

NAME = "Agent Spoofing - Mismatched Agent ID"

QUERY = '''event.agent_id_status:agent_id_mismatch'''


<li><a href="#">DESCRIPTION = Detects when multiple hosts are using the same agent ID. This could occur in the event of an agentbeing taken over and used to inject illegitimate documents into an instance as an attempt to spoof events in order tomasquerade actual activity to evade detection.

NAME = "Agent Spoofing - Multiple Hosts Using Same Agent"

QUERY = '''event.agent_id_status:*'''


<li><a href="#">DESCRIPTION = Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate anattempt to bypass AMSI by loading a rogue AMSI module instead of the legit one.

NAME = "Suspicious Antimalware Scan Interface DLL"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" and file.path != null and file.name : ("amsi.dll", "amsi") and not file.path : ("?:\\Windows\\system32\\amsi.dll", "?:\\Windows\\Syswow64\\amsi.dll", "?:\\$WINDOWS.~BT\\NewOS\\Windows\\WinSXS\\*", "?:\\$WINDOWS.~BT\\NewOS\\Windows\\servicing\\LCU\\*", "?:\\$WINDOWS.~BT\\Work\\*\\*", "?:\\Windows\\SoftwareDistribution\\Download\\*")'''


<li><a href="#">DESCRIPTION = Identifies the execution of PowerShell script with keywords related to different Antimalware Scan Interface (AMSI)bypasses. An adversary may attempt first to disable AMSI before executing further malicious powershell scripts to evadedetection.

NAME = "Potential Antimalware Scan Interface Bypass via PowerShell"

QUERY = '''event.category:"process" and host.os.type:windows and(powershell.file.script_block_text : ("System.Management.Automation.AmsiUtils" or			amsiInitFailed or 			"Invoke-AmsiBypass" or 			"Bypass.AMSI" or 			"amsi.dll" or 			AntimalwareProvideror 			amsiSession or 			amsiContext or			AmsiInitialize or 			unloadobfuscated or 			unloadsilent or 			AmsiX64 or 			AmsiX32 or 			FindAmsiFun) orpowershell.file.script_block_text:("[System.Runtime.InteropServices.Marshal]::Copy" and "VirtualProtect") orpowershell.file.script_block_text:("[Ref].Assembly.GetType(('System.Management.Automation" and ".SetValue(")) andnot powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint")'''


<li><a href="#">DESCRIPTION = Identifies modifications of the AmsiEnable registry key to 0, which disables the Antimalware Scan Interface (AMSI). Anadversary can modify this key to disable AMSI protections.

NAME = "Modification of AmsiEnable Registry Key"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") andregistry.path : ("HKEY_USERS\\*\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable","HKU\\*\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable") andregistry.data.strings: ("0", "0x00000000")'''


<li><a href="#">DESCRIPTION = Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromisedaccount to conceal the actions undertaken during an intrusion.

NAME = "Clearing Windows Console History"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or ?process.pe.original_file_name == "PowerShell.EXE") and (process.args : "*Clear-History*" or (process.args : ("*Remove-Item*", "rm") and process.args : ("*ConsoleHost_history.txt*", "*(Get-PSReadlineOption).HistorySavePath*")) or (process.args : "*Set-PSReadlineOption*" and process.args : "*SaveNothing*"))'''


<li><a href="#">DESCRIPTION = Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done byattackers in an attempt to evade detection or destroy forensic evidence on a system.

NAME = "Clearing Windows Event Logs"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(((process.name : "wevtutil.exe" or ?process.pe.original_file_name == "wevtutil.exe") andprocess.args : ("/e:false", "cl", "clear-log")) or(process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") andprocess.args : "Clear-EventLog"))'''


<li><a href="#">DESCRIPTION = Identifies attempts to clear Windows event log stores. This is often done by attackers in an attempt to evade detectionor destroy forensic evidence on a system.

NAME = "Windows Event Logs Cleared"

QUERY = '''event.action:("audit-log-cleared" or "Log clear") and winlog.api:"wineventlog" andnot winlog.provider_name:"AD FS Auditing'''


<li><a href="#">DESCRIPTION = Identifies attempts to disable/modify the code signing policy through system native utilities. Code signing provides authenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By allowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code. from =

NAME = "Code Signing Policy Modification Through Built-in tools"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name: "bcdedit.exe" or ?process.pe.original_file_name == "bcdedit.exe") and process.args: ("-set", "/set") and process.args: ("TESTSIGNING", "nointegritychecks", "loadoptions", "DISABLE_INTEGRITY_CHECKS")'''


<li><a href="#">DESCRIPTION = Identifies attempts to disable the code signing policy through the registry. Code signing provides authenticity on aprogram, and grants the user with the ability to check whether the program has been tampered with. By allowing theexecution of unsigned or self-signed code, threat actors can craft and execute malicious code. from =

NAME = "Code Signing Policy Modification Through Registry"

QUERY = '''registry where host.os.type == "windows" and event.type : ("creation", "change") and(registry.path : ("HKEY_USERS\\*\\Software\\Policies\\Microsoft\\Windows NT\\Driver Signing\\BehaviorOnFailedVerify","HKU\\*\\Software\\Policies\\Microsoft\\Windows NT\\Driver Signing\\BehaviorOnFailedVerify","\\REGISTRY\\USER\\*\\Software\\Policies\\Microsoft\\Windows NT\\Driver Signing\\BehaviorOnFailedVerify") andregistry.value: "BehaviorOnFailedVerify" andregistry.data.strings : ("0", "0x00000000", "1", "0x00000001"))'''


<li><a href="#">DESCRIPTION = Identifies the creation or modification of a local trusted root certificate in Windows. The install of a malicious rootcertificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity(for example, Microsoft). It could also allow an attacker to decrypt SSL traffic.

NAME = "Creation or Modification of Root Certificate"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") andregistry.path :("HKLM\\Software\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob","HKLM\\Software\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob","HKLM\\Software\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob","HKLM\\Software\\Policies\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob","\\REGISTRY\\MACHINE\\Software\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob","\\REGISTRY\\MACHINE\\Software\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob","\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blob","\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Blob") andnot process.executable : ("?:\\ProgramData\\Lenovo\\Vantage\\Addins\\LenovoHardwareScanAddin\\*\\LdeApi.Server.exe","?:\\ProgramData\\Logishrd\\LogiOptionsPlus\\Plugins\\64\\certmgr.exe","?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe","?:\\ProgramData\\Quest\\KACE\\modules\\clientidentifier\\clientidentifier.exe","?:\\Program Files (x86)\\*.exe","?:\\Program Files\\*.exe","?:\\Windows\\CCM\\CcmExec.exe","?:\\Windows\\ccmsetup\\cache\\ccmsetup.exe","?:\\Windows\\Cluster\\clussvc.exe","?:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe","?:\\Windows\\Lenovo\\ImController\\PluginHost86\\Lenovo.Modern.ImController.PluginHost.Device.exe","?:\\Windows\\Lenovo\\ImController\\Service\\Lenovo.Modern.ImController.exe","?:\\Windows\\Sysmon.exe","?:\\Windows\\Sysmon64.exe","?:\\Windows\\System32\\*.exe","?:\\Windows\\SysWOW64\\*.exe","?:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe","?:\\Windows\\WinSxS\\*.exe")'''


<li><a href="#">DESCRIPTION = A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC)certificates. An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign amalicious executable, making it appear the file was from a trusted, legitimate source.

NAME = "Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall)"

QUERY = '''event.provider:"Microsoft-Windows-Audit-CVE" and message:"[CVE-2020-0601]" and host.os.type:windows'''


<li><a href="#">DESCRIPTION = Identifies modifications to the Windows Defender registry settings to disable the service or set the service to bestarted manually.

NAME = "Windows Defender Disabled via Registry Modification"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") and((registry.path: ("HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware","\\REGISTRY\\MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware") andregistry.data.strings: ("1", "0x00000001") ) or (registry.path: ("HKLM\\System\\*ControlSet*\\Services\\WinDefend\\Start","\\REGISTRY\\MACHINE\\System\\*ControlSet*\\Services\\WinDefend\\Start") andregistry.data.strings in ("3", "4", "0x00000003", "0x00000004") )) andnot(process.executable : ("?:\\WINDOWS\\system32\\services.exe","?:\\Windows\\System32\\svchost.exe","?:\\Program Files (x86)\\Trend Micro\\Security Agent\\NTRmv.exe") and user.id : "S-1-5-18")'''


<li><a href="#">DESCRIPTION = Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folderdirectory or process level.

NAME = "Windows Defender Exclusions Added via PowerShell"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or ?process.pe.original_file_name in ("powershell.exe", "pwsh.dll", "powershell_ise.exe")) andprocess.args : ("*Add-MpPreference*", "*Set-MpPreference*") andprocess.args : ("*-Exclusion*")'''


<li><a href="#">DESCRIPTION = Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidenceof files created during post-exploitation activities.

NAME = "Delete Volume USN Journal with Fsutil"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "fsutil.exe" or ?process.pe.original_file_name == "fsutil.exe") andprocess.args : "deletejournal" and process.args : "usn'''


<li><a href="#">DESCRIPTION = Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensicevidence on a system.

NAME = "WebServer Access Logs Deleted"

QUERY = '''file where event.type == "deletion" andfile.path : ("C:\\inetpub\\logs\\LogFiles\\*.log", "/var/log/apache*/access.log", "/etc/httpd/logs/access_log", "/var/log/httpd/access_log", "/var/www/*/logs/access.log")'''


<li><a href="#">DESCRIPTION = Adversaries may attempt to clear or disable the Bash command-line history in an attempt to evade detection or forensicinvestigations.

NAME = "Tampering of Shell Command-Line History"

QUERY = '''process where event.action in ("exec", "exec_event", "executed", "process_started") and event.type == "start" and (((process.args : ("rm", "echo") or(process.args : "ln" and process.args : "-sf" and process.args : "/dev/null") or(process.args : "truncate" and process.args : "-s0"))and process.args : (".bash_history", "/root/.bash_history", "/home/*/.bash_history","/Users/.bash_history", "/Users/*/.bash_history",".zsh_history", "/root/.zsh_history", "/home/*/.zsh_history", "/Users/.zsh_history", "/Users/*/.zsh_history")) or(process.name : "history" and process.args : "-c") or(process.args : "export" and process.args : ("HISTFILE=/dev/null", "HISTFILESIZE=0")) or(process.args : "unset" and process.args : "HISTFILE") or(process.args : "set" and process.args : "history" and process.args : "+o") )'''


<li><a href="#">DESCRIPTION = Identifies attempts to disable PowerShell Script Block Logging via registry modification. Attackers may disable thislogging to conceal their activities in the host and evade detection.

NAME = "PowerShell Script Block Logging Disabled"

QUERY = '''registry where host.os.type == "windows" and event.type == "change" andregistry.path : ("HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\\EnableScriptBlockLogging","\\REGISTRY\\MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\\EnableScriptBlockLogging") and registry.data.strings : ("0", "0x00000000")'''


<li><a href="#">DESCRIPTION = Identifies use of the netsh.exe to disable or weaken the local firewall. Attackers will use this command line tool todisable the firewall during troubleshooting or to enable network mobility.

NAME = "Disable Windows Firewall Rules via Netsh"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "netsh.exe" and((process.args : "disable" and process.args : "firewall" and process.args : "set") or(process.args : "advfirewall" and process.args : "off" and process.args : "state"))'''


<li><a href="#">DESCRIPTION = "Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings."false_positives =

NAME = "Disabling Windows Defender Security Settings via PowerShell"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or?process.pe.original_file_name in ("powershell.exe", "pwsh.dll", "powershell_ise.exe")) andprocess.args : "Set-MpPreference" and process.args : ("-Disable*", "Disabled", "NeverSend", "-Exclusion*")'''


<li><a href="#">DESCRIPTION = Identifies attempts to disable EventLog via the logman Windows utility, PowerShell, or auditpol. This is often done byattackers in an attempt to evade detection on a system.

NAME = "Disable Windows Event and Security Logs Using Built-in Tools"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(((process.name:"logman.exe" or ?process.pe.original_file_name == "Logman.exe") andprocess.args : "EventLog-*" and process.args : ("stop", "delete")) or((process.name : ("pwsh.exe", "powershell.exe", "powershell_ise.exe") or ?process.pe.original_file_name in("pwsh.exe", "powershell.exe", "powershell_ise.exe")) and	process.args : "Set-Service" and process.args: "EventLog" and process.args : "Disabled")or((process.name:"auditpol.exe" or ?process.pe.original_file_name == "AUDITPOL.EXE") and process.args : "/success:disable"))'''


<li><a href="#">DESCRIPTION = Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltratingdata. With this enabled, an organization will lose visibility into data such as query type, response, and originatingIP, which are used to determine bad actors.

NAME = "DNS-over-HTTPS Enabled via Registry"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") and(registry.path : "*\\SOFTWARE\\Policies\\Microsoft\\Edge\\BuiltInDnsClientEnabled" andregistry.data.strings : "1") or(registry.path : "*\\SOFTWARE\\Google\\Chrome\\DnsOverHttpsMode" andregistry.data.strings : "secure") or(registry.path : "*\\SOFTWARE\\Policies\\Mozilla\\Firefox\\DNSOverHTTPS" andregistry.data.strings : "1")'''


<li><a href="#">DESCRIPTION = Identifies executions of .NET compilers with suspicious parent processes, which can indicate an attacker's attemptto compile code after delivery in order to bypass security mechanisms.

NAME = "Suspicious .NET Code Compilation"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : ("csc.exe", "vbc.exe") andprocess.parent.name : ("wscript.exe", "mshta.exe", "cscript.exe", "wmic.exe", "svchost.exe", "rundll32.exe", "cmstp.exe", "regsvr32.exe")'''


<li><a href="#">DESCRIPTION = Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt todisable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. Thismay also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in astable state.

NAME = "Elastic Agent Service Terminated"

QUERY = '''process where/* net, sc or wmic stopping or deleting Elastic Agent on Windows */(event.type == "start" andprocess.name : ("net.exe", "sc.exe", "wmic.exe","powershell.exe","taskkill.exe","PsKill.exe","ProcessHacker.exe") andprocess.args : ("stopservice","uninstall", "stop", "disabled","Stop-Process","terminate","suspend") andprocess.args : ("elasticendpoint", "Elastic Agent","elastic-agent","elastic-endpoint"))or/* service or systemctl used to stop Elastic Agent on Linux */(event.type == "end" and(process.name : ("systemctl", "service") andprocess.args : "elastic-agent" andprocess.args : "stop")or/* pkill , killall used to stop Elastic Agent on Linux */( event.type == "end" and process.name : ("pkill", "killall") and process.args: "elastic-agent")or/* Unload Elastic Agent extension on MacOS */(process.name : "kextunload" andprocess.args : "com.apple.iokit.EndpointSecurity" andevent.action : "end"))'''


<li><a href="#">DESCRIPTION = Identifies use of the network shell utility (netsh.exe) to enable inbound Remote Desktop Protocol (RDP) connections inthe Windows Firewall.

NAME = "Remote Desktop Enabled in Windows Firewall by Netsh"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : "netsh.exe" or ?process.pe.original_file_name == "netsh.exe") and process.args : ("localport=3389", "RemoteDesktop", "group=\"remote desktop\"") and process.args : ("action=allow", "enable=Yes", "enable")'''


<li><a href="#">DESCRIPTION = Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-linetool to weaken the host firewall settings.

NAME = "Enable Host Network Discovery via Netsh"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "netsh.exe" andprocess.args : ("firewall", "advfirewall") and process.args : "group=Network Discovery" and process.args : "enable=Yes'''


<li><a href="#">DESCRIPTION = Identifies unusual instances of Control Panel with suspicious keywords or paths in the process command line value.Adversaries may abuse control.exe to proxy execution of malicious code.

NAME = "Control Panel Process with Unusual Arguments"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.executable : ("?:\\Windows\\SysWOW64\\control.exe", "?:\\Windows\\System32\\control.exe") and process.command_line :("*.jpg*", "*.png*", "*.gif*", "*.bmp*", "*.jpeg*", "*.TIFF*", "*.inf*", "*.cpl:*/*", "*../../..*", "*/AppData/Local/*", "*:\\Users\\Public\\*", "*\\AppData\\Local\\*")'''


<li><a href="#">DESCRIPTION = Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is usedas a defense evasion technique to blend-in malicious activity with legitimate Windows software.

NAME = "ImageLoad via Windows Update Auto Update Client"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(?process.pe.original_file_name == "wuauclt.exe" or process.name : "wuauclt.exe") and /* necessary windows update client args to load a dll */ process.args : "/RunHandlerComServer" and process.args : "/UpdateDeploymentProvider" and /* common paths writeable by a standard user where the target DLL can be placed */ process.args : ("C:\\Users\\*.dll", "C:\\ProgramData\\*.dll", "C:\\Windows\\Temp\\*.dll", "C:\\Windows\\Tasks\\*.dll")'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the BuildEngine and could have been caused by an Excel or Word document executing a malicious script payload.

NAME = "Microsoft Build Engine Started by an Office Application"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "MSBuild.exe" andprocess.parent.name : ("eqnedt32.exe", "excel.exe", "fltldr.exe", "msaccess.exe", "mspub.exe", "outlook.exe", "powerpnt.exe", "winword.exe" )'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, was started by a script or the Windows command interpreter. Thisbehavior is unusual and is sometimes used by malicious payloads.

NAME = "Microsoft Build Engine Started by a Script Process"

QUERY = '''host.os.type:windows and event.category:process and event.type:start and (process.name.caseless:"msbuild.exe" or process.pe.original_file_name:"MSBuild.exe") and process.parent.name:("cmd.exe" or "powershell.exe" or "pwsh.exe" or "powershell_ise.exe" or "cscript.exe" or"wscript.exe" or "mshta.exe")'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows ManagementInstrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads.

NAME = "Microsoft Build Engine Started by a System Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "MSBuild.exe" andprocess.parent.name : ("explorer.exe", "wmiprvse.exe")'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and mayindicate an attempt to run unnoticed or undetected.

NAME = "Microsoft Build Engine Using an Alternate Name"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.pe.original_file_name == "MSBuild.exe" andnot process.name : "MSBuild.exe'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, started a PowerShell script or the Visual C# Command Line Compiler.This technique is sometimes used to deploy a malicious payload using the Build Engine.

NAME = "Microsoft Build Engine Started an Unusual Process"

QUERY = '''host.os.type:windows and event.category:process and event.type:start and process.parent.name:("MSBuild.exe" or "msbuild.exe") andprocess.name:("csc.exe" or "iexplore.exe" or "powershell.exe")'''


<li><a href="#">DESCRIPTION = Identifies an instance of a Windows trusted program that is known to be vulnerable to DLL Search Order Hijackingstarting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evadedefenses via side loading a malicious DLL within the memory space of one of those processes.

NAME = "Potential DLL Side-Loading via Trusted Microsoft Programs"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.pe.original_file_name in ("WinWord.exe", "EXPLORER.EXE", "w3wp.exe", "DISM.EXE") andnot (process.name : ("winword.exe", "explorer.exe", "w3wp.exe", "Dism.exe") or process.executable : ("?:\\Windows\\explorer.exe", "?:\\Program Files\\Microsoft Office\\root\\Office*\\WINWORD.EXE", "?:\\Program Files?(x86)\\Microsoft Office\\root\\Office*\\WINWORD.EXE", "?:\\Windows\\System32\\Dism.exe", "?:\\Windows\\SysWOW64\\Dism.exe", "?:\\Windows\\System32\\inetsrv\\w3wp.exe") )'''


<li><a href="#">DESCRIPTION = Identifies a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after beingrenamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses viaside-loading a malicious DLL within the memory space of one of those processes.

NAME = "Potential DLL Side-Loading via Microsoft Antimalware Service Executable"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and((process.pe.original_file_name == "MsMpEng.exe" and not process.name : "MsMpEng.exe") or(process.name : "MsMpEng.exe" and notprocess.executable : ("?:\\ProgramData\\Microsoft\\Windows Defender\\*.exe","?:\\Program Files\\Windows Defender\\*.exe","?:\\Program Files (x86)\\Windows Defender\\*.exe","?:\\Program Files\\Microsoft Security Client\\*.exe","?:\\Program Files (x86)\\Microsoft Security Client\\*.exe")))'''


<li><a href="#">DESCRIPTION = Masquerading can allow an adversary to evade defenses and better blend in with the environment. One way it occurs iswhen the name or location of a file is manipulated as a means of tricking a user into executing what they think is abenign file type but is actually executable code.

NAME = "Executable File Creation with Multiple Extensions"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" and file.extension : "exe" andfile.name regex~ .*\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|gif|jpg|png|bmp|hta|txt|img|iso)\.exe andnot (process.executable : ("?:\\Windows\\System32\\msiexec.exe", "C:\\Users\\*\\QGIS_SCCM\\Files\\QGIS-OSGeo4W-*-Setup-x86_64.exe") and file.path : "?:\\Program Files\\QGIS *\\apps\\grass\\*.exe") andnot process.executable : ("/bin/sh", "/usr/sbin/MailScanner", "/usr/bin/perl")'''


<li><a href="#">DESCRIPTION = Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hidemalware in trusted paths.

NAME = "Process Execution from an Unusual Directory"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and/* add suspicious execution paths here */process.executable : ("?:\\PerfLogs\\*.exe", "?:\\Users\\Public\\*.exe", "?:\\Windows\\Tasks\\*.exe","?:\\Intel\\*.exe", "?:\\AMD\\Temp\\*.exe", "?:\\Windows\\AppReadiness\\*.exe","?:\\Windows\\ServiceState\\*.exe", "?:\\Windows\\security\\*.exe", "?:\\Windows\\IdentityCRL\\*.exe","?:\\Windows\\Branding\\*.exe", "?:\\Windows\\csc\\*.exe", "?:\\Windows\\DigitalLocker\\*.exe","?:\\Windows\\en-US\\*.exe", "?:\\Windows\\wlansvc\\*.exe", "?:\\Windows\\Prefetch\\*.exe","?:\\Windows\\Fonts\\*.exe", "?:\\Windows\\diagnostics\\*.exe", "?:\\Windows\\TAPI\\*.exe","?:\\Windows\\INF\\*.exe", "?:\\Windows\\System32\\Speech\\*.exe", "?:\\windows\\tracing\\*.exe","?:\\windows\\IME\\*.exe", "?:\\Windows\\Performance\\*.exe", "?:\\windows\\intel\\*.exe","?:\\windows\\ms\\*.exe", "?:\\Windows\\dot3svc\\*.exe", "?:\\Windows\\panther\\*.exe","?:\\Windows\\RemotePackages\\*.exe", "?:\\Windows\\OCR\\*.exe", "?:\\Windows\\appcompat\\*.exe","?:\\Windows\\apppatch\\*.exe", "?:\\Windows\\addins\\*.exe", "?:\\Windows\\Setup\\*.exe","?:\\Windows\\Help\\*.exe", "?:\\Windows\\SKB\\*.exe", "?:\\Windows\\Vss\\*.exe","?:\\Windows\\Web\\*.exe", "?:\\Windows\\servicing\\*.exe", "?:\\Windows\\CbsTemp\\*.exe","?:\\Windows\\Logs\\*.exe", "?:\\Windows\\WaaS\\*.exe", "?:\\Windows\\ShellExperiences\\*.exe","?:\\Windows\\ShellComponents\\*.exe", "?:\\Windows\\PLA\\*.exe", "?:\\Windows\\Migration\\*.exe","?:\\Windows\\debug\\*.exe", "?:\\Windows\\Cursors\\*.exe", "?:\\Windows\\Containers\\*.exe","?:\\Windows\\Boot\\*.exe", "?:\\Windows\\bcastdvr\\*.exe", "?:\\Windows\\assembly\\*.exe","?:\\Windows\\TextInput\\*.exe", "?:\\Windows\\security\\*.exe", "?:\\Windows\\schemas\\*.exe","?:\\Windows\\SchCache\\*.exe", "?:\\Windows\\Resources\\*.exe", "?:\\Windows\\rescache\\*.exe","?:\\Windows\\Provisioning\\*.exe", "?:\\Windows\\PrintDialog\\*.exe", "?:\\Windows\\PolicyDefinitions\\*.exe","?:\\Windows\\media\\*.exe", "?:\\Windows\\Globalization\\*.exe", "?:\\Windows\\L2Schemas\\*.exe","?:\\Windows\\LiveKernelReports\\*.exe", "?:\\Windows\\ModemLogs\\*.exe","?:\\Windows\\ImmersiveControlPanel\\*.exe") andnot process.name : ("SpeechUXWiz.exe", "SystemSettings.exe", "TrustedInstaller.exe","PrintDialog.exe", "MpSigStub.exe", "LMS.exe", "mpam-*.exe") andnot process.executable :("?:\\Intel\\Wireless\\WUSetupLauncher.exe", "?:\\Intel\\Wireless\\Setup.exe", "?:\\Intel\\Move Mouse.exe", "?:\\windows\\Panther\\DiagTrackRunner.exe", "?:\\Windows\\servicing\\GC64\\tzupd.exe", "?:\\Users\\Public\\res\\RemoteLite.exe", "?:\\Users\\Public\\IBM\\ClientSolutions\\*.exe", "?:\\Users\\Public\\Documents\\syspin.exe", "?:\\Users\\Public\\res\\FileWatcher.exe") /* uncomment once in winlogbeat */ /* and not (process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true) */'''


<li><a href="#">DESCRIPTION = Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversarydefense evasion by avoiding the storing of malicious content directly on disk.

NAME = "Encoded Executable Stored in the Registry"

QUERY = '''registry where host.os.type == "windows" and/* update here with encoding combinations */ registry.data.strings : "TVqQAAMAAAAEAAAA*'''


<li><a href="#">DESCRIPTION = Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS serveraccess via a webshell or other mechanism can disable HTTP Logging as an effective anti-forensics measure.

NAME = "IIS HTTP Logging Disabled"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "appcmd.exe" or ?process.pe.original_file_name == "appcmd.exe") andprocess.args : "/dontLog*:*True" andnot process.parent.name : "iissetup.exe'''


<li><a href="#">DESCRIPTION = An instance of MSBuild, the Microsoft Build Engine, created a thread in another process. This technique is sometimesused to evade detection or elevate privileges.

NAME = "Process Injection by the Microsoft Build Engine"

QUERY = '''process.name:MSBuild.exe and host.os.type:windows and event.action:"CreateRemoteThread detected (rule: CreateRemoteThread)'''


<li><a href="#">DESCRIPTION = Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil isoften leveraged by adversaries to execute code and evade detection.

NAME = "InstallUtil Process Making Network Connections"

QUERY = '''/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */sequence by process.entity_id[process where host.os.type == "windows" and event.type == "start" and process.name : "installutil.exe"][network where host.os.type == "windows" and process.name : "installutil.exe" and network.direction : ("outgoing", "egress")]'''


<li><a href="#">DESCRIPTION = A suspicious Endpoint Security parent process was detected. This may indicate a process hollowing or other form of codeinjection.

NAME = "Suspicious Endpoint Security Parent Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : ("esensor.exe", "elastic-endpoint.exe") andprocess.parent.executable != null and/* add FPs here */not process.parent.executable : ("?:\\Program Files\\Elastic\\*","?:\\Windows\\System32\\services.exe","?:\\Windows\\System32\\WerFault*.exe","?:\\Windows\\System32\\wermgr.exe","?:\\Windows\\explorer.exe") andnot (process.parent.executable : ("?:\\Windows\\System32\\cmd.exe","?:\\Windows\\System32\\SecurityHealthHost.exe","?:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe") andprocess.args : ("test", "version","top", "run","*help", "status","upgrade", "/launch","/enable"))'''


<li><a href="#">DESCRIPTION = Identifies executables with names resembling legitimate business applications but lacking signatures from the originaldeveloper. Attackers may trick users into downloading malicious executables that masquerade as legitimate applicationsvia malicious ads, forum posts, and tutorials, effectively gaining initial access.

NAME = "Potential Masquerading as Business App Installer"

QUERY = '''process where host.os.type == "windows" andevent.type == "start" and process.executable : "?:\\Users\\*\\Downloads\\*" andnot process.code_signature.status : ("errorCode_endpoint*", "errorUntrustedRoot", "errorChaining") and(/* Slack */(process.name : "*slack*.exe" and not(process.code_signature.subject_name in ("Slack Technologies, Inc.","Slack Technologies, LLC" ) and process.code_signature.trusted == true)) or/* WebEx */(process.name : "*webex*.exe" and not(process.code_signature.subject_name in ("Cisco WebEx LLC", "Cisco Systems, Inc.") and process.code_signature.trusted == true)) or/* Teams */(process.name : "teams*.exe" and not(process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true)) or/* Discord */(process.name : "*discord*.exe" and not(process.code_signature.subject_name == "Discord Inc." and process.code_signature.trusted == true)) or/* WhatsApp */(process.name : "*whatsapp*.exe" and not(process.code_signature.subject_name in ("WhatsApp LLC","WhatsApp, Inc","24803D75-212C-471A-BC57-9EF86AB91435" ) and process.code_signature.trusted == true)) or/* Zoom */(process.name : ("*zoom*installer*.exe", "*zoom*setup*.exe", "zoom.exe")and not(process.code_signature.subject_name == "Zoom Video Communications, Inc." and process.code_signature.trusted == true)) or/* Outlook */(process.name : "*outlook*.exe" and not((process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true) or(process.name: "MSOutlookHelp-PST-Viewer.exe" and process.code_signature.subject_name == "Aryson Technologies Pvt. Ltd" andprocess.code_signature.trusted == true))) or/* Thunderbird */(process.name : "*thunderbird*.exe" and not(process.code_signature.subject_name == "Mozilla Corporation" and process.code_signature.trusted == true)) or/* Grammarly */(process.name : "*grammarly*.exe" and not(process.code_signature.subject_name == "Grammarly, Inc." and process.code_signature.trusted == true)) or/* Dropbox */(process.name : "*dropbox*.exe" and not(process.code_signature.subject_name == "Dropbox, Inc" and process.code_signature.trusted == true)) or/* Tableau */(process.name : "*tableau*.exe" and not(process.code_signature.subject_name == "Tableau Software LLC" and process.code_signature.trusted == true)) or/* Google Drive */(process.name : "*googledrive*.exe" and not(process.code_signature.subject_name == "Google LLC" and process.code_signature.trusted == true)) or/* MSOffice */(process.name : "*office*setup*.exe" and not(process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true)) or/* Okta */(process.name : "*okta*.exe" and not(process.code_signature.subject_name == "Okta, Inc." and process.code_signature.trusted == true)) or/* OneDrive */(process.name : "*onedrive*.exe" and not(process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true)) or/* Chrome */(process.name : "*chrome*.exe" and not(process.code_signature.subject_name in ("Google LLC", "Google Inc") and process.code_signature.trusted == true)) or/* Firefox */(process.name : "*firefox*.exe" and not(process.code_signature.subject_name == "Mozilla Corporation" and process.code_signature.trusted == true)) or/* Edge */(process.name : ("*microsoftedge*.exe", "*msedge*.exe") and not(process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true)) or/* Brave */(process.name : "*brave*.exe" and not(process.code_signature.subject_name == "Brave Software, Inc." and process.code_signature.trusted == true)) or/* GoogleCloud Related Tools */(process.name : "*GoogleCloud*.exe" and not(process.code_signature.subject_name == "Google LLC" and process.code_signature.trusted == true)) or/* Github Related Tools */(process.name : "*github*.exe" and not(process.code_signature.subject_name == "GitHub, Inc." and process.code_signature.trusted == true)) or/* Notion */(process.name : "*notion*.exe" and not(process.code_signature.subject_name == "Notion Labs, Inc." and process.code_signature.trusted == true)))'''


<li><a href="#">DESCRIPTION = Identifies suspicious instances of communications apps, both unsigned and renamed ones, that can indicate an attempt toconceal malicious activity, bypass security features such as allowlists, or trick users into executing malware.

NAME = "Potential Masquerading as Communication Apps"

QUERY = '''process where host.os.type == "windows" andevent.type == "start" and(/* Slack */(process.name : "slack.exe" and not(process.code_signature.subject_name in ("Slack Technologies, Inc.","Slack Technologies, LLC" ) and process.code_signature.trusted == true)) or/* WebEx */(process.name : "WebexHost.exe" and not(process.code_signature.subject_name in ("Cisco WebEx LLC", "Cisco Systems, Inc.") and process.code_signature.trusted == true)) or/* Teams */(process.name : "Teams.exe" and not(process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true)) or/* Discord */(process.name : "Discord.exe" and not(process.code_signature.subject_name == "Discord Inc." and process.code_signature.trusted == true)) or/* RocketChat */(process.name : "Rocket.Chat.exe" and not(process.code_signature.subject_name == "Rocket.Chat Technologies Corp." and process.code_signature.trusted == true)) or/* Mattermost */(process.name : "Mattermost.exe" and not(process.code_signature.subject_name == "Mattermost, Inc." and process.code_signature.trusted == true)) or/* WhatsApp */(process.name : "WhatsApp.exe" and not(process.code_signature.subject_name in ("WhatsApp LLC","WhatsApp, Inc","24803D75-212C-471A-BC57-9EF86AB91435" ) and process.code_signature.trusted == true)) or/* Zoom */(process.name : "Zoom.exe" and not(process.code_signature.subject_name == "Zoom Video Communications, Inc." and process.code_signature.trusted == true)) or/* Outlook */(process.name : "outlook.exe" and not(process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true)) or/* Thunderbird */(process.name : "thunderbird.exe" and not(process.code_signature.subject_name == "Mozilla Corporation" and process.code_signature.trusted == true)))'''


<li><a href="#">DESCRIPTION = Identifies a suspicious AutoIt process execution. Malware written as an AutoIt script tends to rename the AutoItexecutable to avoid detection.

NAME = "Renamed AutoIt Scripts Interpreter"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.pe.original_file_name : "AutoIt*.exe" and not process.name : "AutoIt*.exe'''


<li><a href="#">DESCRIPTION = This rules identifies a process created from an executable with a space appended to the end of the filename. This mayindicate an attempt to masquerade a malicious file as benign to gain user execution. When a space is added to the end ofcertain files, the OS will execute the file according to it's true filetype instead of it's extension. Adversaries canhide a program's true filetype by changing the extension of the file. They can then add a space to the end of the nameso that the OS automatically executes the file when it's double-clicked.

NAME = "Masquerading Space After Filename"

QUERY = '''process where host.os.type:("linux","macos") andevent.type == "start" and(process.executable regex~ /[a-z0-9\s_\-\\./]+\s) and notprocess.name in ("ls", "find", "grep", "xkbcomp")'''


<li><a href="#">DESCRIPTION = A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit registry key manipulation. Verify process details such as command line, network connections and file writes.

NAME = "Suspicious WerFault Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "WerFault.exe" and /* args -s and -t used to execute a process via SilentProcessExit mechanism */(process.parent.args : "-s" and process.parent.args : "-t" and process.parent.args : "-c") and not process.executable : ("?:\\Windows\\SysWOW64\\Initcrypt.exe", "?:\\Program Files (x86)\\Heimdal\\Heimdal.Guard.exe")'''


<li><a href="#">DESCRIPTION = Identifies execution from a directory masquerading as the Windows Program Files directories. These paths are trusted andusually host trusted third party programs. An adversary may leverage masquerading, along with low privileges to bypassdetections allowlisting those folders.

NAME = "Program Files Directory Masquerading"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.executable : "C:\\*Program*Files*\\*.exe" andnot process.executable : ("?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Users\\*.exe","?:\\ProgramData\\*.exe","?:\\Windows\\Downloaded Program Files\\*.exe","?:\\Windows\\Temp\\.opera\\????????????\\CProgram?FilesOpera*\\*.exe","?:\\Windows\\Temp\\.opera\\????????????\\CProgram?Files?(x86)Opera*\\*.exe")'''


<li><a href="#">DESCRIPTION = Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matchingcommand-line and process executable values performing outgoing network connections. This may be indicative of amasquerading attempt to evade suspicious child process behavior detections.

NAME = "Potential Windows Error Manager Masquerading"

QUERY = '''sequence by host.id, process.entity_id with maxspan = 5s[process where host.os.type == "windows" and event.type:"start" and process.name : ("wermgr.exe", "WerFault.exe") and process.args_count == 1][network where host.os.type == "windows" and process.name : ("wermgr.exe", "WerFault.exe") and network.protocol != "dns" andnetwork.direction : ("outgoing", "egress") and destination.ip !="::1" and destination.ip !="127.0.0.1"]'''


<li><a href="#">DESCRIPTION = Identifies when one or more features on Microsoft Defender are disabled. Adversaries may disable or tamper withMicrosoft Defender features to evade detection and conceal malicious behavior.

NAME = "Microsoft Windows Defender Tampering"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") and(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\PUAProtection" andregistry.data.strings : ("0", "0x00000000")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\App and Browser protection\\DisallowExploitProtectionOverride" andregistry.data.strings : ("0", "0x00000000")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Features\\TamperProtection" andregistry.data.strings : ("0", "0x00000000")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableRealtimeMonitoring" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableIntrusionPreventionSystem" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableScriptScanning" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\EnableControlledFolderAccess" andregistry.data.strings : ("0", "0x00000000")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableIOAVProtection" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Reporting\\DisableEnhancedNotifications" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\DisableBlockAtFirstSeen" andregistry.data.strings : ("1", "0x00000001")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\SpynetReporting" andregistry.data.strings : ("0", "0x00000000")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\SubmitSamplesConsent" andregistry.data.strings : ("0", "0x00000000")) or(registry.path : "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableBehaviorMonitoring" andregistry.data.strings : ("1", "0x00000001"))'''


<li><a href="#">DESCRIPTION = Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signaturevalidation. Adversaries may use these binaries to 'live off the land' and execute malicious files that could bypassapplication allowlists and signature validation.

NAME = "Network Connection via Signed Binary"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and (process.name : "expand.exe" or process.name : "extrac32.exe" or process.name : "ieexec.exe" or process.name : "makecab.exe") and event.type == "start"][network where host.os.type == "windows" and (process.name : "expand.exe" or process.name : "extrac32.exe" or process.name : "ieexec.exe" or process.name : "makecab.exe") andnot cidrmatch(destination.ip,"10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32","192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24","192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")]'''


<li><a href="#">DESCRIPTION = Microsoft Office Products offer options for users and developers to control the security settings for running and usingMacros. Adversaries may abuse these security settings to modify the default behavior of the Office Application to trustfuture macros and/or disable security warnings, which could increase their chances of establishing persistence.

NAME = "MS Office Macro Security Registry Modifications"

QUERY = '''registry where host.os.type == "windows" and event.type == "change" andregistry.path : ("HKU\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM","HKU\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings","HKU\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM","HKU\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings","\\REGISTRY\\USER\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM","\\REGISTRY\\USER\\S-1-5-21-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings","\\REGISTRY\\USER\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM","\\REGISTRY\\USER\\S-1-12-1-*\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings") andregistry.data.strings : ("0x00000001", "1") andprocess.name : ("cscript.exe", "wscript.exe", "mshta.exe", "mshta.exe", "winword.exe", "excel.exe")'''


<li><a href="#">DESCRIPTION = Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is oftenleveraged by adversaries to execute code and evade detection.

NAME = "MsBuild Making Network Connections"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and process.name : "MSBuild.exe" and event.type == "start"][network where host.os.type == "windows" and process.name : "MSBuild.exe" and not cidrmatch(destination.ip, "127.0.0.1", "::1") and not dns.question.name : "localhost"]'''


<li><a href="#">DESCRIPTION = Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is oftenleveraged by adversaries to execute malicious scripts and evade detection.

NAME = "Mshta Making Network Connections"

QUERY = '''sequence by process.entity_id with maxspan=10m[process where host.os.type == "windows" and event.type == "start" and process.name : "mshta.exe" and not process.parent.name : "Microsoft.ConfigurationManagement.exe" and not (process.parent.executable : "C:\\Amazon\\Amazon Assistant\\amazonAssistantService.exe" orprocess.parent.executable : "C:\\TeamViewer\\TeamViewer.exe") and not process.args : "ADSelfService_Enroll.hta"][network where host.os.type == "windows" and process.name : "mshta.exe"]'''


<li><a href="#">DESCRIPTION = Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveragedby adversaries to execute malicious scripts and evade detection.

NAME = "Network Connection via MsXsl"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and process.name : "msxsl.exe" and event.type == "start"][network where host.os.type == "windows" and process.name : "msxsl.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")]'''


<li><a href="#">DESCRIPTION = Identifies network activity from unexpected system applications. This may indicate adversarial activity as theseapplications are often leveraged by adversaries to execute code and evade detection.

NAME = "Unusual Network Activity from a Windows System Binary"

QUERY = '''sequence by process.entity_id with maxspan=5m[process where host.os.type == "windows" and event.type == "start" and /* known applocker bypasses */ (process.name : "bginfo.exe" orprocess.name : "cdb.exe" orprocess.name : "control.exe" orprocess.name : "cmstp.exe" orprocess.name : "csi.exe" orprocess.name : "dnx.exe" orprocess.name : "fsi.exe" orprocess.name : "ieexec.exe" orprocess.name : "iexpress.exe" orprocess.name : "installutil.exe" orprocess.name : "Microsoft.Workflow.Compiler.exe" orprocess.name : "MSBuild.exe" orprocess.name : "msdt.exe" orprocess.name : "mshta.exe" orprocess.name : "msiexec.exe" orprocess.name : "msxsl.exe" orprocess.name : "odbcconf.exe" orprocess.name : "rcsi.exe" orprocess.name : "regsvr32.exe" orprocess.name : "xwizard.exe")][network where (process.name : "bginfo.exe" orprocess.name : "cdb.exe" orprocess.name : "control.exe" orprocess.name : "cmstp.exe" orprocess.name : "csi.exe" orprocess.name : "dnx.exe" orprocess.name : "fsi.exe" orprocess.name : "ieexec.exe" orprocess.name : "iexpress.exe" orprocess.name : "installutil.exe" orprocess.name : "Microsoft.Workflow.Compiler.exe" or(process.name : "msbuild.exe" anddestination.ip != "127.0.0.1") orprocess.name : "msdt.exe" orprocess.name : "mshta.exe" or(process.name : "msiexec.exe" and notdns.question.name : ( "ocsp.digicert.com", "ocsp.verisign.com", "ocsp.comodoca.com", "ocsp.entrust.net", "ocsp.usertrust.com", "ocsp.godaddy.com", "ocsp.camerfirma.com", "ocsp.globalsign.com", "ocsp.sectigo.com", "*.local") and/* Localhost, DigiCert and Comodo CA IP addresses */not cidrmatch(destination.ip, "127.0.0.1", "192.229.211.108/32", "192.229.221.95/32","152.195.38.76/32", "104.18.14.101/32")) orprocess.name : "msxsl.exe" orprocess.name : "odbcconf.exe" orprocess.name : "rcsi.exe" orprocess.name : "regsvr32.exe" orprocess.name : "xwizard.exe")]'''


<li><a href="#">DESCRIPTION = Identifies parent process spoofing used to thwart detection. Adversaries may spoof the parent process identifier (PPID)of a new process to evade process-monitoring defenses or to elevate privileges.

NAME = "Parent Process PID Spoofing"

QUERY = '''/* This rule is compatible with Elastic Endpoint only */sequence by host.id, user.id with maxspan=3m[process where host.os.type == "windows" and event.type == "start" andprocess.Ext.token.integrity_level_name != "system" and (process.pe.original_file_name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe", "eqnedt32.exe", "fltldr.exe", "mspub.exe", "msaccess.exe", "powershell.exe", "pwsh.exe", "cscript.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "msbuild.exe", "mshta.exe", "wmic.exe", "cmstp.exe", "msxsl.exe") or(process.executable : ("?:\\Users\\*.exe", "?:\\ProgramData\\*.exe", "?:\\Windows\\Temp\\*.exe", "?:\\Windows\\Tasks\\*") and (process.code_signature.exists == false or process.code_signature.status : "errorBadDigest")) or process.executable : "?:\\Windows\\Microsoft.NET\\*.exe") and not process.executable :("?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\WINDOWS\\SysWOW64\\WerFaultSecure.exe","?:\\Windows\\System32\\WerFault.exe","?:\\Windows\\SysWOW64\\WerFault.exe")] by process.pid [process where host.os.type == "windows" and event.type == "start" andprocess.parent.Ext.real.pid > 0 and/* process.parent.Ext.real.pid is only populated if the parent process pid doesn't match */not (process.name : "msedge.exe" and process.parent.name : "sihost.exe") andnot process.executable :("?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\WINDOWS\\SysWOW64\\WerFaultSecure.exe","?:\\Windows\\System32\\WerFault.exe","?:\\Windows\\SysWOW64\\WerFault.exe") ] by process.parent.Ext.real.pid'''


<li><a href="#">DESCRIPTION = Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn't bydefault) and is set to 1, then remote connections from all local members of Administrators are granted fullhigh-integrity tokens during negotiation.

NAME = "Local Account TokenFilter Policy Disabled"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKLM\\*\\LocalAccountTokenFilterPolicy","\\REGISTRY\\MACHINE\\*\\LocalAccountTokenFilterPolicy") andregistry.data.strings : ("1", "0x00000001")'''


<li><a href="#">DESCRIPTION = Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this methodto load executables and DLLs without writing to the disk, bypassing security solutions.

NAME = "Suspicious .NET Reflection via PowerShell"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ("[System.Reflection.Assembly]::Load" or"[Reflection.Assembly]::Load") andnot powershell.file.script_block_text : (("CommonWorkflowParameters" or "RelatedLinksHelpInfo") and"HelpDisplayStrings") andnot (powershell.file.script_block_text :("Get-SolutionFiles" or "Get-VisualStudio" or "Select-MSBuildPath") andfile.name : "PathFunctions.ps1") andnot file.path : C\:\\\\Program?Files\\\\Microsoft?Monitoring?Agent\\\\Agent\\\\Health?Service?State\\\\Monitoring?Host?Temporary?Files*\\\\AvailabilityGroupMonitoring.ps1 andnot user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, whichmalware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses.

NAME = "PowerShell Suspicious Payload Encoded and Compressed"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : (("System.IO.Compression.DeflateStream" or"System.IO.Compression.GzipStream" or"IO.Compression.DeflateStream" or"IO.Compression.GzipStream") andFromBase64String) andnot file.path: ?\:\\\\ProgramData\\\\Microsoft\\\\Windows?Defender?Advanced?Threat?Protection\\\\Downloads\\\\* andnot user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Identifies the use of Cmdlets and methods related to encryption/decryption of files in PowerShell scripts, which malwareand offensive security tools can abuse to encrypt data or decrypt payloads to bypass security solutions.

NAME = "PowerShell Script with Encryption/Decryption Capabilities"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : (("Cryptography.AESManaged" or"Cryptography.RijndaelManaged" or"Cryptography.SHA1Managed" or"Cryptography.SHA256Managed" or"Cryptography.SHA384Managed" or"Cryptography.SHA512Managed" or"Cryptography.SymmetricAlgorithm" or"PasswordDeriveBytes" or"Rfc2898DeriveBytes") and(CipherMode and PaddingMode) and(".CreateEncryptor" or".CreateDecryptor")) and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects the use of Windows API functions that are commonly abused by malware and security tools to load malicious codeor inject it into remote processes.

NAME = "Potential Process Injection via PowerShell"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ( (VirtualAlloc or VirtualAllocEx or VirtualProtect or LdrLoadDll or LoadLibrary or LoadLibraryA orLoadLibraryEx or GetProcAddress or OpenProcess or OpenProcessToken or AdjustTokenPrivileges) and (WriteProcessMemory or CreateRemoteThread or NtCreateThreadEx or CreateThread or QueueUserAPC orSuspendThread or ResumeThread or GetDelegateForFunctionPointer)) and not (user.id:("S-1-5-18" or "S-1-5-19") and file.directory: "C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\SenseCM")'''


<li><a href="#">DESCRIPTION = Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade networkconstraints, like internet and network lateral communication restrictions.

NAME = "Windows Firewall Disabled via PowerShell"

QUERY = '''process where host.os.type == "windows" and event.action == "start" and(process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") or ?process.pe.original_file_name == "PowerShell.EXE") and process.args : "*Set-NetFirewallProfile*" and(process.args : "*-Enabled*" and process.args : "*False*") and(process.args : "*-All*" or process.args : ("*Public*", "*Domain*", "*Private*"))'''


<li><a href="#">DESCRIPTION = Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and othernon-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removalof these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary'sfootprint.

NAME = "Process Termination followed by Deletion"

QUERY = '''sequence by host.id with maxspan=5s [process where host.os.type == "windows" and event.type == "end" andprocess.code_signature.trusted != true andnot process.executable : ("C:\\Windows\\SoftwareDistribution\\*.exe", "C:\\Windows\\WinSxS\\*.exe") ] by process.executable [file where host.os.type == "windows" and event.type == "deletion" and file.extension : ("exe", "scr", "com") andnot process.executable : ("?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\System32\\svchost.exe","?:\\Windows\\System32\\drvinst.exe") andnot file.path : ("?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\Temp\\*\\DismHost.exe","?:\\$WINDOWS.~BT\\Work\\*\\DismHost.exe","?:\\$WinREAgent\\Scratch\\*\\DismHost.exe","?:\\Windows\\tenable_mw_scan_*.exe","?:\\Users\\*\\AppData\\Local\\Temp\\LogiUI\\Pak\\uninstall.exe") ] by file.path'''


<li><a href="#">DESCRIPTION = Identifies potential abuse of the Microsoft Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious command orbinary execution via malicious process arguments.

NAME = "Suspicious Microsoft Diagnostics Wizard Execution"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.pe.original_file_name == "msdt.exe" or process.name : "msdt.exe") and (process.args : ("IT_RebrowseForFile=*", "ms-msdt:/id", "ms-msdt:-id", "*FromBase64*") or(process.args : "-af" and process.args : "/skip" and process.parent.name : ("explorer.exe", "cmd.exe", "powershell.exe", "cscript.exe", "wscript.exe", "mshta.exe", "rundll32.exe", "regsvr32.exe") and process.args : ("?:\\WINDOWS\\diagnostics\\index\\PCWDiagnostic.xml", "PCWDiagnostic.xml", "?:\\Users\\Public\\*", "?:\\Windows\\Temp\\*")) or(process.pe.original_file_name == "msdt.exe" and not process.name : "msdt.exe" and process.name != null) or(process.pe.original_file_name == "msdt.exe" and not process.executable : ("?:\\Windows\\system32\\msdt.exe", "?:\\Windows\\SysWOW64\\msdt.exe")))'''


<li><a href="#">DESCRIPTION = Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse ofRunDLL32 could indicate malicious activity.

NAME = "Unusual Child Processes of RunDLL32"

QUERY = '''sequence with maxspan=1h[process where host.os.type == "windows" and event.type == "start" and (process.name : "rundll32.exe" or process.pe.original_file_name == "RUNDLL32.EXE") andprocess.args_count == 1] by process.entity_id[process where host.os.type == "windows" and event.type == "start" and process.parent.name : "rundll32.exe"] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = Identifies attempts to enable the Windows scheduled tasks AT command via the registry. Attackers may use this method tomove laterally or persist locally. The AT command has been deprecated since Windows 8 and Windows Server 2012, but stillexists for backwards compatibility.

NAME = "Scheduled Tasks AT Command Enabled"

QUERY = '''registry where host.os.type == "windows" andregistry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt") and registry.data.strings : ("1", "0x00000001")'''


<li><a href="#">DESCRIPTION = Detects file name patterns generated by the use of Sysinternals SDelete utility to securely delete a file via multiplefile overwrite and rename operations.

NAME = "Potential Secure File Deletion via SDelete Utility"

QUERY = '''file where host.os.type == "windows" and event.type == "change" and file.name : "*AAA.AAA'''


<li><a href="#">DESCRIPTION = Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by theWindows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signaturevalidation checks or inject code into critical processes.

NAME = "SIP Provider Modification"

QUERY = '''registry where host.os.type == "windows" and event.type:"change" andregistry.path: ("*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType 0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll","*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType 0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll","*\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll","*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll") andregistry.data.strings:"*.dll'''


<li><a href="#">DESCRIPTION = Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse thistechnique to manipulate relevant security services.

NAME = "SolarWinds Process Disabling Services via Registry"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\Start","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\Start") andregistry.data.strings : ("4", "0x00000004") andprocess.name : ("SolarWinds.BusinessLayerHost*.exe","ConfigurationWizard*.exe","NetflowDatabaseMaintenance*.exe","NetFlowService*.exe","SolarWinds.Administration*.exe","SolarWinds.Collector.Service*.exe","SolarwindsDiagnostics*.exe")'''


<li><a href="#">DESCRIPTION = Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part ofCertificate Services. CertUtil is often abused by attackers to live off the land for stealthier command and control ordata exfiltration.

NAME = "Suspicious CertUtil Commands"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "certutil.exe" or ?process.pe.original_file_name == "CertUtil.exe") andprocess.args : ("?decode", "?encode", "?urlcache", "?verifyctl", "?encodehex", "?decodehex", "?exportPFX")'''


<li><a href="#">DESCRIPTION = Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker mayuse this technique to evade defenses.

NAME = "Suspicious Execution from a Mounted Device"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.executable : "C:\\*" and(process.working_directory : "?:\\" and not process.working_directory: "C:\\") andprocess.parent.name : "explorer.exe" andprocess.name : ("rundll32.exe", "mshta.exe", "powershell.exe", "pwsh.exe", "cmd.exe", "regsvr32.exe","cscript.exe", "wscript.exe")'''


<li><a href="#">DESCRIPTION = Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspiciouscode execution.

NAME = "Suspicious Managed Code Hosting Process"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.name : ("wscript.exe.log", "cscript.exe.log", "mshta.exe.log", "wmic.exe.log", "svchost.exe.log", "dllhost.exe.log", "cmstp.exe.log", "regsvr32.exe.log")'''


<li><a href="#">DESCRIPTION = Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hookuserland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypasshooked functions by writing malicious functions that call syscalls directly.

NAME = "Suspicious Process Access via Direct System Call"

QUERY = '''process where host.os.type == "windows" and event.code == "10" and length(winlog.event_data.CallTrace) > 0 and /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */ not winlog.event_data.CallTrace :("?:\\WINDOWS\\SYSTEM32\\ntdll.dll*", "?:\\WINDOWS\\SysWOW64\\ntdll.dll*", "?:\\Windows\\System32\\wow64cpu.dll*", "?:\\WINDOWS\\System32\\wow64win.dll*", "?:\\Windows\\System32\\win32u.dll*") and not winlog.event_data.TargetImage :("?:\\Program Files (x86)\\Malwarebytes Anti-Exploit\\mbae-svc.exe", "?:\\Program Files\\Cisco\\AMP\\*\\sfc.exe", "?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\*\\msedgewebview2.exe", "?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\*\\AcroCEF.exe") and not (process.executable : ("?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe","?:\\Program Files (x86)\\World of Warcraft\\_classic_\\WowClassic.exe") andnot winlog.event_data.TargetImage : "?:\\WINDOWS\\system32\\lsass.exe")'''


<li><a href="#">DESCRIPTION = Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parentprocess. This may indicate a code injection attempt.

NAME = "Suspicious Process Creation CallTrace"

QUERY = '''sequence by host.id with maxspan=1m[process where host.os.type == "windows" and event.code == "1" and /* sysmon process creation */ process.parent.name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe", "eqnedt32.exe", "fltldr.exe","mspub.exe", "msaccess.exe","cscript.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe","mshta.exe", "wmic.exe", "cmstp.exe", "msxsl.exe") and /* noisy FP patterns */ not (process.parent.name : "EXCEL.EXE" and process.executable : "?:\\Program Files\\Microsoft Office\\root\\Office*\\ADDINS\\*.exe") and not (process.executable : "?:\\Windows\\splwow64.exe" and process.args in ("8192", "12288") and process.parent.name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")) and not (process.parent.name : "rundll32.exe" and process.parent.args : ("?:\\WINDOWS\\Installer\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc", "--no-sandbox")) and not (process.executable :("?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\*\\msedgewebview2.exe", "?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe", "?:\\Windows\\SysWOW64\\DWWIN.EXE") andprocess.parent.name : ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")) and not (process.parent.name : "regsvr32.exe" and process.parent.args : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*")) ] by process.parent.entity_id, process.entity_id[process where host.os.type == "windows" and event.code == "10" and /* Sysmon process access event from unknown module */ winlog.event_data.CallTrace : "*UNKNOWN*"] by process.entity_id, winlog.event_data.TargetProcessGUID'''


<li><a href="#">DESCRIPTION = Identifies scrobj.dll loaded into unusual Microsoft processes. This usually means a malicious scriptlet is beingexecuted in the target process.

NAME = "Suspicious Script Object Execution"

QUERY = '''any where host.os.type == "windows" and(event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and(?dll.name : "scrobj.dll" or ?file.name : "scrobj.dll") andprocess.executable : ("?:\\Windows\\System32\\*.exe", "?:\\Windows\\SysWOW64\\*.exe") andnot process.executable : ( "?:\\Windows\\System32\\cscript.exe", "?:\\Windows\\SysWOW64\\cscript.exe", "?:\\Windows\\system32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe", "?:\\Windows\\System32\\smartscreen.exe", "?:\\Windows\\system32\\taskhostw.exe", "?:\\windows\\system32\\inetsrv\\w3wp.exe", "?:\\windows\\SysWOW64\\inetsrv\\w3wp.exe", "?:\\Windows\\system32\\wscript.exe", "?:\\Windows\\SysWOW64\\wscript.exe", "?:\\Windows\\System32\\mshta.exe", "?:\\Windows\\system32\\mobsync.exe", "?:\\Windows\\SysWOW64\\mobsync.exe", "?:\\Windows\\System32\\cmd.exe", "?:\\Windows\\SysWOW64\\cmd.exe","?:\\Windows\\System32\\OpenWith.exe", "?:\\Windows\\System32\\wbem\\WMIADAP.exe", "?:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe")'''


<li><a href="#">DESCRIPTION = Identifies the execution of a process with a single character process name, differing from the original file name. This is often done by adversaries while staging, executing temporary utilities, or trying to bypass security detections based on the process name.

NAME = "Renamed Utility Executed with Short Program Name"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and length(process.name) > 0 and length(process.name) == 5 and length(process.pe.original_file_name) > 5'''


<li><a href="#">DESCRIPTION = Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scriptinglibraries it may be indicative of an allowlist bypass.

NAME = "Suspicious WMIC XSL Script Execution"

QUERY = '''sequence by process.entity_id with maxspan = 2m[process where host.os.type == "windows" and event.type == "start" and (process.name : "WMIC.exe" or process.pe.original_file_name : "wmic.exe") and process.args : ("format*:*", "/format*:*", "*-format*:*") and not process.command_line : ("* /format:table *", "* /format:table")][any where host.os.type == "windows" and (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and (?dll.name : ("jscript.dll", "vbscript.dll") or file.name : ("jscript.dll", "vbscript.dll"))]'''


<li><a href="#">DESCRIPTION = A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process detailssuch as command line, network connections, file writes and associated file signature details as well.

NAME = "Suspicious Zoom Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : "Zoom.exe" and process.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe")'''


<li><a href="#">DESCRIPTION = Identifies an unexpected executable file being created or modified by a Windows system critical process, which mayindicate activity related to remote code execution or other forms of exploitation.

NAME = "Unusual Executable File Creation by a System Critical Process"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.extension : ("exe", "dll") andprocess.name : ("smss.exe","autochk.exe","csrss.exe","wininit.exe","services.exe","lsass.exe","winlogon.exe","userinit.exe","LogonUI.exe")'''


<li><a href="#">DESCRIPTION = Identifies modification of a file creation time. Adversaries may modify file time attributes to blendmalicious content with existing files. Timestomping is a technique that modifies the timestamps of a file often to mimic files that are in trusted directories.

NAME = "File Creation Time Changed"

QUERY = '''file where host.os.type == "windows" and event.code : "2" and /* Requires Sysmon EventID 2 - File creation time change */ event.action : "File creation time changed*" and not process.executable : ("?:\\Program Files\\*","?:\\Program Files (x86)\\*","?:\\Windows\\system32\\cleanmgr.exe", "?:\\Windows\\system32\\msiexec.exe","?:\\Windows\\syswow64\\msiexec.exe","?:\\Windows\\system32\\svchost.exe","?:\\WINDOWS\\system32\\backgroundTaskHost.exe", "?:\\Users\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrome.exe","?:\\Users\\*\\AppData\\Local\\Mozilla Firefox\\firefox.exe", "?:\\Users\\*\\AppData\\Local\\slack\\app-*\\slack.exe","?:\\Users\\*\\AppData\\Local\\GitHubDesktop\\app-*\\GitHubDesktop.exe", "?:\\Users\\*\\AppData\\Local\\Microsoft\\Teams\\current\\Teams.exe","?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe") andnot file.extension : ("temp", "tmp", "~tmp", "xml", "newcfg") and not user.name : ("SYSTEM", "Local Service", "Network Service") and not file.name : ("LOG", "temp-index", "license.rtf", "iconcache_*.db")'''


<li><a href="#">DESCRIPTION = Timestomping is an anti-forensics technique which is used to modify the timestamps of a file, often to mimic files thatare in the same folder.

NAME = "Timestomping using Touch Command"

QUERY = '''process where event.type == "start" and process.name : "touch" and user.id != "0" and process.args : ("-r", "-t", "-a*","-m*") and not process.args : ( "/usr/lib/go-*/bin/go", "/usr/lib/dracut/dracut-functions.sh", "/tmp/KSInstallAction.*/m/.patch/*") and not process.parent.name in ("pmlogger_daily", "pmlogger_janitor", "systemd")'''


<li><a href="#">DESCRIPTION = Identifies a Windows trusted program running from locations often abused by adversaries to masquerade as a trustedprogram and loading a recently dropped DLL. This behavior may indicate an attempt to evade defenses via side-loading a malicious DLL within the memory space of a signed processes.

NAME = "Unsigned DLL Side-Loading from a Suspicious Folder"

QUERY = '''library where host.os.type == "windows" and process.code_signature.trusted == true and (dll.Ext.relative_file_creation_time <= 500 or dll.Ext.relative_file_name_modify_time <= 500) andnot dll.code_signature.status : ("trusted", "errorExpired", "errorCode_endpoint*", "errorChaining") and /* Suspicious Paths */dll.path : ("?:\\PerfLogs\\*.dll","?:\\Users\\*\\Pictures\\*.dll","?:\\Users\\*\\Music\\*.dll","?:\\Users\\Public\\*.dll","?:\\Users\\*\\Documents\\*.dll","?:\\Windows\\Tasks\\*.dll","?:\\Windows\\System32\\Tasks\\*.dll","?:\\Intel\\*.dll","?:\\AMD\\Temp\\*.dll","?:\\Windows\\AppReadiness\\*.dll","?:\\Windows\\ServiceState\\*.dll","?:\\Windows\\security\\*.dll",		"?:\\Windows\\System\\*.dll","?:\\Windows\\IdentityCRL\\*.dll","?:\\Windows\\Branding\\*.dll","?:\\Windows\\csc\\*.dll","?:\\Windows\\DigitalLocker\\*.dll","?:\\Windows\\en-US\\*.dll","?:\\Windows\\wlansvc\\*.dll","?:\\Windows\\Prefetch\\*.dll","?:\\Windows\\Fonts\\*.dll","?:\\Windows\\diagnostics\\*.dll","?:\\Windows\\TAPI\\*.dll","?:\\Windows\\INF\\*.dll","?:\\windows\\tracing\\*.dll","?:\\windows\\IME\\*.dll","?:\\Windows\\Performance\\*.dll","?:\\windows\\intel\\*.dll","?:\\windows\\ms\\*.dll","?:\\Windows\\dot3svc\\*.dll","?:\\Windows\\ServiceProfiles\\*.dll","?:\\Windows\\panther\\*.dll","?:\\Windows\\RemotePackages\\*.dll","?:\\Windows\\OCR\\*.dll","?:\\Windows\\appcompat\\*.dll","?:\\Windows\\apppatch\\*.dll","?:\\Windows\\addins\\*.dll","?:\\Windows\\Setup\\*.dll","?:\\Windows\\Help\\*.dll","?:\\Windows\\SKB\\*.dll","?:\\Windows\\Vss\\*.dll","?:\\Windows\\Web\\*.dll","?:\\Windows\\servicing\\*.dll","?:\\Windows\\CbsTemp\\*.dll","?:\\Windows\\Logs\\*.dll","?:\\Windows\\WaaS\\*.dll","?:\\Windows\\twain_32\\*.dll","?:\\Windows\\ShellExperiences\\*.dll","?:\\Windows\\ShellComponents\\*.dll","?:\\Windows\\PLA\\*.dll","?:\\Windows\\Migration\\*.dll","?:\\Windows\\debug\\*.dll","?:\\Windows\\Cursors\\*.dll","?:\\Windows\\Containers\\*.dll","?:\\Windows\\Boot\\*.dll","?:\\Windows\\bcastdvr\\*.dll","?:\\Windows\\TextInput\\*.dll","?:\\Windows\\schemas\\*.dll","?:\\Windows\\SchCache\\*.dll","?:\\Windows\\Resources\\*.dll","?:\\Windows\\rescache\\*.dll","?:\\Windows\\Provisioning\\*.dll","?:\\Windows\\PrintDialog\\*.dll","?:\\Windows\\PolicyDefinitions\\*.dll","?:\\Windows\\media\\*.dll","?:\\Windows\\Globalization\\*.dll","?:\\Windows\\L2Schemas\\*.dll","?:\\Windows\\LiveKernelReports\\*.dll","?:\\Windows\\ModemLogs\\*.dll","?:\\Windows\\ImmersiveControlPanel\\*.dll","?:\\$Recycle.Bin\\*.dll") and 	 	 /* DLL loaded from the process.executable current directory */	 endswith~(substring(dll.path, 0, length(dll.path) - (length(dll.name) + 1)), substring(process.executable, 0, length(process.executable) - (length(process.name) + 1)))'''


<li><a href="#">DESCRIPTION = Identifies attempt to load an untrusted driver. Adversaries may modify code signing policies to enable execution of unsigned or self-signed code.

NAME = "Untrusted Driver Loaded"

QUERY = '''driver where host.os.type == "windows" and process.pid == 4 anddll.code_signature.trusted != true and not dll.code_signature.status : ("errorExpired", "errorRevoked")'''


<li><a href="#">DESCRIPTION = Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate filesand sometimes done by adversaries to hide malware.

NAME = "Unusual File Creation - Alternate Data Stream"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" andfile.path : "C:\\*:*" andnot file.path : ("C:\\*:zone.identifier*", "C:\\users\\*\\appdata\\roaming\\microsoft\\teams\\old_weblogs_*:$DATA") andnot process.executable :("?:\\windows\\System32\\svchost.exe", "?:\\Windows\\System32\\inetsrv\\w3wp.exe", "?:\\Windows\\explorer.exe", "?:\\Windows\\System32\\sihost.exe", "?:\\Windows\\System32\\PickerHost.exe", "?:\\Windows\\System32\\SearchProtocolHost.exe", "?:\\Program Files (x86)\\Dropbox\\Client\\Dropbox.exe", "?:\\Program Files\\Rivet Networks\\SmartByte\\SmartByteNetworkService.exe", "?:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", "?:\\Program Files\\ExpressConnect\\ExpressConnectNetworkService.exe", "?:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe", "?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", "?:\\Program Files\\Mozilla Firefox\\firefox.exe", "?:\\Program Files(x86)\\Microsoft Office\\root\\*\\EXCEL.EXE", "?:\\Program Files\\Microsoft Office\\root\\*\\EXCEL.EXE", "?:\\Program Files (x86)\\Microsoft Office\\root\\*\\OUTLOOK.EXE", "?:\\Program Files\\Microsoft Office\\root\\*\\OUTLOOK.EXE", "?:\\Program Files (x86)\\Microsoft Office\\root\\*\\POWERPNT.EXE", "?:\\Program Files\\Microsoft Office\\root\\*\\POWERPNT.EXE", "?:\\Program Files (x86)\\Microsoft Office\\root\\*\\WINWORD.EXE", "?:\\Program Files\\Microsoft Office\\root\\*\\WINWORD.EXE") andfile.extension :("pdf","dll","png","exe","dat","com","bat","cmd","sys","vbs","ps1","hta","txt","vbe","js","wsh","docx","doc","xlsx","xls","pptx","ppt","rtf","gif","jpg","png","bmp","img","iso")'''


<li><a href="#">DESCRIPTION = Identifies processes running from an Alternate Data Stream. This is uncommon for legitimate processes and sometimes doneby adversaries to hide malware.

NAME = "Unusual Process Execution Path - Alternate Data Stream"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.args : "?:\\*:*" and process.args_count == 1'''


<li><a href="#">DESCRIPTION = Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Commandand Control activity.

NAME = "Unusual Network Connection via DllHost"

QUERY = '''sequence by host.id, process.entity_id with maxspan=1m[process where host.os.type == "windows" and event.type == "start" and process.name : "dllhost.exe" and process.args_count == 1][network where host.os.type == "windows" and process.name : "dllhost.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24","192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24","192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10","192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10","FF00::/8")]'''


<li><a href="#">DESCRIPTION = Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Commandand Control activity.

NAME = "Unusual Network Connection via RunDLL32"

QUERY = '''sequence by host.id, process.entity_id with maxspan=1m[process where host.os.type == "windows" and event.type == "start" and process.name : "rundll32.exe" and process.args_count == 1][network where host.os.type == "windows" and process.name : "rundll32.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")]'''


<li><a href="#">DESCRIPTION = Identifies network activity from unexpected system applications. This may indicate adversarial activity as theseapplications are often leveraged by adversaries to execute code and evade detection.

NAME = "Unusual Process Network Connection"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and (process.name : "Microsoft.Workflow.Compiler.exe" orprocess.name : "bginfo.exe" orprocess.name : "cdb.exe" orprocess.name : "cmstp.exe" orprocess.name : "csi.exe" orprocess.name : "dnx.exe" orprocess.name : "fsi.exe" orprocess.name : "ieexec.exe" orprocess.name : "iexpress.exe" orprocess.name : "odbcconf.exe" orprocess.name : "rcsi.exe" orprocess.name : "xwizard.exe") and event.type == "start"][network where host.os.type == "windows" and (process.name : "Microsoft.Workflow.Compiler.exe" orprocess.name : "bginfo.exe" orprocess.name : "cdb.exe" orprocess.name : "cmstp.exe" orprocess.name : "csi.exe" orprocess.name : "dnx.exe" orprocess.name : "fsi.exe" orprocess.name : "ieexec.exe" orprocess.name : "iexpress.exe" orprocess.name : "odbcconf.exe" orprocess.name : "rcsi.exe" orprocess.name : "xwizard.exe")]'''


<li><a href="#">DESCRIPTION = "Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection."from =

NAME = "Unusual Child Process from a System Virtual Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.pid == 4 and process.executable : "?*" andnot process.executable : ("Registry", "MemCompression", "?:\\Windows\\System32\\smss.exe")'''


<li><a href="#">DESCRIPTION = The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evadedefenses.

NAME = "Potential Evasion via Filter Manager"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "fltMC.exe" and process.args : "unload" andnot((process.executable : "?:\\Program Files (x86)\\ManageEngine\\UEMS_Agent\\bin\\DCFAService64.exe" andprocess.args : ("DFMFilter", "DRMFilter")) or(process.executable : "?:\\Windows\\SysWOW64\\msiexec.exe" andprocess.args : ("BrFilter_*", "BrCow_*") anduser.id : "S-1-5-18"))'''


<li><a href="#">DESCRIPTION = Identifies multiple Windows Filtering Platform block events and where the process name is related to an endpoint security software. Adversaries may add malicious WFP rules to prevent Endpoint security from sending telemetry.

NAME = "Potential Evasion via Windows Filtering Platform"

QUERY = '''sequence by winlog.computer_name with maxspan=1m [network where host.os.type == "windows" and event.action : ("windows-firewall-packet-block", "windows-firewall-packet-drop") and process.name : ("bdagent.exe", "bdreinit.exe", "pdscan.exe", "pdiface.exe", "BDSubWiz.exe", "ProductAgentService.exe","ProductAgentUI.exe", "WatchDog.exe", "CarbonBlackClientSetup.exe", "TrGUI.exe", "TracCAPI.exe", "cpmsi_tool.exe","trac.exe", "vna_install64.exe", "vna_utils.exe", "TracSrvWrapper.exe", "vsmon.exe", "p95tray.exe","CybereasonRansomFreeServiceHost.exe", "CrAmTray.exe", "minionhost.exe", "CybereasonSensor.exe", "CylanceUI.exe","CylanceProtectSetup.exe", "cylancesvc.exe", "cyupdate.exe", "elastic-agent.exe", "elastic-endpoint.exe","egui.exe", "minodlogin.exe", "emu-rep.exe", "emu_install.exe", "emu-cci.exe", "emu-gui.exe", "emu-uninstall.exe","ndep.exe", "spike.exe", "ecls.exe", "ecmd.exe", "ecomserver.exe", "eeclnt.exe", "eh64.exe", "EHttpSrv.exe","xagt.exe", "collectoragent.exe", "FSAEConfig.exe", "uninstalldcagent.exe", "rmon.exe", "fccomint.exe","fclanguageselector.exe", "fortifw.exe", "fcreg.exe", "fortitray.exe", "fcappdb.exe", "fcwizard.exe", "submitv.exe","av_task.exe", "fortiwf.exe", "fortiwadbd.exe", "fcauth.exe", "fcdblog.exe", "fcmgr.exe", "fortiwad.exe","fortiproxy.exe", "fortiscand.exe", "fortivpnst.exe", "ipsec.exe", "fcwscd7.exe", "fcasc.exe", "fchelper.exe","forticlient.exe","fcwsc.exe", "FortiClient.exe", "fmon.exe", "FSSOMA.exe", "FCVbltScan.exe", "FortiESNAC.exe","EPCUserAvatar.exe", "FortiAvatar.exe", "FortiClient_Diagnostic_Tool.exe", "FortiSSLVPNdaemon.exe", "avp.exe","FCConfig.exe", "avpsus.exe", "klnagent.exe", "klnsacwsrv.exe", "kl_platf.exe", "stpass.exe", "klnagwds.exe","mbae.exe", "mbae64.exe", "mbae-svc.exe", "mbae-uninstaller.exe", "mbaeLoader32.exe", "mbaeloader64.exe","mbam-dor.exe", "mbamgui.exe", "mbamservice.exe", "mbamtrayctrl.exe", "mbampt.exe", "mbamscheduler.exe","Coreinst.exe", "mbae-setup.exe", "mcupdate.exe", "ProtectedModuleHost.exe", "ESConfigTool.exe", "FWInstCheck.exe","FwWindowsFirewallHandler.exe", "mfeesp.exe", "mfefw.exe", "mfeProvisionModeUtility.exe", "mfetp.exe", "avpui.exe", "WscAVExe.exe", "mcshield.exe", "McChHost.exe", "mfewc.exe", "mfewch.exe", "mfewcui.exe", "fwinfo.exe","mfecanary.exe", "mfefire.exe", "mfehidin.exe", "mfemms.exe", "mfevtps.exe", "mmsinfo.exe", "vtpinfo.exe","MarSetup.exe", "mctray.exe", "masvc.exe", "macmnsvc.exe", "McAPExe.exe", "McPvTray.exe", "mcods.exe","mcuicnt.exe", "mcuihost.exe", "xtray.exe", "McpService.exe", "epefprtrainer.exe", "mfeffcoreservice.exe","MfeEpeSvc.exe", "qualysagent.exe", "QualysProxy.exe", "QualysAgentUI.exe", "SVRTgui.exe", "SVRTcli.exe","SVRTcli.exe", "SVRTgui.exe", "SCTCleanupService.exe", "SVRTservice.exe", "native.exe", "SCTBootTasks.exe","ALMon.exe", "SAA.exe", "SUMService.exe", "ssp.exe", "SCFService.exe", "SCFManager.exe", "spa.exe", "cabarc.exe","sargui.exe", "sntpservice.exe", "McsClient.exe", "McsAgent.exe", "McsHeartbeat.exe", "SAVAdminService.exe","sav32cli.exe", "ForceUpdateAlongSideSGN.exe", "SAVCleanupService.exe", "SavMain.exe", "SavProgress.exe", "SavProxy.exe", "SavService.exe", "swc_service.exe", "swi_di.exe", "swi_service.exe", "swi_filter.exe","ALUpdate.exe", "SophosUpdate.exe", "ALsvc.exe", "SophosAlert.exe", "osCheck.exe", "N360Downloader.exe","InstWrap.exe", "symbos.exe", "nss.exe", "symcorpui.exe", "isPwdSvc.exe", "ccsvchst.exe", "ntrmv.exe","pccntmon.exe", "AosUImanager.exe", "NTRTScan.exe", "TMAS_OL.exe", "TMAS_OLImp.exe", "TMAS_OLSentry.exe","ufnavi.exe", "Clnrbin.exe", "vizorhtmldialog.exe", "pwmConsole.exe", "PwmSvc.exe", "coreServiceShell.exe","ds_agent.exe", "SfCtlCom.exe", "MBAMHelper.exe", "cb.exe", "smc.exe", "tda.exe", "xagtnotif.exe", "ekrn.exe","dsa.exe", "Notifier.exe", "rphcp.exe", "lc_sensor.exe", "CSFalconService.exe", "CSFalconController.exe","SenseSampleUploader.exe", "windefend.exe", "MSASCui.exe", "MSASCuiL.exe", "msmpeng.exe", "msmpsvc.exe","MsSense.exe", "esensor.exe", "sentinelone.exe", "tmccsf.exe", "csfalconcontainer.exe", "sensecncproxy.exe","splunk.exe", "sysmon.exe", "sysmon64.exe", "taniumclient.exe")] with runs=5'''


<li><a href="#">DESCRIPTION = Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current workingdirectory. Misuse of Windows Work Folders could indicate malicious activity.

NAME = "Signed Proxy Execution via MS Work Folders"

QUERY = '''process where host.os.type == "windows" and event.type == "start"and process.name : "control.exe" and process.parent.name : "WorkFolders.exe"and not process.executable : ("?:\\Windows\\System32\\control.exe", "?:\\Windows\\SysWOW64\\control.exe")'''


<li><a href="#">DESCRIPTION = Detects Linux Bash commands from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.

NAME = "Suspicious Execution via Windows Subsystem for Linux"

QUERY = '''process where host.os.type == "windows" and event.type : "start" and(((process.executable : "?:\\Windows\\System32\\bash.exe" or ?process.pe.original_file_name == "Bash.exe") and not process.command_line : ("bash", "bash.exe")) or process.executable : "?:\\Users\\*\\AppData\\Local\\Packages\\*\\rootfs\\usr\\bin\\bash" or (process.parent.name : "wsl.exe" and ?process.parent.command_line : "bash*" and not process.name : "wslhost.exe") or (process.name : "wsl.exe" and process.args : ("curl", "/etc/shadow", "/etc/passwd", "cat", "--system", "root", "-e", "--exec", "bash", "/mnt/c/*") and not process.args : ("wsl-bootstrap", "docker-desktop-data", "*.vscode-server*"))) and not process.parent.executable : ("?:\\Program Files\\Docker\\*.exe", "?:\\Program Files (x86)\\Docker\\*.exe")'''


<li><a href="#">DESCRIPTION = Detects attempts to execute a program on the host from the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.

NAME = "Execution via Windows Subsystem for Linux"

QUERY = '''process where host.os.type == "windows" and event.type : "start" andprocess.parent.name : ("wsl.exe", "wslhost.exe") andnot process.executable : ("?:\\Program Files (x86)\\*","?:\\Program Files\\*","?:\\Program Files*\\WindowsApps\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\wsl*.exe","?:\\Windows\\System32\\conhost.exe","?:\\Windows\\System32\\lxss\\wslhost.exe","?:\\Windows\\System32\\WerFault.exe","?:\\Windows\\Sys*\\wslconfig.exe")'''


<li><a href="#">DESCRIPTION = Detects attempts to enable the Windows Subsystem for Linux using Microsoft Dism utility. Adversaries may enable and use WSL for Linux to avoid detection.

NAME = "Windows Subsystem for Linux Enabled via Dism Utility"

QUERY = '''process where host.os.type == "windows" and event.type : "start" and (process.name : "Dism.exe" or ?process.pe.original_file_name == "DISM.EXE") andprocess.command_line : "*Microsoft-Windows-Subsystem-Linux*'''


<li><a href="#">DESCRIPTION = Detects files creation and modification on the host system from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.

NAME = "Host Files System Changes via Windows Subsystem for Linux"

QUERY = '''sequence by process.entity_id with maxspan=5m [process where host.os.type == "windows" and event.type == "start" andprocess.name : "dllhost.exe" and/* Plan9FileSystem CLSID - WSL Host File System Worker */process.command_line : "*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*"] [file where host.os.type == "windows" and process.name : "dllhost.exe" and not file.path : "?:\\Users\\*\\Downloads\\*"]'''


<li><a href="#">DESCRIPTION = Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.

NAME = "Attempt to Install Kali Linux via WSL"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and( (process.name : "wsl.exe" and process.args : ("-d", "--distribution", "-i", "--install") and process.args : "kali*") orprocess.executable : ("?:\\Users\\*\\AppData\\Local\\packages\\kalilinux*","?:\\Users\\*\\AppData\\Local\\Microsoft\\WindowsApps\\kali.exe", "?:\\Program Files*\\WindowsApps\\KaliLinux.*\\kali.exe") )'''


<li><a href="#">DESCRIPTION = Detects changes to the registry that indicates the install of a new Windows Subsystem for Linux distribution by name. Adversaries may enable and use WSL for Linux to avoid detection.

NAME = "Windows Subsystem for Linux Distribution Installed"

QUERY = '''registry where host.os.type == "windows" and registry.path :("HK*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Lxss\\*\\PackageFamilyName","\\REGISTRY\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Lxss\\*\\PackageFamilyName")'''


<li><a href="#">DESCRIPTION = Identifies processes loading Active Directory related modules followed by a network connection to the ADWS dedicated TCP port. Adversaries may abuse the ADWS Windows service that allows Active Directory to be queried via this web service.

NAME = "Potential Enumeration via Active Directory Web Service"

QUERY = '''sequence by process.entity_id with maxspan=3m [library where host.os.type == "windows" and dll.name : ("System.DirectoryServices*.dll", "System.IdentityModel*.dll") and not user.id in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and not process.executable : ("?:\\windows\\system32\\dsac.exe","?:\\program files\\powershell\\?\\pwsh.exe","?:\\windows\\system32\\windowspowershell\\*.exe","?:\\windows\\syswow64\\windowspowershell\\*.exe","?:\\program files\\microsoft monitoring agent\\*.exe","?:\\windows\\adws\\microsoft.activedirectory.webservices.exe")] [network where host.os.type == "windows" and destination.port == 9389 and source.port >= 49152 andnetwork.direction == "egress" and network.transport == "tcp" and not cidrmatch(destination.ip, "127.0.0.0/8", "::1/128")]'''


<li><a href="#">DESCRIPTION = This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequentlyleveraged by threat actors to perform post-exploitation Active Directory reconnaissance. The AdFind tool has beenobserved in Trickbot, Ryuk, Maze, and FIN6 campaigns. For Winlogbeat, this rule requires Sysmon.

NAME = "AdFind Command Activity"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "AdFind.exe" or ?process.pe.original_file_name == "AdFind.exe") andprocess.args : ("objectcategory=computer", "(objectcategory=computer)","objectcategory=person", "(objectcategory=person)","objectcategory=subnet", "(objectcategory=subnet)","objectcategory=group", "(objectcategory=group)","objectcategory=organizationalunit", "(objectcategory=organizationalunit)","objectcategory=attributeschema", "(objectcategory=attributeschema)","domainlist", "dcmodes", "adinfo", "dclist", "computers_pwnotreqd", "trustdmp")'''


<li><a href="#">DESCRIPTION = Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windowstools.

NAME = "Enumeration of Administrator Accounts"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and((((process.name : "net.exe" or ?process.pe.original_file_name == "net.exe") or((process.name : "net1.exe" or ?process.pe.original_file_name == "net1.exe") and not process.parent.name : "net.exe")) andprocess.args : ("group", "user", "localgroup") andprocess.args : ("*admin*", "Domain Admins", "Remote Desktop Users", "Enterprise Admins", "Organization Management")and not process.args : ("/add", "/delete")) or((process.name : "wmic.exe" or ?process.pe.original_file_name == "wmic.exe") andprocess.args : ("group", "useraccount"))) and not user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20")'''


<li><a href="#">DESCRIPTION = Identifies when the SYSTEM account uses an account discovery utility. This could be a sign of discovery activity afteran adversary has achieved privilege escalation.

NAME = "Account Discovery Command via SYSTEM Account"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(?process.Ext.token.integrity_level_name : "System" or?winlog.event_data.IntegrityLevel : "System") and(process.name : "whoami.exe" or(process.name : "net1.exe" and not process.parent.name : "net.exe" and not process.args : ("start", "stop", "/active:*")))'''


<li><a href="#">DESCRIPTION = Identifies the use of dsquery.exe for domain trust discovery purposes. Adversaries may use this command-line utility toenumerate trust relationships that may be used for Lateral Movement opportunities in Windows multi-domain forestenvironments.

NAME = "Enumerating Domain Trusts via DSQUERY.EXE"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "dsquery.exe" or ?process.pe.original_file_name: "dsquery.exe") and process.args : "*objectClass=trustedDomain*'''


<li><a href="#">DESCRIPTION = Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility toenumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC)replication in a Microsoft Windows NT Domain.

NAME = "Enumerating Domain Trusts via NLTEST.EXE"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "nltest.exe" and process.args : ("/DCLIST:*", "/DCNAME:*", "/DSGET*","/LSAQUERYFTI:*", "/PARENTDOMAIN","/DOMAIN_TRUSTS", "/BDC_QUERY:*") and not process.parent.name : "PDQInventoryScanner.exe" and not user.id in ("S-1-5-18", "S-1-5-19", "S-1-5-20")'''


<li><a href="#">DESCRIPTION = Detects the usage of gpresult.exe to query group policy objects. Attackers may query group policy objects during the reconnaissance phase after compromising a system to gain a better understanding of the active directory environment and possible methods to escalate privileges or move laterally. from =

NAME = "Group Policy Discovery via Microsoft GPResult Utility"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name: "gpresult.exe" or ?process.pe.original_file_name == "gprslt.exe") and process.args: ("/z", "/v", "/r", "/x")'''


<li><a href="#">DESCRIPTION = Identifies use of the Windows file system utility (fsutil.exe) to gather information about attached peripheral devicesand components connected to a computer system.

NAME = "Peripheral Device Discovery"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "fsutil.exe" or ?process.pe.original_file_name == "fsutil.exe") andprocess.args : "fsinfo" and process.args : "drives'''


<li><a href="#">DESCRIPTION = Detects scripts that contain PowerShell functions, structures, or Windows API functions related to windows shareenumeration activities. Attackers, mainly ransomware groups, commonly identify and inspect network shares, looking forcritical information for encryption and/or exfiltration.

NAME = "PowerShell Share Enumeration Script"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text:("Invoke-ShareFinder" or"Invoke-ShareFinderThreaded" or("shi1_netname" and"shi1_remark") or("NetShareEnum" and"NetApiBufferFree")) and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = This rule detects the use of discovery-related Windows API functions in PowerShell Scripts. Attackers can use thesefunctions to perform various situational awareness related activities, like enumerating users, shares, sessions, domaintrusts, groups, etc.

NAME = "PowerShell Suspicious Discovery Related Windows API Functions"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : (NetShareEnum orNetWkstaUserEnum orNetSessionEnum orNetLocalGroupEnum orNetLocalGroupGetMembers orDsGetSiteName orDsEnumerateDomainTrusts orWTSEnumerateSessionsEx orWTSQuerySessionInformation orLsaGetLogonSessionData orQueryServiceObjectSecurity orGetComputerNameEx orNetWkstaGetInfo orGetUserNameEx orNetUserEnum orNetUserGetInfo orNetGroupEnum orNetGroupGetInfo orNetGroupGetUsers orNetWkstaTransportEnum orNetServerGetInfo orLsaEnumerateTrustedDomainsorNetScheduleJobEnum orNetUserModalsGet)and not file.path : ?\:\\\\ProgramData\\\\Microsoft\\\\Windows?Defender?Advanced?Threat?Protection\\\\DataCollection\\\\*'''


<li><a href="#">DESCRIPTION = '''This rule identifies a potential network sweep.A network sweep is a method used by attackers to scan a targetnetwork, identifying active hosts, open ports, and available services to gather information on vulnerabilities andweaknesses. This reconnaissance helps them plan subsequent attacks and exploit potential entry points for unauthorizedaccess, data theft, or other malicious activities. This rule proposes threshold logic to check for connection attemptsfrom one source host to 10 or more destination hosts on commonly used network services.'''from =

NAME = "Potential Network Sweep Detected"

QUERY = '''destination.port : (21 or 22 or 23 or 25 or 139 or 445 or 3389 or 5985 or 5986) andsource.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = '''This rule identifies a potential port scan. A port scan is a method utilized by attackers to systematically scan atarget system or network for open ports, allowing them to identify available services and potential vulnerabilities.By mapping out the open ports, attackers can gather critical information to plan and execute targeted attacks, gainingunauthorized access, compromising security, and potentially leading to data breaches, unauthorized control, or furtherexploitation of the targeted system or network. This rule proposes threshold logic to check for connection attemptsfrom one source host to 20 or more destination ports.'''from =

NAME = "Potential Network Scan Detected"

QUERY = '''destination.port : * and event.action : "network_flow" and source.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = '''This rule identifies a potential SYN-Based port scan. A SYN port scan is a technique employed by attackers to scan atarget network for open ports by sending SYN packets to multiple ports and observing the response.Attackers use this method to identify potential entry points or services that may be vulnerable to exploitation,allowing them to launch targeted attacks or gain unauthorized access to the system or network, compromising itssecurity and potentially leading to data breaches or further malicious activities. This rule proposes threshold logicto check for connection attempts from one source host to 10 or more destination ports using 2 or less packets per port.'''from =

NAME = "Potential SYN-Based Network Scan Detected"

QUERY = '''destination.port : * and network.packets <= 2 and source.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = Identifies instances of an unusual process enumerating built-in Windows privileged local groups membership likeAdministrators or Remote Desktop users.

NAME = "Enumeration of Privileged Local Groups Membership"

QUERY = '''host.os.type:windows and event.category:iam and event.action:user-member-enumerated and (group.name:(*Admin* or "RemoteDesktopUsers") orwinlog.event_data.TargetSid:("S-1-5-32-544" or "S-1-5-32-555")) and not (winlog.event_data.SubjectUserName: *$ orwinlog.event_data.SubjectUserSid: ("S-1-5-19" or "S-1-5-20") or winlog.event_data.CallerProcessName:("-" or*\:\\\\Windows\\\\System32\\\\VSSVC.exe or*\:\\\\Windows\\\\System32\\\\SearchIndexer.exe or*\:\\\\Windows\\\\System32\\\\CompatTelRunner.exe or*\:\\\\Windows\\\\System32\\\\oobe\\\\msoobe.exe or *\:\\\\Windows\\\\System32\\\\net1.exe or*\:\\\\Windows\\\\System32\\\\svchost.exe or*\:\\\\Windows\\\\System32\\\\Netplwiz.exe or*\:\\\\Windows\\\\System32\\\\msiexec.exe or *\:\\\\Windows\\\\System32\\\\CloudExperienceHostBroker.exe or *\:\\\\Windows\\\\System32\\\\RuntimeBroker.exe or *\:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe or *\:\\\\Windows\\\\System32\\\\SrTasks.exe or *\:\\\\Windows\\\\System32\\\\diskshadow.exe or *\:\\\\Windows\\\\System32\\\\dfsrs.exe or *\:\\\\Windows\\\\System32\\\\vssadmin.exe or *\:\\\\Windows\\\\System32\\\\dllhost.exe or *\:\\\\Windows\\\\System32\\\\mmc.exe or *\:\\\\Windows\\\\System32\\\\SettingSyncHost.exe or *\:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe or *\:\\\\Windows\\\\System32\\\\wsmprovhost.exe or *\:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\x3jobt3?.exe or *\:\\\\Windows\\\\System32\\\\mstsc.exe or *\:\\\\Windows\\\\System32\\\\esentutl.exe or *\:\\\\Windows\\\\System32\\\\RecoveryDrive.exe or *\:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe or *\:\\\\Windows\\\\SysWOW64\\\\msiexec.exe or *\:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe or *\:\\\\Windows\\\\Temp\\\\rubrik_vmware???\\\\snaptool.exe or *\:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe or ?\:\\\\WindowsAzure\\\\*WaAppAgent.exe or ?\:\\\\Program?Files?\(x86\)\\\\*.exe or ?\:\\\\Program?Files\\\\*.exe or ?\:\\\\$WINDOWS.~BT\\\\Sources\\\\*.exe))'''


<li><a href="#">DESCRIPTION = Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirusor Host Firewall details.

NAME = "Security Software Discovery via Grep"

QUERY = '''process where event.type == "start" andprocess.name : "grep" and user.id != "0" and not process.parent.executable : ("/Library/Application Support/*", "/opt/McAfee/agent/scripts/ma") and process.args : ("Little Snitch*","Avast*","Avira*","ESET*","BlockBlock*","360Sec*","LuLu*","KnockKnock*","kav","KIS","RTProtectionDaemon*","Malware*","VShieldScanner*","WebProtection*","webinspectord*","McAfee*","isecespd*","macmnsvc*","masvc*","kesl*","avscan*","guard*","rtvscand*","symcfgd*","scmdaemon*","symantec*","sophos*","osquery*","elastic-endpoint*") and not ( (process.args : "Avast" and process.args : "Passwords") or (process.parent.args : "/opt/McAfee/agent/scripts/ma" and process.parent.args : "checkhealth") or (process.command_line : ( "grep ESET Command-line scanner, version %s -A2", "grep -i McAfee Web Gateway Core version:", "grep --color=auto ESET Command-line scanner, version %s -A2" ) ) or (process.parent.command_line : ( sh -c printf "command_start_%s"*; perl -pe 's/[^ -~]/\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1; printf "command_done_%s*, bash -c perl -pe 's/[^ -~]/\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1 ) ))'''


<li><a href="#">DESCRIPTION = This rule leverages alert data from various Discovery building block rules to alert on signals with unusual uniquehost.id, user.id and process.command_line entries.

NAME = "Unusual Discovery Signal Alert with Unusual Process Command Line"

QUERY = '''host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:("d68e95ad-1c82-4074-a12a-125fe10ac8ba" or "7b8bfc26-81d2-435e-965c-d722ee397ef1" or"0635c542-1b96-4335-9b47-126582d2c19a" or "6ea55c81-e2ba-42f2-a134-bccf857ba922" or"e0881d20-54ac-457f-8733-fe0bc5d44c55" or "06568a02-af29-4f20-929c-f3af281e41aa" or"c4e9ed3e-55a2-4309-a012-bc3c78dad10a" or "51176ed2-2d90-49f2-9f3d-17196428b169")'''


<li><a href="#">DESCRIPTION = This rule leverages Discovery building block rule alert data to alert on signals with unusual unique host.id, user.idand process.executable entries.

NAME = "Unusual Discovery Signal Alert with Unusual Process Executable"

QUERY = '''host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:"1d72d014-e2ab-4707-b056-9b96abe7b511'''


<li><a href="#">DESCRIPTION = An adversary may attempt to get detailed information about the operating system and hardware. This rule identifiescommon locations used to discover virtual machine hardware by a non-root user. This technique has been used by the PupyRAT and other malware.

NAME = "Virtual Machine Fingerprinting via Grep"

QUERY = '''process where event.type == "start" and process.name in ("grep", "egrep") and user.id != "0" and process.args : ("parallels*", "vmware*", "virtualbox*") and process.args : "Manufacturer*" and not process.parent.executable in ("/Applications/Docker.app/Contents/MacOS/Docker", "/usr/libexec/kcare/virt-what")'''


<li><a href="#">DESCRIPTION = Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who iscurrently logged on to the local system.

NAME = "Whoami Process Activity"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.name : "whoami.exe" and((/* scoped for whoami execution under system privileges */(user.domain : ("NT *", "* NT", "IIS APPPOOL") anduser.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20", "S-1-5-82-*") andnot ?winlog.event_data.SubjectUserName : "*$") andnot (process.parent.name : "cmd.exe" andprocess.parent.args : ("chcp 437>nul 2>&1 & C:\\WINDOWS\\System32\\whoami.exe/groups","chcp 437>nul 2>&1 & %systemroot%\\system32\\whoami /user","C:\\WINDOWS\\System32\\whoami.exe /groups","*WINDOWS\\system32\\config\\systemprofile*")) andnot (process.parent.executable : "C:\\Windows\\system32\\inetsrv\\appcmd.exe" and process.parent.args : "LIST") andnot process.parent.executable : ("C:\\Program Files\\Microsoft Monitoring Agent\\Agent\\MonitoringHost.exe","C:\\Program Files\\Cohesity\\cohesity_windows_agent_service.exe")) orprocess.parent.name : ("wsmprovhost.exe", "w3wp.exe", "wmiprvse.exe", "rundll32.exe", "regsvr32.exe"))'''


<li><a href="#">DESCRIPTION = "A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected."false_positives =

NAME = "Command Execution via SolarWinds Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.name: ("cmd.exe", "powershell.exe") andprocess.parent.name: ( "ConfigurationWizard*.exe", "NetflowDatabaseMaintenance*.exe", "NetFlowService*.exe", "SolarWinds.Administration*.exe", "SolarWinds.Collector.Service*.exe", "SolarwindsDiagnostics*.exe" )'''


<li><a href="#">DESCRIPTION = "A suspicious SolarWinds child process was detected, which may indicate an attempt to execute malicious programs."false_positives =

NAME = "Suspicious SolarWinds Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name: ("SolarWinds.BusinessLayerHost.exe", "SolarWinds.BusinessLayerHostx64.exe") and not (process.name : ("APMServiceControl*.exe","ExportToPDFCmd*.Exe","SolarWinds.Credentials.Orion.WebApi*.exe","SolarWinds.Orion.Topology.Calculator*.exe","Database-Maint.exe","SolarWinds.Orion.ApiPoller.Service.exe","WerFault.exe","WerMgr.exe","SolarWinds.BusinessLayerHost.exe","SolarWinds.BusinessLayerHostx64.exe","SolarWinds.Topology.Calculator.exe","SolarWinds.Topology.Calculatorx64.exe","SolarWinds.APM.RealTimeProcessPoller.exe") andprocess.code_signature.trusted == true ) and not process.executable : ("?:\\Windows\\SysWOW64\\ARP.EXE", "?:\\Windows\\SysWOW64\\lodctr.exe", "?:\\Windows\\SysWOW64\\unlodctr.exe")'''


<li><a href="#">DESCRIPTION = Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows applicationprogramming interface (API) that enables interaction between software objects or executable code. Xwizard can be used torun a COM object created in registry to evade defensive counter measures.

NAME = "Execution of COM object via Xwizard"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : "xwizard.exe" or ?process.pe.original_file_name : "xwizard.exe") and ( (process.args : "RunWizard" and process.args : "{*}") or (process.executable != null and not process.executable : ("C:\\Windows\\SysWOW64\\xwizard.exe", "C:\\Windows\\System32\\xwizard.exe") ) )'''


<li><a href="#">DESCRIPTION = Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from aremote URL.

NAME = "Command Prompt Network Connection"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and process.name : "cmd.exe" and event.type == "start"][network where host.os.type == "windows" and process.name : "cmd.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24","192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32","192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24","192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1","FE80::/10", "FF00::/8") andnot dns.question.name : ("wpad", "localhost", "ocsp.comodoca.com", "ocsp.digicert.com", "ocsp.sectigo.com", "crl.comodoca.com")]'''


<li><a href="#">DESCRIPTION = "Identifies a suspicious parent child process relationship with cmd.exe descending from svchost.exe"from =

NAME = "Svchost spawning Cmd"

QUERY = '''host.os.type:windows and event.category:process and event.type:start and process.parent.name:"svchost.exe" and process.name:("cmd.exe" or "Cmd.exe" or "CMD.EXE")'''


<li><a href="#">DESCRIPTION = "Identifies a suspicious parent child process relationship with cmd.exe descending from an unusual process."from =

NAME = "Unusual Parent Process for cmd.exe"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "cmd.exe" andprocess.parent.name : ("lsass.exe", "csrss.exe", "epad.exe", "regsvr32.exe", "dllhost.exe", "LogonUI.exe", "wermgr.exe", "spoolsv.exe", "jucheck.exe", "jusched.exe", "ctfmon.exe", "taskhostw.exe", "GoogleUpdate.exe", "sppsvc.exe", "sihost.exe", "slui.exe", "SIHClient.exe", "SearchIndexer.exe", "SearchProtocolHost.exe", "FlashPlayerUpdateService.exe", "WerFault.exe", "WUDFHost.exe", "unsecapp.exe", "wlanext.exe" ) andnot (process.parent.name : "dllhost.exe" and process.parent.args : "/Processid:{CA8C87C1-929D-45BA-94DB-EF8E6CB346AD}")'''


<li><a href="#">DESCRIPTION = "Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code."false_positives =

NAME = "Command Shell Activity Started via RunDLL32"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.name : ("cmd.exe", "powershell.exe") andprocess.parent.name : "rundll32.exe" and process.parent.command_line != null and/* common FPs can be added here */not process.parent.args : ("C:\\Windows\\System32\\SHELL32.dll,RunAsNewUser_RunDLL", "C:\\WINDOWS\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc")'''


<li><a href="#">DESCRIPTION = Identifies native Windows host and network enumeration commands spawned by the Windows Management InstrumentationProvider Service (WMIPrvSE).

NAME = "Enumeration Command Spawned via WMIPrvSE"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.command_line != null and process.name:("arp.exe","dsquery.exe","dsget.exe","gpresult.exe","hostname.exe","ipconfig.exe","nbtstat.exe","net.exe","net1.exe","netsh.exe","netstat.exe","nltest.exe","ping.exe","qprocess.exe","quser.exe","qwinsta.exe","reg.exe","sc.exe","systeminfo.exe","tasklist.exe","tracert.exe","whoami.exe") andprocess.parent.name:"wmiprvse.exe" and not (process.name : "sc.exe" and process.args : "RemoteRegistry" and process.args : "start=" and process.args : ("demand", "disabled")) andnot process.args : "tenable_mw_scan'''


<li><a href="#">DESCRIPTION = Identifies process execution from suspicious default Windows directories. This may be abused by adversaries to hidemalware in trusted paths.

NAME = "Execution from Unusual Directory - Command Line"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : ("wscript.exe","cscript.exe","rundll32.exe","regsvr32.exe","cmstp.exe","RegAsm.exe","installutil.exe","mshta.exe","RegSvcs.exe","powershell.exe","pwsh.exe","cmd.exe") and/* add suspicious execution paths here */process.args : ("C:\\PerfLogs\\*","C:\\Users\\Public\\*","C:\\Windows\\Tasks\\*","C:\\Intel\\*","C:\\AMD\\Temp\\*","C:\\Windows\\AppReadiness\\*","C:\\Windows\\ServiceState\\*","C:\\Windows\\security\\*","C:\\Windows\\IdentityCRL\\*","C:\\Windows\\Branding\\*","C:\\Windows\\csc\\*","C:\\Windows\\DigitalLocker\\*","C:\\Windows\\en-US\\*","C:\\Windows\\wlansvc\\*","C:\\Windows\\Prefetch\\*","C:\\Windows\\Fonts\\*","C:\\Windows\\diagnostics\\*","C:\\Windows\\TAPI\\*","C:\\Windows\\INF\\*","C:\\Windows\\System32\\Speech\\*","C:\\windows\\tracing\\*","c:\\windows\\IME\\*","c:\\Windows\\Performance\\*","c:\\windows\\intel\\*","c:\\windows\\ms\\*","C:\\Windows\\dot3svc\\*","C:\\Windows\\panther\\*","C:\\Windows\\RemotePackages\\*","C:\\Windows\\OCR\\*","C:\\Windows\\appcompat\\*","C:\\Windows\\apppatch\\*","C:\\Windows\\addins\\*","C:\\Windows\\Setup\\*","C:\\Windows\\Help\\*","C:\\Windows\\SKB\\*","C:\\Windows\\Vss\\*","C:\\Windows\\servicing\\*","C:\\Windows\\CbsTemp\\*","C:\\Windows\\Logs\\*","C:\\Windows\\WaaS\\*","C:\\Windows\\twain_32\\*","C:\\Windows\\ShellExperiences\\*","C:\\Windows\\ShellComponents\\*","C:\\Windows\\PLA\\*","C:\\Windows\\Migration\\*","C:\\Windows\\debug\\*","C:\\Windows\\Cursors\\*","C:\\Windows\\Containers\\*","C:\\Windows\\Boot\\*","C:\\Windows\\bcastdvr\\*","C:\\Windows\\TextInput\\*","C:\\Windows\\security\\*","C:\\Windows\\schemas\\*","C:\\Windows\\SchCache\\*","C:\\Windows\\Resources\\*","C:\\Windows\\rescache\\*","C:\\Windows\\Provisioning\\*","C:\\Windows\\PrintDialog\\*","C:\\Windows\\PolicyDefinitions\\*","C:\\Windows\\media\\*","C:\\Windows\\Globalization\\*","C:\\Windows\\L2Schemas\\*","C:\\Windows\\LiveKernelReports\\*","C:\\Windows\\ModemLogs\\*","C:\\Windows\\ImmersiveControlPanel\\*","C:\\$Recycle.Bin\\*") and/* noisy FP patterns */not process.parent.executable : ("C:\\WINDOWS\\System32\\DriverStore\\FileRepository\\*\\igfxCUIService*.exe", "C:\\Windows\\System32\\spacedeskService.exe", "C:\\Program Files\\Dell\\SupportAssistAgent\\SRE\\SRE.exe") andnot (process.name : "rundll32.exe" and process.args : ("uxtheme.dll,#64", "PRINTUI.DLL,PrintUIEntry", "?:\\Windows\\System32\\FirewallControlPanel.dll,ShowNotificationDialog", "?:\\WINDOWS\\system32\\Speech\\SpeechUX\\sapi.cpl", "?:\\Windows\\system32\\shell32.dll,OpenAs_RunDLL")) andnot (process.name : "cscript.exe" and process.args : "?:\\WINDOWS\\system32\\calluxxprovider.vbs") andnot (process.name : "cmd.exe" and process.args : "?:\\WINDOWS\\system32\\powercfg.exe" and process.args : "?:\\WINDOWS\\inf\\PowerPlan.log") andnot (process.name : "regsvr32.exe" and process.args : "?:\\Windows\\Help\\OEM\\scripts\\checkmui.dll") andnot (process.name : "cmd.exe" and process.parent.executable : ("?:\\Windows\\System32\\oobe\\windeploy.exe","?:\\Program Files (x86)\\ossec-agent\\wazuh-agent.exe","?:\\Windows\\System32\\igfxCUIService.exe","?:\\Windows\\Temp\\IE*.tmp\\IE*-support\\ienrcore.exe"))'''


<li><a href="#">DESCRIPTION = Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may concealmalicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executableprogram (hh.exe).

NAME = "Network Connection via Compiled HTML File"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and process.name : "hh.exe" and event.type == "start"][network where host.os.type == "windows" and process.name : "hh.exe" and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8") and not dns.question.name : "localhost"]'''


<li><a href="#">DESCRIPTION = Identifies an executable created by a Microsoft Office application and subsequently executed. These processes are oftenlaunched via scripts inside documents or during exploitation of Microsoft Office applications.

NAME = "Execution of File Written or Modified by Microsoft Office"

QUERY = '''sequence with maxspan=2h[file where host.os.type == "windows" and event.type != "deletion" and file.extension : "exe" and (process.name : "WINWORD.EXE" orprocess.name : "EXCEL.EXE" orprocess.name : "OUTLOOK.EXE" orprocess.name : "POWERPNT.EXE" orprocess.name : "eqnedt32.exe" orprocess.name : "fltldr.exe" orprocess.name : "MSPUB.EXE" orprocess.name : "MSACCESS.EXE")] by host.id, file.path[process where host.os.type == "windows" and event.type == "start" andnot (process.name : "NewOutlookInstaller.exe" and process.code_signature.subject_name : "Microsoft Corporation" and process.code_signature.trusted == true)] by host.id, process.executable'''


<li><a href="#">DESCRIPTION = Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes areoften launched via exploitation of PDF applications.

NAME = "Execution of File Written or Modified by PDF Reader"

QUERY = '''sequence with maxspan=2h[file where host.os.type == "windows" and event.type != "deletion" and file.extension : "exe" and (process.name : "AcroRd32.exe" orprocess.name : "rdrcef.exe" orprocess.name : "FoxitPhantomPDF.exe" orprocess.name : "FoxitReader.exe") and not (file.name : "FoxitPhantomPDF.exe" orfile.name : "FoxitPhantomPDFUpdater.exe" orfile.name : "FoxitReader.exe" orfile.name : "FoxitReaderUpdater.exe" orfile.name : "AcroRd32.exe" orfile.name : "rdrcef.exe")] by host.id, file.path[process where host.os.type == "windows" and event.type == "start"] by host.id, process.executable'''


<li><a href="#">DESCRIPTION = "Identifies the execution of and EggShell Backdoor. EggShell is a known post exploitation tool for macOS and Linux."from =

NAME = "EggShell Backdoor Execution"

QUERY = '''event.category:process and event.type:(process_started or start) and process.name:espl and process.args:eyJkZWJ1ZyI6*'''


<li><a href="#">DESCRIPTION = Detects known PowerShell offensive tooling functions names in PowerShell scripts. Attackers commonly use out-of-the-boxoffensive tools without modifying the code. This rule aim is to take advantage of that.

NAME = "Potential PowerShell HackTool Script by Function Names"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : ("Add-DomainGroupMember" or "Add-DomainObjectAcl" or"Add-RemoteConnection" or "Add-ServiceDacl" or"Add-Win32Type" or "Convert-ADName" or"Convert-LDAPProperty" or "ConvertFrom-LDAPLogonHours" or"ConvertFrom-UACValue" or "Copy-ArrayOfMemAddresses" or"Create-NamedPipe" or "Create-ProcessWithToken" or"Create-RemoteThread" or "Create-SuspendedWinLogon" or"Create-WinLogonProcess" or "Emit-CallThreadStub" or"Enable-SeAssignPrimaryTokenPrivilege" or "Enable-SeDebugPrivilege" or"Enum-AllTokens" or "Export-PowerViewCSV" or"Find-AVSignature" or "Find-AppLockerLog" or"Find-DomainLocalGroupMember" or "Find-DomainObjectPropertyOutlier" or"Find-DomainProcess" or "Find-DomainShare" or"Find-DomainUserEvent" or "Find-DomainUserLocation" or"Find-InterestingDomainAcl" or "Find-InterestingDomainShareFile" or"Find-InterestingFile" or "Find-LocalAdminAccess" or"Find-PSScriptsInPSAppLog" or "Find-PathDLLHijack" or"Find-ProcessDLLHijack" or "Find-RDPClientConnection" or"Get-AllAttributesForClass" or "Get-CachedGPPPassword" or"Get-DecryptedCpassword" or "Get-DecryptedSitelistPassword" or"Get-DelegateType" or"Get-DomainDFSShare" or "Get-DomainDFSShareV1" or"Get-DomainDFSShareV2" or "Get-DomainDNSRecord" or"Get-DomainDNSZone" or "Get-DomainFileServer" or"Get-DomainForeignGroupMember" or "Get-DomainForeignUser" or"Get-DomainGPO" or "Get-DomainGPOComputerLocalGroupMapping" or"Get-DomainGPOLocalGroup" or "Get-DomainGPOUserLocalGroupMapping" or"Get-DomainGUIDMap" or "Get-DomainGroup" or"Get-DomainGroupMember" or "Get-DomainGroupMemberDeleted" or"Get-DomainManagedSecurityGroup" or "Get-DomainOU" or"Get-DomainObject" or "Get-DomainObjectAcl" or"Get-DomainObjectAttributeHistory" or "Get-DomainObjectLinkedAttributeHistory" or"Get-DomainPolicyData" or "Get-DomainSID" or"Get-DomainSPNTicket" or "Get-DomainSearcher" or"Get-DomainSite" or "Get-DomainSubnet" or"Get-DomainTrust" or "Get-DomainTrustMapping" or"Get-DomainUser" or "Get-DomainUserEvent" or"Get-Forest" or "Get-ForestDomain" or"Get-ForestGlobalCatalog" or "Get-ForestSchemaClass" or"Get-ForestTrust" or "Get-GPODelegation" or"Get-GPPAutologon" or "Get-GPPInnerField" or"Get-GPPInnerFields" or "Get-GPPPassword" or"Get-GptTmpl" or "Get-GroupsXML" or"Get-HttpStatus" or "Get-ImageNtHeaders" or"Get-Keystrokes" or"Get-MemoryProcAddress" or "Get-MicrophoneAudio" or"Get-ModifiablePath" or "Get-ModifiableRegistryAutoRun" or"Get-ModifiableScheduledTaskFile" or "Get-ModifiableService" or"Get-ModifiableServiceFile" or "Get-Name" or"Get-NetComputerSiteName" or "Get-NetLocalGroup" or"Get-NetLocalGroupMember" or "Get-NetLoggedon" or"Get-NetRDPSession" or "Get-NetSession" or"Get-NetShare" or "Get-PEArchitecture" or"Get-PEBasicInfo" or "Get-PEDetailedInfo" or"Get-PathAcl" or "Get-PrimaryToken" or"Get-ProcAddress" or "Get-ProcessTokenGroup" or"Get-ProcessTokenPrivilege" or "Get-ProcessTokenType" or"Get-RegLoggedOn" or "Get-RegistryAlwaysInstallElevated" or"Get-RegistryAutoLogon" or "Get-RemoteProcAddress" or"Get-Screenshot" or "Get-ServiceDetail" or"Get-SiteListPassword" or "Get-SitelistField" or"Get-System" or "Get-SystemNamedPipe" or"Get-SystemToken" or "Get-ThreadToken" or"Get-TimedScreenshot" or "Get-TokenInformation" or"Get-TopPort" or "Get-UnattendedInstallFile" or"Get-UniqueTokens" or "Get-UnquotedService" or"Get-VaultCredential" or "Get-VaultElementValue" or"Get-VirtualProtectValue" or "Get-VolumeShadowCopy" or"Get-WMIProcess" or "Get-WMIRegCachedRDPConnection" or"Get-WMIRegLastLoggedOn" or "Get-WMIRegMountedDrive" or"Get-WMIRegProxy" or "Get-WebConfig" or"Get-Win32Constants" or "Get-Win32Functions" or"Get-Win32Types" or "Import-DllImports" or"Import-DllInRemoteProcess" or "Inject-LocalShellcode" or"Inject-RemoteShellcode" or "Install-ServiceBinary" or"Invoke-CompareAttributesForClass" or "Invoke-CreateRemoteThread" or"Invoke-CredentialInjection" or "Invoke-DllInjection" or"Invoke-EventVwrBypass" or "Invoke-ImpersonateUser" or"Invoke-Kerberoast" or "Invoke-MemoryFreeLibrary" or"Invoke-MemoryLoadLibrary" or"Invoke-Mimikatz" or "Invoke-NinjaCopy" or"Invoke-PatchDll" or "Invoke-Portscan" or"Invoke-PrivescAudit" or "Invoke-ReflectivePEInjection" or"Invoke-ReverseDnsLookup" or "Invoke-RevertToSelf" or"Invoke-ServiceAbuse" or "Invoke-Shellcode" or"Invoke-TokenManipulation" or "Invoke-UserImpersonation" or"Invoke-WmiCommand" or "Mount-VolumeShadowCopy" or"New-ADObjectAccessControlEntry" or "New-DomainGroup" or"New-DomainUser" or "New-DynamicParameter" or"New-InMemoryModule" or"New-ThreadedFunction" or "New-VolumeShadowCopy" or"Out-CompressedDll" or "Out-EncodedCommand" or"Out-EncryptedScript" or "Out-Minidump" or"PortScan-Alive" or "Portscan-Port" or"Remove-DomainGroupMember" or "Remove-DomainObjectAcl" or"Remove-RemoteConnection" or "Remove-VolumeShadowCopy" or"Restore-ServiceBinary" or "Set-DesktopACLToAllowEveryone" or"Set-DesktopACLs" or "Set-DomainObject" or"Set-DomainObjectOwner" or "Set-DomainUserPassword" or"Set-ServiceBinaryPath" or "Sub-SignedIntAsUnsigned" or"Test-AdminAccess" or "Test-MemoryRangeValid" or"Test-ServiceDaclPermission" or "Update-ExeFunctions" or"Update-MemoryAddresses" or "Update-MemoryProtectionFlags" or"Write-BytesToMemory" or "Write-HijackDll" or"Write-PortscanOut" or "Write-ServiceBinary" or"Write-UserAddMSI" or "Invoke-Privesc" or"func_get_proc_address" or "Invoke-BloodHound" or"Invoke-HostEnum" or "Get-BrowserInformation" or"Get-DomainAccountPolicy" or "Get-DomainAdmins" or"Get-AVProcesses" or "Get-AVInfo" or"Get-RecycleBin" or "Invoke-BruteForce" or"Get-PassHints" or "Invoke-SessionGopher" or"Get-LSASecret" or "Get-PassHashes" or"Invoke-WdigestDowngrade" or "Get-ChromeDump" or"Invoke-DomainPasswordSpray" or "Get-FoxDump" or"New-HoneyHash" or "Invoke-DCSync" or"Invoke-PowerDump" or "Invoke-SSIDExfil" or"Invoke-PowerShellTCP" or "Add-Exfiltration" or"Do-Exfiltration" or "Invoke-DropboxUpload" or"Invoke-ExfilDataToGitHub" or "Invoke-EgressCheck" or"Invoke-PostExfil" or "Create-MultipleSessions" or"Invoke-NetworkRelay" or "New-GPOImmediateTask" or"Invoke-WMIDebugger" or "Invoke-SQLOSCMD" or"Invoke-SMBExec" or "Invoke-PSRemoting" or"Invoke-ExecuteMSBuild" or "Invoke-DCOM" or"Invoke-InveighRelay" or "Invoke-PsExec" or"Invoke-SSHCommand" or "Find-ActiveUsersWMI" or"Get-SystemDrivesWMI" or "Get-ActiveNICSWMI" or"Remove-Persistence" or "DNS_TXT_Pwnage" or"Execute-OnTime" or "HTTP-Backdoor" or"Add-ConstrainedDelegationBackdoor" or "Add-RegBackdoor" or"Add-ScrnSaveBackdoor" or "Gupt-Backdoor" or"Invoke-ADSBackdoor" or "Add-Persistence" or"Invoke-ResolverBackdoor" or "Invoke-EventLogBackdoor" or"Invoke-DeadUserBackdoor" or "Invoke-DisableMachineAcctChange" or"Invoke-AccessBinary" or "Add-NetUser" or"Invoke-Schtasks" or "Invoke-JSRatRegsvr" or"Invoke-JSRatRundll" or "Invoke-PoshRatHttps" or"Invoke-PsGcatAgent" or "Remove-PoshRat" or"Install-SSP" or "Invoke-BackdoorLNK" or"PowerBreach" or "InstallEXE-Persistence" or"RemoveEXE-Persistence" or "Install-ServiceLevel-Persistence" or"Remove-ServiceLevel-Persistence" or "Invoke-Prompt" or"Invoke-PacketCapture" or "Start-WebcamRecorder" or"Get-USBKeyStrokes" or "Invoke-KeeThief" or"Get-Keystrokes" or "Invoke-NetRipper" or"Get-EmailItems" or "Invoke-MailSearch" or"Invoke-SearchGAL" or "Get-WebCredentials" or"Start-CaptureServer" or "Invoke-PowerShellIcmp" or"Invoke-PowerShellTcpOneLine" or "Invoke-PowerShellTcpOneLineBind" or"Invoke-PowerShellUdp" or "Invoke-PowerShellUdpOneLine" or"Run-EXEonRemote" or "Download-Execute-PS" or"Out-RundllCommand" or "Set-RemoteWMI" or"Set-DCShadowPermissions" or "Invoke-PowerShellWMI" or"Invoke-Vnc" or "Invoke-LockWorkStation" or"Invoke-EternalBlue" or "Invoke-ShellcodeMSIL" or"Invoke-MetasploitPayload" or "Invoke-DowngradeAccount" or"Invoke-RunAs" or "ExetoText" or"Disable-SecuritySettings" or "Set-MacAttribute" or"Invoke-MS16032" or "Invoke-BypassUACTokenManipulation" or"Invoke-SDCLTBypass" or "Invoke-FodHelperBypass" or"Invoke-EventVwrBypass" or "Invoke-EnvBypass" or"Get-ServiceUnquoted" or "Get-ServiceFilePermission" or"Get-ServicePermission" or"Enable-DuplicateToken" or "Invoke-PsUaCme" or"Invoke-Tater" or "Invoke-WScriptBypassUAC" or"Invoke-AllChecks" or "Find-TrustedDocuments" or"Invoke-Interceptor" or "Invoke-PoshRatHttp" or"Invoke-ExecCommandWMI" or "Invoke-KillProcessWMI" or"Invoke-CreateShareandExecute" or "Invoke-RemoteScriptWithOutput" or"Invoke-SchedJobManipulation" or "Invoke-ServiceManipulation" or"Invoke-PowerOptionsWMI" or "Invoke-DirectoryListing" or"Invoke-FileTransferOverWMI" or "Invoke-WMImplant" or"Invoke-WMIObfuscatedPSCommand" or "Invoke-WMIDuplicateClass" or"Invoke-WMIUpload" or "Invoke-WMIRemoteExtract" or "Invoke-winPEAS") andnot powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint") andnot file.path : (?\:\\\\ProgramData\\\\Microsoft\\\\Windows?Defender?Advanced?Threat?Protection\\\\DataCollection\\\\*) andnot user.id : ("S-1-5-18" or "S-1-5-19")'''


<li><a href="#">DESCRIPTION = Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackersembed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk.

NAME = "Suspicious Portable Executable Encoded in Powershell Script"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text : (TVqQAAMAAAAEAAAA) and not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects the use of PSReflect in PowerShell scripts. Attackers leverage PSReflect as a library that enables PowerShell toaccess win32 API functions.

NAME = "PowerShell PSReflect Script"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text:("New-InMemoryModule" or"Add-Win32Type" orpsenum orDefineDynamicAssembly orDefineDynamicModule or"Reflection.TypeAttributes" or"Reflection.Emit.OpCodes" or"Reflection.Emit.CustomAttributeBuilder" or"Runtime.InteropServices.DllImportAttribute") andnot user.id : "S-1-5-18" andnot file.path : ?\:\\\\ProgramData\\\\MaaS360\\\\Cloud?Extender\\\\AR\\\\Scripts\\\\ASModuleCommon.ps1*'''


<li><a href="#">DESCRIPTION = Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateralmovement.

NAME = "PsExec Network Connection"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and process.name : "PsExec.exe" and event.type == "start" and /* This flag suppresses the display of the license dialog and mayindicate that psexec executed for the first time in the machine */ process.args : "-accepteula" and not process.executable : ("?:\\ProgramData\\Docusnap\\Discovery\\discovery\\plugins\\17\\Bin\\psexec.exe", "?:\\Docusnap 11\\Bin\\psexec.exe", "?:\\Program Files\\Docusnap X\\Bin\\psexec.exe", "?:\\Program Files\\Docusnap X\\Tools\\dsDNS.exe") and not process.parent.executable : "?:\\Program Files (x86)\\Cynet\\Cynet Scanner\\CynetScanner.exe"][network where host.os.type == "windows" and process.name : "PsExec.exe"]'''


<li><a href="#">DESCRIPTION = Identifies when a Python script is executed using command line input and imports the sys module. Attackers often usethis method to execute malicious scripts and avoiding writing it to disk.

NAME = "Python Script Execution via Command Line"

QUERY = '''process where event.type in ("start", "process_started") and process.name : "python*" and process.args : "-c" and process.args : "*import*sys*'''


<li><a href="#">DESCRIPTION = Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection.This may be indicative of an attacker bypassing allowlists or running arbitrary scripts via a signed Microsoft binary.

NAME = "Network Connection via Registration Utility"

QUERY = '''sequence by process.entity_id[process where host.os.type == "windows" and event.type == "start" and process.name : ("regsvr32.exe", "RegAsm.exe", "RegSvcs.exe") and not ( (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and (process.parent.name : "msiexec.exe" or process.parent.executable : ("C:\\Program Files (x86)\\*.exe", "C:\\Program Files\\*.exe")) ) ][network where host.os.type == "windows" and process.name : ("regsvr32.exe", "RegAsm.exe", "RegSvcs.exe")and not cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8") and network.protocol != "dns"]'''


<li><a href="#">DESCRIPTION = "Identifies the execution of a shell process with suspicious arguments which may be indicative of reverse shell activity."from =

NAME = "Potential Reverse Shell Activity via Terminal"

QUERY = '''process where event.type in ("start", "process_started") andprocess.name in ("sh", "bash", "zsh", "dash", "zmodload") andprocess.args : ("*/dev/tcp/*", "*/dev/udp/*", "*zsh/net/tcp*", "*zsh/net/udp*") and/* noisy FPs */not (process.parent.name : "timeout" and process.executable : "/var/lib/docker/overlay*") andnot process.command_line : ("*/dev/tcp/sirh_db/*", "*/dev/tcp/remoteiot.com/*", "*dev/tcp/elk.stag.one/*", "*dev/tcp/kafka/*","*/dev/tcp/$0/$1*", "*/dev/tcp/127.*", "*/dev/udp/127.*", "*/dev/tcp/localhost/*", "*/dev/tcp/itom-vault/*") andnot process.parent.command_line : "runc init'''


<li><a href="#">DESCRIPTION = Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connectionwithin a short time period. This may indicate lateral movement or remote discovery via scheduled tasks.

NAME = "Outbound Scheduled Task Activity via PowerShell"

QUERY = '''sequence by host.id, process.entity_id with maxspan = 5s [any where host.os.type == "windows" and (event.category == "library" or (event.category == "process" and event.action : "Image loaded*")) and(?dll.name : "taskschd.dll" or file.name : "taskschd.dll") and process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe")] [network where host.os.type == "windows" and process.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and destination.port == 135 and not destination.ip in ("127.0.0.1", "::1")]'''


<li><a href="#">DESCRIPTION = Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuseshared modules to execute malicious payloads by instructing the Windows module loader to load DLLs from arbitrary localpaths.

NAME = "Execution via local SxS Shared Module"

QUERY = '''file where host.os.type == "windows" and file.extension : "dll" and file.path : "C:\\*\\*.exe.local\\*.dll'''


<li><a href="#">DESCRIPTION = Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This couldbe indicative of adversary lateral movement.

NAME = "Suspicious Cmd Execution via WMI"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : "WmiPrvSE.exe" and process.name : "cmd.exe" and process.args : "\\\\127.0.0.1\\*" and process.args : ("2>&1", "1>")'''


<li><a href="#">DESCRIPTION = Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicateadversarial activity where child processes are spawned via Windows Management Instrumentation (WMI). This technique canbe used to execute code and evade traditional parent/child processes spawned from Microsoft Office products.

NAME = "Suspicious WMI Image Load from MS Office"

QUERY = '''any where host.os.type == "windows" and (event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) andprocess.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "MSPUB.EXE", "MSACCESS.EXE") and(?dll.name : "wmiutils.dll" or file.name : "wmiutils.dll")'''


<li><a href="#">DESCRIPTION = Identifies suspicious child processes of the Java interpreter process. This may indicate an attempt to execute amalicious JAR file or an exploitation attempt via a JAVA specific vulnerability.

NAME = "Suspicious JAVA Child Process"

QUERY = '''event.category:process and event.type:("start" or "process_started") and process.parent.name:"java" and process.name:(bash or dash or sh or tcsh or csh or zsh or ksh or fish or python* or php* or perl or ruby or lua* or openssl ornc or netcat or ncat or telnet or awk or socat or wget or curl) and process.args :(whoami or id or uname or cat or hostname or ip or curl or wget or pwd or ls or cd or python* or php* or perl orruby or lua* or openssl or nc or netcat or ncat or telnet or awk or socat)'''


<li><a href="#">DESCRIPTION = Identifies an outbound network connection by JAVA to LDAP, RMI or DNS standard ports followed by a suspicious JAVA childprocesses. This may indicate an attempt to exploit a JAVA/NDI (Java Naming and Directory Interface) injectionvulnerability.

NAME = "Potential JAVA/JNDI Exploitation Attempt"

QUERY = '''sequence by host.id with maxspan=1m [network where event.action == "connection_attempted" andprocess.name : "java" and/* outbound connection attempt to LDAP, RMI or DNS standard ports by JAVA process */destination.port in (1389, 389, 1099, 53, 5353)] by process.pid [process where event.type == "start" and/* Suspicious JAVA child process */process.parent.name : "java" and process.name : ("sh", "bash", "dash", "ksh", "tcsh", "zsh", "curl", "perl*", "python*", "ruby*", "php*", "wget")] by process.parent.pid'''


<li><a href="#">DESCRIPTION = Identifies suspicious child processes of PDF reader applications. These child processes are often launched viaexploitation of PDF applications or social engineering.

NAME = "Suspicious PDF Reader Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : ("AcroRd32.exe", "Acrobat.exe", "FoxitPhantomPDF.exe", "FoxitReader.exe") andprocess.name : ("arp.exe", "dsquery.exe", "dsget.exe", "gpresult.exe", "hostname.exe", "ipconfig.exe", "nbtstat.exe","net.exe", "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "ping.exe", "qprocess.exe","quser.exe", "qwinsta.exe", "reg.exe", "sc.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe","whoami.exe", "bginfo.exe", "cdb.exe", "cmstp.exe", "csi.exe", "dnx.exe", "fsi.exe", "ieexec.exe","iexpress.exe", "installutil.exe", "Microsoft.Workflow.Compiler.exe", "msbuild.exe", "mshta.exe","msxsl.exe", "odbcconf.exe", "rcsi.exe", "regsvr32.exe", "xwizard.exe", "atbroker.exe","forfiles.exe", "schtasks.exe", "regasm.exe", "regsvcs.exe", "cmd.exe", "cscript.exe","powershell.exe", "pwsh.exe", "wmic.exe", "wscript.exe", "bitsadmin.exe", "certutil.exe", "ftp.exe")'''


<li><a href="#">DESCRIPTION = Identifies the PowerShell engine being invoked by unexpected processes. Rather than executing PowerShell functionalitywith powershell.exe, some attackers do this to operate more stealthily.

NAME = "Suspicious PowerShell Engine ImageLoad"

QUERY = '''host.os.type:windows and event.category:library and dll.name:("System.Management.Automation.dll" or "System.Management.Automation.ni.dll") and not (process.code_signature.subject_name:("Microsoft Corporation" or "Microsoft Dynamic Code Publisher" or "Microsoft Windows") and process.code_signature.trusted:true and not process.name.caseless:("regsvr32.exe" or "rundll32.exe")) and not (process.executable.caseless:(?\:\\\\Program?Files?\(x86\)\\\\*.exe or ?\:\\\\Program?Files\\\\*.exe) andprocess.code_signature.trusted:true) and not (process.executable.caseless:?\:\\\\Windows\\\\Lenovo\\\\*.exe and process.code_signature.subject_name:"Lenovo" and process.code_signature.trusted:true) and not (process.executable.caseless:?\:\\\\ProgramData\\\\chocolatey\\\\choco.exe* andprocess.code_signature.subject_name:"Chocolatey Software, Inc." and process.code_signature.trusted:true) and not process.executable.caseless : "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe'''


<li><a href="#">DESCRIPTION = Identifies suspicious psexec activity which is executing from the psexec service that has been renamed, possibly toevade detection.

NAME = "Suspicious Process Execution via Renamed PsExec Executable"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.pe.original_file_name : "psexesvc.exe" and not process.name : "PSEXESVC.exe'''


<li><a href="#">DESCRIPTION = Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may concealmalicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executableprogram (hh.exe).

NAME = "Process Activity via Compiled HTML File"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : "hh.exe" and process.name : ("mshta.exe", "cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe", "cscript.exe", "wscript.exe")'''


<li><a href="#">DESCRIPTION = Detects when the Console Window Host (conhost.exe) process is spawned by a suspicious parent process, which could beindicative of code injection.

NAME = "Conhost Spawned By Suspicious Parent Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : "conhost.exe" andprocess.parent.name : ("lsass.exe", "services.exe", "smss.exe", "winlogon.exe", "explorer.exe", "dllhost.exe", "rundll32.exe", "regsvr32.exe", "userinit.exe", "wininit.exe", "spoolsv.exe", "ctfmon.exe") andnot (process.parent.name : "rundll32.exe" and process.parent.args : ("?:\\Windows\\Installer\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc","?:\\WINDOWS\\system32\\PcaSvc.dll,PcaPatchSdbTask","?:\\WINDOWS\\system32\\davclnt.dll,DavSetCookie"))'''


<li><a href="#">DESCRIPTION = This rule detects rare internet network connections via the SMB protocol. SMB is commonly used to leak NTLM credentials via rogue UNC path injection.

NAME = "Rare SMB Connection to the Internet"

QUERY = '''event.category:network and host.os.type:windows and process.pid:4 and network.transport:tcp and destination.port:(139 or 445) and source.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16) andnot destination.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8")'''


<li><a href="#">DESCRIPTION = Identifies the deletion of backup files, saved using third-party software, by a process outside of the backup suite.Adversaries may delete Backup files to ensure that recovery from a ransomware attack is less likely.

NAME = "Third-party Backup Files Deleted via Unexpected Process"

QUERY = '''file where host.os.type == "windows" and event.type == "deletion" and(/* Veeam Related Backup Files */(file.extension : ("VBK", "VIB", "VBM") andnot (process.executable : ("?:\\Windows\\*", "?:\\Program Files\\*", "?:\\Program Files (x86)\\*") and(process.code_signature.trusted == true and process.code_signature.subject_name : ("Veeam Software Group GmbH", "Veeam Software AG")))) or/* Veritas Backup Exec Related Backup File */(file.extension : "BKF" andnot process.executable : ("?:\\Program Files\\Veritas\\Backup Exec\\*","?:\\Program Files (x86)\\Veritas\\Backup Exec\\*"))) andnot (process.name : ("MSExchangeMailboxAssistants.exe", "Microsoft.PowerBI.EnterpriseGateway.exe") and(process.code_signature.subject_name : "Microsoft Corporation" and process.code_signature.trusted == true)) andnot file.path : ("?:\\ProgramData\\Trend Micro\\*","?:\\Program Files (x86)\\Trend Micro\\*","?:\\$RECYCLE.BIN\\*")'''


<li><a href="#">DESCRIPTION = Identifies use of the wbadmin.exe to delete the backup catalog. Ransomware and other malware may do this to preventsystem recovery.

NAME = "Deleting Backup Catalogs with Wbadmin"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "wbadmin.exe" or ?process.pe.original_file_name == "WBADMIN.EXE") andprocess.args : "catalog" and process.args : "delete'''


<li><a href="#">DESCRIPTION = The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the firstpoint of lookup for DNS hostname resolution so if adversaries can modify the endpoint hosts file, they can route trafficto malicious infrastructure. This rule detects modifications to the hosts file on Microsoft Windows, Linux (Ubuntu orRHEL) and macOS systems.

NAME = "Hosts File Modified"

QUERY = '''any where/* file events for creation; file change events are not captured by some of the included sources for linux and so may miss this, which is the purpose of the process + command line args logic below */( event.category == "file" and event.type in ("change", "creation") and file.path : ("/private/etc/hosts", "/etc/hosts", "?:\\Windows\\System32\\drivers\\etc\\hosts") andnot process.name in ("dockerd", "rootlesskit", "podman", "crio"))or/* process events for change targeting linux only */( event.category == "process" and event.type in ("start") and process.name in ("nano", "vim", "vi", "emacs", "echo", "sed") and process.args : ("/etc/hosts") andnot process.parent.name in ("dhclient-script", "google_set_hostname"))'''


<li><a href="#">DESCRIPTION = Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or anattacker as a destructive technique.

NAME = "Modification of Boot Configuration"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "bcdedit.exe" or ?process.pe.original_file_name == "bcdedit.exe") and((process.args : "/set" and process.args : "bootstatuspolicy" and process.args : "ignoreallfailures") or(process.args : "no" and process.args : "recoveryenabled"))'''


<li><a href="#">DESCRIPTION = This rule identifies a high number (10) of process terminations (stop, delete, or suspend) from the same host within ashort time period.

NAME = "High Number of Process and/or Service Terminations"

QUERY = '''event.category:process and host.os.type:windows and event.type:start and process.name:(net.exe or sc.exe or taskkill.exe) and process.args:(stop or pause or delete or "/PID" or "/IM" or "/T" or "/F" or "/t" or "/f" or "/im" or "/pid") and not process.parent.name:osquerybeat.exe'''


<li><a href="#">DESCRIPTION = Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem withransomware or other destructive attacks.

NAME = "Volume Shadow Copy Deleted or Resized via VssAdmin"

QUERY = '''process where host.os.type == "windows" and event.type == "start"and (process.name : "vssadmin.exe" or ?process.pe.original_file_name == "VSSADMIN.EXE") andprocess.args in ("delete", "resize") and process.args : "shadows*'''


<li><a href="#">DESCRIPTION = Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonlyoccurs in tandem with ransomware or other destructive attacks.

NAME = "Volume Shadow Copy Deletion via PowerShell"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : ("powershell.exe", "pwsh.exe", "powershell_ise.exe") andprocess.args : ("*Get-WmiObject*", "*gwmi*", "*Get-CimInstance*", "*gcim*") andprocess.args : ("*Win32_ShadowCopy*") andprocess.args : ("*.Delete()*", "*Remove-WmiObject*", "*rwmi*", "*Remove-CimInstance*", "*rcim*")'''


<li><a href="#">DESCRIPTION = Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware orother destructive attacks.

NAME = "Volume Shadow Copy Deletion via WMIC"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "WMIC.exe" or ?process.pe.original_file_name == "wmic.exe") andprocess.args : "delete" and process.args : "shadowcopy'''


<li><a href="#">DESCRIPTION = Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggledata and files past content filters by hiding malicious payloads inside of seemingly benign HTML files.

NAME = "Suspicious HTML File Creation"

QUERY = '''sequence by user.id with maxspan=5m [file where host.os.type == "windows" and event.action in ("creation", "rename") andfile.extension : ("htm", "html") and file.path : ("?:\\Users\\*\\Downloads\\*","?:\\Users\\*\\Content.Outlook\\*","?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*","?:\\Users\\*\\AppData\\Local\\Temp\\7z*","?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*") and ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size >= 1000000)] [process where host.os.type == "windows" and event.action == "start" and( (process.name in ("chrome.exe", "msedge.exe", "brave.exe", "whale.exe", "browser.exe", "dragon.exe", "vivaldi.exe", "opera.exe")and process.args == "--single-argument") or (process.name == "iexplore.exe" and process.args_count == 2) or (process.name in ("firefox.exe", "waterfox.exe") and process.args == "-url"))and process.args : ("?:\\Users\\*\\Downloads\\*.htm*","?:\\Users\\*\\Content.Outlook\\*.htm*","?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*.htm*","?:\\Users\\*\\AppData\\Local\\Temp\\7z*.htm*","?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*.htm*")]'''


<li><a href="#">DESCRIPTION = Identifies the execution of a process with arguments pointing to the INetCache Folder. Adversaries may deliver maliciouscontent via WININET during initial access.

NAME = "Suspicious Execution from INET Cache"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : ("explorer.exe", "winrar.exe", "7zFM.exe", "Bandizip.exe") and(process.args : "?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\INetCache\\IE\\*" or process.executable : "?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\INetCache\\IE\\*")'''


<li><a href="#">DESCRIPTION = Identifies process execution from a removable media and by an unusual process. Adversaries may move onto systems,possibly those on disconnected or air-gapped networks, by copying malware to removable media and taking advantage ofAutorun features when the media is inserted into a system and executes.

NAME = "Execution from a Removable Media with Network Connection"

QUERY = '''sequence by process.entity_id with maxspan=5m [process where host.os.type == "windows" and event.action == "start" and/* Direct Exec from USB */(process.Ext.device.bus_type : "usb" or process.Ext.device.product_id : "USB *") and(process.code_signature.trusted == false or process.code_signature.exists == false) and not process.code_signature.status : ("errorExpired", "errorCode_endpoint*")] [network where host.os.type == "windows" and event.action == "connection_attempted"]'''


<li><a href="#">DESCRIPTION = Identifies the execution of the built-in Windows Installer, msiexec.exe, to install a remote package. Adversaries may abusemsiexec.exe to launch local or network accessible MSI files.

NAME = "Potential Remote File Execution via MSIEXEC"

QUERY = '''sequence with maxspan=1m [process where host.os.type == "windows" and event.action == "start" andprocess.name : "msiexec.exe" and process.args : "/V"] by process.entity_id [network where host.os.type == "windows" and process.name : "msiexec.exe" andevent.action == "connection_attempted"] by process.entity_id [process where host.os.type == "windows" and event.action == "start" andprocess.parent.name : "msiexec.exe" and user.id : ("S-1-5-21-*", "S-1-5-12-1-*") andnot process.executable : ("?:\\Windows\\SysWOW64\\msiexec.exe","?:\\Windows\\System32\\msiexec.exe","?:\\Windows\\System32\\srtasks.exe","?:\\Windows\\SysWOW64\\srtasks.exe","?:\\Windows\\System32\\taskkill.exe","?:\\Windows\\Installer\\MSI*.tmp","?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\System32\\ie4uinit.exe","?:\\Windows\\SysWOW64\\ie4uinit.exe","?:\\Windows\\System32\\sc.exe","?:\\Windows\\system32\\Wbem\\mofcomp.exe","?:\\Windows\\twain_32\\fjscan32\\SOP\\crtdmprc.exe","?:\\Windows\\SysWOW64\\taskkill.exe","?:\\Windows\\SysWOW64\\schtasks.exe","?:\\Windows\\system32\\schtasks.exe","?:\\Windows\\System32\\sdbinst.exe") andnot (process.code_signature.subject_name == "Citrix Systems, Inc." and process.code_signature.trusted == true) andnot (process.name : ("regsvr32.exe", "powershell.exe", "rundll32.exe", "wscript.exe") and process.Ext.token.integrity_level_name == "high" and process.args : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*")) andnot (process.executable : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe") and process.code_signature.trusted == true) andnot (process.name : "rundll32.exe" and process.args : "printui.dll,PrintUIEntry")] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = Identifies execution of common Microsoft Office applications to launch an Office Add-In from a suspicious path or with an unusual parent process. This may indicate an attempt to get initial access via a malicious phishing MS Office Add-In.

NAME = "Suspicious Execution via Microsoft Office Add-Ins"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "MSACCESS.EXE", "VSTOInstaller.exe") and process.args regex~ .+\.(wll|xll|ppa|ppam|xla|xlam|vsto) and /* Office Add-In from suspicious paths */(process.args : ("?:\\Users\\*\\Temp\\7z*","?:\\Users\\*\\Temp\\Rar$*","?:\\Users\\*\\Temp\\Temp?_*","?:\\Users\\*\\Temp\\BNZ.*","?:\\Users\\*\\Downloads\\*","?:\\Users\\*\\AppData\\Roaming\\*","?:\\Users\\Public\\*","?:\\ProgramData\\*","?:\\Windows\\Temp\\*","\\Device\\*","http*") or	process.parent.name : ("explorer.exe", "OpenWith.exe") or /* Office Add-In from suspicious parent */process.parent.name : ("cmd.exe", "powershell.exe")) and	/* False Positives */not (process.args : "*.vsto" and process.parent.executable : ("?:\\Program Files\\Logitech\\LogiOptions\\PlugInInstallerUtility*.exe","?:\\ProgramData\\Logishrd\\LogiOptions\\Plugins\\VSTO\\*\\VSTOInstaller.exe","?:\\Program Files\\Logitech\\LogiOptions\\PlugInInstallerUtility.exe","?:\\Program Files\\LogiOptionsPlus\\PlugInInstallerUtility*.exe","?:\\ProgramData\\Logishrd\\LogiOptionsPlus\\Plugins\\VSTO\\*\\VSTOInstaller.exe","?:\\Program Files\\Common Files\\microsoft shared\\VSTO\\*\\VSTOInstaller.exe")) andnot (process.args : "/Uninstall" and process.name : "VSTOInstaller.exe") andnot (process.parent.name : "rundll32.exe" and process.parent.args : "?:\\WINDOWS\\Installer\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc") andnot (process.name : "VSTOInstaller.exe" and process.args : "https://dl.getsidekick.com/outlook/vsto/Sidekick.vsto")'''


<li><a href="#">DESCRIPTION = Identifies newly seen removable devices by device friendly name using registry modification events. While this activityis not inherently malicious, analysts can use those events to aid monitoring for data exfiltration over those devices.

NAME = "First Time Seen Removable Device"

QUERY = '''event.category:"registry" and host.os.type:"windows" and registry.value:"FriendlyName" and registry.path:*USBSTOR*'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of RPC traffic from the Internet. RPC is commonly used bysystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never bedirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access orbackdoor vector.

NAME = "RPC (Remote Procedure Call) from the Internet"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) andnetwork.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) andnot source.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8") anddestination.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16)'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of RPC traffic to the Internet. RPC is commonly used bysystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never bedirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access orbackdoor vector.

NAME = "RPC (Remote Procedure Call) to the Internet"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) andnetwork.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) andsource.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16) andnot destination.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8")'''


<li><a href="#">DESCRIPTION = Identifies a PowerShell process launched by either cscript.exe or wscript.exe. Observing Windows scripting processesexecuting a PowerShell script, may be indicative of malicious activity.

NAME = "Windows Script Executing PowerShell"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : ("cscript.exe", "wscript.exe") and process.name : "powershell.exe" andnot (process.parent.name : "wscript.exe" andprocess.parent.args : "?:\\ProgramData\\intune-drive-mapping-generator\\IntuneDriveMapping-VBSHelper.vbs" andprocess.parent.args : "?:\\ProgramData\\intune-drive-mapping-generator\\DriveMapping.ps1")'''


<li><a href="#">DESCRIPTION = Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a processvia Windows Management Instrumentation (WMI). This may be indicative of malicious activity.

NAME = "Windows Script Interpreter Executing Process via WMI"

QUERY = '''sequence by host.id with maxspan = 5s[any where host.os.type == "windows" and(event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) and (?dll.name : "wmiutils.dll" or file.name : "wmiutils.dll") and process.name : ("wscript.exe", "cscript.exe")][process where host.os.type == "windows" and event.type == "start" and process.parent.name : "wmiprvse.exe" and user.domain != "NT AUTHORITY" and (process.pe.original_file_name :("cscript.exe","wscript.exe","PowerShell.EXE","Cmd.Exe","MSHTA.EXE","RUNDLL32.EXE","REGSVR32.EXE","MSBuild.exe","InstallUtil.exe","RegAsm.exe","RegSvcs.exe","msxsl.exe","CONTROL.EXE","EXPLORER.EXE","Microsoft.Workflow.Compiler.exe","msiexec.exe") orprocess.executable : ("C:\\Users\\*.exe", "C:\\ProgramData\\*.exe") )]'''


<li><a href="#">DESCRIPTION = This rule detects network events that may indicate the use of Windows file sharing (also called SMB or CIFS) traffic tothe Internet. SMB is commonly used within networks to share files, printers, and other system resources amongst trustedsystems. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited bythreat actors as an initial access or backdoor vector or for data exfiltration.

NAME = "SMB (Windows File Sharing) Activity to the Internet"

QUERY = '''(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) andnetwork.transport:tcp and (destination.port:(139 or 445) or event.dataset:zeek.smb) andsource.ip:(10.0.0.0/8 or172.16.0.0/12 or192.168.0.0/16) andnot destination.ip:(10.0.0.0/8 or127.0.0.0/8 or169.254.0.0/16 or172.16.0.0/12 or192.0.0.0/24 or192.0.0.0/29 or192.0.0.8/32 or192.0.0.9/32 or192.0.0.10/32 or192.0.0.170/32 or192.0.0.171/32 or192.0.2.0/24 or192.31.196.0/24 or192.52.193.0/24 or192.168.0.0/16 or192.88.99.0/24 or224.0.0.0/4 or100.64.0.0/10 or192.175.48.0/24 or198.18.0.0/15 or198.51.100.0/24 or203.0.113.0/24 or240.0.0.0/4 or"::1" or"FE80::/10" or"FF00::/8")'''


<li><a href="#">DESCRIPTION = Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activityhas been observed exploiting CVE-2021-26858.

NAME = "Microsoft Exchange Server UM Writing Suspicious Files"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" andprocess.name : ("UMWorkerProcess.exe", "umservice.exe") andfile.extension : ("php", "jsp", "js", "aspx", "asmx", "asax", "cfm", "shtml") and(file.path : "?:\\inetpub\\wwwroot\\aspnet_client\\*" or(file.path : "?:\\*\\Microsoft\\Exchange Server*\\FrontEnd\\HttpProxy\\owa\\auth\\*" and not (file.path : "?:\\*\\Microsoft\\Exchange Server*\\FrontEnd\\HttpProxy\\owa\\auth\\version\\*" orfile.name : ("errorFE.aspx", "expiredpassword.aspx", "frowny.aspx", "GetIdToken.htm", "logoff.aspx","logon.aspx", "OutlookCN.aspx", "RedirSuiteServiceProxy.aspx", "signout.aspx"))) or(file.path : "?:\\*\\Microsoft\\Exchange Server*\\FrontEnd\\HttpProxy\\ecp\\auth\\*" and not file.name : "TimeoutLogoff.aspx"))'''


<li><a href="#">DESCRIPTION = Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. Thisactivity has been observed exploiting CVE-2021-26857.

NAME = "Microsoft Exchange Server UM Spawning Suspicious Processes"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : ("UMService.exe", "UMWorkerProcess.exe") andnot process.executable :("?:\\Windows\\System32\\werfault.exe", "?:\\Windows\\System32\\wermgr.exe", "?:\\Program Files\\Microsoft\\Exchange Server\\V??\\Bin\\UMWorkerProcess.exe", "?:\\Program Files\\Microsoft\\Exchange Server\\Bin\\UMWorkerProcess.exe", "D:\\Exchange 2016\\Bin\\UMWorkerProcess.exe", "E:\\ExchangeServer\\Bin\\UMWorkerProcess.exe", "D:\\Exchange\\Bin\\UMWorkerProcess.exe", "D:\\Exchange Server\\Bin\\UMWorkerProcess.exe", "E:\\Exchange Server\\V15\\Bin\\UMWorkerProcess.exe")'''


<li><a href="#">DESCRIPTION = Identifies suspicious processes being spawned by the Microsoft Exchange Server worker process (w3wp). This activity mayindicate exploitation activity or access to an existing web shell backdoor.

NAME = "Microsoft Exchange Worker Spawning Suspicious Processes"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "w3wp.exe" and process.parent.args : "MSExchange*AppPool" and(process.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe") or?process.pe.original_file_name in ("cmd.exe", "powershell.exe", "pwsh.dll", "powershell_ise.exe"))'''


<li><a href="#">DESCRIPTION = Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel).These child processes are often launched during exploitation of Office applications or from documents with maliciousmacros.

NAME = "Suspicious MS Office Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : ("eqnedt32.exe", "excel.exe", "fltldr.exe", "msaccess.exe","mspub.exe", "powerpnt.exe", "winword.exe", "outlook.exe") andprocess.name : ("Microsoft.Workflow.Compiler.exe", "arp.exe", "atbroker.exe", "bginfo.exe", "bitsadmin.exe", "cdb.exe","certutil.exe", "cmd.exe", "cmstp.exe", "control.exe", "cscript.exe", "csi.exe", "dnx.exe", "dsget.exe","dsquery.exe", "forfiles.exe", "fsi.exe", "ftp.exe", "gpresult.exe", "hostname.exe", "ieexec.exe", "iexpress.exe","installutil.exe", "ipconfig.exe", "mshta.exe", "msxsl.exe", "nbtstat.exe", "net.exe", "net1.exe", "netsh.exe","netstat.exe", "nltest.exe", "odbcconf.exe", "ping.exe", "powershell.exe", "pwsh.exe", "qprocess.exe","quser.exe", "qwinsta.exe", "rcsi.exe", "reg.exe", "regasm.exe", "regsvcs.exe", "regsvr32.exe", "sc.exe","schtasks.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe", "whoami.exe", "wmic.exe", "wscript.exe","xwizard.exe", "explorer.exe", "rundll32.exe", "hh.exe", "msdt.exe") andnot (process.parent.name : "outlook.exe" andprocess.name : "rundll32.exe" andprocess.args : "shell32.dll,Control_RunDLL" andprocess.args : "srchadmin.dll")'''


<li><a href="#">DESCRIPTION = Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spearphishing activity.

NAME = "Suspicious MS Outlook Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "outlook.exe" andprocess.name : ("Microsoft.Workflow.Compiler.exe", "arp.exe", "atbroker.exe", "bginfo.exe", "bitsadmin.exe","cdb.exe", "certutil.exe", "cmd.exe", "cmstp.exe", "cscript.exe", "csi.exe", "dnx.exe", "dsget.exe","dsquery.exe", "forfiles.exe", "fsi.exe", "ftp.exe", "gpresult.exe", "hostname.exe", "ieexec.exe","iexpress.exe", "installutil.exe", "ipconfig.exe", "mshta.exe", "msxsl.exe", "nbtstat.exe", "net.exe","net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "odbcconf.exe", "ping.exe", "powershell.exe","pwsh.exe", "qprocess.exe", "quser.exe", "qwinsta.exe", "rcsi.exe", "reg.exe", "regasm.exe","regsvcs.exe", "regsvr32.exe", "sc.exe", "schtasks.exe", "systeminfo.exe", "tasklist.exe","tracert.exe", "whoami.exe", "wmic.exe", "wscript.exe", "xwizard.exe")'''


<li><a href="#">DESCRIPTION = Identifies Elasticsearch nodes that do not have Transport Layer Security (TLS), and/or lack authentication, and areaccepting inbound network connections over the default Elasticsearch port.

NAME = "Inbound Connection to an Unsecure Elasticsearch Node"

QUERY = '''(event.dataset: network_traffic.http OR (event.category: network_traffic AND network.protocol: http)) ANDstatus:OK AND destination.port:9200 AND network.direction:inbound AND NOT http.response.headers.content-type:"image/x-icon" AND NOT_exists_:http.request.headers.authorization'''


<li><a href="#">DESCRIPTION = Identifies a suspicious Windows explorer child process. Explorer.exe can be abused to launch malicious scripts orexecutables from a trusted parent process.

NAME = "Suspicious Explorer Child Process"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and( process.name : ("cscript.exe", "wscript.exe", "powershell.exe", "rundll32.exe", "cmd.exe", "mshta.exe", "regsvr32.exe") or process.pe.original_file_name in ("cscript.exe", "wscript.exe", "PowerShell.EXE", "RUNDLL32.EXE", "Cmd.Exe", "MSHTA.EXE", "REGSVR32.EXE")) and/* Explorer started via DCOM */process.parent.name : "explorer.exe" and process.parent.args : "-Embedding" andnot process.parent.args:(/* Noisy CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs */"/factory,{5BD95610-9434-43C2-886C-57852CC8A120}","/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}")'''


<li><a href="#">DESCRIPTION = Identifies the execution of a hosted XSL script using the Microsoft.XMLDOM COM interface via Microsoft Office processes. This behavior may indicate adversarial activity to execute malicious JScript or VBScript on the system.

NAME = "Remote XSL Script Execution via COM"

QUERY = '''sequence with maxspan=1m [library where host.os.type == "windows" and dll.name : "msxml3.dll" andprocess.name : ("winword.exe", "excel.exe", "powerpnt.exe", "mspub.exe")] by process.entity_id [process where host.os.type == "windows" and event.action == "start" andprocess.parent.name : ("winword.exe", "excel.exe", "powerpnt.exe", "mspub.exe") and not process.executable :("?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\SysWoW64\\WerFault.exe", "?:\\windows\\splwow64.exe", "?:\\Windows\\System32\\conhost.exe", "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*exe")] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = This rule identifies Zoom meetings that are created without a passcode. Meetings without a passcode are susceptible toZoombombing. Zoombombing is carried out by taking advantage of Zoom sessions that are not protected with a passcode.Zoombombing refers to the unwanted, disruptive intrusion, generally by Internet trolls and hackers, into a videoconference call. In a typical Zoombombing incident, a teleconferencing session is hijacked by the insertion of materialthat is lewd, obscene, racist, or antisemitic in nature, typically resulting of the shutdown of the session.

NAME = "Zoom Meeting with no Passcode"

QUERY = '''event.type:creation and event.module:zoom and event.dataset:zoom.webhook andevent.action:meeting.created and not zoom.meeting.password:*'''


<li><a href="#">DESCRIPTION = Adversaries may pass the hash using stolen password hashes to move laterally within an environment, bypassing normal system access controls. Pass the hash (PtH) is a method of authenticating as a user without having access to the user's cleartext password. from =

NAME = "Potential Pass-the-Hash (PtH) Attempt"

QUERY = '''host.os.type:"windows" and event.category : "authentication" and event.action : "logged-in" and winlog.logon.type : "NewCredentials" and event.outcome : "success" and user.id : (S-1-5-21-* or S-1-12-1-*) and winlog.event_data.LogonProcessName : "seclogo'''


<li><a href="#">DESCRIPTION = Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversarylateral movement but will be noisy if commonly done by admins.

NAME = "Service Command Lateral Movement"

QUERY = '''sequence by process.entity_id with maxspan = 1m[process where host.os.type == "windows" and event.type == "start" and (process.name : "sc.exe" or process.pe.original_file_name : "sc.exe") andprocess.args : "\\\\*" and process.args : ("binPath=*", "binpath=*") andprocess.args : ("create", "config", "failure", "start")][network where host.os.type == "windows" and process.name : "sc.exe" and destination.ip != "127.0.0.1"]'''


<li><a href="#">DESCRIPTION = Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which arelaunched via the HTA Application COM Object. This behavior may indicate an attacker abusing a DCOM application to movelaterally while attempting to evade detection.

NAME = "Incoming DCOM Lateral Movement via MSHTA"

QUERY = '''sequence with maxspan=1m[process where host.os.type == "windows" and event.type == "start" and process.name : "mshta.exe" and process.args : "-Embedding"] by host.id, process.entity_id[network where host.os.type == "windows" and event.type == "start" and process.name : "mshta.exe" and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.port > 49151 and destination.port > 49151 and source.ip != "127.0.0.1" and source.ip != "::1"] by host.id, process.entity_id'''


<li><a href="#">DESCRIPTION = Identifies the use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launchedvia the MMC20 Application COM Object. This behavior may indicate an attacker abusing a DCOM application to movelaterally.

NAME = "Incoming DCOM Lateral Movement with MMC"

QUERY = '''sequence by host.id with maxspan=1m [network where host.os.type == "windows" and event.type == "start" and process.name : "mmc.exe" and source.port >= 49152 and destination.port >= 49152 and source.ip != "127.0.0.1" and source.ip != "::1" andnetwork.direction : ("incoming", "ingress") and network.transport == "tcp" ] by process.entity_id [process where host.os.type == "windows" and event.type == "start" and process.parent.name : "mmc.exe" ] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched viathe ShellBrowserWindow or ShellWindows Application COM Object. This behavior may indicate an attacker abusing a DCOMapplication to stealthily move laterally.

NAME = "Incoming DCOM Lateral Movement with ShellBrowserWindow or ShellWindows"

QUERY = '''sequence by host.id with maxspan=5s [network where host.os.type == "windows" and event.type == "start" and process.name : "explorer.exe" andnetwork.direction : ("incoming", "ingress") and network.transport == "tcp" andsource.port > 49151 and destination.port > 49151 and source.ip != "127.0.0.1" and source.ip != "::1" ] by process.entity_id [process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "explorer.exe" ] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = Identifies NullSessionPipe registry modifications that specify which pipes can be accessed anonymously. This could beindicative of adversary lateral movement preparation by making the added pipe available to everyone.

NAME = "NullSessionPipe Registry Modification"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") andregistry.path : ("HKLM\\SYSTEM\\*ControlSet*\\services\\LanmanServer\\Parameters\\NullSessionPipes","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\services\\LanmanServer\\Parameters\\NullSessionPipes") and length(registry.data.strings) > 0'''


<li><a href="#">DESCRIPTION = Identifies unexpected processes making network connections over port 445. Windows File Sharing is typically implementedover Server Message Block (SMB), which communicates between hosts using port 445. When legitimate, these networkconnections are established by the kernel. Processes making 445/tcp connections may be port scanners, exploits, orsuspicious user-level processes moving laterally.

NAME = "Direct Outbound SMB Connection"

QUERY = '''sequence by process.entity_id with maxspan=2m[process where host.os.type == "windows" and event.type == "start" and process.pid != 4 andnot user.id : ("S-1-5-19", "S-1-5-20") andnot (process.code_signature.trusted == true and not process.code_signature.subject_name : "Microsoft *") andnot (process.name : "powershell.exe" and process.args : "?:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\\PSScript_*.ps1")][network where host.os.type == "windows" and destination.port == 445 and process.pid != 4 and not cidrmatch(destination.ip, "127.0.0.1", "::1")]until [process where host.os.type == "windows" and event.type == "end"]'''


<li><a href="#">DESCRIPTION = Specially crafted DNS requests can manipulate a known overflow vulnerability in some Windows DNS servers, resulting inRemote Code Execution (RCE) or a Denial of Service (DoS) from crashing the service.

NAME = "Abnormally Large DNS Response"

QUERY = '''(event.dataset: network_traffic.dns or (event.category: (network or network_traffic) and destination.port: 53)) and(event.dataset:zeek.dns or type:dns or event.type:connection) and network.bytes > 60000'''


<li><a href="#">DESCRIPTION = Identifies the modification of the Remote Desktop Protocol (RDP) Shadow registry or the execution of processesindicative of an active RDP shadowing session. An adversary may abuse the RDP Shadowing feature to spy on or controlother users active RDP sessions.

NAME = "Potential Remote Desktop Shadowing Activity"

QUERY = '''/* Identifies the modification of RDP Shadow registry orthe execution of processes indicative of active shadow RDP session */any where host.os.type == "windows" and((event.category == "registry" and registry.path : ("HKLM\\Software\\Policies\\Microsoft\\Windows NT\\Terminal Services\\Shadow","\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\Windows NT\\Terminal Services\\Shadow")) or(event.category == "process" and event.type == "start" and (process.name : ("RdpSaUacHelper.exe", "RdpSaProxy.exe") and process.parent.name : "svchost.exe") or (process.pe.original_file_name : "mstsc.exe" and process.args : "/shadow:*")))'''


<li><a href="#">DESCRIPTION = Identifies the creation or change of a Windows executable file over network shares. Adversaries may transfer tools orother files between systems in a compromised environment.

NAME = "Potential Lateral Tool Transfer via SMB Share"

QUERY = '''sequence by host.id with maxspan=30s[network where host.os.type == "windows" and event.type == "start" and process.pid == 4 and destination.port == 445 and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.ip != "127.0.0.1" and source.ip != "::1"] by process.entity_id/* add more executable extensions here if they are not noisy in your environment */[file where host.os.type == "windows" and event.type in ("creation", "change") and process.pid == 4 and(file.Ext.header_bytes : "4d5a*" or file.extension : ("exe", "scr", "pif", "com", "dll"))] by process.entity_id'''


<li><a href="#">DESCRIPTION = Identifies execution from the Remote Desktop Protocol (RDP) shared mountpoint tsclient on the target host. This mayindicate a lateral movement attempt.

NAME = "Execution via TSClient Mountpoint"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.executable : "\\Device\\Mup\\tsclient\\*.exe'''


<li><a href="#">DESCRIPTION = Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movementvia network file shares.

NAME = "Remote Execution via File Shares"

QUERY = '''sequence with maxspan=1m[file where host.os.type == "windows" and event.type in ("creation", "change") andprocess.pid == 4 and (file.extension : "exe" or file.Ext.header_bytes : "4d5a*")] by host.id, file.path[process where host.os.type == "windows" and event.type == "start" andnot (/* Veeam related processes */(process.name : ("VeeamGuestHelper.exe", "VeeamGuestIndexer.exe", "VeeamAgent.exe", "VeeamLogShipper.exe", "Veeam.VSS.Sharepoint2010.exe") and process.code_signature.trusted == true and process.code_signature.subject_name : "Veeam Software Group GmbH") or/* PDQ related processes */(process.name : ("PDQInventoryScanner.exe", "PDQInventoryMonitor.exe", "PDQInventory-Scanner-?.exe", "PDQInventoryWakeCommand-?.exe") and process.code_signature.trusted == true and process.code_signature.subject_name : "PDQ.com Corporation"))] by host.id, process.executable'''


<li><a href="#">DESCRIPTION = Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be anindication of lateral movement.

NAME = "Incoming Execution via WinRM Remote Shell"

QUERY = '''sequence by host.id with maxspan=30s [network where host.os.type == "windows" and process.pid == 4 and network.direction : ("incoming", "ingress") anddestination.port in (5985, 5986) and network.protocol == "http" and source.ip != "127.0.0.1" and source.ip != "::1"] [process where host.os.type == "windows" and event.type == "start" and process.parent.name : "winrshost.exe" and not process.executable : "?:\\Windows\\System32\\conhost.exe"]'''


<li><a href="#">DESCRIPTION = Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative ofadversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts.

NAME = "WMI Incoming Lateral Movement"

QUERY = '''sequence by host.id with maxspan = 2s /* Accepted Incoming RPC connection by Winmgmt service */[network where host.os.type == "windows" and process.name : "svchost.exe" and network.direction : ("incoming", "ingress") and source.ip != "127.0.0.1" and source.ip != "::1" and source.port >= 49152 and destination.port >= 49152]/* Excluding Common FPs Nessus and SCCM */[process where host.os.type == "windows" and event.type == "start" and process.parent.name : "WmiPrvSE.exe" and not (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and not user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20") and not process.executable : ("?:\\Program Files\\HPWBEM\\Tools\\hpsum_swdiscovery.exe","?:\\Windows\\CCM\\Ccm32BitLauncher.exe","?:\\Windows\\System32\\wbem\\mofcomp.exe","?:\\Windows\\Microsoft.NET\\Framework*\\csc.exe","?:\\Windows\\System32\\powercfg.exe") and not (process.executable : "?:\\Windows\\System32\\msiexec.exe" and process.args : "REBOOT=ReallySuppress") and not (process.executable : "?:\\Windows\\System32\\inetsrv\\appcmd.exe" and process.args : "uninstall") ]'''


<li><a href="#">DESCRIPTION = Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement orpreparation for data exfiltration.

NAME = "Mounting Hidden or WebDav Remote Shares"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and ((process.name : "net.exe" or ?process.pe.original_file_name == "net.exe") or ((process.name : "net1.exe" or ?process.pe.original_file_name == "net1.exe") and not process.parent.name : "net.exe")) and process.args : "use" and /* including hidden and webdav based online shares such as onedrive*/ process.args : ("\\\\*\\*$*", "\\\\*@SSL\\*", "http*") and /* excluding shares deletion operation */ not process.args : "/d*'''


<li><a href="#">DESCRIPTION = Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run anyWindows PowerShell command on one or more remote computers. This could be an indication of lateral movement.

NAME = "Incoming Execution via PowerShell Remoting"

QUERY = '''sequence by host.id with maxspan = 30s [network where host.os.type == "windows" and network.direction : ("incoming", "ingress") and destination.port in (5985, 5986) andnetwork.protocol == "http" and source.ip != "127.0.0.1" and source.ip != "::1"] [process where host.os.type == "windows" and event.type == "start" and process.parent.name : "wsmprovhost.exe" and not process.executable : "?:\\Windows\\System32\\conhost.exe"]'''


<li><a href="#">DESCRIPTION = Identifies registry write modifications to enable Remote Desktop Protocol (RDP) access. This could be indicative ofadversary lateral movement preparation.

NAME = "RDP Enabled via Registry"

QUERY = '''registry where host.os.type == "windows" andevent.type in ("creation", "change") andregistry.path : "HKLM\\SYSTEM\\*ControlSet*\\Control\\Terminal Server\\fDenyTSConnections" andregistry.data.strings : ("0", "0x00000000") andnot process.executable : ("?:\\Windows\\System32\\SystemPropertiesRemote.exe", "?:\\Windows\\System32\\SystemPropertiesComputerName.exe", "?:\\Windows\\System32\\SystemPropertiesAdvanced.exe", "?:\\Windows\\System32\\SystemSettingsAdminFlows.exe", "?:\\Windows\\WinSxS\\*\\TiWorker.exe", "?:\\Windows\\system32\\svchost.exe")'''


<li><a href="#">DESCRIPTION = Identifies potential behavior of SharpRDP, which is a tool that can be used to perform authenticated command executionagainst a remote target via Remote Desktop Protocol (RDP) for the purposes of lateral movement.

NAME = "Potential SharpRDP Behavior"

QUERY = '''/* Incoming RDP followed by a new RunMRU string value set to cmd, powershell, taskmgr or tsclient, followed by process execution within 1m */sequence by host.id with maxspan=1m[network where host.os.type == "windows" and event.type == "start" and process.name : "svchost.exe" and destination.port == 3389 and network.direction : ("incoming", "ingress") and network.transport == "tcp" and source.ip != "127.0.0.1" and source.ip != "::1"][registry where host.os.type == "windows" and process.name : "explorer.exe" and registry.path : ("HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU\\*") and registry.data.strings : ("cmd.exe*", "powershell.exe*", "taskmgr*", "\\\\tsclient\\*.exe\\*")][process where host.os.type == "windows" and event.type == "start" and (process.parent.name : ("cmd.exe", "powershell.exe", "taskmgr.exe") or process.args : ("\\\\tsclient\\*.exe")) and not process.name : "conhost.exe" ]'''


<li><a href="#">DESCRIPTION = Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data stagingactivity.

NAME = "Remote File Copy to a Hidden Share"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : ("cmd.exe", "powershell.exe", "xcopy.exe") andprocess.args : ("copy*", "move*", "cp", "mv") orprocess.name : "robocopy.exe") and process.args : "*\\\\*\\*$*'''


<li><a href="#">DESCRIPTION = Discovery of files created by a remote host on sensitive directories and folders. Remote file creation in thesedirectories could indicate a malicious binary or script trying to compromise the system.

NAME = "Deprecated - Remote File Creation on a Sensitive Directory"

QUERY = '''file where event.action in ("creation", "modification") andnot user.name:("SYSTEM", "root") andprocess.name in ("System", "scp", "sshd", "smbd", "vsftpd", "sftp-server") and(file.path : ("?:\\Users\\*\\AppData\\Roaming*", "?:\\Program Files*","?:\\Windows\\*", "?:\\Windows\\System\\*","?:\\Windows\\System32\\*", "/etc/*", "/tmp*","/var/tmp*", "/home/*/.*", "/home/.*", "/usr/bin/*","/sbin/*", "/bin/*", "/usr/lib/*", "/usr/sbin/*","/usr/share/*", "/usr/local/*", "/var/lib/dpkg/*","/lib/systemd/*"))'''


<li><a href="#">DESCRIPTION = Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateralmovement, but will be noisy if commonly done by administrators.

NAME = "Remote Windows Service Installed"

QUERY = '''sequence by winlog.logon.id, winlog.computer_name with maxspan=1m[authentication where event.action == "logged-in" and winlog.logon.type : "Network" andevent.outcome=="success" and source.ip != null and source.ip != "127.0.0.1" and source.ip != "::1"][iam where event.action == "service-installed" and not winlog.event_data.SubjectLogonId : "0x3e7" and not winlog.event_data.ServiceFileName : ("?:\\Windows\\ADCR_Agent\\adcrsvc.exe","?:\\Windows\\System32\\VSSVC.exe","?:\\Windows\\servicing\\TrustedInstaller.exe","?:\\Windows\\System32\\svchost.exe","?:\\Program Files (x86)\\*.exe","?:\\Program Files\\*.exe","?:\\Windows\\PSEXESVC.EXE","?:\\Windows\\System32\\sppsvc.exe","?:\\Windows\\System32\\wbem\\WmiApSrv.exe","?:\\WINDOWS\\RemoteAuditService.exe","?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe","?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe","?:\\Windows\\CAInvokerService.exe","?:\\Windows\\System32\\upfc.exe","?:\\Windows\\AdminArsenal\\PDQ*.exe","?:\\Windows\\System32\\vds.exe","?:\\Windows\\Veeam\\Backup\\VeeamDeploymentSvc.exe","?:\\Windows\\ProPatches\\Scheduler\\STSchedEx.exe","?:\\Windows\\System32\\certsrv.exe","?:\\Windows\\eset-remote-install-service.exe","?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe","?:\\Pella Corporation\\OSCToGPAutoService\\OSCToGPAutoSvc.exe","?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe","?:\\Windows\\SysWOW64\\NwxExeSvc\\NwxExeSvc.exe","?:\\Windows\\System32\\taskhostex.exe")]'''


<li><a href="#">DESCRIPTION = Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateralmovement, but will be noisy if commonly done by administrators.

NAME = "Remotely Started Services via RPC"

QUERY = '''sequence with maxspan=1s [network where host.os.type == "windows" and process.name : "services.exe" andnetwork.direction : ("incoming", "ingress") and network.transport == "tcp" andsource.port >= 49152 and destination.port >= 49152 and source.ip != "127.0.0.1" and source.ip != "::1" ] by host.id, process.entity_id [process where host.os.type == "windows" andevent.type == "start" and process.parent.name : "services.exe" and not (process.executable : "?:\\Windows\\System32\\msiexec.exe" and process.args : "/V") and not process.executable : ("?:\\Pella Corporation\\OSCToGPAutoService\\OSCToGPAutoSvc.exe","?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe","?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe","?:\\Program Files (x86)\\*.exe","?:\\Program Files\\*.exe","?:\\Windows\\ADCR_Agent\\adcrsvc.exe","?:\\Windows\\AdminArsenal\\PDQ*.exe","?:\\Windows\\CAInvokerService.exe","?:\\Windows\\ccmsetup\\ccmsetup.exe","?:\\Windows\\eset-remote-install-service.exe","?:\\Windows\\ProPatches\\Scheduler\\STSchedEx.exe","?:\\Windows\\PSEXESVC.EXE","?:\\Windows\\RemoteAuditService.exe","?:\\Windows\\servicing\\TrustedInstaller.exe","?:\\Windows\\System32\\certsrv.exe","?:\\Windows\\System32\\sppsvc.exe","?:\\Windows\\System32\\srmhost.exe","?:\\Windows\\System32\\svchost.exe","?:\\Windows\\System32\\taskhostex.exe","?:\\Windows\\System32\\upfc.exe","?:\\Windows\\System32\\vds.exe","?:\\Windows\\System32\\VSSVC.exe","?:\\Windows\\System32\\wbem\\WmiApSrv.exe","?:\\Windows\\SysWOW64\\NwxExeSvc\\NwxExeSvc.exe","?:\\Windows\\Veeam\\Backup\\VeeamDeploymentSvc.exe","?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe","?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe" )] by host.id, process.parent.entity_id'''


<li><a href="#">DESCRIPTION = Identifies scheduled task creation from a remote source. This could be indicative of adversary lateral movement.

NAME = "Remote Scheduled Task Creation via RPC"

QUERY = '''iam where event.action == "scheduled-task-created" andwinlog.event_data.RpcCallClientLocality : "0" and winlog.event_data.ClientProcessId : "0'''


<li><a href="#">DESCRIPTION = "Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement."from =

NAME = "Remote Scheduled Task Creation"

QUERY = '''/* Task Scheduler service incoming connection followed by TaskCache registry modification*/sequence by host.id, process.entity_id with maxspan = 1m [network where host.os.type == "windows" and process.name : "svchost.exe" and network.direction : ("incoming", "ingress") and source.port >= 49152 and destination.port >= 49152 and source.ip != "127.0.0.1" and source.ip != "::1" ] [registry where host.os.type == "windows" and registry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions"]'''


<li><a href="#">DESCRIPTION = Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate thepresence of RDP lateral movement capability.

NAME = "Suspicious RDP ActiveX Client Loaded"

QUERY = '''any where host.os.type == "windows" and (event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) and (?dll.name : "mstscax.dll" or file.name : "mstscax.dll") and /* depending on noise in your env add here extra paths*/process.executable : ("C:\\Windows\\*","C:\\Users\\Public\\*","C:\\Users\\Default\\*","C:\\Intel\\*","C:\\PerfLogs\\*","C:\\ProgramData\\*","\\Device\\Mup\\*","\\\\*") and/* add here FPs */not process.executable : ("?:\\Windows\\System32\\mstsc.exe","?:\\Windows\\SysWOW64\\mstsc.exe","?:\\Windows\\System32\\vmconnect.exe","?:\\Windows\\System32\\WindowsSandboxClient.exe","?:\\Windows\\System32\\hvsirdpclient.exe")'''


<li><a href="#">DESCRIPTION = Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, whichmay indicate activity related to remote code execution or other forms of exploitation.

NAME = "Unusual Child Process of dns.exe"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : "dns.exe" andnot process.name : "conhost.exe'''


<li><a href="#">DESCRIPTION = Identifies an unexpected file being modified by dns.exe, the process responsible for Windows DNS Server services, whichmay indicate activity related to remote code execution or other forms of exploitation.

NAME = "Unusual File Modification by dns.exe"

QUERY = '''file where host.os.type == "windows" and process.name : "dns.exe" and event.type in ("creation", "deletion", "change") andnot file.name : "dns.log" and not(file.extension : ("old", "temp", "bak", "dns", "arpa") and file.path : "C:\\Windows\\System32\\dns\\*")'''


<li><a href="#">DESCRIPTION = Identifies suspicious file creations in the startup folder of a remote system. An adversary could abuse this to movelaterally by dropping a malicious script or executable that will be executed after a reboot or user logon.

NAME = "Lateral Movement via Startup Folder"

QUERY = '''file where host.os.type == "windows" and event.type in ("creation", "change") and /* via RDP TSClient mounted share or SMB */(process.name : "mstsc.exe" or process.pid == 4) and file.path : ("?:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*","?:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*")'''


<li><a href="#">DESCRIPTION = Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistentbackdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on theAdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions onthe protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining theirAdministrative Privileges.

NAME = "AdminSDHolder Backdoor"

QUERY = '''event.action:"Directory Service Changes" and event.code:5136 andwinlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*'''


<li><a href="#">DESCRIPTION = "Detects writing executable files that will be automatically launched by Adobe on launch."from =

NAME = "Adobe Hijack Persistence"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" andfile.path : ("?:\\Program Files (x86)\\Adobe\\Acrobat Reader DC\\Reader\\AcroCEF\\RdrCEF.exe", "?:\\Program Files\\Adobe\\Acrobat Reader DC\\Reader\\AcroCEF\\RdrCEF.exe") andnot process.name : "msiexec.exe'''


<li><a href="#">DESCRIPTION = Identifies the installation of custom Application Compatibility Shim databases. This Windows functionality has beenabused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.

NAME = "Installation of Custom Shim Databases"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") andregistry.path : "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\*.sdb" and not process.executable :("?:\\Program Files (x86)\\DesktopCentral_Agent\\swrepository\\1\\swuploads\\SAP-SLC\\SAPSetupSLC02_14-80001954\\Setup\\NwSapSetup.exe", "?:\\$WINDOWS.~BT\\Sources\\SetupPlatform.exe","?:\\Program Files (x86)\\SAP\\SAPsetup\\setup\\NwSapSetup.exe","?:\\Program Files (x86)\\SAP\\SapSetup\\OnRebootSvc\\NWSAPSetupOnRebootInstSvc.exe","?:\\Program Files (x86)\\Kaspersky Lab\\Kaspersky Security for Windows Server\\kavfs.exe")'''


<li><a href="#">DESCRIPTION = Detects attempts to maintain persistence by creating registry keys using AppCert DLLs. AppCert DLLs are loaded by everyprocess using the common API functions to create processes.

NAME = "Registry Persistence via AppCert DLL"

QUERY = '''registry where host.os.type == "windows" and/* uncomment once stable length(bytes_written_string) > 0 and */registry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\Session Manager\\AppCertDLLs\\*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Session Manager\\AppCertDLLs\\*")'''


<li><a href="#">DESCRIPTION = AppInit DLLs are dynamic-link libraries (DLLs) that are loaded into every process that creates a user interface (loadsuser32.dll) on Microsoft Windows operating systems. The AppInit DLL mechanism is used to load custom code into user-modeprocesses, allowing for the customization of the user interface and the behavior of Windows-based applications.Attackers who add those DLLs to the registry locations can execute code with elevated privileges, similar to processinjection, and provide a solid and constant persistence on the machine.

NAME = "Registry Persistence via AppInit DLL"

QUERY = '''registry where host.os.type == "windows" andregistry.path : ( "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls", "HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls", "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls", "\\REGISTRY\\MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls") andnot process.executable : ( "?:\\Windows\\System32\\DriverStore\\FileRepository\\*\\Display.NvContainer\\NVDisplay.Container.exe", "?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe", "?:\\Program Files\\Commvault\\Base\\cvd.exe", "?:\\Program Files\\Commvault\\ContentStore*\\Base\\cvd.exe", "?:\\Program Files (x86)\\Commvault\\Base\\cvd.exe", "?:\\Program Files (x86)\\Commvault\\ContentStore*\\Base\\cvd.exe", "?:\\Program Files\\NVIDIA Corporation\\Display.NvContainer\\NVDisplay.Container.exe")'''


<li><a href="#">DESCRIPTION = Adversaries may modify the standard authentication module for persistence via patching the normal authorization processor modifying the login configuration to allow unauthorized access or elevate privileges.

NAME = "Modification of Standard Authentication Module or Configuration"

QUERY = '''event.category:file and event.type:change and(file.name:pam_*.so or file.path:(/etc/pam.d/* or /private/etc/pam.d/* or /usr/lib64/security/*)) andprocess.executable:(* andnot(/usr/libexec/packagekitd or/usr/bin/vim or/usr/libexec/xpcproxy or/usr/bin/bsdtar or/usr/local/bin/brew or"/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service")) andnot file.path: ( /tmp/snap.rootfs_*/pam_*.so or /tmp/newroot/lib/*/pam_*.so or /private/var/folders/*/T/com.apple.fileprovider.ArchiveService/TemporaryItems/*/lib/security/pam_*.so or /tmp/newroot/usr/lib64/security/pam_*.so ) andnot process.name: ( yum or dnf or rsync or platform-python or authconfig or rpm or pdkg or apk or dnf-automatic or btrfs or dpkg or pam-auth-update or steam or platform-python3.6 or pam-config or microdnf or yum_install or yum-cron or systemd or containerd or pacman )'''


<li><a href="#">DESCRIPTION = Detects the creation and modification of an account with the "Don't Expire Password" option Enabled. Attackers can abusethis misconfiguration to persist in the domain and maintain long-term access using compromised accounts with thisproperty.

NAME = "Account Configured with Never-Expiring Password"

QUERY = '''event.action:"modified-user-account" and winlog.api:"wineventlog" and event.code:"4738" andmessage:"'Don't Expire Password' - Enabled" and not user.id:"S-1-5-18'''


<li><a href="#">DESCRIPTION = Identifies the creation of a hidden local user account by appending the dollar sign to the account name. This issometimes done by attackers to increase access to a system and avoid appearing in the results of accounts listing usingthe net users command.

NAME = "Creation of a Hidden Local User Account"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\","\\REGISTRY\\MACHINE\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\")'''


<li><a href="#">DESCRIPTION = The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing adifferent process to be executed. This functionality can be abused by an adversary to establish persistence.

NAME = "Image File Execution Options Injection"

QUERY = '''registry where host.os.type == "windows" and length(registry.data.strings) > 0 andregistry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*.exe\\Debugger","HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*\\Debugger","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess","HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*.exe\\Debugger","\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*\\Debugger","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess","\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess") and/* add FPs here */not registry.data.strings regex~ (C:\\Program Files( \(x86\))?\\ThinKiosk\\thinkiosk\.exe, .*\\PSAppDeployToolkit\\.*)'''


<li><a href="#">DESCRIPTION = Identifies suspicious startup shell folder modifications to change the default Startup directory in order to bypassdetections monitoring file creation in the Windows Startup folder.

NAME = "Suspicious Startup Shell Folder Modification"

QUERY = '''registry where host.os.type == "windows" and registry.path : ( "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Common Startup", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Common Startup", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Startup", "HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup", "HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Startup", "\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Common Startup", "\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Common Startup", "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup", "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Startup" ) andregistry.data.strings != null and/* Normal Startup Folder Paths */not registry.data.strings : ( "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup", "%ProgramData%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup", "%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup", "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup" )'''


<li><a href="#">DESCRIPTION = A job can be used to schedule programs or scripts to be executed at a specified date and time. Adversaries may abusetask scheduling functionality to facilitate initial or recurring execution of malicious code.

NAME = "Persistence via Scheduled Job Creation"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.path : "?:\\Windows\\Tasks\\*" and file.extension : "job" andnot ((process.executable : "?:\\Program Files\\CCleaner\\CCleaner64.exe" andfile.path : "?:\\Windows\\Tasks\\CCleanerCrashReporting.job") or(process.executable : ("?:\\Program Files (x86)\\ManageEngine\\UEMS_Agent\\bin\\dcagentregister.exe","?:\\Program Files (x86)\\DesktopCentral_Agent\\bin\\dcagentregister.exe") andfile.path : "?:\\Windows\\Tasks\\DCAgentUpdater.job"))'''


<li><a href="#">DESCRIPTION = Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/orescalate privileges.

NAME = "Local Scheduled Task Creation"

QUERY = '''sequence with maxspan=1m[process where host.os.type == "windows" and event.type != "end" and((process.name : ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe","powershell.exe", "pwsh.exe", "powershell_ise.exe", "WmiPrvSe.exe", "wsmprovhost.exe", "winrshost.exe") orprocess.pe.original_file_name : ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe", "powershell.exe", "pwsh.dll", "powershell_ise.exe", "WmiPrvSe.exe", "wsmprovhost.exe", "winrshost.exe")) or?process.code_signature.trusted == false)] by process.entity_id[process where host.os.type == "windows" and event.type == "start" and(process.name : "schtasks.exe" or process.pe.original_file_name == "schtasks.exe") andprocess.args : ("/create", "-create") and process.args : ("/RU", "/SC", "/TN", "/TR", "/F", "/XML") and/* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */not (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System")] by process.parent.entity_id'''


<li><a href="#">DESCRIPTION = A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused byan adversary to establish persistence.

NAME = "Scheduled Task Created by a Windows Script"

QUERY = '''sequence by host.id with maxspan = 30s[any where host.os.type == "windows" and (event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) and(?dll.name : "taskschd.dll" or file.name : "taskschd.dll") andprocess.name : ("cscript.exe", "wscript.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe")][registry where host.os.type == "windows" and registry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions")]'''


<li><a href="#">DESCRIPTION = "Detects attempts to establish persistence on an endpoint by abusing Microsoft Office add-ins."from =

NAME = "Persistence via Microsoft Office AddIns"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" and file.extension : ("wll","xll","ppa","ppam","xla","xlam") and file.path :("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Word\\Startup\\*","C:\\Users\\*\\AppData\\Roaming\\Microsoft\\AddIns\\*","C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Excel\\XLSTART\\*")'''


<li><a href="#">DESCRIPTION = "Detects attempts to establish persistence on an endpoint by installing a rogue Microsoft Outlook VBA Template."false_positives =

NAME = "Persistence via Microsoft Outlook VBA"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" and file.path : "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Outlook\\VbaProject.OTM'''


<li><a href="#">DESCRIPTION = Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique tomaintain persistence to the domain by having the ability to request tickets for the KRBTGT service.

NAME = "KRBTGT Delegation Backdoor"

QUERY = '''event.action:modified-user-account and event.code:4738 andwinlog.event_data.AllowedToDelegateTo:*krbtgt*'''


<li><a href="#">DESCRIPTION = Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device.Adversaries may target user email to collect sensitive information.

NAME = "New ActiveSyncAllowedDeviceID Added via PowerShell"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name: ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and process.args : "Set-CASMailbox*ActiveSyncAllowedDeviceIDs*'''


<li><a href="#">DESCRIPTION = Identifies the creation or modification of a PowerShell profile. PowerShell profile is a script that is executed whenPowerShell starts to customize the user environment, which can be abused by attackers to persist in a environment wherePowerShell is common.

NAME = "Persistence via PowerShell profile"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.path : ("?:\\Users\\*\\Documents\\WindowsPowerShell\\*", "?:\\Users\\*\\Documents\\PowerShell\\*", "?:\\Windows\\System32\\WindowsPowerShell\\*") andfile.name : ("profile.ps1", "Microsoft.Powershell_profile.ps1")'''


<li><a href="#">DESCRIPTION = Windows contains accessibility features that may be launched with a key combination before a user has logged in. Anadversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to thesystem.

NAME = "Potential Modification of Accessibility Binaries"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : ("Utilman.exe", "winlogon.exe") and user.name == "SYSTEM" and process.pe.original_file_name : "?*" and process.args :("C:\\Windows\\System32\\osk.exe","C:\\Windows\\System32\\Magnify.exe","C:\\Windows\\System32\\Narrator.exe","C:\\Windows\\System32\\Sethc.exe","utilman.exe","ATBroker.exe","DisplaySwitch.exe","sethc.exe") and not process.pe.original_file_name in("osk.exe","sethc.exe","utilman2.exe","DisplaySwitch.exe","ATBroker.exe","ScreenMagnifier.exe","SR.exe","Narrator.exe","magnify.exe","MAGNIFY.EXE")/* uncomment once in winlogbeat to avoid bypass with rogue process with matching pe original file name *//* and process.code_signature.subject_name == "Microsoft Windows" and process.code_signature.status == "trusted" */'''


<li><a href="#">DESCRIPTION = Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This couldbe an indication of an adversary's attempt to persist in a stealthy manner.

NAME = "Uncommon Registry Persistence Change"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") and length(registry.data.strings) > 0 and registry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\*","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Terminal Server\\Install\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Runonce\\*","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Load","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Run","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\IconServiceLib","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\AppSetup","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Taskman","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\VmApplet","HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*","HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell","HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script","HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script","HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script","HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script","HKLM\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\*\\ShellComponent","HKLM\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect\\MicrosoftActiveSync","HKLM\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect\\MicrosoftActiveSync","HKLM\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath","HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec","HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script","HKLM\\SOFTWARE\\Microsoft\\Command Processor\\Autorun","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Command Processor\\Autorun","HKEY_USERS\\*\\Control Panel\\Desktop\\scrnsave.exe","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*\\VerifierDlls","HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\GpExtensions\\*\\DllName","HKLM\\SYSTEM\\ControlSet*\\Control\\SafeBoot\\AlternateShell","HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal Server\\Wds\\rdpwd\\StartupPrograms","HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram","HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\BootExecute","HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\SetupExecute","HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\Execute","HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\S0InitialCommand","HKLM\\SYSTEM\\ControlSet*\\Control\\ServiceControlManagerExtension","HKLM\\SYSTEM\\ControlSet*\\Control\\BootVerificationProgram\\ImagePath","HKLM\\SYSTEM\\Setup\\CmdLine","HKEY_USERS\\*\\Environment\\UserInitMprLogonScript") and not registry.data.strings : ("C:\\Windows\\system32\\userinit.exe", "cmd.exe", "C:\\Program Files (x86)\\*.exe","C:\\Program Files\\*.exe") and not (process.name : "rundll32.exe" and registry.path : "*\\Software\\Microsoft\\Internet Explorer\\Extensions\\*\\Script") and not process.executable : ("C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe", "C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe", "C:\\Program Files\\*.exe", "C:\\Program Files (x86)\\*.exe")'''


<li><a href="#">DESCRIPTION = Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate accountpasswords to maintain access or evade password duration policies and preserve compromised credentials.

NAME = "Account Password Reset Remotely"

QUERY = '''sequence by winlog.computer_name with maxspan=1m[authentication where event.action == "logged-in" and/* event 4624 need to be logged */winlog.logon.type : "Network" and event.outcome == "success" and source.ip != null andsource.ip != "127.0.0.1" and source.ip != "::1" andnot winlog.event_data.TargetUserName : ("svc*", "PIM_*", "_*_", "*-*-*", "*$")] by winlog.event_data.TargetLogonId /* event 4724 need to be logged */[iam where event.action == "reset-password" and (/* This rule is very noisy if not scoped to privileged accounts, duplicate the rule and add your own naming convention and accounts of interest here. */winlog.event_data.TargetUserName: ("*Admin*", "*super*", "*SVC*", "*DC0*", "*service*", "*DMZ*", "*ADM*") orwinlog.event_data.TargetSid : ("S-1-5-21-*-500", "S-1-12-1-*-500"))] by winlog.event_data.SubjectLogonId'''


<li><a href="#">DESCRIPTION = Identifies run key or startup key registry modifications. In order to survive reboots and other system interrupts,attackers will modify run keys within the registry or leverage startup folder items as a form of persistence.

NAME = "Startup or Run Key Registry Modification"

QUERY = '''registry where host.os.type == "windows" and registry.data.strings != null and registry.path : ( /* Machine Hive */ "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*", /* Users Hive */ "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*", "HKEY_USERS\\*\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*" ) and/* add common legitimate changes without being too restrictive as this is one of the most abused AESPs */not registry.data.strings : "ctfmon.exe /n" andnot (registry.value : "Application Restart #*" and process.name : "csrss.exe") andnot user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20") andnot registry.data.strings : ("?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe") andnot process.executable : ("?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\SysWOW64\\msiexec.exe") andnot (/* Logitech G Hub */(process.code_signature.trusted == true and process.code_signature.subject_name == "Logitech Inc" and(process.name : "lghub_agent.exe" and registry.data.strings : ("\"?:\\Program Files\\LGHUB\\lghub.exe\" --background","\"?:\\Program Files\\LGHUB\\system_tray\\lghub_system_tray.exe\" --minimized")) or(process.name : "LogiBolt.exe" and registry.data.strings : ("?:\\Program Files\\Logi\\LogiBolt\\LogiBolt.exe --startup","?:\\Users\\*\\AppData\\Local\\Logi\\LogiBolt\\LogiBolt.exe --startup"))) or/* Google Drive File Stream, Chrome, and Google Update */(process.code_signature.trusted == true and process.code_signature.subject_name == "Google LLC" and(process.name : "GoogleDriveFS.exe" and registry.data.strings : ("\"?:\\Program Files\\Google\\Drive File Stream\\*\\GoogleDriveFS.exe\" --startup_mode") orprocess.name : "chrome.exe" and registry.data.strings : ("\"?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" --no-startup-window /prefetch:5","\"?:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe\" --no-startup-window /prefetch:5") orprocess.name : "GoogleUpdate.exe" and registry.data.strings : ("\"?:\\Users\\*\\AppData\\Local\\Google\\Update\\*\\GoogleUpdateCore.exe\""))) or/* MS Programs */(process.code_signature.trusted == true and process.code_signature.subject_name in ("Microsoft Windows", "Microsoft Corporation") and(process.name : "msedge.exe" and registry.data.strings : ("\"?:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --no-startup-window --win-session-start /prefetch:5","\"C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --win-session-start","\"C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --no-startup-window --win-session-start") orprocess.name : ("Update.exe", "Teams.exe") and registry.data.strings : ("?:\\Users\\*\\AppData\\Local\\Microsoft\\Teams\\Update.exe --processStart \"Teams.exe\" --process-start-args \"--system-initiated\"","?:\\ProgramData\\*\\Microsoft\\Teams\\Update.exe --processStart \"Teams.exe\" --process-start-args \"--system-initiated\"") orprocess.name : "OneDriveStandaloneUpdater.exe" and registry.data.strings : ("?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\*\\Microsoft.SharePoint.exe") orprocess.name : "OneDriveSetup.exe" andregistry.data.strings : ("?:\\Windows\\system32\\cmd.exe /q /c * \"?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\*\"","?:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe /background*","\"?:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe\" /background*","?:\\Program Files\\Microsoft OneDrive\\OneDrive.exe /background *","?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\??.???.????.????\\Microsoft.SharePoint.exe") orprocess.name : "OneDrive.exe" and registry.data.strings : ("\"?:\\Program Files\\Microsoft OneDrive\\OneDrive.exe\" /background","\"?:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe\" /background","\"?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe\" /background") orprocess.name : "Microsoft.SharePoint.exe" and registry.data.strings : ("?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\??.???.????.????\\Microsoft.SharePoint.exe") orprocess.name : "MicrosoftEdgeUpdate.exe" and registry.data.strings : ("\"?:\\Users\\Expedient\\AppData\\Local\\Microsoft\\EdgeUpdate\\*\\MicrosoftEdgeUpdateCore.exe\"") orprocess.executable : "?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\*\\Installer\\setup.exe" andregistry.data.strings : ("\"?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\*\\Installer\\setup.exe\" --msedgewebview --delete-old-versions --system-level --verbose-logging --on-logon"))) or/* Slack */(process.code_signature.trusted == true and process.code_signature.subject_name in ( "Slack Technologies, Inc.", "Slack Technologies, LLC") and process.name : "slack.exe" and registry.data.strings : ("\"?:\\Users\\*\\AppData\\Local\\slack\\slack.exe\" --process-start-args --startup","\"?:\\ProgramData\\*\\slack\\slack.exe\" --process-start-args --startup","\"?:\\Program Files\\Slack\\slack.exe\" --process-start-args --startup")) or/* Cisco */(process.code_signature.trusted == true and process.code_signature.subject_name in ("Cisco WebEx LLC", "Cisco Systems, Inc.") and(process.name : "WebexHost.exe" and registry.data.strings : ("\"?:\\Users\\*\\AppData\\Local\\WebEx\\WebexHost.exe\" /daemon /runFrom=autorun")) or(process.name : "CiscoJabber.exe" and registry.data.strings : ("\"?:\\Program Files (x86)\\Cisco Systems\\Cisco Jabber\\CiscoJabber.exe\" /min"))) or/* Loom */(process.code_signature.trusted == true and process.code_signature.subject_name == "Loom, Inc." andprocess.name : "Loom.exe" and registry.data.strings : ("?:\\Users\\*\\AppData\\Local\\Programs\\Loom\\Loom.exe --process-start-args \"--loomHidden\"")) or/* Adobe */(process.code_signature.trusted == true and process.code_signature.subject_name == "Adobe Inc." andprocess.name : ("Acrobat.exe", "FlashUtil32_*_Plugin.exe") and registry.data.strings : ("\"?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\AdobeCollabSync.exe\"","\"?:\\Program Files (x86)\\Adobe\\Acrobat DC\\Acrobat\\AdobeCollabSync.exe\"","?:\\WINDOWS\\SysWOW64\\Macromed\\Flash\\FlashUtil32_*_Plugin.exe -update plugin")) or/* CCleaner */(process.code_signature.trusted == true and process.code_signature.subject_name == "PIRIFORM SOFTWARE LIMITED" andprocess.name : ("CCleanerBrowser.exe", "CCleaner64.exe") and registry.data.strings : ("\"C:\\Program Files (x86)\\CCleaner Browser\\Application\\CCleanerBrowser.exe\" --check-run=src=logon --auto-launch-at-startup --profile-directory=\"Default\"","\"C:\\Program Files\\CCleaner\\CCleaner64.exe\" /MONITOR")) or/* Opera */(process.code_signature.trusted == true and process.code_signature.subject_name == "Opera Norway AS" andprocess.name : "opera.exe" and registry.data.strings : ("?:\\Users\\*\\AppData\\Local\\Programs\\Opera\\launcher.exe","?:\\Users\\*\\AppData\\Local\\Programs\\Opera GX\\launcher.exe")) or/* Avast */(process.code_signature.trusted == true and process.code_signature.subject_name == "Avast Software s.r.o." andprocess.name : "AvastBrowser.exe" and registry.data.strings : ("\"?:\\Users\\*\\AppData\\Local\\AVAST Software\\Browser\\Application\\AvastBrowser.exe\" --check-run=src=logon --auto-launch-at-startup*","\"?:\\Program Files (x86)\\AVAST Software\\Browser\\Application\\AvastBrowser.exe\" --check-run=src=logon --auto-launch-at-startup*","")) or/* Grammarly */(process.code_signature.trusted == true and process.code_signature.subject_name == "Grammarly, Inc." andprocess.name : "GrammarlyInstaller.exe" and registry.data.strings : ("?:\\Users\\*\\AppData\\Local\\Grammarly\\DesktopIntegrations\\Grammarly.Desktop.exe")))'''


<li><a href="#">DESCRIPTION = Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage andcommand line usage.

NAME = "Execution of Persistent Suspicious Program"

QUERY = '''/* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */sequence by host.id, user.name with maxspan=1m[process where host.os.type == "windows" and event.type == "start" and process.name : "userinit.exe" and process.parent.name : "winlogon.exe"][process where host.os.type == "windows" and event.type == "start" and process.name : "explorer.exe"][process where host.os.type == "windows" and event.type == "start" and process.parent.name : "explorer.exe" and /* add suspicious programs here */ process.pe.original_file_name in ("cscript.exe", "wscript.exe", "PowerShell.EXE", "MSHTA.EXE", "RUNDLL32.EXE", "REGSVR32.EXE", "RegAsm.exe", "MSBuild.exe", "InstallUtil.exe") and/* add potential suspicious paths here */process.args : ("C:\\Users\\*", "C:\\ProgramData\\*", "C:\\Windows\\Temp\\*", "C:\\Windows\\Tasks\\*", "C:\\PerfLogs\\*", "C:\\Intel\\*") ]'''


<li><a href="#">DESCRIPTION = Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence,move laterally, and/or escalate privileges.

NAME = "A scheduled task was created"

QUERY = '''iam where event.action == "scheduled-task-created" and /* excluding tasks created by the computer account */ not user.name : "*$" and /* TaskContent is not parsed, exclude by full taskname noisy ones */ not winlog.event_data.TaskName : ("\\CreateExplorerShellUnelevatedTask","\\Hewlett-Packard\\HPDeviceCheck","\\Hewlett-Packard\\HP Support Assistant\\WarrantyChecker","\\Hewlett-Packard\\HP Support Assistant\\WarrantyChecker_backup","\\Hewlett-Packard\\HP Web Products Detection","\\Microsoft\\VisualStudio\\Updates\\BackgroundDownload","\\OneDrive Standalone Update Task-S-1-5-21*","\\OneDrive Standalone Update Task-S-1-12-1-*" )'''


<li><a href="#">DESCRIPTION = Indicates the update of a scheduled task using Windows event logs. Adversaries can use these to establish persistence,by changing the configuration of a legit scheduled task. Some changes such as disabling or enabling a scheduled task arecommon and may may generate noise.

NAME = "A scheduled task was updated"

QUERY = '''iam where event.action == "scheduled-task-updated" and /* excluding tasks created by the computer account */ not user.name : "*$" andnot winlog.event_data.TaskName : "*Microsoft*" andnot winlog.event_data.TaskName :("\\User_Feed_Synchronization-*", "\\OneDrive Reporting Task-S-1-5-21*", "\\OneDrive Reporting Task-S-1-12-1-*", "\\Hewlett-Packard\\HP Web Products Detection", "\\Hewlett-Packard\\HPDeviceCheck","\\Microsoft\\Windows\\UpdateOrchestrator\\UpdateAssistant","\\IpamDnsProvisioning", "\\Microsoft\\Windows\\UpdateOrchestrator\\UpdateAssistantAllUsersRun","\\Microsoft\\Windows\\UpdateOrchestrator\\UpdateAssistantCalendarRun","\\Microsoft\\Windows\\UpdateOrchestrator\\UpdateAssistantWakeupRun","\\Microsoft\\Windows\\.NET Framework\\.NET Framework NGEN v*","\\Microsoft\\VisualStudio\\Updates\\BackgroundDownload") and not winlog.event_data.SubjectUserSid :("S-1-5-18", "S-1-5-19", "S-1-5-20")'''


<li><a href="#">DESCRIPTION = Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded fromthe SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolderobject. If the permissions on any of the protected accounts and groups do not match, the permissions on the protectedaccounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded willremain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in thesegroups.

NAME = "AdminSDHolder SDProp Exclusion Added"

QUERY = '''any where event.action == "Directory Service Changes" andevent.code == "5136" andwinlog.event_data.AttributeLDAPDisplayName : "dSHeuristics" andlength(winlog.event_data.AttributeValue) > 15 andwinlog.event_data.AttributeValue regex~ "[0-9]{15}([1-9a-f]).*'''


<li><a href="#">DESCRIPTION = Identifies an unsigned library created in the last 5 minutes and subsequently loaded by a shared windows service(svchost). Adversaries may use this technique to maintain persistence or run with System privileges.

NAME = "Unsigned DLL Loaded by Svchost"

QUERY = '''library where host.os.type == "windows" and process.executable :("?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\Syswow64\\svchost.exe") and dll.code_signature.trusted != true and not dll.code_signature.status : ("trusted", "errorExpired", "errorCode_endpoint*") and dll.hash.sha256 != null and ( /* DLL created within 5 minutes of the library load event - compatible with Elastic Endpoint 8.4+ */ dll.Ext.relative_file_creation_time <= 300 or /* unusual paths */ dll.path :("?:\\ProgramData\\*","?:\\Users\\*","?:\\PerfLogs\\*","?:\\Windows\\Tasks\\*","?:\\Intel\\*","?:\\AMD\\Temp\\*","?:\\Windows\\AppReadiness\\*","?:\\Windows\\ServiceState\\*","?:\\Windows\\security\\*","?:\\Windows\\IdentityCRL\\*","?:\\Windows\\Branding\\*","?:\\Windows\\csc\\*","?:\\Windows\\DigitalLocker\\*","?:\\Windows\\en-US\\*","?:\\Windows\\wlansvc\\*","?:\\Windows\\Prefetch\\*","?:\\Windows\\Fonts\\*","?:\\Windows\\diagnostics\\*","?:\\Windows\\TAPI\\*","?:\\Windows\\INF\\*","?:\\Windows\\System32\\Speech\\*","?:\\windows\\tracing\\*","?:\\windows\\IME\\*","?:\\Windows\\Performance\\*","?:\\windows\\intel\\*","?:\\windows\\ms\\*","?:\\Windows\\dot3svc\\*","?:\\Windows\\panther\\*","?:\\Windows\\RemotePackages\\*","?:\\Windows\\OCR\\*","?:\\Windows\\appcompat\\*","?:\\Windows\\apppatch\\*","?:\\Windows\\addins\\*","?:\\Windows\\Setup\\*","?:\\Windows\\Help\\*","?:\\Windows\\SKB\\*","?:\\Windows\\Vss\\*","?:\\Windows\\servicing\\*","?:\\Windows\\CbsTemp\\*","?:\\Windows\\Logs\\*","?:\\Windows\\WaaS\\*","?:\\Windows\\twain_32\\*","?:\\Windows\\ShellExperiences\\*","?:\\Windows\\ShellComponents\\*","?:\\Windows\\PLA\\*","?:\\Windows\\Migration\\*","?:\\Windows\\debug\\*","?:\\Windows\\Cursors\\*","?:\\Windows\\Containers\\*","?:\\Windows\\Boot\\*","?:\\Windows\\bcastdvr\\*","?:\\Windows\\TextInput\\*","?:\\Windows\\security\\*","?:\\Windows\\schemas\\*","?:\\Windows\\SchCache\\*","?:\\Windows\\Resources\\*","?:\\Windows\\rescache\\*","?:\\Windows\\Provisioning\\*","?:\\Windows\\PrintDialog\\*","?:\\Windows\\PolicyDefinitions\\*","?:\\Windows\\media\\*","?:\\Windows\\Globalization\\*","?:\\Windows\\L2Schemas\\*","?:\\Windows\\LiveKernelReports\\*","?:\\Windows\\ModemLogs\\*","?:\\Windows\\ImmersiveControlPanel\\*","?:\\$Recycle.Bin\\*")) and not dll.hash.sha256 : ("3ed33e71641645367442e65dca6dab0d326b22b48ef9a4c2a2488e67383aa9a6","b4db053f6032964df1b254ac44cb995ffaeb4f3ade09597670aba4f172cf65e4","214c75f678bc596bbe667a3b520aaaf09a0e50c364a28ac738a02f867a085eba","23aa95b637a1bf6188b386c21c4e87967ede80242327c55447a5bb70d9439244","5050b025909e81ae5481db37beb807a80c52fc6dd30c8aa47c9f7841e2a31be7")'''


<li><a href="#">DESCRIPTION = Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically runas SYSTEM and can be used for privilege escalation and persistence.

NAME = "Suspicious Service was Installed in the System"

QUERY = '''any where(event.code : "4697" and (winlog.event_data.ServiceFileName :("*COMSPEC*", "*\\127.0.0.1*", "*Admin$*", "*powershell*", "*rundll32*", "*cmd.exe*", "*PSEXESVC*", "*echo*", "*RemComSvc*", "*.bat*", "*.cmd*", "*certutil*", "*vssadmin*", "*certmgr*", "*bitsadmin*", "*\\Users\\*", "*\\Windows\\Temp\\*", "*\\Windows\\Tasks\\*", "*\\PerfLogs\\*", "*\\Windows\\Debug\\*","*regsvr32*", "*msbuild*") or winlog.event_data.ServiceFileName regex~ %systemroot%\\[a-z0-9]+\.exe)) or(event.code : "7045" and winlog.event_data.ImagePath : ( "*COMSPEC*", "*\\127.0.0.1*", "*Admin$*", "*powershell*", "*rundll32*", "*cmd.exe*", "*PSEXESVC*", "*echo*", "*RemComSvc*", "*.bat*", "*.cmd*", "*certutil*", "*vssadmin*", "*certmgr*", "*bitsadmin*", "*\\Users\\*", "*\\Windows\\Temp\\*", "*\\Windows\\Tasks\\*", "*\\PerfLogs\\*", "*\\Windows\\Debug\\*", "*regsvr32*", "*msbuild*"))'''


<li><a href="#">DESCRIPTION = Identifies processes modifying the services registry key directly, instead of through the expected Windows APIs. Thiscould be an indication of an adversary attempting to stealthily persist through abnormal service creation ormodification of an existing service.

NAME = "Unusual Persistence via Services Registry"

QUERY = '''registry where host.os.type == "windows" and event.type == "change" andregistry.path : ("HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ServiceDLL","HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath","\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ServiceDLL","\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath") and not registry.data.strings : ("?:\\windows\\system32\\Drivers\\*.sys","\\SystemRoot\\System32\\drivers\\*.sys","\\??\\?:\\Windows\\system32\\Drivers\\*.SYS","system32\\DRIVERS\\USBSTOR") andnot (process.name : "procexp??.exe" and registry.data.strings : "?:\\*\\procexp*.sys") andnot process.executable : ("?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\System32\\svchost.exe","?:\\Windows\\winsxs\\*\\TiWorker.exe","?:\\Windows\\System32\\drvinst.exe","?:\\Windows\\System32\\services.exe","?:\\Windows\\System32\\msiexec.exe","?:\\Windows\\System32\\regsvr32.exe")'''


<li><a href="#">DESCRIPTION = Both ~/.bash_profile and ~/.bashrc are files containing shell commands that are run when Bash is invoked. These filesare executed in a user's context, either interactively or non-interactively, when a user logs in so that theirenvironment is set correctly. Adversaries may abuse this to establish persistence by executing malicious contenttriggered by a user’s shell.

NAME = "Bash Shell Profile Modification"

QUERY = '''event.category:file and event.type:change andprocess.name:(* and not (sudo or vim or zsh or env or nano or bash or Terminal or xpcproxy or login or cat or cp orlaunchctl or java or dnf or tailwatchd or ldconfig or yum or semodule or cpanellogd or dockerd or authselect or chmod ordnf-automatic or git or dpkg or platform-python)) andnot process.executable:(/Applications/* or /private/var/folders/* or /usr/local/* or /opt/saltstack/salt/bin/*) andfile.path:(/private/etc/rc.local or /etc/rc.local or /home/*/.profile or /home/*/.profile1 or /home/*/.bash_profile or /home/*/.bash_profile1 or /home/*/.bashrc or /Users/*/.bash_profile or /Users/*/.zshenv)'''


<li><a href="#">DESCRIPTION = The Secure Shell (SSH) authorized_keys file specifies which users are allowed to log into a server using public keyauthentication. Adversaries may modify it to maintain persistence on a victim host by adding their own public key(s).

NAME = "SSH Authorized Keys File Modification"

QUERY = '''event.category:file and event.type:(change or creation) and file.name:("authorized_keys" or "authorized_keys2" or "/etc/ssh/sshd_config" or "/root/.ssh") and not process.executable: (/Library/Developer/CommandLineTools/usr/bin/git or/usr/local/Cellar/maven/*/libexec/bin/mvn or/Library/Java/JavaVirtualMachines/jdk*.jdk/Contents/Home/bin/java or/usr/bin/vim or/usr/local/Cellar/coreutils/*/bin/gcat or/usr/bin/bsdtar or/usr/bin/nautilus or/usr/bin/scp or/usr/bin/touch or/var/lib/docker/* or/usr/bin/google_guest_agent or /opt/jc/bin/jumpcloud-agent or /opt/puppetlabs/puppet/bin/puppet or/usr/bin/chef-client)'''


<li><a href="#">DESCRIPTION = Identifies files written to or modified in the startup folder by commonly abused processes. Adversaries may use thistechnique to maintain persistence.

NAME = "Startup Persistence by a Suspicious Process"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" anduser.domain != "NT AUTHORITY" andfile.path : ("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*", "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\*") andprocess.name : ("cmd.exe","powershell.exe","wmic.exe","mshta.exe","pwsh.exe","cscript.exe","wscript.exe","regsvr32.exe","RegAsm.exe","rundll32.exe","EQNEDT32.EXE","WINWORD.EXE","EXCEL.EXE","POWERPNT.EXE","MSPUB.EXE","MSACCESS.EXE","iexplore.exe","InstallUtil.exe")'''


<li><a href="#">DESCRIPTION = Identifies files written or modified in the startup folder by unsigned processes. Adversaries may abuse this techniqueto maintain persistence in an environment.

NAME = "Startup Folder Persistence via Unsigned Process"

QUERY = '''sequence by host.id, process.entity_id with maxspan=5s[process where host.os.type == "windows" and event.type == "start" and process.code_signature.trusted == false and/* suspicious paths can be added here*/ process.executable : ("C:\\Users\\*.exe", "C:\\ProgramData\\*.exe", "C:\\Windows\\Temp\\*.exe", "C:\\Windows\\Tasks\\*.exe", "C:\\Intel\\*.exe", "C:\\PerfLogs\\*.exe") ] [file where host.os.type == "windows" and event.type != "deletion" and user.domain != "NT AUTHORITY" andfile.path : ("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*", "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\*") ]'''


<li><a href="#">DESCRIPTION = Identifies script engines creating files in the Startup folder, or the creation of script files in the Startup folder.Adversaries may abuse this technique to maintain persistence in an environment.

NAME = "Persistent Scripts in the Startup Directory"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.extension : ("lnk", "vbs", "vbe", "wsh", "wsf", "js") andnot (startsWith(user.domain, "NT") or endsWith(user.domain, "NT")) and/* detect shortcuts created by wscript.exe or cscript.exe */(file.path : "C:\\*\\Programs\\Startup\\*.lnk" and process.name : ("wscript.exe", "cscript.exe")) or/* detect vbs or js files created by any process */file.path : ("C:\\*\\Programs\\Startup\\*.vbs", "C:\\*\\Programs\\Startup\\*.vbe", "C:\\*\\Programs\\Startup\\*.wsh", "C:\\*\\Programs\\Startup\\*.wsf", "C:\\*\\Programs\\Startup\\*.js")'''


<li><a href="#">DESCRIPTION = Identifies Component Object Model (COM) hijacking via registry modification. Adversaries may establish persistence byexecuting malicious content triggered by hijacked references to COM objects.

NAME = "Component Object Model Hijacking"

QUERY = '''registry where host.os.type == "windows" and/* not necessary but good for filtering privileged installations */user.domain != "NT AUTHORITY" and((registry.path : "HK*\\InprocServer32\\" andregistry.data.strings: ("scrobj.dll", "?:\\*\\scrobj.dll") andnot registry.path : "*\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\*") or(registry.path : "HKLM\\*\\InProcServer32\\*" andregistry.data.strings : ("*\\Users\\*", "*\\ProgramData\\*")) or/* in general COM Registry changes on Users Hive is less noisy and worth alerting */(registry.path : ("HKEY_USERS\\*\\InprocServer32\\","HKEY_USERS\\*\\LocalServer32\\","HKEY_USERS\\*\\DelegateExecute","HKEY_USERS\\*\\TreatAs\\","HKEY_USERS\\*\\ScriptletURL*") andnot ((process.name : "svchost.exe" andprocess.code_signature.trusted == true and process.code_signature.subject_name == "Microsoft Windows Publisher" andregistry.value : "DelegateExecute" andregistry.data.strings : (/* https://strontic.github.io/xcyclopedia/library/clsid_4ED3A719-CEA8-4BD9-910D-E252F997AFC2.html */"{4ED3A719-CEA8-4BD9-910D-E252F997AFC2}",/* https://strontic.github.io/xcyclopedia/library/clsid_A56A841F-E974-45C1-8001-7E3F8A085917.html */"{A56A841F-E974-45C1-8001-7E3F8A085917}",/* https://strontic.github.io/xcyclopedia/library/clsid_BFEC0C93-0B7D-4F2C-B09C-AFFFC4BDAE78.html */"{BFEC0C93-0B7D-4F2C-B09C-AFFFC4BDAE78}","%SystemRoot%\\system32\\shdocvw.dll")) or(process.name : "veeam.backup.shell.exe" andregistry.path : "HKEY_USERS\\S-1-*_Classes\\CLSID\\*\\LocalServer32\\" andprocess.code_signature.trusted == true and process.code_signature.subject_name == "Veeam Software Group GmbH") or (process.name : ("ADNotificationManager.exe", "Creative Cloud.exe") andprocess.code_signature.trusted == true and process.code_signature.subject_name == "Adobe Inc." andregistry.data.strings : ("\"?:\\Program Files (x86)\\Adobe\\Acrobat Reader DC\\Reader\\ADNotificationManager.exe\" -ToastActivated","\"?:\\Program Files (x86)\\Adobe\\Acrobat DC\\Acrobat\\ADNotificationManager.exe\" -ToastActivated","\"?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\ADNotificationManager.exe\" -ToastActivated","\"?:\\Program Files\\Adobe\\Acrobat Reader DC\\Reader\\ADNotificationManager.exe\" -ToastActivated","\"?:\\Program Files\\Adobe\\Adobe Creative Cloud\\ACC\\Creative Cloud.exe\" -ToastActivated")) or (process.name : ("IslandUpdateComRegisterShell64.exe", "IslandUpdate.exe", "GoogleUpdateComRegisterShell64.exe") andprocess.code_signature.trusted == true andprocess.code_signature.subject_name in ("Island Technology Inc.", "Google LLC") andregistry.data.strings : ("*?:\\Users\\*\\AppData\\Local\\Island\\Update\\*","*?:\\Users\\*\\AppData\\Local\\Google\\Update\\*")) or (process.name : ("SelfService.exe", "WfShell.exe") andprocess.code_signature.trusted == true and process.code_signature.subject_name == "Citrix Systems, Inc." andregistry.data.strings : ("\"?:\\Program Files (x86)\\Citrix\\ICA Client\\SelfServicePlugin\\SelfService.exe\" -ToastActivated","%SystemRoot%\\system32\\shdocvw.dll","%SystemRoot%\\sysWOW64\\shdocvw.dll")) or (process.name : ("msrdcw.exe") andprocess.code_signature.trusted == true and process.code_signature.subject_name == "Microsoft Corporation" andregistry.data.strings : ("\"?:\\Program Files\\Remote Desktop\\msrdcw.exe\" -ToastActivated","\"?:\\Users\\*\\AppData\\Local\\Apps\\Remote Desktop\\msrdcw.exe\" -ToastActivated")) or (process.name : ("ssvagent.exe") andprocess.code_signature.trusted == true and process.code_signature.subject_name == "Oracle America, Inc." andregistry.data.strings : ("?:\\Program Files\\Java\\jre*\\bin\\jp2iexp.dll","?:\\Program Files (x86)\\Java\\jre*\\bin\\jp2iexp.dll")) or (process.name : ("hpnotifications.exe") andprocess.code_signature.trusted == true and process.code_signature.subject_name == "HP Inc." andregistry.data.strings : ("\"?:\\Windows\\System32\\DriverStore\\FileRepository\\hpsvcsscancomp.inf_amd64_*\\x64\\hpnotifications.exe\" -ToastActivated"))))) and/* removes false-positives generated by OneDrive and Teams */not(process.name: ("OneDrive.exe", "OneDriveSetup.exe", "FileSyncConfig.exe", "Teams.exe") andprocess.code_signature.trusted == true and process.code_signature.subject_name in ("Microsoft Windows", "Microsoft Corporation")) and/* Teams DLL loaded by regsvr */not (process.name: "regsvr32.exe" and registry.data.strings : "*Microsoft.Teams.*.dll")'''


<li><a href="#">DESCRIPTION = Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicateadversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique canbe used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary(schtasks.exe) used to manage scheduled tasks.

NAME = "Suspicious Image Load (taskschd.dll) from MS Office"

QUERY = '''any where host.os.type == "windows" and (event.category : ("library", "driver") or (event.category == "process" and event.action : "Image loaded*")) andprocess.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "MSPUB.EXE", "MSACCESS.EXE") and(?dll.name : "taskschd.dll" or file.name : "taskschd.dll")'''


<li><a href="#">DESCRIPTION = "Identifies execution of a suspicious program via scheduled tasks by looking at process lineage and command line usage."false_positives =

NAME = "Suspicious Execution via Scheduled Task"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and/* Schedule service cmdline on Win10+ */process.parent.name : "svchost.exe" and process.parent.args : "Schedule" and/* add suspicious programs here */process.pe.original_file_name in("cscript.exe","wscript.exe","PowerShell.EXE","Cmd.Exe","MSHTA.EXE","RUNDLL32.EXE","REGSVR32.EXE","MSBuild.exe","InstallUtil.exe","RegAsm.exe","RegSvcs.exe","msxsl.exe","CONTROL.EXE","EXPLORER.EXE","Microsoft.Workflow.Compiler.exe","msiexec.exe") and/* add suspicious paths here */process.args : ( "C:\\Users\\*", "C:\\ProgramData\\*", "C:\\Windows\\Temp\\*", "C:\\Windows\\Tasks\\*", "C:\\PerfLogs\\*", "C:\\Intel\\*", "C:\\Windows\\Debug\\*", "C:\\HP\\*") and not (process.name : "cmd.exe" and process.args : "?:\\*.bat" and process.working_directory : "?:\\Windows\\System32\\") and not (process.name : "cscript.exe" and process.args : "?:\\Windows\\system32\\calluxxprovider.vbs") and not (process.name : "powershell.exe" and process.args : ("-File", "-PSConsoleFile") and user.id : "S-1-5-18") and not (process.name : "msiexec.exe" and user.id : "S-1-5-18")'''


<li><a href="#">DESCRIPTION = Identifies the creation of a suspicious ImagePath value. This could be an indication of an adversary attempting tostealthily persist or escalate privileges through abnormal service creation.

NAME = "Suspicious ImagePath Service Creation"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath","\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath") and /* add suspicious registry ImagePath values here */registry.data.strings : ("%COMSPEC%*", "*\\.\\pipe\\*")'''


<li><a href="#">DESCRIPTION = Detects the creation of a WMI Event Subscription. Attackers can abuse this mechanism for persistence or to elevate toSYSTEM privileges.

NAME = "Suspicious WMI Event Subscription Created"

QUERY = '''any where event.dataset == "windows.sysmon_operational" and event.code == "21" andwinlog.event_data.Operation : "Created" and winlog.event_data.Consumer : ("*subscription:CommandLineEventConsumer*", "*subscription:ActiveScriptEventConsumer*")'''


<li><a href="#">DESCRIPTION = Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetrationtesters may run a shell as a service to gain SYSTEM permissions.

NAME = "System Shells via Services"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "services.exe" andprocess.name : ("cmd.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe") and/* Third party FP's */not process.args : "NVDisplay.ContainerLocalSystem'''


<li><a href="#">DESCRIPTION = Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxymalicious execution via the schedule service and perform clean up.

NAME = "Temporarily Scheduled Task Creation"

QUERY = '''sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m [iam where event.action == "scheduled-task-created" and not user.name : "*$"] [iam where event.action == "scheduled-task-deleted" and not user.name : "*$"]'''


<li><a href="#">DESCRIPTION = Identifies modification of the Time Provider. Adversaries may establish persistence by registering and enabling amalicious DLL as a time provider. Windows uses the time provider architecture to obtain accurate time stamps from othernetwork devices or clients in the network. Time providers are implemented in the form of a DLL file which resides in theSystem32 folder. The service W32Time initiates during the startup of Windows and loads w32time.dll.

NAME = "Potential Persistence via Time Provider Modification"

QUERY = '''registry where host.os.type == "windows" and event.type:"change" andregistry.path: ("HKLM\\SYSTEM\\*ControlSet*\\Services\\W32Time\\TimeProviders\\*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\W32Time\\TimeProviders\\*") andregistry.data.strings:"*.dll" andnot(process.executable : "?:\\Windows\\System32\\msiexec.exe" andregistry.data.strings : "?:\\Program Files\\VMware\\VMware Tools\\vmwTimeProvider\\vmwTimeProvider.dll")'''


<li><a href="#">DESCRIPTION = Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in ActiveDirectory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearlyany action in Active Directory and on domain-joined systems.

NAME = "User Added to Privileged Group"

QUERY = '''iam where winlog.api:"wineventlog" and event.action == "added-member-to-group" andgroup.name : ("Admin*","Local Administrators","Domain Admins","Enterprise Admins","Backup Admins","Schema Admins","DnsAdmins","Exchange Organization Administrators")'''


<li><a href="#">DESCRIPTION = Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistenceon a system or domain.

NAME = "User Account Creation"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.name : ("net.exe", "net1.exe") andnot process.parent.name : "net.exe" and(process.args : "user" and process.args : ("/ad", "/add"))'''


<li><a href="#">DESCRIPTION = Identifies attempts to create a Windows User Account. This is sometimes done by attackers to persist or increase accessto a system or domain.

NAME = "Windows User Account Creation"

QUERY = '''event.module:("system" or "security") and winlog.api:"wineventlog" and(event.code:"4720" or event.action:"added-user-account")'''


<li><a href="#">DESCRIPTION = The Application Shim was created to allow for backward compatibility of software as the operating system codebasechanges over time. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrarycode execution in legitimate Windows processes.

NAME = "Potential Application Shimming via Sdbinst"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.name : "sdbinst.exe" andnot (process.args : "-m" and process.args : "-bg") andnot process.args : "-mm'''


<li><a href="#">DESCRIPTION = An adversary can use the Background Intelligent Transfer Service (BITS) SetNotifyCmdLine method to execute a programthat runs after a job finishes transferring data or after a job enters a specified state in order to persist on asystem.

NAME = "Persistence via BITS Job Notify Cmdline"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "svchost.exe" and process.parent.args : "BITS" andnot process.executable :("?:\\Windows\\System32\\WerFaultSecure.exe", "?:\\Windows\\System32\\WerFault.exe", "?:\\Windows\\System32\\wermgr.exe", "?:\\WINDOWS\\system32\\directxdatabaseupdater.exe")'''


<li><a href="#">DESCRIPTION = Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated)registry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit).

NAME = "Persistence via Hidden Run Key Detected"

QUERY = '''/* Registry Path ends with backslash */registry where host.os.type == "windows" and /* length(registry.data.strings) > 0 and */ registry.path : ("HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\","HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\","HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\","HKLM\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\","HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\","HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\","\\REGISTRY\\MACHINE\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\")'''


<li><a href="#">DESCRIPTION = Identifies registry modifications related to the Windows Security Support Provider (SSP) configuration. Adversaries mayabuse this to establish persistence in an environment.

NAME = "Installation of Security Support Provider"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Security Packages*","HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\OSConfig\\Security Packages*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Security Packages*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Lsa\\OSConfig\\Security Packages*" ) and not process.executable : ("C:\\Windows\\System32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe")'''


<li><a href="#">DESCRIPTION = Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with anintegrity level of system.

NAME = "Persistence via TelemetryController Scheduled Task Hijack"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : "CompatTelRunner.exe" and process.args : "-cv*" andnot process.name : ("conhost.exe","DeviceCensus.exe","CompatTelRunner.exe","DismHost.exe","rundll32.exe","powershell.exe")'''


<li><a href="#">DESCRIPTION = Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integritylevel of SYSTEM.

NAME = "Persistence via Update Orchestrator Service Hijack"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.executable : "C:\\Windows\\System32\\svchost.exe" andprocess.parent.args : "UsoSvc" andnot process.executable :("?:\\ProgramData\\Microsoft\\Windows\\UUS\\Packages\\*\\amd64\\MoUsoCoreWorker.exe","?:\\Windows\\System32\\UsoClient.exe","?:\\Windows\\System32\\MusNotification.exe","?:\\Windows\\System32\\MusNotificationUx.exe","?:\\Windows\\System32\\MusNotifyIcon.exe","?:\\Windows\\System32\\WerFault.exe","?:\\Windows\\System32\\WerMgr.exe","?:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe","?:\\Windows\\System32\\MoUsoCoreWorker.exe","?:\\Windows\\UUS\\amd64\\UsoCoreWorker.exe","?:\\Windows\\System32\\UsoCoreWorker.exe","?:\\Program Files\\Common Files\\microsoft shared\\ClickToRun\\OfficeC2RClient.exe") andnot process.name : ("MoUsoCoreWorker.exe", "OfficeC2RClient.exe")'''


<li><a href="#">DESCRIPTION = An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, andbindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to anevent and execute arbitrary code when that event occurs, providing persistence on a system.

NAME = "Persistence via WMI Event Subscription"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and(process.name : "wmic.exe" or ?process.pe.original_file_name == "wmic.exe") andprocess.args : "create" andprocess.args : ("ActiveScriptEventConsumer", "CommandLineEventConsumer")'''


<li><a href="#">DESCRIPTION = Identifies use of the Windows Management Instrumentation StdRegProv (registry provider) to modify commonly abusedregistry locations for persistence.

NAME = "Persistence via WMI Standard Registry Provider"

QUERY = '''registry where host.os.type == "windows" and registry.data.strings != null and process.name : "WmiPrvSe.exe" and registry.path : ("HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Command Processor\\Autorun","HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*","HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*","HKLM\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\*","HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*","HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*","HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*","HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*","HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*","HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*","HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ServiceDLL","HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ImagePath","HKEY_USERS\\*\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*","HKEY_USERS\\*\\Environment\\UserInitMprLogonScript","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Load","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script","HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec","HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Command Processor\\Autorun","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*","\\REGISTRY\\MACHINE\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\*","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*","\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\ServiceDLL","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\ImagePath","\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*","\\REGISTRY\\USER\\*\\Environment\\UserInitMprLogonScript","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Load","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Shell","\\REGISTRY\\USER\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script","\\REGISTRY\\USER\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script","\\REGISTRY\\USER\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\\Script","\\REGISTRY\\USER\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Exec","\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Internet Explorer\\Extensions\\*\\Script")'''


<li><a href="#">DESCRIPTION = Identifies execution via MSSQL xp_cmdshell stored procedure. Malicious users may attempt to elevate their privileges byusing xp_cmdshell, which is disabled by default, thus, it's important to review the context of it's use.

NAME = "Execution via MSSQL xp_cmdshell Stored Procedure"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name : "sqlservr.exe" and ( (process.name : "cmd.exe" and not process.args : ("\\\\*", "diskfree", "rmdir", "mkdir", "dir", "del", "rename", "bcp", "*XMLNAMESPACES*", "?:\\MSSQL\\Backup\\Jobs\\sql_agent_backup_job.ps1", "K:\\MSSQL\\Backup\\msdb", "K:\\MSSQL\\Backup\\Logins")) or(process.name : "vpnbridge.exe" or ?process.pe.original_file_name : "vpnbridge.exe") or(process.name : "certutil.exe" or ?process.pe.original_file_name == "CertUtil.exe") or(process.name : "bitsadmin.exe" or ?process.pe.original_file_name == "bitsadmin.exe"))'''


<li><a href="#">DESCRIPTION = "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access."false_positives =

NAME = "Web Shell Detection: Script Process Child of Common Web Processes"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.parent.name : ("w3wp.exe", "httpd.exe", "nginx.exe", "php.exe", "php-cgi.exe", "tomcat.exe") andprocess.name : ("cmd.exe", "cscript.exe", "powershell.exe", "pwsh.exe", "powershell_ise.exe", "wmic.exe", "wscript.exe") andnot (process.parent.name : ("php.exe", "httpd.exe") and process.name : "cmd.exe" andprocess.command_line : ("cmd.exe /c mode CON","cmd.exe /s /c \"mode CON\"","cmd.exe /c \"mode\"","cmd.exe /s /c \"tput colors 2>&1\""))'''


<li><a href="#">DESCRIPTION = Identifies process creation with alternate credentials. Adversaries may create a new process with a different token toescalate privileges and bypass access controls.

NAME = "Process Creation via Secondary Logon"

QUERY = '''sequence by winlog.computer_name with maxspan=1m[authentication where event.action:"logged-in" and event.outcome == "success" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and /* seclogon service */ process.name == "svchost.exe" and winlog.event_data.LogonProcessName : "seclogo*" and source.ip == "::1" ] by winlog.event_data.TargetLogonId[process where event.type == "start"] by winlog.event_data.TargetLogonId'''


<li><a href="#">DESCRIPTION = Identifies the creation of a process impersonating the token of another user logon session. Adversaries may create a newprocess with a different token to escalate privileges and bypass access controls.

NAME = "Process Created with a Duplicated Token"

QUERY = '''/* This rule is only compatible with Elastic Endpoint 8.4+ */process where host.os.type == "windows" and event.action == "start" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and (process.Ext.effective_parent.executable regex~ [C-Z]:\\Windows\\(System32|SysWOW64)\\[a-zA-Z0-9\-\_\.]+\.exe orprocess.Ext.effective_parent.executable : "?:\\Windows\\explorer.exe") and (process.name : ("powershell.exe", "cmd.exe", "rundll32.exe", "notepad.exe", "net.exe", "ntdsutil.exe","tasklist.exe", "reg.exe", "certutil.exe", "bitsadmin.exe", "msbuild.exe", "esentutl.exe") or((process.Ext.relative_file_creation_time <= 900 or process.Ext.relative_file_name_modify_time <= 900) and not process.code_signature.status : ("trusted", "errorExpired", "errorCode_endpoint*") and not process.executable : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*")) ) and not (process.name : "rundll32.exe" andprocess.command_line : ("*davclnt.dll,DavSetCookie*", "*?:\\Program Files*","*\\Windows\\System32\\winethc.dll*", "*\\Windows\\SYSTEM32\\EDGEHTML.dll*","*shell32.dll,SHCreateLocalServerRunDll*")) and not startswith~(process.Ext.effective_parent.name, process.parent.name) andnot (process.name : "powershell.exe" and process.parent.name : "wmiprvse.exe" and process.Ext.effective_parent.executable : "?:\\Windows\\System32\\wsmprovhost.exe") andnot (process.Ext.effective_parent.executable : "?:\\Windows\\System32\\RuntimeBroker.exe" and process.parent.executable : "?:\\Windows\\System32\\sihost.exe") andnot (process.Ext.effective_parent.executable : "?:\\Windows\\System32\\sethc.exe" and process.parent.executable : "?:\\Windows\\System32\\svchost.exe") andnot (process.Ext.effective_parent.executable : "?:\\Windows\\explorer.exe" and process.parent.executable : ("?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\twain_32\\*.exe"))'''


<li><a href="#">DESCRIPTION = Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers canabuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentialscontains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys,certificates, and certificate requests.

NAME = "Modification of the msPKIAccountCredentials"

QUERY = '''event.action:"Directory Service Changes" and event.code:"5136" andwinlog.event_data.AttributeLDAPDisplayName:"msPKIAccountCredentials" and winlog.event_data.OperationType:"%%14674" andnot winlog.event_data.SubjectUserSid : "S-1-5-18'''


<li><a href="#">DESCRIPTION = User Account Control (UAC) can help mitigate the impact of malware on Windows hosts. With UAC, apps and tasks always runin the security context of a non-administrator account, unless an administrator specifically authorizesadministrator-level access to the system. This rule identifies registry value changes to bypass User Access Control(UAC) protection.

NAME = "Disabling User Account Control via Registry Modification"

QUERY = '''registry where host.os.type == "windows" and event.type == "change" andregistry.path :("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA","HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin","HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop") andregistry.data.strings : ("0", "0x00000000")'''


<li><a href="#">DESCRIPTION = Identifies the load of a driver with an original file name and signature values that were observedfor the first time during the last 30 days. This rule type can help baseline drivers installationwithin your environment.

NAME = "First Time Seen Driver Loaded"

QUERY = '''event.category:"driver" and host.os.type:windows and event.action:"load'''


<li><a href="#">DESCRIPTION = A sudoers file specifies the commands users or groups can run and from which terminals. Adversaries can take advantageof these configurations to execute commands as other users or spawn processes with higher privileges.

NAME = "Potential Privilege Escalation via Sudoers File Modification"

QUERY = '''event.category:process and event.type:start and process.args:(echo and *NOPASSWD*ALL*)'''


<li><a href="#">DESCRIPTION = Identifies an attempt to load a revoked or expired driver. Adversaries may bring outdated drivers with vulnerabilitiesto gain code execution in kernel mode or abuse revoked certificates to sign their drivers.

NAME = "Expired or Revoked Driver Loaded"

QUERY = '''driver where host.os.type == "windows" and process.pid == 4 anddll.code_signature.status : ("errorExpired", "errorRevoked")'''


<li><a href="#">DESCRIPTION = Detects the creation or modification of a new Group Policy based scheduled task or service. These methods are used forlegitimate system administration, but can also be abused by an attacker with domain admin permissions to execute amalicious payload remotely on all or a subset of the domain joined machines.

NAME = "Creation or Modification of a new GPO Scheduled Task or Service"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.path : ("?:\\Windows\\SYSVOL\\domain\\Policies\\*\\MACHINE\\Preferences\\ScheduledTasks\\ScheduledTasks.xml", "?:\\Windows\\SYSVOL\\domain\\Policies\\*\\MACHINE\\Preferences\\Services\\Services.xml") andnot process.name : "dfsrs.exe'''


<li><a href="#">DESCRIPTION = "Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects."false_positives =

NAME = "Startup/Logon Script added to Group Policy Object"

QUERY = '''( event.code:5136 and winlog.event_data.AttributeLDAPDisplayName:(gPCMachineExtensionNames or gPCUserExtensionNames) and winlog.event_data.AttributeValue:(*42B5FAAE-6536-11D2-AE5A-0000F87571E3* and(*40B66650-4972-11D1-A7CA-0000F87571E3* or *40B6664F-4972-11D1-A7CA-0000F87571E3*)))or( event.code:5145 and winlog.event_data.ShareName:\\\\*\\SYSVOL and winlog.event_data.RelativeTargetName:(*\\scripts.ini or *\\psscripts.ini) and (message:WriteData or winlog.event_data.AccessList:*%%4417*))'''


<li><a href="#">DESCRIPTION = Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts oruse them to add users as local admins.

NAME = "Group Policy Abuse for Privilege Addition"

QUERY = '''event.code: "5136" andwinlog.event_data.AttributeLDAPDisplayName:"gPCMachineExtensionNames" andwinlog.event_data.AttributeValue:(*827D319E-6EAC-11D2-A4EA-00C04F79F83A* and *803E14A0-B4FB-11D0-A0D0-00A0C90F574B*)'''


<li><a href="#">DESCRIPTION = Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by theGPO.

NAME = "Scheduled Task Execution at Scale via GPO"

QUERY = '''(event.code: "5136" and winlog.event_data.AttributeLDAPDisplayName:("gPCMachineExtensionNames" or "gPCUserExtensionNames") and winlog.event_data.AttributeValue:(*CAB54552-DEEA-4691-817E-ED4A4D1AFC72* and *AADCED64-746C-4633-A97C-D61349046527*))or(event.code: "5145" and winlog.event_data.ShareName: "\\\\*\\SYSVOL" and winlog.event_data.RelativeTargetName: *ScheduledTasks.xml and(message: WriteData or winlog.event_data.AccessList: *%%4417*))'''


<li><a href="#">DESCRIPTION = Identifies a potential exploitation of InstallerTakeOver (CVE-2021-41379) default PoC execution. Successful exploitationallows an unprivileged user to escalate privileges to SYSTEM.

NAME = "Potential Privilege Escalation via InstallerFileTakeOver"

QUERY = '''process where host.os.type == "windows" and event.type == "start" andprocess.Ext.token.integrity_level_name : "System" and((process.name : "elevation_service.exe" and not process.pe.original_file_name == "elevation_service.exe") or(process.name : "elevation_service.exe" and not process.code_signature.trusted == true) or(process.parent.name : "elevation_service.exe" and process.name : ("rundll32.exe", "cmd.exe", "powershell.exe"))) andnot(process.name : "elevation_service.exe" and process.code_signature.trusted == true andprocess.pe.original_file_name == null)'''


<li><a href="#">DESCRIPTION = Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set tolocalhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberosrelay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges.

NAME = "Service Creation via Local Kerberos Authentication"

QUERY = '''sequence by winlog.computer_name with maxspan=5m [authentication where/* event 4624 need to be logged */event.action == "logged-in" and event.outcome == "success" and/* authenticate locally using relayed kerberos Ticket */winlog.event_data.AuthenticationPackageName :"Kerberos" and winlog.logon.type == "Network" andcidrmatch(source.ip, "127.0.0.0/8", "::1") and source.port > 0] by winlog.event_data.TargetLogonId[any where /* event 4697 need to be logged */ event.action : "service-installed"] by winlog.event_data.SubjectLogonId'''


<li><a href="#">DESCRIPTION = Adversaries can use the autostart mechanism provided by the Local Security Authority (LSA) authentication packages forprivilege escalation or persistence by placing a reference to a binary in the Windows registry. The binary will then beexecuted by SYSTEM when the authentication packages are loaded.

NAME = "Potential LSA Authentication Package Abuse"

QUERY = '''registry where host.os.type == "windows" and event.type == "change" andregistry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Authentication Packages","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Authentication Packages") and/* exclude SYSTEM SID - look for changes by non-SYSTEM user */not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Identifies interactive logon attempt with alternate credentials and by an unusual process. Adversaries may create a new token to escalate privileges and bypass access controls.

NAME = "Interactive Logon by an Unusual Process"

QUERY = '''authentication wherehost.os.type : "windows" and winlog.event_data.LogonProcessName : "Advapi*" andwinlog.logon.type == "Interactive" and winlog.event_data.SubjectUserSid : ("S-1-5-21*", "S-1-12-*") andwinlog.event_data.TargetUserSid : ("S-1-5-21*", "S-1-12-*")and process.executable : "C:\\*" andnot startswith~(winlog.event_data.SubjectUserSid, winlog.event_data.TargetUserSid) andnot process.executable : ("?:\\Windows\\System32\\winlogon.exe","?:\\Windows\\System32\\wininit.exe","?:\\Program Files\\*.exe","?:\\Program Files (x86)\\*.exe","?:\\Windows\\SysWOW64\\inetsrv\\w3wp.exe","?:\\Windows\\System32\\inetsrv\\w3wp.exe","?:\\Windows\\SysWOW64\\msiexec.exe")'''


<li><a href="#">DESCRIPTION = Identifies a privilege escalation attempt via named pipe impersonation. An adversary may abuse this technique byutilizing a framework such Metasploit's meterpreter getsystem command.

NAME = "Privilege Escalation via Named Pipe Impersonation"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and (process.name : ("Cmd.Exe", "PowerShell.EXE") or ?process.pe.original_file_name in ("Cmd.Exe", "PowerShell.EXE")) and process.args : "echo" and process.args : ">" and process.args : "\\\\.\\pipe\\*'''


<li><a href="#">DESCRIPTION = Identifies a new credentials logon type performed by an unusual process. This may indicate the existence of an access tokenforging capability that are often abused to bypass access control restrictions.

NAME = "First Time Seen NewCredentials Logon Process"

QUERY = '''event.category:"authentication" and host.os.type:"windows" and winlog.logon.type:"NewCredentials" and winlog.event_data.LogonProcessName:(Advapi* or "Advapi") and not winlog.event_data.SubjectUserName:*$ and not process.executable :???\\Program?Files*'''


<li><a href="#">DESCRIPTION = Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or onethat can be loaded from a different location by a native Windows process. This may be abused to persist or elevateprivileges via privileged file write vulnerabilities.

NAME = "Suspicious DLL Loaded for Persistence or Privilege Escalation"

QUERY = '''any where host.os.type == "windows" and (event.category : ("driver", "library") or (event.category == "process" and event.action : "Image loaded*")) and (/* compatible with Elastic Endpoint Library Events */(?dll.name : ("wlbsctrl.dll", "wbemcomn.dll", "WptsExtensions.dll", "Tsmsisrv.dll", "TSVIPSrv.dll", "Msfte.dll", "wow64log.dll", "WindowsCoreDeviceInfo.dll", "Ualapi.dll", "wlanhlp.dll", "phoneinfo.dll", "EdgeGdi.dll", "cdpsgshims.dll", "windowsperformancerecordercontrol.dll", "diagtrack_win.dll", "oci.dll", "TPPCOIPW32.dll","tpgenlic.dll", "thinmon.dll", "fxsst.dll", "msTracer.dll") and (?dll.code_signature.trusted != true or ?dll.code_signature.exists != true)) or/* compatible with Sysmon EventID 7 - Image Load */(file.name : ("wlbsctrl.dll", "wbemcomn.dll", "WptsExtensions.dll", "Tsmsisrv.dll", "TSVIPSrv.dll", "Msfte.dll", "wow64log.dll", "WindowsCoreDeviceInfo.dll", "Ualapi.dll", "wlanhlp.dll", "phoneinfo.dll", "EdgeGdi.dll", "cdpsgshims.dll", "windowsperformancerecordercontrol.dll", "diagtrack_win.dll", "oci.dll", "TPPCOIPW32.dll","tpgenlic.dll", "thinmon.dll", "fxsst.dll", "msTracer.dll") andnot file.path : ("?:\\Windows\\System32\\wbemcomn.dll", "?:\\Windows\\SysWOW64\\wbemcomn.dll") andnot file.hash.sha256 : ("6e837794fc282446906c36d681958f2f6212043fc117c716936920be166a700f","b14e4954e8cca060ffeb57f2458b6a3a39c7d2f27e94391cbcea5387652f21a4","c258d90acd006fa109dc6b748008edbb196d6168bc75ace0de0de54a4db46662") andnot file.code_signature.status == "Valid"))'''


<li><a href="#">DESCRIPTION = Identifies port monitor and print processor registry modifications. Adversaries may abuse port monitor and printprocessors to run malicious DLLs during system boot that will be executed as SYSTEM for privilege escalation and/orpersistence, if permissions allow writing a fully-qualified pathname for that DLL.

NAME = "Potential Port Monitor or Print Processor Registration Abuse"

QUERY = '''registry where host.os.type == "windows" and event.type in ("creation", "change") andregistry.path : ("HKLM\\SYSTEM\\*ControlSet*\\Control\\Print\\Monitors\\*","HKLM\\SYSTEM\\*ControlSet*\\Control\\Print\\Environments\\Windows*\\Print Processors\\*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Print\\Monitors\\*","\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Print\\Environments\\Windows*\\Print Processors\\*") and registry.data.strings : "*.dll" and/* exclude SYSTEM SID - look for changes by non-SYSTEM user */not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = Detects scripts that contain PowerShell functions, structures, or Windows API functions related to tokenimpersonation/theft. Attackers may duplicate then impersonate another user's token to escalate privileges and bypassaccess controls.

NAME = "PowerShell Script with Token Impersonation Capabilities"

QUERY = '''event.category:process and host.os.type:windows andpowershell.file.script_block_text:("Invoke-TokenManipulation" or"ImpersonateNamedPipeClient" or"NtImpersonateThread" or("STARTUPINFOEX" and"UpdateProcThreadAttribute") or("AdjustTokenPrivileges" and"SeDebugPrivilege") or(("DuplicateToken" or"DuplicateTokenEx") and("SetThreadToken" or"ImpersonateLoggedOnUser" or"CreateProcessWithTokenW" or"CreatePRocessAsUserW" or"CreateProcessAsUserA")) ) andnot (user.id:("S-1-5-18" or "S-1-5-19" or "S-1-5-20") andfile.directory: "C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads") andnot powershell.file.script_block_text : ("sentinelbreakpoints" and "Set-PSBreakpoint" and "PowerSploitIndicators")'''


<li><a href="#">DESCRIPTION = Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service.Exploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running asSYSTEM.

NAME = "Suspicious Print Spooler Point and Print DLL"

QUERY = '''sequence by host.id with maxspan=30s[registry where host.os.type == "windows" and registry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\Printers\\*\\SpoolDirectory","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\Printers\\*\\SpoolDirectory") and registry.data.strings : "C:\\Windows\\System32\\spool\\drivers\\x64\\4"][registry where host.os.type == "windows" and registry.path : ("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\Printers\\*\\CopyFiles\\Payload\\Module","\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\Printers\\*\\CopyFiles\\Payload\\Module") and registry.data.strings : "C:\\Windows\\System32\\spool\\drivers\\x64\\4\\*"]'''


<li><a href="#">DESCRIPTION = Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service. For moreinformation refer to the following CVE's - CVE-2020-1048, CVE-2020-1337 and CVE-2020-1300 and verify that the impactedsystem is patched.

NAME = "Suspicious PrintSpooler Service Executable File Creation"

QUERY = '''file where host.os.type == "windows" and event.type == "creation" andprocess.name : "spoolsv.exe" and file.extension : "dll" andfile.path : ("?:\\Windows\\System32\\*", "?:\\Windows\\SysWOW64\\*") andnot file.path : ("?:\\WINDOWS\\SysWOW64\\PrintConfig.dll","?:\\WINDOWS\\system32\\x5lrs.dll","?:\\WINDOWS\\sysWOW64\\x5lrs.dll","?:\\WINDOWS\\system32\\PrintConfig.dll","?:\\WINDOWS\\system32\\spool\\DRIVERS\\x64\\*.dll","?:\\WINDOWS\\system32\\spool\\DRIVERS\\W32X86\\*.dll","?:\\WINDOWS\\system32\\spool\\PRTPROCS\\x64\\*.dll","?:\\WINDOWS\\system32\\spool\\{????????-????-????-????-????????????}\\*.dll")'''


<li><a href="#">DESCRIPTION = Detects deletion of print driver files by an unusual process. This may indicate a clean up attempt post successfulprivilege escalation via Print Spooler service related vulnerabilities.

NAME = "Suspicious Print Spooler File Deletion"

QUERY = '''file where host.os.type == "windows" and event.type : "deletion" and not process.name : ("spoolsv.exe", "dllhost.exe", "explorer.exe") and file.path : "?:\\Windows\\System32\\spool\\drivers\\x64\\3\\*.dll'''


<li><a href="#">DESCRIPTION = Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service includingCVE-2020-1048 and CVE-2020-1337.

NAME = "Suspicious Print Spooler SPL File Created"

QUERY = '''file where host.os.type == "windows" and event.type != "deletion" andfile.extension : "spl" andfile.path : "?:\\Windows\\System32\\spool\\PRINTERS\\*" andnot process.name : ("spoolsv.exe","printfilterpipelinesvc.exe","PrintIsolationHost.exe","splwow64.exe","msiexec.exe","poqexec.exe","System") andnot user.id : "S-1-5-18" andnot process.executable :("?:\\Windows\\System32\\mmc.exe", "\\Device\\Mup\\*.exe", "?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\mmc.exe", "?:\\Windows\\System32\\printui.exe", "?:\\Windows\\System32\\mstsc.exe", "?:\\Windows\\System32\\spool\\*.exe", "?:\\Program Files\\*.exe", "?:\\Program Files (x86)\\*.exe", "?:\\PROGRA~1\\*.exe", "?:\\PROGRA~2\\*.exe", "?:\\Windows\\System32\\rundll32.exe")'''


<li><a href="#">DESCRIPTION = Identifies a privilege escalation attempt via a rogue Windows directory (Windir) environment variable. This is a knownprimitive that is often combined with other vulnerabilities to elevate privileges.

NAME = "Privilege Escalation via Windir Environment Variable"

QUERY = '''registry where host.os.type == "windows" and registry.path : ("HKEY_USERS\\*\\Environment\\windir","HKEY_USERS\\*\\Environment\\systemroot","HKU\\*\\Environment\\windir","HKU\\*\\Environment\\systemroot","\\REGISTRY\\USER\\*\\Environment\\windir","\\REGISTRY\\USER\\*\\Environment\\systemroot") and not registry.data.strings : ("C:\\windows", "%SystemRoot%")'''


<li><a href="#">DESCRIPTION = Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 toelevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a securityvulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing.

NAME = "Potential Privileged Escalation via SamAccountName Spoofing"

QUERY = '''iam where event.action == "renamed-user-account" and/* machine account name renamed to user like account name */winlog.event_data.OldTargetUserName : "*$" and not winlog.event_data.NewTargetUserName : "*$'''


<li><a href="#">DESCRIPTION = Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services.This can potentially indicate an attempt to elevate privileges or maintain persistence.

NAME = "Service Control Spawned via Script Interpreter"

QUERY = '''/* This rule is not compatible with Sysmon due to user.id issues */process where host.os.type == "windows" and event.type == "start" and(process.name : "sc.exe" or process.pe.original_file_name == "sc.exe") andprocess.parent.name : ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe","powershell.exe", "pwsh.exe") andprocess.args:("config", "create", "start", "delete", "stop", "pause") and/* exclude SYSTEM SID - look for service creations by non-SYSTEM user */not user.id : "S-1-5-18'''


<li><a href="#">DESCRIPTION = An adversary may add the setuid or setgid bit to a file or directory in order to run a file with the privileges of theowning user or group. An adversary can take advantage of this to either do a shell escape or exploit a vulnerability inan application with the setuid or setgid bit to get code running in a different user’s context. Additionally,adversaries can use this mechanism on their own malware to make sure they're able to execute in elevated contexts in thefuture.

NAME = "Setuid / Setgid Bit Set via chmod"

QUERY = '''event.category:process AND event.type:(start OR process_started) AND process.name:chmod AND process.args:("+s" OR "u+s" OR /4[0-9]{3}/ OR g+s OR /2[0-9]{3}/) AND NOT process.args: ( /.*\/Applications\/VirtualBox.app\/.+/ OR /\/usr\/local\/lib\/python.+/ OR /\/var\/folders\/.+\/FP.*nstallHelper/ OR /\/Library\/Filesystems\/.+/ OR /\/usr\/lib\/virtualbox\/.+/ OR /\/Library\/Application.*/ OR "/run/postgresql" OR "/var/crash" OR "/var/run/postgresql" OR /\/usr\/bin\/.+/ OR /\/usr\/local\/share\/.+/ OR /\/Applications\/.+/ OR /\/usr\/libexec\/.+/ OR "/var/metrics" OR /\/var\/lib\/dpkg\/.+/ OR /\/run\/log\/journal\/.*/ OR \/Users\/*\/.minikube\/bin\/docker-machine-driver-hyperkit ) AND NOT process.parent.executable: ( /\/var\/lib\/docker\/.+/ OR "/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service" OR "/var/lib/dpkg/info/whoopsie.postinst" )'''


<li><a href="#">DESCRIPTION = Identifies the attempted use of a heap-based buffer overflow vulnerability for the Sudo binary in Unix-like systems(CVE-2021-3156). Successful exploitation allows an unprivileged user to escalate to the root user.

NAME = "Sudo Heap-Based Buffer Overflow Attempt"

QUERY = '''event.category:process and event.type:start andprocess.name:(sudo or sudoedit) andprocess.args:(*\\ and ("-i" or "-s"))'''


<li><a href="#">DESCRIPTION = A sudoers file specifies the commands that users or groups can run and from which terminals. Adversaries can takeadvantage of these configurations to execute commands as other users or spawn processes with higher privileges.

NAME = "Sudoers File Modification"

QUERY = '''event.category:file and event.type:change and file.path:(/etc/sudoers* or /private/etc/sudoers*) andnot process.name:(dpkg or platform-python or puppet or yum or dnf) and not process.executable:(/opt/chef/embedded/bin/ruby or /opt/puppetlabs/puppet/bin/ruby or /usr/bin/dockerd)'''


<li><a href="#">DESCRIPTION = Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domaincontroller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparationstep to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain adminprivileges.

NAME = "Remote Computer Account DnsHostName Update"

QUERY = '''iam where event.action == "changed-computer-account" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and/* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */winlog.event_data.DnsHostName : "??*" and/* exclude FPs where DnsHostName starts with the ComputerName that was changed */not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))'''


<li><a href="#">DESCRIPTION = Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversariesmay create a new process with a different token to escalate privileges and bypass access controls.

NAME = "SeDebugPrivilege Enabled by a Suspicious Process"

QUERY = '''any where host.os.type == "windows" and event.provider: "Microsoft-Windows-Security-Auditing" and event.action : "Token Right Adjusted Events" and winlog.event_data.EnabledPrivilegeList : "SeDebugPrivilege" and /* exclude processes with System Integrity*/ not winlog.event_data.SubjectUserSid : ("S-1-5-18", "S-1-5-19", "S-1-5-20") and not winlog.event_data.ProcessName : ("?:\\Windows\\System32\\msiexec.exe","?:\\Windows\\SysWOW64\\msiexec.exe","?:\\Windows\\System32\\lsass.exe","?:\\Windows\\WinSxS\\*","?:\\Program Files\\*","?:\\Program Files (x86)\\*","?:\\Windows\\System32\\MRT.exe","?:\\Windows\\System32\\cleanmgr.exe","?:\\Windows\\System32\\taskhostw.exe","?:\\Windows\\System32\\mmc.exe","?:\\Users\\*\\AppData\\Local\\Temp\\*-*\\DismHost.exe","?:\\Windows\\System32\\auditpol.exe","?:\\Windows\\System32\\wbem\\WmiPrvSe.exe","?:\\Windows\\SysWOW64\\wbem\\WmiPrvSe.exe")'''


<li><a href="#">DESCRIPTION = Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue WindowsClipUp program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.

NAME = "UAC Bypass Attempt with IEditionUpgradeManager Elevated COM Interface"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.name : "Clipup.exe" andnot process.executable : "C:\\Windows\\System32\\ClipUp.exe" and process.parent.name : "dllhost.exe" and/* CLSID of the Elevated COM Interface IEditionUpgradeManager */process.parent.args : "/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}'''


<li><a href="#">DESCRIPTION = Identifies User Account Control (UAC) bypass attempts by abusing an elevated COM Interface to launch a maliciousprogram. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.

NAME = "UAC Bypass Attempt via Elevated COM Internet Explorer Add-On Installer"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.executable : "C:\\*\\AppData\\*\\Temp\\IDC*.tmp\\*.exe" and process.parent.name : "ieinstal.exe" and process.parent.args : "-Embedding" /* uncomment once in winlogbeat */ /* and not (process.code_signature.subject_name == "Microsoft Corporation" and process.code_signature.trusted == true) */'''


<li><a href="#">DESCRIPTION = Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attemptto bypass UAC to stealthily execute code with elevated permissions.

NAME = "UAC Bypass via ICMLuaUtil Elevated COM Interface"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.parent.name == "dllhost.exe" and process.parent.args in ("/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}", "/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}") and process.pe.original_file_name != "WerFault.exe'''


<li><a href="#">DESCRIPTION = Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC tostealthily execute code with elevated permissions.

NAME = "UAC Bypass via DiskCleanup Scheduled Task Hijack"

QUERY = '''process where host.os.type == "windows" and event.type == "start" and process.args : "/autoclean" and process.args : "/d" and process.executable != null andnot process.executable : ("C:\\Windows\\System32\\cleanmgr.exe", "C:\\Windows\\SysWOW64\\cleanmgr.exe", "C:\\Windows\\System32\\taskhostw.exe")'''


</div>
<script>
function myFunction() {
var input, filter, ul, li, a, i, txtValue;
input = document.getElementById("myInput");
filter = input.value.toUpperCase();
ul = document.getElementById("myUL");
li = ul.getElementsByTagName("li");
for (i = 0; i < li.length; i++) {
a = li[i].getElementsByTagName("a")[0];
txtValue = a.textContent || a.innerText;
if (txtValue.toUpperCase().indexOf(filter) > -1) {
li[i].style.display = "";
} else {
li[i].style.display = "none";
}
}
}
</script>
<script src="hilitor.js"></script>
<script>
var myHilitor = new Hilitor("content"); // id of the element to parse
// myHilitor.setBreakRegExp(new RegExp('[^\\w\' -]+', "g")); // expanded to include spaces
myHilitor.apply();
</script>
<script>
window.addEventListener("DOMContentLoaded", function(e) {
var myHilitor2 = new Hilitor("playground");
myHilitor2.setMatchType("left");
document.getElementById("keywords").addEventListener("keyup", function(e) {
myHilitor2.apply(this.value);
}, false);
}, false);
</script>
</html>